generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Role {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  description String?
  /** JSON array de códigos de permiso: ["REPORTES", "EDITAR_PACIENTES", "ELIMINAR_REGISTROS"] */
  permissions String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  users       User[]

  @@index([code])
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  name         String?
  isActive     Boolean  @default(true)
  roleId       String?
  role         Role?    @relation(fields: [roleId], references: [id], onDelete: SetNull)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  favoriteTests UserFavoriteTest[]
  payments      Payment[]
  admissionRequestsCreated AdmissionRequest[]

  @@index([email])
  @@index([roleId])
}

model UserFavoriteTest {
  id        String   @id @default(cuid())
  userId    String
  labTestId String
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  labTest LabTest @relation(fields: [labTestId], references: [id], onDelete: Cascade)

  @@unique([userId, labTestId])
  @@index([userId])
}

model TestProfile {
  id           String   @id @default(cuid())
  name         String
  packagePrice Float?   // Precio promocional del paquete (si null = suma de análisis)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  items TestProfileItem[]
}

model TestProfileItem {
  id         String   @id @default(cuid())
  profileId  String
  labTestId  String
  order      Int
  createdAt  DateTime @default(now())

  profile TestProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  labTest LabTest     @relation(fields: [labTestId], references: [id], onDelete: Cascade)

  @@unique([profileId, labTestId])
  @@index([profileId])
}

enum Sex {
  M
  F
  O
}

model LabSection {
  id        String   @id @default(cuid())
  code      String   @unique
  name      String
  order     Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  labTests LabTest[]

  @@index([code])
}

enum ValueType {
  NUMBER
  DECIMAL
  PERCENTAGE
  TEXT
  SELECT
}

enum OrderStatus {
  PENDIENTE
  EN_PROCESO
  COMPLETADO
  ENTREGADO
  ANULADO
}

enum OrderPatientType {
  CLINICA
  EXTERNO
  IZAGA
}

enum PaymentMethod {
  EFECTIVO
  TARJETA
  TRANSFERENCIA
  CREDITO
}

enum OrderItemStatus {
  PENDIENTE
  EN_PROCESO
  COMPLETADO
}

enum AdmissionStatus {
  PENDIENTE
  CONVERTIDA
  CANCELADA
}

model Patient {
  id        String   @id @default(cuid())
  code      String   @unique
  dni       String   @unique
  firstName String
  lastName  String
  birthDate DateTime
  sex       Sex
  phone     String?
  address   String?
  email     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  orders             LabOrder[]
  admissionRequests  AdmissionRequest[]

  @@index([dni])
  @@index([code])
}

model LabTest {
  id                    String      @id @default(cuid())
  code                  String      @unique
  name                  String
  sectionId             String
  section               LabSection @relation(fields: [sectionId], references: [id], onDelete: Restrict)
  price                 Float
  estimatedTimeMinutes  Int?
  isActive              Boolean    @default(true)
  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt
  deletedAt             DateTime?

  template       LabTemplate?
  items          LabOrderItem[]
  admissionItems AdmissionRequestItem[]
  favoriteUsers  UserFavoriteTest[]
  profileItems   TestProfileItem[]

  @@index([sectionId])
  @@index([isActive])
}

model LabTemplate {
  id        String   @id @default(cuid())
  labTestId String   @unique
  title     String
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  labTest LabTest           @relation(fields: [labTestId], references: [id])
  items   LabTemplateItem[]
}

model LabTemplateItem {
  id           String   @id @default(cuid())
  templateId   String
  groupName    String?
  paramName    String
  unit         String?
  refRangeText String?  // Mantener para compatibilidad con valores simples
  refMin       Float?   // Mantener para compatibilidad con valores simples
  refMax       Float?   // Mantener para compatibilidad con valores simples
  description  String?  // texto descriptivo del parámetro (desde JSON)
  valueType    ValueType
  selectOptions String   @default("[]")
  order        Int
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  template LabTemplate              @relation(fields: [templateId], references: [id])
  resultItems LabResultItem[]
  refRanges   LabTemplateItemRefRange[]
}

model LabTemplateItemRefRange {
  id              String   @id @default(cuid())
  templateItemId  String
  ageGroup        String?  // "NIÑOS", "JOVENES", "ADULTOS", null = todos
  sex             Sex?     // M, F, O, null = todos
  refRangeText    String?  // Texto descriptivo del rango
  refMin          Float?
  refMax          Float?
  order           Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  templateItem LabTemplateItem @relation(fields: [templateItemId], references: [id], onDelete: Cascade)

  @@index([templateItemId])
}

model LabOrder {
  id          String            @id @default(cuid())
  orderCode   String            @unique
  patientId   String
  requestedBy String?
  notes       String?
  preAnalyticNote String?
  patientType OrderPatientType?
  branchId    String?
  admissionRequestId String?           @unique
  status      OrderStatus       @default(PENDIENTE)
  totalPrice  Float
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  deliveredAt DateTime?

  patient Patient        @relation(fields: [patientId], references: [id])
  branch  Branch?        @relation(fields: [branchId], references: [id], onDelete: SetNull)
  admissionRequest AdmissionRequest? @relation("LabOrderFromAdmissionRequest", fields: [admissionRequestId], references: [id], onDelete: SetNull)
  convertedFromAdmissionRequest AdmissionRequest? @relation("AdmissionConvertedOrder")
  items   LabOrderItem[]
  payments Payment[]

  @@index([status])
  @@index([createdAt])
  @@index([patientType])
  @@index([branchId])
  @@index([admissionRequestId])
}

model Payment {
  id          String        @id @default(cuid())
  orderId      String
  amount       Float
  method       PaymentMethod
  notes        String?
  paidAt       DateTime      @default(now())
  recordedById String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  order LabOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user  User?    @relation(fields: [recordedById], references: [id], onDelete: SetNull)

  @@index([orderId])
  @@index([paidAt])
  @@index([method])
}

model LabOrderItem {
  id               String          @id @default(cuid())
  orderId          String
  labTestId        String
  status           OrderItemStatus @default(PENDIENTE)
  priceSnapshot    Float
  templateSnapshot Json?
  promotionId      String?         // Si viene de una promoción, id del TestProfile
  promotionName    String?         // Nombre de la promoción (para mostrar en detalle)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  order    LabOrder   @relation(fields: [orderId], references: [id])
  labTest  LabTest    @relation(fields: [labTestId], references: [id])
  result   LabResult?
}

model LabResult {
  id          String   @id @default(cuid())
  orderItemId String   @unique
  reportedAt  DateTime?
  reportedBy  String?
  comment     String?
  isDraft     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  orderItem LabOrderItem    @relation(fields: [orderItemId], references: [id])
  items     LabResultItem[]
}

model AppConfig {
  id    String   @id @default(cuid())
  key   String   @unique
  value String
}

model Branch {
  id        String   @id @default(cuid())
  code      String   @unique
  name      String
  address   String?
  phone     String?
  order     Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders            LabOrder[]
  admissionRequests AdmissionRequest[]

  @@index([code])
  @@index([order])
}

model AdmissionRequest {
  id             String          @id @default(cuid())
  requestCode    String          @unique
  patientId      String
  requestedBy    String?
  notes          String?
  patientType    OrderPatientType?
  branchId       String?
  createdById    String?
  status         AdmissionStatus @default(PENDIENTE)
  totalPrice     Float
  convertedOrderId String?       @unique
  convertedAt    DateTime?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  patient        Patient         @relation(fields: [patientId], references: [id])
  branch         Branch?         @relation(fields: [branchId], references: [id], onDelete: SetNull)
  createdBy      User?           @relation(fields: [createdById], references: [id], onDelete: SetNull)
  convertedOrder LabOrder?       @relation("AdmissionConvertedOrder", fields: [convertedOrderId], references: [id], onDelete: SetNull)
  items          AdmissionRequestItem[]
  labOrder       LabOrder?       @relation("LabOrderFromAdmissionRequest")

  @@index([status])
  @@index([createdAt])
  @@index([patientId])
  @@index([branchId])
}

model AdmissionRequestItem {
  id                String   @id @default(cuid())
  admissionRequestId String
  labTestId         String
  order             Int      @default(0)
  priceBase         Float
  priceApplied      Float
  adjustmentReason  String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  admissionRequest AdmissionRequest @relation(fields: [admissionRequestId], references: [id], onDelete: Cascade)
  labTest          LabTest          @relation(fields: [labTestId], references: [id], onDelete: Restrict)

  @@index([admissionRequestId])
  @@index([labTestId])
}

model PreAnalyticNoteTemplate {
  id        String   @id @default(cuid())
  code      String   @unique
  title     String
  text      String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([isActive])
}

model LabResultItem {
  id               String   @id @default(cuid())
  resultId         String
  templateItemId   String?
  paramNameSnapshot String
  unitSnapshot     String?
  refTextSnapshot  String?
  refMinSnapshot   Float?
  refMaxSnapshot   Float?
  value            String
  isOutOfRange     Boolean  @default(false)
  order            Int
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  result       LabResult       @relation(fields: [resultId], references: [id])
  templateItem LabTemplateItem? @relation(fields: [templateItemId], references: [id])
}
