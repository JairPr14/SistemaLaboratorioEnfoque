[{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\eslint.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\next.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\postcss.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\prisma.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\prisma\\seed.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\scripts\\check-db.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\scripts\\clear-all-except-auth.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":6,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":6,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[228,231],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[228,231],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":"tx es el cliente Prisma de transacción"}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\scripts\\clear-patients.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\scripts\\seed-complete-templates.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\scripts\\seed-patients.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\scripts\\seed-production.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\(app)\\admisiones\\nueva\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\(app)\\admisiones\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\(app)\\catalog\\tests\\[id]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\(app)\\catalog\\tests\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\(app)\\cobro-admision\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\(app)\\configuracion\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\(app)\\configuracion\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'canManageCatalog' is assigned a value but never used.","line":107,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":107,"endColumn":25}],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":644,"column":19,"nodeType":"JSXOpeningElement","endLine":648,"endColumn":21,"suppressions":[{"kind":"directive","justification":"URL dinámica de sello"}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport { useSession } from \"next-auth/react\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from \"@/components/ui/dialog\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { toast } from \"sonner\";\r\nimport { Pencil, Users, Shield, UserPlus, Trash2, Stamp, FlaskConical, Plus, Building2, GripVertical, TestTube2 } from \"lucide-react\";\r\nimport Link from \"next/link\";\r\nimport {\r\n  ALL_PERMISSIONS,\r\n  PERMISSION_GROUPS,\r\n  ADMIN_ROLE_CODE,\r\n  PERMISSION_GESTIONAR_ROLES,\r\n  PERMISSION_GESTIONAR_USUARIOS,\r\n  PERMISSION_GESTIONAR_SEDES,\r\n  PERMISSION_GESTIONAR_SECCIONES,\r\n  PERMISSION_GESTIONAR_PREANALITICOS,\r\n  PERMISSION_GESTIONAR_SELLO,\r\n  PERMISSION_GESTIONAR_CATALOGO,\r\n  PERMISSION_GESTIONAR_LAB_REFERIDOS,\r\n} from \"@/lib/auth\";\r\n\r\nfunction hasPermissionClient(\r\n  session: { user?: { roleCode?: string | null; permissions?: string[] } } | null,\r\n  permission: string\r\n): boolean {\r\n  if (!session?.user) return false;\r\n  const perms = session.user.permissions ?? [];\r\n  if (perms.includes(permission)) return true;\r\n  if (session.user.roleCode === ADMIN_ROLE_CODE && perms.length === 0) return true;\r\n  return false;\r\n}\r\n\r\ntype Role = {\r\n  id: string;\r\n  code: string;\r\n  name: string;\r\n  description: string | null;\r\n  permissions: string | null;\r\n  isActive: boolean;\r\n  _count: { users: number };\r\n};\r\n\r\nfunction parseRolePermissions(permissions: string | null): string[] {\r\n  if (!permissions) return [];\r\n  try {\r\n    const parsed = JSON.parse(permissions) as unknown;\r\n    return Array.isArray(parsed) && parsed.every((p) => typeof p === \"string\") ? parsed : [];\r\n  } catch {\r\n    return [];\r\n  }\r\n}\r\n\r\ntype User = {\r\n  id: string;\r\n  email: string;\r\n  name: string | null;\r\n  isActive: boolean;\r\n  roleId: string | null;\r\n  role: { id: string; code: string; name: string } | null;\r\n};\r\n\r\ntype Branch = {\r\n  id: string;\r\n  code: string;\r\n  name: string;\r\n  address: string | null;\r\n  phone: string | null;\r\n  order: number;\r\n  isActive: boolean;\r\n};\r\n\r\nexport default function ConfiguracionPage() {\r\n  const { data: session } = useSession();\r\n  const [roles, setRoles] = useState<Role[]>([]);\r\n  const [users, setUsers] = useState<User[]>([]);\r\n  const [branches, setBranches] = useState<Branch[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [roleEdit, setRoleEdit] = useState<Role | null>(null);\r\n  const [roleCreate, setRoleCreate] = useState(false);\r\n  const [userEdit, setUserEdit] = useState<User | null>(null);\r\n  const [userCreate, setUserCreate] = useState(false);\r\n  const [branchEdit, setBranchEdit] = useState<Branch | null>(null);\r\n  const [branchCreate, setBranchCreate] = useState(false);\r\n  const [saving, setSaving] = useState(false);\r\n  const [printConfig, setPrintConfig] = useState<{ stampEnabled: boolean; stampImageUrl: string | null } | null>(null);\r\n  const [stampUploading, setStampUploading] = useState(false);\r\n\r\n  // Permisos del usuario actual\r\n  const canManageRoles = hasPermissionClient(session, PERMISSION_GESTIONAR_ROLES);\r\n  const canManageUsers = hasPermissionClient(session, PERMISSION_GESTIONAR_USUARIOS);\r\n  const canManageBranches = hasPermissionClient(session, PERMISSION_GESTIONAR_SEDES);\r\n  const canManageSections = hasPermissionClient(session, PERMISSION_GESTIONAR_SECCIONES);\r\n  const canManagePreanalytics = hasPermissionClient(session, PERMISSION_GESTIONAR_PREANALITICOS);\r\n  const canManageStamp = hasPermissionClient(session, PERMISSION_GESTIONAR_SELLO);\r\n  const canManageCatalog = hasPermissionClient(session, PERMISSION_GESTIONAR_CATALOGO);\r\n  const canManageReferredLabs =\r\n    hasPermissionClient(session, PERMISSION_GESTIONAR_CATALOGO) ||\r\n    hasPermissionClient(session, PERMISSION_GESTIONAR_LAB_REFERIDOS);\r\n\r\n  const loadRoles = async () => {\r\n    const res = await fetch(\"/api/roles\");\r\n    if (res.ok) {\r\n      const data = await res.json();\r\n      setRoles(data.items ?? []);\r\n    }\r\n  };\r\n\r\n  const loadUsers = async () => {\r\n    const res = await fetch(\"/api/config/users\");\r\n    if (res.ok) {\r\n      const data = await res.json();\r\n      setUsers(data.items ?? []);\r\n    }\r\n  };\r\n\r\n  const loadPrintConfig = async () => {\r\n    const res = await fetch(\"/api/config/print\");\r\n    if (res.ok) {\r\n      const data = await res.json();\r\n      setPrintConfig(data);\r\n    }\r\n  };\r\n\r\n  const loadBranches = async () => {\r\n    const res = await fetch(\"/api/config/branches\");\r\n    if (res.ok) {\r\n      const data = await res.json();\r\n      setBranches(data ?? []);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    Promise.all([loadRoles(), loadUsers(), loadPrintConfig(), loadBranches()]).finally(() => setLoading(false));\r\n  }, []);\r\n\r\n  const handleSaveRole = async (e: React.FormEvent<HTMLFormElement>) => {\r\n    if (!roleEdit) return;\r\n    e.preventDefault();\r\n    setSaving(true);\r\n    const form = e.currentTarget;\r\n    const name = (form.elements.namedItem(\"roleName\") as HTMLInputElement).value.trim();\r\n    const description = (form.elements.namedItem(\"roleDescription\") as HTMLInputElement).value.trim() || null;\r\n    const isActive = (form.elements.namedItem(\"roleActive\") as HTMLInputElement).checked;\r\n    const permissions = ALL_PERMISSIONS.filter(\r\n      (p) => (form.elements.namedItem(`rolePerm_${p.code}`) as HTMLInputElement)?.checked,\r\n    ).map((p) => p.code);\r\n    try {\r\n      const res = await fetch(`/api/roles/${roleEdit.id}`, {\r\n        method: \"PATCH\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ name, description, isActive, permissions }),\r\n      });\r\n      const data = await res.json().catch(() => ({}));\r\n      if (!res.ok) {\r\n        toast.error(data.error ?? \"Error al guardar\");\r\n        return;\r\n      }\r\n      toast.success(\"Rol actualizado\");\r\n      setRoleEdit(null);\r\n      await loadRoles();\r\n    } catch {\r\n      toast.error(\"No se pudo actualizar el rol\");\r\n    } finally {\r\n      setSaving(false);\r\n    }\r\n  };\r\n\r\n  const handleCreateRole = async (e: React.FormEvent<HTMLFormElement>) => {\r\n    e.preventDefault();\r\n    setSaving(true);\r\n    const form = e.currentTarget;\r\n    const code = (form.elements.namedItem(\"newRoleCode\") as HTMLInputElement).value.trim().toUpperCase();\r\n    const name = (form.elements.namedItem(\"newRoleName\") as HTMLInputElement).value.trim();\r\n    const description = (form.elements.namedItem(\"newRoleDescription\") as HTMLInputElement).value.trim() || null;\r\n    const isActive = (form.elements.namedItem(\"newRoleActive\") as HTMLInputElement).checked;\r\n    const permissions = ALL_PERMISSIONS.filter(\r\n      (p) => (form.elements.namedItem(`newRolePerm_${p.code}`) as HTMLInputElement)?.checked,\r\n    ).map((p) => p.code);\r\n    try {\r\n      const res = await fetch(\"/api/roles\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ code, name, description, isActive, permissions }),\r\n      });\r\n      const data = await res.json().catch(() => ({}));\r\n      if (!res.ok) {\r\n        toast.error(data.error ?? \"Error al crear el rol\");\r\n        return;\r\n      }\r\n      toast.success(\"Rol creado\");\r\n      setRoleCreate(false);\r\n      await loadRoles();\r\n    } catch {\r\n      toast.error(\"Error de conexión\");\r\n    } finally {\r\n      setSaving(false);\r\n    }\r\n  };\r\n\r\n  const handleDeleteRole = async (role: Role) => {\r\n    if (role._count.users > 0) {\r\n      toast.error(`No se puede eliminar el rol. Tiene ${role._count.users} usuario(s) asignado(s)`);\r\n      return;\r\n    }\r\n    if (!confirm(`¿Eliminar el rol \"${role.name}\" (${role.code})?`)) return;\r\n    setSaving(true);\r\n    try {\r\n      const res = await fetch(`/api/roles/${role.id}`, { method: \"DELETE\" });\r\n      const data = await res.json().catch(() => ({}));\r\n      if (!res.ok) {\r\n        toast.error(data.error ?? \"Error al eliminar\");\r\n        return;\r\n      }\r\n      toast.success(\"Rol eliminado\");\r\n      await loadRoles();\r\n    } catch {\r\n      toast.error(\"No se pudo eliminar el rol\");\r\n    } finally {\r\n      setSaving(false);\r\n    }\r\n  };\r\n\r\n  const handleSaveUser = async (e: React.FormEvent<HTMLFormElement>) => {\r\n    if (!userEdit) return;\r\n    e.preventDefault();\r\n    setSaving(true);\r\n    const form = e.currentTarget;\r\n    const roleId = (form.elements.namedItem(\"userRoleId\") as HTMLSelectElement).value || null;\r\n    const isActive = (form.elements.namedItem(\"userActive\") as HTMLInputElement).checked;\r\n    const newPassword = (form.elements.namedItem(\"userPassword\") as HTMLInputElement).value;\r\n    const confirmPassword = (form.elements.namedItem(\"userPasswordConfirm\") as HTMLInputElement).value;\r\n    \r\n    // Validar contraseña si se proporciona\r\n    if (newPassword) {\r\n      if (newPassword.length < 6) {\r\n        toast.error(\"La contraseña debe tener al menos 6 caracteres\");\r\n        setSaving(false);\r\n        return;\r\n      }\r\n      if (newPassword !== confirmPassword) {\r\n        toast.error(\"Las contraseñas no coinciden\");\r\n        setSaving(false);\r\n        return;\r\n      }\r\n    }\r\n    \r\n    try {\r\n      const res = await fetch(`/api/config/users/${userEdit.id}`, {\r\n        method: \"PATCH\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ \r\n          roleId, \r\n          isActive,\r\n          ...(newPassword && { password: newPassword })\r\n        }),\r\n      });\r\n      const data = await res.json().catch(() => ({}));\r\n      if (!res.ok) {\r\n        toast.error(data.error ?? \"Error al guardar\");\r\n        return;\r\n      }\r\n      toast.success(\"Usuario actualizado\");\r\n      setUserEdit(null);\r\n      await loadUsers();\r\n    } catch {\r\n      toast.error(\"No se pudo actualizar el usuario\");\r\n    } finally {\r\n      setSaving(false);\r\n    }\r\n  };\r\n\r\n  const handleCreateUser = async (e: React.FormEvent<HTMLFormElement>) => {\r\n    e.preventDefault();\r\n    setSaving(true);\r\n    const form = e.currentTarget;\r\n    const email = (form.elements.namedItem(\"newEmail\") as HTMLInputElement).value.trim().toLowerCase();\r\n    const password = (form.elements.namedItem(\"newPassword\") as HTMLInputElement).value;\r\n    const name = (form.elements.namedItem(\"newName\") as HTMLInputElement).value.trim() || null;\r\n    const roleId = (form.elements.namedItem(\"newRoleId\") as HTMLSelectElement).value || null;\r\n    try {\r\n      const res = await fetch(\"/api/config/users\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ email, password, name, roleId }),\r\n      });\r\n      const data = await res.json().catch(() => ({}));\r\n      if (!res.ok) {\r\n        toast.error(data.error ?? \"Error al crear el usuario\");\r\n        return;\r\n      }\r\n      toast.success(\"Usuario creado\");\r\n      setUserCreate(false);\r\n      await loadUsers();\r\n    } catch {\r\n      toast.error(\"Error de conexión\");\r\n    } finally {\r\n      setSaving(false);\r\n    }\r\n  };\r\n\r\n  const handleStampEnabledChange = async (enabled: boolean) => {\r\n    setSaving(true);\r\n    try {\r\n      const res = await fetch(\"/api/config/print\", {\r\n        method: \"PATCH\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ stampEnabled: enabled }),\r\n      });\r\n      if (!res.ok) throw new Error(\"Error al guardar\");\r\n      const data = await res.json();\r\n      setPrintConfig(data);\r\n      toast.success(enabled ? \"Sello activado en PDFs\" : \"Sello desactivado\");\r\n    } catch {\r\n      toast.error(\"No se pudo actualizar\");\r\n    } finally {\r\n      setSaving(false);\r\n    }\r\n  };\r\n\r\n  const handleStampUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    const file = e.target.files?.[0];\r\n    if (!file) return;\r\n    setStampUploading(true);\r\n    try {\r\n      const formData = new FormData();\r\n      formData.append(\"stamp\", file);\r\n      const res = await fetch(\"/api/config/print/upload\", {\r\n        method: \"POST\",\r\n        body: formData,\r\n      });\r\n      const data = await res.json();\r\n      if (!res.ok) throw new Error(data.error ?? \"Error al subir\");\r\n      setPrintConfig((prev) => (prev ? { ...prev, stampImageUrl: data.stampImageUrl } : null));\r\n      toast.success(\"Sello subido correctamente\");\r\n    } catch (err) {\r\n      toast.error(err instanceof Error ? err.message : \"Error al subir el sello\");\r\n    } finally {\r\n      setStampUploading(false);\r\n      e.target.value = \"\";\r\n    }\r\n  };\r\n\r\n  const handleRemoveStamp = async () => {\r\n    if (!confirm(\"¿Quitar el sello de los PDFs? Deberá subir uno nuevo para volver a usarlo.\")) return;\r\n    setSaving(true);\r\n    try {\r\n      const res = await fetch(\"/api/config/print\", {\r\n        method: \"PATCH\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ stampImageUrl: null, stampEnabled: false }),\r\n      });\r\n      if (!res.ok) throw new Error(\"Error al guardar\");\r\n      const data = await res.json();\r\n      setPrintConfig(data);\r\n      toast.success(\"Sello eliminado\");\r\n    } catch {\r\n      toast.error(\"No se pudo eliminar\");\r\n    } finally {\r\n      setSaving(false);\r\n    }\r\n  };\r\n\r\n  const handleDeleteUser = async (user: User) => {\r\n    if (!confirm(`¿Eliminar al usuario ${user.email}? No podrá iniciar sesión.`)) return;\r\n    setSaving(true);\r\n    try {\r\n      const res = await fetch(`/api/config/users/${user.id}`, { method: \"DELETE\" });\r\n      if (!res.ok) throw new Error(\"Error al eliminar\");\r\n      toast.success(\"Usuario eliminado\");\r\n      await loadUsers();\r\n    } catch {\r\n      toast.error(\"No se pudo eliminar el usuario\");\r\n    } finally {\r\n      setSaving(false);\r\n    }\r\n  };\r\n\r\n  const handleCreateBranch = async (e: React.FormEvent<HTMLFormElement>) => {\r\n    e.preventDefault();\r\n    setSaving(true);\r\n    const form = e.currentTarget;\r\n    const code = (form.elements.namedItem(\"newBranchCode\") as HTMLInputElement).value.trim().toUpperCase();\r\n    const name = (form.elements.namedItem(\"newBranchName\") as HTMLInputElement).value.trim();\r\n    const address = (form.elements.namedItem(\"newBranchAddress\") as HTMLInputElement).value.trim() || null;\r\n    const phone = (form.elements.namedItem(\"newBranchPhone\") as HTMLInputElement).value.trim() || null;\r\n    const order = parseInt((form.elements.namedItem(\"newBranchOrder\") as HTMLInputElement).value) || 0;\r\n    const isActive = (form.elements.namedItem(\"newBranchActive\") as HTMLInputElement).checked;\r\n    try {\r\n      const res = await fetch(\"/api/config/branches\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ code, name, address, phone, order, isActive }),\r\n      });\r\n      const data = await res.json().catch(() => ({}));\r\n      if (!res.ok) {\r\n        toast.error(data.error ?? \"Error al crear la sede\");\r\n        return;\r\n      }\r\n      toast.success(\"Sede creada\");\r\n      setBranchCreate(false);\r\n      await loadBranches();\r\n    } catch {\r\n      toast.error(\"Error de conexión\");\r\n    } finally {\r\n      setSaving(false);\r\n    }\r\n  };\r\n\r\n  const handleSaveBranch = async (e: React.FormEvent<HTMLFormElement>) => {\r\n    if (!branchEdit) return;\r\n    e.preventDefault();\r\n    setSaving(true);\r\n    const form = e.currentTarget;\r\n    const code = (form.elements.namedItem(\"branchCode\") as HTMLInputElement).value.trim().toUpperCase();\r\n    const name = (form.elements.namedItem(\"branchName\") as HTMLInputElement).value.trim();\r\n    const address = (form.elements.namedItem(\"branchAddress\") as HTMLInputElement).value.trim() || null;\r\n    const phone = (form.elements.namedItem(\"branchPhone\") as HTMLInputElement).value.trim() || null;\r\n    const order = parseInt((form.elements.namedItem(\"branchOrder\") as HTMLInputElement).value) || 0;\r\n    const isActive = (form.elements.namedItem(\"branchActive\") as HTMLInputElement).checked;\r\n    try {\r\n      const res = await fetch(`/api/config/branches/${branchEdit.id}`, {\r\n        method: \"PUT\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ code, name, address, phone, order, isActive }),\r\n      });\r\n      const data = await res.json().catch(() => ({}));\r\n      if (!res.ok) {\r\n        toast.error(data.error ?? \"Error al guardar\");\r\n        return;\r\n      }\r\n      toast.success(\"Sede actualizada\");\r\n      setBranchEdit(null);\r\n      await loadBranches();\r\n    } catch {\r\n      toast.error(\"No se pudo actualizar la sede\");\r\n    } finally {\r\n      setSaving(false);\r\n    }\r\n  };\r\n\r\n  const handleDeleteBranch = async (branch: Branch) => {\r\n    if (!confirm(`¿Eliminar la sede \"${branch.name}\" (${branch.code})?`)) return;\r\n    setSaving(true);\r\n    try {\r\n      const res = await fetch(`/api/config/branches/${branch.id}`, { method: \"DELETE\" });\r\n      const data = await res.json().catch(() => ({}));\r\n      if (!res.ok) {\r\n        toast.error(data.error ?? \"Error al eliminar\");\r\n        return;\r\n      }\r\n      toast.success(\"Sede eliminada\");\r\n      await loadBranches();\r\n    } catch {\r\n      toast.error(\"No se pudo eliminar la sede\");\r\n    } finally {\r\n      setSaving(false);\r\n    }\r\n  };\r\n\r\n  const rolePerms = roleEdit ? parseRolePermissions(roleEdit.permissions) : [];\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"flex items-center justify-center py-12 text-slate-500 dark:text-slate-400\">\r\n        Cargando configuración...\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-8\">\r\n      <div className=\"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between\">\r\n        <div>\r\n          <h1 className=\"text-2xl font-semibold text-slate-900 dark:text-slate-100\">Configuración</h1>\r\n          <p className=\"text-slate-500 dark:text-slate-400 mt-1\">\r\n            Roles, usuarios y gestión administrativa\r\n          </p>\r\n        </div>\r\n        <div className=\"flex flex-wrap items-center gap-2\">\r\n          {canManagePreanalytics && (\r\n            <Link href=\"/configuracion/preanaliticos\">\r\n              <Button variant=\"outline\" size=\"sm\">\r\n                Gestión de preanalíticos\r\n              </Button>\r\n            </Link>\r\n          )}\r\n          {canManageSections && (\r\n            <Link href=\"/configuracion/secciones\">\r\n              <Button variant=\"outline\" size=\"sm\">\r\n                <FlaskConical className=\"h-4 w-4 mr-2\" />\r\n                Gestión de Secciones\r\n              </Button>\r\n            </Link>\r\n          )}\r\n          {canManageReferredLabs && (\r\n            <Link href=\"/configuracion/referred-labs\">\r\n              <Button variant=\"outline\" size=\"sm\">\r\n                <TestTube2 className=\"h-4 w-4 mr-2\" />\r\n                Laboratorios referidos\r\n              </Button>\r\n            </Link>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {canManageRoles && (\r\n        <Card>\r\n          <CardHeader className=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between\">\r\n            <div className=\"flex items-center gap-2\">\r\n              <Shield className=\"h-5 w-5 text-slate-600 dark:text-slate-400\" />\r\n              <CardTitle>Roles</CardTitle>\r\n            </div>\r\n            <Button onClick={() => setRoleCreate(true)} size=\"sm\">\r\n              <Plus className=\"h-4 w-4 mr-2\" />\r\n              Nuevo rol\r\n            </Button>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"overflow-x-auto -mx-1\">\r\n            <Table className=\"min-w-[540px]\">\r\n              <TableHeader>\r\n                <TableRow>\r\n                  <TableHead>Código</TableHead>\r\n                  <TableHead>Nombre</TableHead>\r\n                  <TableHead>Descripción</TableHead>\r\n                  <TableHead>Estado</TableHead>\r\n                  <TableHead>Usuarios</TableHead>\r\n                  <TableHead className=\"w-12\" />\r\n                </TableRow>\r\n              </TableHeader>\r\n              <TableBody>\r\n                {roles.length === 0 ? (\r\n                  <TableRow>\r\n                    <TableCell colSpan={6} className=\"py-8 text-center text-slate-500 dark:text-slate-400\">\r\n                      No hay roles.\r\n                    </TableCell>\r\n                  </TableRow>\r\n                ) : (\r\n                  roles.map((role) => (\r\n                    <TableRow key={role.id}>\r\n                      <TableCell className=\"font-medium\">{role.code}</TableCell>\r\n                      <TableCell>{role.name}</TableCell>\r\n                      <TableCell className=\"text-slate-500 dark:text-slate-400 max-w-xs truncate\">\r\n                        {role.description ?? \"—\"}\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <Badge variant={role.isActive ? \"success\" : \"secondary\"}>\r\n                          {role.isActive ? \"Activo\" : \"Inactivo\"}\r\n                        </Badge>\r\n                      </TableCell>\r\n                      <TableCell>{role._count.users}</TableCell>\r\n                      <TableCell>\r\n                        <div className=\"flex justify-end gap-1\">\r\n                          <Button\r\n                            variant=\"ghost\"\r\n                            size=\"icon\"\r\n                            onClick={() => setRoleEdit(role)}\r\n                            title=\"Editar rol\"\r\n                          >\r\n                            <Pencil className=\"h-4 w-4\" />\r\n                          </Button>\r\n                          <Button\r\n                            variant=\"ghost\"\r\n                            size=\"icon\"\r\n                            onClick={() => handleDeleteRole(role)}\r\n                            disabled={saving || role._count.users > 0}\r\n                            title={role._count.users > 0 ? \"No se puede eliminar: tiene usuarios asignados\" : \"Eliminar rol\"}\r\n                            className=\"text-slate-500 dark:text-slate-400 hover:text-red-600 dark:hover:text-red-400\"\r\n                          >\r\n                            <Trash2 className=\"h-4 w-4\" />\r\n                          </Button>\r\n                        </div>\r\n                      </TableCell>\r\n                    </TableRow>\r\n                  ))\r\n                )}\r\n              </TableBody>\r\n            </Table>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n\r\n      {canManageStamp && (\r\n        <Card>\r\n          <CardHeader className=\"flex flex-row items-center gap-2\">\r\n            <Stamp className=\"h-5 w-5 text-slate-600 dark:text-slate-400\" />\r\n            <CardTitle>Sello virtual para PDFs</CardTitle>\r\n          </CardHeader>\r\n          <CardContent className=\"space-y-4\">\r\n            <p className=\"text-sm text-slate-600 dark:text-slate-300\">\r\n              Incluya un sello o firma digital en cada hoja de los informes de laboratorio exportados a PDF.\r\n            </p>\r\n            <div className=\"flex items-center gap-3\">\r\n              <input\r\n                type=\"checkbox\"\r\n                id=\"stampEnabled\"\r\n                checked={printConfig?.stampEnabled ?? false}\r\n                disabled={!printConfig?.stampImageUrl || saving}\r\n                onChange={(e) => handleStampEnabledChange(e.target.checked)}\r\n                className=\"h-4 w-4 rounded border-slate-300\"\r\n              />\r\n              <Label htmlFor=\"stampEnabled\">\r\n                Incluir sello en los PDFs\r\n              {!printConfig?.stampImageUrl && (\r\n                <span className=\"ml-2 text-xs text-amber-600\">(Suba una imagen primero)</span>\r\n              )}\r\n            </Label>\r\n          </div>\r\n          <div className=\"flex flex-wrap items-center gap-4 pt-2\">\r\n            <div className=\"flex items-center gap-2\">\r\n              <input\r\n                type=\"file\"\r\n                id=\"stampFile\"\r\n                accept=\"image/png,image/jpeg,image/jpg,image/webp\"\r\n                onChange={handleStampUpload}\r\n                disabled={stampUploading}\r\n                className=\"hidden\"\r\n              />\r\n              <Label htmlFor=\"stampFile\" className=\"cursor-pointer\">\r\n                <span\r\n                  className={`inline-flex items-center justify-center gap-2 rounded-md border border-slate-200 dark:border-slate-600 px-3 py-2 text-sm font-medium hover:bg-slate-100 dark:hover:bg-slate-700 ${stampUploading ? \"opacity-50 cursor-not-allowed\" : \"\"}`}\r\n                >\r\n                  {stampUploading ? \"Subiendo…\" : printConfig?.stampImageUrl ? \"Cambiar sello\" : \"Subir sello\"}\r\n                </span>\r\n              </Label>\r\n            </div>\r\n            {printConfig?.stampImageUrl && (\r\n              <>\r\n                <div className=\"flex items-center gap-2\">\r\n                  {/* eslint-disable-next-line @next/next/no-img-element -- URL dinámica de sello */}\r\n                  <img\r\n                    src={printConfig.stampImageUrl}\r\n                    alt=\"Vista previa del sello\"\r\n                    className=\"h-16 w-auto max-w-32 object-contain border border-slate-200 rounded\"\r\n                  />\r\n                </div>\r\n                <Button\r\n                  type=\"button\"\r\n                  variant=\"ghost\"\r\n                  size=\"sm\"\r\n                  onClick={handleRemoveStamp}\r\n                  disabled={saving}\r\n                  className=\"text-slate-500 dark:text-slate-400 hover:text-red-600 dark:hover:text-red-400\"\r\n                >\r\n                  Quitar sello\r\n                </Button>\r\n              </>\r\n            )}\r\n          </div>\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n\r\n      {canManageUsers && (\r\n        <Card>\r\n          <CardHeader className=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between\">\r\n            <div className=\"flex items-center gap-2\">\r\n              <Users className=\"h-5 w-5 text-slate-600 dark:text-slate-400\" />\r\n              <CardTitle>Usuarios</CardTitle>\r\n            </div>\r\n            <Button onClick={() => setUserCreate(true)} size=\"sm\">\r\n              <UserPlus className=\"h-4 w-4 mr-2\" />\r\n              Nuevo usuario\r\n            </Button>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"overflow-x-auto -mx-1\">\r\n            <Table className=\"min-w-[520px]\">\r\n              <TableHeader>\r\n                <TableRow>\r\n                  <TableHead>Email</TableHead>\r\n                  <TableHead>Nombre</TableHead>\r\n                  <TableHead>Rol</TableHead>\r\n                  <TableHead>Estado</TableHead>\r\n                  <TableHead className=\"w-24 text-right\">Acciones</TableHead>\r\n                </TableRow>\r\n              </TableHeader>\r\n              <TableBody>\r\n                {users.length === 0 ? (\r\n                  <TableRow>\r\n                    <TableCell colSpan={5} className=\"py-8 text-center text-slate-500 dark:text-slate-400\">\r\n                      No hay usuarios.\r\n                    </TableCell>\r\n                  </TableRow>\r\n                ) : (\r\n                  users.map((user) => (\r\n                    <TableRow key={user.id}>\r\n                      <TableCell className=\"font-medium\">{user.email}</TableCell>\r\n                      <TableCell>{user.name ?? \"—\"}</TableCell>\r\n                      <TableCell>\r\n                        {user.role ? (\r\n                          <Badge variant=\"secondary\">{user.role.name}</Badge>\r\n                        ) : (\r\n                          <span className=\"text-slate-400 dark:text-slate-500\">Sin rol</span>\r\n                        )}\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <Badge variant={user.isActive ? \"success\" : \"secondary\"}>\r\n                          {user.isActive ? \"Activo\" : \"Inactivo\"}\r\n                        </Badge>\r\n                      </TableCell>\r\n                      <TableCell className=\"text-right\">\r\n                        <div className=\"flex justify-end gap-1\">\r\n                          <Button\r\n                            variant=\"ghost\"\r\n                            size=\"icon\"\r\n                            onClick={() => setUserEdit(user)}\r\n                            title=\"Editar usuario\"\r\n                          >\r\n                            <Pencil className=\"h-4 w-4\" />\r\n                          </Button>\r\n                          <Button\r\n                            variant=\"ghost\"\r\n                            size=\"icon\"\r\n                            onClick={() => handleDeleteUser(user)}\r\n                            disabled={saving}\r\n                            title=\"Eliminar usuario\"\r\n                            className=\"text-slate-500 dark:text-slate-400 hover:text-red-600 dark:hover:text-red-400\"\r\n                          >\r\n                            <Trash2 className=\"h-4 w-4\" />\r\n                          </Button>\r\n                        </div>\r\n                    </TableCell>\r\n                  </TableRow>\r\n                ))\r\n              )}\r\n            </TableBody>\r\n          </Table>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n\r\n      {/* Sección Sedes */}\r\n      {canManageBranches && (\r\n        <Card>\r\n          <CardHeader className=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between\">\r\n            <div className=\"flex items-center gap-2\">\r\n              <Building2 className=\"h-5 w-5 text-slate-600 dark:text-slate-400\" />\r\n              <CardTitle>Sedes</CardTitle>\r\n            </div>\r\n            <Button onClick={() => setBranchCreate(true)} size=\"sm\">\r\n              <Plus className=\"h-4 w-4 mr-2\" />\r\n              Nueva sede\r\n            </Button>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"overflow-x-auto -mx-1\">\r\n              <Table className=\"min-w-[600px]\">\r\n                <TableHeader>\r\n                  <TableRow>\r\n                    <TableHead className=\"w-12\">Orden</TableHead>\r\n                    <TableHead>Código</TableHead>\r\n                    <TableHead>Nombre</TableHead>\r\n                    <TableHead>Dirección</TableHead>\r\n                    <TableHead>Teléfono</TableHead>\r\n                    <TableHead>Estado</TableHead>\r\n                    <TableHead className=\"w-24 text-right\">Acciones</TableHead>\r\n                  </TableRow>\r\n                </TableHeader>\r\n                <TableBody>\r\n                  {branches.length === 0 ? (\r\n                    <TableRow>\r\n                      <TableCell colSpan={7} className=\"py-8 text-center text-slate-500 dark:text-slate-400\">\r\n                        No hay sedes configuradas.\r\n                      </TableCell>\r\n                    </TableRow>\r\n                  ) : (\r\n                    branches.map((branch) => (\r\n                      <TableRow key={branch.id}>\r\n                        <TableCell>\r\n                          <div className=\"flex items-center gap-1 text-slate-400\">\r\n                            <GripVertical className=\"h-4 w-4\" />\r\n                            <span className=\"text-sm\">{branch.order}</span>\r\n                          </div>\r\n                        </TableCell>\r\n                        <TableCell className=\"font-medium font-mono text-xs\">\r\n                          {branch.code}\r\n                        </TableCell>\r\n                        <TableCell className=\"font-medium\">{branch.name}</TableCell>\r\n                        <TableCell className=\"text-slate-600 dark:text-slate-400 max-w-xs truncate\">\r\n                          {branch.address ?? \"—\"}\r\n                        </TableCell>\r\n                        <TableCell className=\"text-slate-600 dark:text-slate-400\">\r\n                          {branch.phone ?? \"—\"}\r\n                        </TableCell>\r\n                        <TableCell>\r\n                          <Badge variant={branch.isActive ? \"success\" : \"secondary\"}>\r\n                            {branch.isActive ? \"Activa\" : \"Inactiva\"}\r\n                          </Badge>\r\n                        </TableCell>\r\n                        <TableCell className=\"text-right\">\r\n                          <div className=\"flex justify-end gap-1\">\r\n                            <Button\r\n                              variant=\"ghost\"\r\n                              size=\"icon\"\r\n                              onClick={() => setBranchEdit(branch)}\r\n                              title=\"Editar sede\"\r\n                            >\r\n                              <Pencil className=\"h-4 w-4\" />\r\n                            </Button>\r\n                            <Button\r\n                              variant=\"ghost\"\r\n                              size=\"icon\"\r\n                              onClick={() => handleDeleteBranch(branch)}\r\n                              disabled={saving}\r\n                              title=\"Eliminar sede\"\r\n                              className=\"text-slate-500 dark:text-slate-400 hover:text-red-600 dark:hover:text-red-400\"\r\n                            >\r\n                              <Trash2 className=\"h-4 w-4\" />\r\n                            </Button>\r\n                          </div>\r\n                        </TableCell>\r\n                      </TableRow>\r\n                    ))\r\n                  )}\r\n                </TableBody>\r\n              </Table>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n\r\n      {/* Diálogo nuevo rol */}\r\n      <Dialog open={roleCreate} onOpenChange={(open) => !open && setRoleCreate(false)}>\r\n        <DialogContent>\r\n          <DialogHeader>\r\n            <DialogTitle>Nuevo rol</DialogTitle>\r\n          </DialogHeader>\r\n          <form onSubmit={handleCreateRole} className=\"space-y-4\">\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"newRoleCode\">Código</Label>\r\n              <Input\r\n                id=\"newRoleCode\"\r\n                name=\"newRoleCode\"\r\n                placeholder=\"Ej: ADMIN, LAB, RECEPTION\"\r\n                required\r\n                pattern=\"[A-Z0-9_]+\"\r\n                title=\"Solo letras mayúsculas, números y guiones bajos\"\r\n              />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"newRoleName\">Nombre</Label>\r\n              <Input\r\n                id=\"newRoleName\"\r\n                name=\"newRoleName\"\r\n                placeholder=\"Ej: Administrador\"\r\n                required\r\n              />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"newRoleDescription\">Descripción (opcional)</Label>\r\n              <Input\r\n                id=\"newRoleDescription\"\r\n                name=\"newRoleDescription\"\r\n                placeholder=\"Ej: Acceso completo al sistema\"\r\n              />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label className=\"text-slate-700 dark:text-slate-300\">Permisos</Label>\r\n              <div className=\"rounded-md border border-slate-200 bg-slate-50/50 p-3 space-y-4 max-h-64 overflow-y-auto dark:border-slate-600 dark:bg-slate-800/50\">\r\n                {PERMISSION_GROUPS.map((group) => (\r\n                  <div key={group.label}>\r\n                    <p className=\"text-xs font-semibold uppercase text-slate-500 dark:text-slate-400 mb-2\">\r\n                      {group.label}\r\n                    </p>\r\n                    <div className=\"space-y-2 pl-1\">\r\n                      {group.permissions.map((p) => (\r\n                        <div key={p.code} className=\"flex items-center gap-2\">\r\n                          <input\r\n                            type=\"checkbox\"\r\n                            id={`newRolePerm_${p.code}`}\r\n                            name={`newRolePerm_${p.code}`}\r\n                            className=\"h-4 w-4 rounded border-slate-300\"\r\n                          />\r\n                          <Label htmlFor={`newRolePerm_${p.code}`} className=\"font-normal cursor-pointer text-sm\">\r\n                            {p.label}\r\n                          </Label>\r\n                        </div>\r\n                      ))}\r\n                    </div>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            </div>\r\n            <div className=\"flex items-center gap-2\">\r\n              <input\r\n                type=\"checkbox\"\r\n                id=\"newRoleActive\"\r\n                name=\"newRoleActive\"\r\n                defaultChecked={true}\r\n                className=\"h-4 w-4 rounded border-slate-300\"\r\n              />\r\n              <Label htmlFor=\"newRoleActive\">Activo</Label>\r\n            </div>\r\n            <div className=\"flex justify-end gap-2 pt-2\">\r\n              <Button type=\"button\" variant=\"outline\" onClick={() => setRoleCreate(false)}>\r\n                Cancelar\r\n              </Button>\r\n              <Button type=\"submit\" disabled={saving}>\r\n                {saving ? \"Creando...\" : \"Crear rol\"}\r\n              </Button>\r\n            </div>\r\n          </form>\r\n        </DialogContent>\r\n      </Dialog>\r\n\r\n      {/* Diálogo editar rol */}\r\n      <Dialog open={!!roleEdit} onOpenChange={(open) => !open && setRoleEdit(null)}>\r\n        <DialogContent>\r\n          <DialogHeader>\r\n            <DialogTitle>Editar rol</DialogTitle>\r\n          </DialogHeader>\r\n          {roleEdit && (\r\n            <form onSubmit={handleSaveRole} className=\"space-y-4\">\r\n              <p className=\"text-sm text-slate-500 dark:text-slate-400\">Código: {roleEdit.code}</p>\r\n              <div className=\"space-y-2\">\r\n                <Label htmlFor=\"roleName\">Nombre</Label>\r\n                <Input\r\n                  id=\"roleName\"\r\n                  name=\"roleName\"\r\n                  defaultValue={roleEdit.name}\r\n                  required\r\n                />\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <Label htmlFor=\"roleDescription\">Descripción</Label>\r\n                <Input\r\n                  id=\"roleDescription\"\r\n                  name=\"roleDescription\"\r\n                  defaultValue={roleEdit.description ?? \"\"}\r\n                />\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <Label className=\"text-slate-700 dark:text-slate-300\">Permisos</Label>\r\n                <div className=\"rounded-md border border-slate-200 bg-slate-50/50 p-3 space-y-4 max-h-64 overflow-y-auto dark:border-slate-600 dark:bg-slate-800/50\">\r\n                  {PERMISSION_GROUPS.map((group) => (\r\n                    <div key={group.label}>\r\n                      <p className=\"text-xs font-semibold uppercase text-slate-500 dark:text-slate-400 mb-2\">\r\n                        {group.label}\r\n                      </p>\r\n                      <div className=\"space-y-2 pl-1\">\r\n                        {group.permissions.map((p) => (\r\n                          <div key={p.code} className=\"flex items-center gap-2\">\r\n                            <input\r\n                              type=\"checkbox\"\r\n                              id={`rolePerm_${p.code}`}\r\n                              name={`rolePerm_${p.code}`}\r\n                              defaultChecked={rolePerms.includes(p.code)}\r\n                              className=\"h-4 w-4 rounded border-slate-300\"\r\n                            />\r\n                            <Label htmlFor={`rolePerm_${p.code}`} className=\"font-normal cursor-pointer text-sm\">\r\n                              {p.label}\r\n                            </Label>\r\n                          </div>\r\n                        ))}\r\n                      </div>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              </div>\r\n              <div className=\"flex items-center gap-2\">\r\n                <input\r\n                  type=\"checkbox\"\r\n                  id=\"roleActive\"\r\n                  name=\"roleActive\"\r\n                  defaultChecked={roleEdit.isActive}\r\n                  className=\"h-4 w-4 rounded border-slate-300\"\r\n                />\r\n                <Label htmlFor=\"roleActive\">Activo</Label>\r\n              </div>\r\n              <div className=\"flex justify-end gap-2 pt-2\">\r\n                <Button type=\"button\" variant=\"outline\" onClick={() => setRoleEdit(null)}>\r\n                  Cancelar\r\n                </Button>\r\n                <Button type=\"submit\" disabled={saving}>\r\n                  {saving ? \"Guardando...\" : \"Guardar\"}\r\n                </Button>\r\n              </div>\r\n            </form>\r\n          )}\r\n        </DialogContent>\r\n      </Dialog>\r\n\r\n      {/* Diálogo nuevo usuario */}\r\n      <Dialog open={userCreate} onOpenChange={(open) => !open && setUserCreate(false)}>\r\n        <DialogContent>\r\n          <DialogHeader>\r\n            <DialogTitle>Nuevo usuario</DialogTitle>\r\n          </DialogHeader>\r\n          <form onSubmit={handleCreateUser} className=\"space-y-4\">\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"newEmail\">Email</Label>\r\n              <Input\r\n                id=\"newEmail\"\r\n                name=\"newEmail\"\r\n                type=\"email\"\r\n                placeholder=\"usuario@laboratorio.com\"\r\n                required\r\n              />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"newPassword\">Contraseña</Label>\r\n              <Input\r\n                id=\"newPassword\"\r\n                name=\"newPassword\"\r\n                type=\"password\"\r\n                placeholder=\"Mínimo 6 caracteres\"\r\n                minLength={6}\r\n                required\r\n              />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"newName\">Nombre (opcional)</Label>\r\n              <Input\r\n                id=\"newName\"\r\n                name=\"newName\"\r\n                placeholder=\"Ej: María García\"\r\n              />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"newRoleId\">Rol</Label>\r\n              <select\r\n                id=\"newRoleId\"\r\n                name=\"newRoleId\"\r\n                className=\"flex h-9 w-full rounded-md border border-slate-200 bg-white px-3 py-1 text-sm dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100\"\r\n              >\r\n                <option value=\"\">Sin rol</option>\r\n                {roles.map((r) => (\r\n                  <option key={r.id} value={r.id}>\r\n                    {r.name} ({r.code})\r\n                  </option>\r\n                ))}\r\n              </select>\r\n            </div>\r\n            <div className=\"flex justify-end gap-2 pt-2\">\r\n              <Button type=\"button\" variant=\"outline\" onClick={() => setUserCreate(false)}>\r\n                Cancelar\r\n              </Button>\r\n              <Button type=\"submit\" disabled={saving}>\r\n                {saving ? \"Creando...\" : \"Crear usuario\"}\r\n              </Button>\r\n            </div>\r\n          </form>\r\n        </DialogContent>\r\n      </Dialog>\r\n\r\n      {/* Diálogo editar usuario */}\r\n      <Dialog open={!!userEdit} onOpenChange={(open) => !open && setUserEdit(null)}>\r\n        <DialogContent>\r\n          <DialogHeader>\r\n            <DialogTitle>Editar usuario</DialogTitle>\r\n          </DialogHeader>\r\n          {userEdit && (\r\n            <form onSubmit={handleSaveUser} className=\"space-y-4\">\r\n              <p className=\"text-sm text-slate-500 dark:text-slate-400\">{userEdit.email}</p>\r\n              <div className=\"space-y-2\">\r\n                <Label htmlFor=\"userRoleId\">Rol</Label>\r\n                <select\r\n                  id=\"userRoleId\"\r\n                  name=\"userRoleId\"\r\n                  defaultValue={userEdit.roleId ?? \"\"}\r\n                  className=\"flex h-9 w-full rounded-md border border-slate-200 bg-white px-3 py-1 text-sm dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100\"\r\n                >\r\n                  <option value=\"\">Sin rol</option>\r\n                  {roles.map((r) => (\r\n                    <option key={r.id} value={r.id}>\r\n                      {r.name} ({r.code})\r\n                    </option>\r\n                  ))}\r\n                </select>\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <Label htmlFor=\"userPassword\">Nueva contraseña (opcional)</Label>\r\n                <Input\r\n                  id=\"userPassword\"\r\n                  name=\"userPassword\"\r\n                  type=\"password\"\r\n                  placeholder=\"Dejar vacío para no cambiar\"\r\n                  minLength={6}\r\n                  className=\"dark:bg-slate-800\"\r\n                />\r\n                <p className=\"text-xs text-slate-500 dark:text-slate-400\">Mínimo 6 caracteres</p>\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <Label htmlFor=\"userPasswordConfirm\">Confirmar nueva contraseña</Label>\r\n                <Input\r\n                  id=\"userPasswordConfirm\"\r\n                  name=\"userPasswordConfirm\"\r\n                  type=\"password\"\r\n                  placeholder=\"Repetir contraseña\"\r\n                  minLength={6}\r\n                  className=\"dark:bg-slate-800\"\r\n                />\r\n              </div>\r\n              <div className=\"flex items-center gap-2\">\r\n                <input\r\n                  type=\"checkbox\"\r\n                  id=\"userActive\"\r\n                  name=\"userActive\"\r\n                  defaultChecked={userEdit.isActive}\r\n                  className=\"h-4 w-4 rounded border-slate-300\"\r\n                />\r\n                <Label htmlFor=\"userActive\">Activo</Label>\r\n              </div>\r\n              <div className=\"flex justify-end gap-2 pt-2\">\r\n                <Button type=\"button\" variant=\"outline\" onClick={() => setUserEdit(null)}>\r\n                  Cancelar\r\n                </Button>\r\n                <Button type=\"submit\" disabled={saving}>\r\n                  {saving ? \"Guardando...\" : \"Guardar\"}\r\n                </Button>\r\n              </div>\r\n            </form>\r\n          )}\r\n        </DialogContent>\r\n      </Dialog>\r\n\r\n      {/* Diálogo nueva sede */}\r\n      <Dialog open={branchCreate} onOpenChange={(open) => !open && setBranchCreate(false)}>\r\n        <DialogContent>\r\n          <DialogHeader>\r\n            <DialogTitle>Nueva sede</DialogTitle>\r\n          </DialogHeader>\r\n          <form onSubmit={handleCreateBranch} className=\"space-y-4\">\r\n            <div className=\"grid gap-4 sm:grid-cols-2\">\r\n              <div className=\"space-y-2\">\r\n                <Label htmlFor=\"newBranchCode\">Código</Label>\r\n                <Input\r\n                  id=\"newBranchCode\"\r\n                  name=\"newBranchCode\"\r\n                  placeholder=\"Ej: SEDE_CENTRAL\"\r\n                  required\r\n                  pattern=\"[A-Z0-9_]+\"\r\n                  title=\"Solo letras mayúsculas, números y guiones bajos\"\r\n                />\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <Label htmlFor=\"newBranchName\">Nombre</Label>\r\n                <Input\r\n                  id=\"newBranchName\"\r\n                  name=\"newBranchName\"\r\n                  placeholder=\"Ej: Sede Central\"\r\n                  required\r\n                />\r\n              </div>\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"newBranchAddress\">Dirección (opcional)</Label>\r\n              <Input\r\n                id=\"newBranchAddress\"\r\n                name=\"newBranchAddress\"\r\n                placeholder=\"Ej: Av. Principal 123\"\r\n              />\r\n            </div>\r\n            <div className=\"grid gap-4 sm:grid-cols-2\">\r\n              <div className=\"space-y-2\">\r\n                <Label htmlFor=\"newBranchPhone\">Teléfono (opcional)</Label>\r\n                <Input\r\n                  id=\"newBranchPhone\"\r\n                  name=\"newBranchPhone\"\r\n                  placeholder=\"Ej: +51 999 999 999\"\r\n                />\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <Label htmlFor=\"newBranchOrder\">Orden</Label>\r\n                <Input\r\n                  id=\"newBranchOrder\"\r\n                  name=\"newBranchOrder\"\r\n                  type=\"number\"\r\n                  defaultValue=\"0\"\r\n                  min=\"0\"\r\n                />\r\n                <p className=\"text-xs text-slate-500 dark:text-slate-400\">Menor número = aparece primero</p>\r\n              </div>\r\n            </div>\r\n            <div className=\"flex items-center gap-2\">\r\n              <input\r\n                type=\"checkbox\"\r\n                id=\"newBranchActive\"\r\n                name=\"newBranchActive\"\r\n                defaultChecked={true}\r\n                className=\"h-4 w-4 rounded border-slate-300\"\r\n              />\r\n              <Label htmlFor=\"newBranchActive\">Activa</Label>\r\n            </div>\r\n            <div className=\"flex justify-end gap-2 pt-2\">\r\n              <Button type=\"button\" variant=\"outline\" onClick={() => setBranchCreate(false)}>\r\n                Cancelar\r\n              </Button>\r\n              <Button type=\"submit\" disabled={saving}>\r\n                {saving ? \"Creando...\" : \"Crear sede\"}\r\n              </Button>\r\n            </div>\r\n          </form>\r\n        </DialogContent>\r\n      </Dialog>\r\n\r\n      {/* Diálogo editar sede */}\r\n      <Dialog open={!!branchEdit} onOpenChange={(open) => !open && setBranchEdit(null)}>\r\n        <DialogContent>\r\n          <DialogHeader>\r\n            <DialogTitle>Editar sede</DialogTitle>\r\n          </DialogHeader>\r\n          {branchEdit && (\r\n            <form onSubmit={handleSaveBranch} className=\"space-y-4\">\r\n              <div className=\"grid gap-4 sm:grid-cols-2\">\r\n                <div className=\"space-y-2\">\r\n                  <Label htmlFor=\"branchCode\">Código</Label>\r\n                  <Input\r\n                    id=\"branchCode\"\r\n                    name=\"branchCode\"\r\n                    defaultValue={branchEdit.code}\r\n                    required\r\n                    pattern=\"[A-Z0-9_]+\"\r\n                    title=\"Solo letras mayúsculas, números y guiones bajos\"\r\n                  />\r\n                </div>\r\n                <div className=\"space-y-2\">\r\n                  <Label htmlFor=\"branchName\">Nombre</Label>\r\n                  <Input\r\n                    id=\"branchName\"\r\n                    name=\"branchName\"\r\n                    defaultValue={branchEdit.name}\r\n                    required\r\n                  />\r\n                </div>\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <Label htmlFor=\"branchAddress\">Dirección (opcional)</Label>\r\n                <Input\r\n                  id=\"branchAddress\"\r\n                  name=\"branchAddress\"\r\n                  defaultValue={branchEdit.address ?? \"\"}\r\n                />\r\n              </div>\r\n              <div className=\"grid gap-4 sm:grid-cols-2\">\r\n                <div className=\"space-y-2\">\r\n                  <Label htmlFor=\"branchPhone\">Teléfono (opcional)</Label>\r\n                  <Input\r\n                    id=\"branchPhone\"\r\n                    name=\"branchPhone\"\r\n                    defaultValue={branchEdit.phone ?? \"\"}\r\n                  />\r\n                </div>\r\n                <div className=\"space-y-2\">\r\n                  <Label htmlFor=\"branchOrder\">Orden</Label>\r\n                  <Input\r\n                    id=\"branchOrder\"\r\n                    name=\"branchOrder\"\r\n                    type=\"number\"\r\n                    defaultValue={branchEdit.order}\r\n                    min=\"0\"\r\n                  />\r\n                  <p className=\"text-xs text-slate-500 dark:text-slate-400\">Menor número = aparece primero</p>\r\n                </div>\r\n              </div>\r\n              <div className=\"flex items-center gap-2\">\r\n                <input\r\n                  type=\"checkbox\"\r\n                  id=\"branchActive\"\r\n                  name=\"branchActive\"\r\n                  defaultChecked={branchEdit.isActive}\r\n                  className=\"h-4 w-4 rounded border-slate-300\"\r\n                />\r\n                <Label htmlFor=\"branchActive\">Activa</Label>\r\n              </div>\r\n              <div className=\"flex justify-end gap-2 pt-2\">\r\n                <Button type=\"button\" variant=\"outline\" onClick={() => setBranchEdit(null)}>\r\n                  Cancelar\r\n                </Button>\r\n                <Button type=\"submit\" disabled={saving}>\r\n                  {saving ? \"Guardando...\" : \"Guardar\"}\r\n                </Button>\r\n              </div>\r\n            </form>\r\n          )}\r\n        </DialogContent>\r\n      </Dialog>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\(app)\\configuracion\\preanaliticos\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\(app)\\configuracion\\referred-labs\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\(app)\\configuracion\\referred-labs\\page.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":202,"column":27,"nodeType":"JSXOpeningElement","endLine":206,"endColumn":29},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":233,"column":27,"nodeType":"JSXOpeningElement","endLine":237,"endColumn":29}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { toast } from \"sonner\";\r\nimport { Plus, Pencil, Trash2 } from \"lucide-react\";\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from \"@/components/ui/dialog\";\r\n\r\ntype ReferredLab = {\r\n  id: string;\r\n  name: string;\r\n  logoUrl: string | null;\r\n  stampImageUrl: string | null;\r\n  isActive: boolean;\r\n  _count?: { labTests: number };\r\n};\r\n\r\nexport default function ReferredLabsPage() {\r\n  const [labs, setLabs] = useState<ReferredLab[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [editingLab, setEditingLab] = useState<ReferredLab | null>(null);\r\n  const [creating, setCreating] = useState(false);\r\n  const [saving, setSaving] = useState(false);\r\n  const [uploading, setUploading] = useState<{ id: string; type: string } | null>(null);\r\n  const [formData, setFormData] = useState({ name: \"\", isActive: true });\r\n\r\n  const loadLabs = async () => {\r\n    try {\r\n      const res = await fetch(\"/api/referred-labs\");\r\n      if (res.ok) {\r\n        const data = await res.json();\r\n        setLabs(data.items ?? []);\r\n      }\r\n    } catch {\r\n      toast.error(\"Error al cargar laboratorios referidos\");\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    loadLabs();\r\n  }, []);\r\n\r\n  const handleOpenEdit = (lab: ReferredLab) => {\r\n    setEditingLab(lab);\r\n    setFormData({ name: lab.name, isActive: lab.isActive });\r\n  };\r\n\r\n  const handleOpenCreate = () => {\r\n    setCreating(true);\r\n    setFormData({ name: \"\", isActive: true });\r\n  };\r\n\r\n  const handleSaveEdit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    if (!editingLab) return;\r\n    setSaving(true);\r\n    try {\r\n      const res = await fetch(`/api/referred-labs/${editingLab.id}`, {\r\n        method: \"PUT\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify(formData),\r\n      });\r\n      const data = await res.json().catch(() => ({}));\r\n      if (!res.ok) throw new Error(data.error || \"Error al guardar\");\r\n      toast.success(\"Laboratorio actualizado\");\r\n      setEditingLab(null);\r\n      await loadLabs();\r\n    } catch (err) {\r\n      toast.error(err instanceof Error ? err.message : \"No se pudo actualizar\");\r\n    } finally {\r\n      setSaving(false);\r\n    }\r\n  };\r\n\r\n  const handleSaveCreate = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    if (!formData.name.trim()) {\r\n      toast.error(\"El nombre es requerido\");\r\n      return;\r\n    }\r\n    setSaving(true);\r\n    try {\r\n      const res = await fetch(\"/api/referred-labs\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify(formData),\r\n      });\r\n      const data = await res.json().catch(() => ({}));\r\n      if (!res.ok) throw new Error(data.error || \"Error al crear\");\r\n      toast.success(\"Laboratorio referido creado\");\r\n      setCreating(false);\r\n      setFormData({ name: \"\", isActive: true });\r\n      await loadLabs();\r\n    } catch (err) {\r\n      toast.error(err instanceof Error ? err.message : \"No se pudo crear\");\r\n    } finally {\r\n      setSaving(false);\r\n    }\r\n  };\r\n\r\n  const handleDelete = async (lab: ReferredLab) => {\r\n    if (!confirm(`¿Eliminar el laboratorio referido \"${lab.name}\"? No debe tener análisis asignados.`)) return;\r\n    try {\r\n      const res = await fetch(`/api/referred-labs/${lab.id}`, { method: \"DELETE\" });\r\n      const data = await res.json().catch(() => ({}));\r\n      if (!res.ok) throw new Error(data.error || \"Error al eliminar\");\r\n      toast.success(\"Laboratorio eliminado\");\r\n      await loadLabs();\r\n    } catch (err) {\r\n      toast.error(err instanceof Error ? err.message : \"No se pudo eliminar\");\r\n    }\r\n  };\r\n\r\n  const handleUpload = async (labId: string, type: \"logo\" | \"stamp\", file: File) => {\r\n    setUploading({ id: labId, type });\r\n    try {\r\n      const formData = new FormData();\r\n      formData.append(\"file\", file);\r\n      formData.append(\"type\", type);\r\n      const res = await fetch(`/api/referred-labs/${labId}/upload`, {\r\n        method: \"POST\",\r\n        body: formData,\r\n      });\r\n      const data = await res.json().catch(() => ({}));\r\n      if (!res.ok) throw new Error(data.error || \"Error al subir\");\r\n      toast.success(data.message || \"Imagen subida\");\r\n      await loadLabs();\r\n    } catch (err) {\r\n      toast.error(err instanceof Error ? err.message : \"No se pudo subir\");\r\n    } finally {\r\n      setUploading(null);\r\n    }\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"flex justify-center py-12 text-slate-500 dark:text-slate-400\">\r\n        Cargando laboratorios referidos...\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\r\n        <div>\r\n          <h1 className=\"text-2xl font-semibold text-slate-900 dark:text-slate-100\">\r\n            Laboratorios referidos\r\n          </h1>\r\n          <p className=\"text-slate-500 dark:text-slate-400 mt-1\">\r\n            Instituciones a las que derivamos análisis. Configura logo y sello para mostrar en los PDFs.\r\n          </p>\r\n        </div>\r\n        <Button onClick={handleOpenCreate} className=\"gap-2 shrink-0\">\r\n          <Plus className=\"h-4 w-4\" />\r\n          Nuevo laboratorio\r\n        </Button>\r\n      </div>\r\n\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle>Laboratorios ({labs.length})</CardTitle>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"-mx-1 overflow-x-auto\">\r\n            <Table className=\"min-w-[500px]\">\r\n              <TableHeader>\r\n                <TableRow>\r\n                  <TableHead>Nombre</TableHead>\r\n                  <TableHead>Logo</TableHead>\r\n                  <TableHead>Sello</TableHead>\r\n                  <TableHead>Estado</TableHead>\r\n                  <TableHead className=\"text-right\">Análisis</TableHead>\r\n                  <TableHead className=\"w-32 text-right\">Acciones</TableHead>\r\n                </TableRow>\r\n              </TableHeader>\r\n              <TableBody>\r\n                {labs.length === 0 ? (\r\n                  <TableRow>\r\n                    <TableCell colSpan={6} className=\"py-8 text-center text-slate-500\">\r\n                      No hay laboratorios referidos. Crea el primero.\r\n                    </TableCell>\r\n                  </TableRow>\r\n                ) : (\r\n                  labs.map((lab) => (\r\n                    <TableRow key={lab.id}>\r\n                      <TableCell className=\"font-medium\">{lab.name}</TableCell>\r\n                      <TableCell>\r\n                        {lab.logoUrl ? (\r\n                          <img\r\n                            src={lab.logoUrl}\r\n                            alt={`Logo ${lab.name}`}\r\n                            className=\"h-10 w-auto max-w-20 object-contain\"\r\n                          />\r\n                        ) : (\r\n                          <span className=\"text-slate-400 text-sm\">—</span>\r\n                        )}\r\n                        <input\r\n                          type=\"file\"\r\n                          accept=\"image/png,image/jpeg,image/webp\"\r\n                          className=\"hidden\"\r\n                          id={`logo-${lab.id}`}\r\n                          onChange={(e) => {\r\n                            const f = e.target.files?.[0];\r\n                            if (f) handleUpload(lab.id, \"logo\", f);\r\n                            e.target.value = \"\";\r\n                          }}\r\n                        />\r\n                        <Label htmlFor={`logo-${lab.id}`} className=\"cursor-pointer ml-2\">\r\n                          <span className=\"text-xs text-teal-600 hover:underline\">\r\n                            {uploading?.id === lab.id && uploading?.type === \"logo\"\r\n                              ? \"Subiendo…\"\r\n                              : lab.logoUrl\r\n                                ? \"Cambiar\"\r\n                                : \"Subir\"}\r\n                          </span>\r\n                        </Label>\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        {lab.stampImageUrl ? (\r\n                          <img\r\n                            src={lab.stampImageUrl}\r\n                            alt={`Sello ${lab.name}`}\r\n                            className=\"h-10 w-auto max-w-20 object-contain\"\r\n                          />\r\n                        ) : (\r\n                          <span className=\"text-slate-400 text-sm\">—</span>\r\n                        )}\r\n                        <input\r\n                          type=\"file\"\r\n                          accept=\"image/png,image/jpeg,image/webp\"\r\n                          className=\"hidden\"\r\n                          id={`stamp-${lab.id}`}\r\n                          onChange={(e) => {\r\n                            const f = e.target.files?.[0];\r\n                            if (f) handleUpload(lab.id, \"stamp\", f);\r\n                            e.target.value = \"\";\r\n                          }}\r\n                        />\r\n                        <Label htmlFor={`stamp-${lab.id}`} className=\"cursor-pointer ml-2\">\r\n                          <span className=\"text-xs text-teal-600 hover:underline\">\r\n                            {uploading?.id === lab.id && uploading?.type === \"stamp\"\r\n                              ? \"Subiendo…\"\r\n                              : lab.stampImageUrl\r\n                                ? \"Cambiar\"\r\n                                : \"Subir\"}\r\n                          </span>\r\n                        </Label>\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <Badge variant={lab.isActive ? \"success\" : \"secondary\"}>\r\n                          {lab.isActive ? \"Activo\" : \"Inactivo\"}\r\n                        </Badge>\r\n                      </TableCell>\r\n                      <TableCell className=\"text-right\">{lab._count?.labTests ?? 0}</TableCell>\r\n                      <TableCell className=\"text-right\">\r\n                        <div className=\"flex justify-end gap-1\">\r\n                          <Button\r\n                            variant=\"ghost\"\r\n                            size=\"icon\"\r\n                            onClick={() => handleOpenEdit(lab)}\r\n                            title=\"Editar\"\r\n                          >\r\n                            <Pencil className=\"h-4 w-4\" />\r\n                          </Button>\r\n                          <Button\r\n                            variant=\"ghost\"\r\n                            size=\"icon\"\r\n                            onClick={() => handleDelete(lab)}\r\n                            title=\"Eliminar\"\r\n                            disabled={(lab._count?.labTests ?? 0) > 0}\r\n                            className=\"text-red-600 hover:text-red-700 hover:bg-red-50\"\r\n                          >\r\n                            <Trash2 className=\"h-4 w-4\" />\r\n                          </Button>\r\n                        </div>\r\n                      </TableCell>\r\n                    </TableRow>\r\n                  ))\r\n                )}\r\n              </TableBody>\r\n            </Table>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      <Dialog open={!!editingLab} onOpenChange={(o) => !o && setEditingLab(null)}>\r\n        <DialogContent>\r\n          <DialogHeader>\r\n            <DialogTitle>Editar laboratorio referido</DialogTitle>\r\n          </DialogHeader>\r\n          {editingLab && (\r\n            <form onSubmit={handleSaveEdit} className=\"space-y-4\">\r\n              <div className=\"space-y-2\">\r\n                <Label htmlFor=\"editName\">Nombre</Label>\r\n                <Input\r\n                  id=\"editName\"\r\n                  value={formData.name}\r\n                  onChange={(e) => setFormData((p) => ({ ...p, name: e.target.value }))}\r\n                  placeholder=\"Laboratorio X\"\r\n                />\r\n              </div>\r\n              <div className=\"flex items-center gap-2\">\r\n                <input\r\n                  type=\"checkbox\"\r\n                  id=\"editActive\"\r\n                  checked={formData.isActive}\r\n                  onChange={(e) => setFormData((p) => ({ ...p, isActive: e.target.checked }))}\r\n                  className=\"h-4 w-4 rounded\"\r\n                />\r\n                <Label htmlFor=\"editActive\">Activo</Label>\r\n              </div>\r\n              <div className=\"flex justify-end gap-2 pt-2\">\r\n                <Button type=\"button\" variant=\"outline\" onClick={() => setEditingLab(null)}>\r\n                  Cancelar\r\n                </Button>\r\n                <Button type=\"submit\" disabled={saving}>\r\n                  {saving ? \"Guardando...\" : \"Guardar\"}\r\n                </Button>\r\n              </div>\r\n            </form>\r\n          )}\r\n        </DialogContent>\r\n      </Dialog>\r\n\r\n      <Dialog open={creating} onOpenChange={(o) => !o && setCreating(false)}>\r\n        <DialogContent>\r\n          <DialogHeader>\r\n            <DialogTitle>Nuevo laboratorio referido</DialogTitle>\r\n          </DialogHeader>\r\n          <form onSubmit={handleSaveCreate} className=\"space-y-4\">\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"newName\">Nombre</Label>\r\n              <Input\r\n                id=\"newName\"\r\n                value={formData.name}\r\n                onChange={(e) => setFormData((p) => ({ ...p, name: e.target.value }))}\r\n                placeholder=\"Laboratorio referido\"\r\n              />\r\n            </div>\r\n            <div className=\"flex items-center gap-2\">\r\n              <input\r\n                type=\"checkbox\"\r\n                id=\"newActive\"\r\n                checked={formData.isActive}\r\n                onChange={(e) => setFormData((p) => ({ ...p, isActive: e.target.checked }))}\r\n                className=\"h-4 w-4 rounded\"\r\n              />\r\n              <Label htmlFor=\"newActive\">Activo</Label>\r\n            </div>\r\n            <div className=\"flex justify-end gap-2 pt-2\">\r\n              <Button type=\"button\" variant=\"outline\" onClick={() => setCreating(false)}>\r\n                Cancelar\r\n              </Button>\r\n              <Button type=\"submit\" disabled={saving}>\r\n                {saving ? \"Creando...\" : \"Crear\"}\r\n              </Button>\r\n            </div>\r\n          </form>\r\n        </DialogContent>\r\n      </Dialog>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\(app)\\configuracion\\secciones\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\(app)\\dashboard\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\(app)\\delivered\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\(app)\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\(app)\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\(app)\\orders\\[id]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\(app)\\orders\\[id]\\payment-ticket\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\(app)\\orders\\[id]\\print\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'items' is defined but never used.","line":104,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":104,"endColumn":8},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'order' is defined but never used.","line":105,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":105,"endColumn":8}],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":91,"column":9,"nodeType":"JSXOpeningElement","endLine":95,"endColumn":11,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":126,"column":15,"nodeType":"JSXOpeningElement","endLine":130,"endColumn":17,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":140,"column":15,"nodeType":"JSXOpeningElement","endLine":144,"endColumn":17,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { notFound } from \"next/navigation\";\r\n\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport { formatDate } from \"@/lib/format\";\r\nimport { formatWithThousands } from \"@/lib/formatNumber\";\r\nimport { getPrintConfig } from \"@/lib/print-config\";\r\nimport { PrintActions } from \"@/components/orders/PrintActions\";\r\nimport { PrintFitToPage } from \"@/components/orders/PrintFitToPage\";\r\n\r\ntype Props = {\r\n  params: Promise<{ id: string }>;\r\n  searchParams: Promise<{ items?: string; referredLabId?: string }>;\r\n};\r\n\r\nfunction calculateAge(birthDate: Date): number {\r\n  const today = new Date();\r\n  let age = today.getFullYear() - birthDate.getFullYear();\r\n  const monthDiff = today.getMonth() - birthDate.getMonth();\r\n  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {\r\n    age--;\r\n  }\r\n  return age;\r\n}\r\n\r\n// Forma mínima del order que usan PatientDataBlock y FooterBlock (sin datos de cobro)\r\ntype OrderForPrint = {\r\n  patient: { lastName: string; firstName: string; dni: string; birthDate: Date; sex: string | null };\r\n  requestedBy: string | null;\r\n  preAnalyticNote?: string | null;\r\n  createdAt: Date;\r\n  orderCode: string;\r\n  deliveredAt: Date | null;\r\n  items: Array<{\r\n    id: string;\r\n    result: { reportedBy?: string | null } | null;\r\n  }>;\r\n};\r\n\r\ntype RefRangeItem = { ageGroup?: string | null; sex?: string | null; refRangeText?: string | null; refMin?: number | null; refMax?: number | null };\r\n\r\nfunction PatientDataBlock({\r\n  order,\r\n  age,\r\n  sexLabel,\r\n}: {\r\n  order: OrderForPrint;\r\n  age: number;\r\n  sexLabel: string;\r\n}) {\r\n  return (\r\n    <div className=\"grid grid-cols-2 gap-x-8 gap-y-1 text-sm mb-6\">\r\n      <div className=\"flex gap-2\">\r\n        <span className=\"text-slate-500 font-medium shrink-0\">PACIENTE:</span>\r\n        <span className=\"font-semibold text-slate-900 uppercase\">\r\n          {order.patient.lastName} {order.patient.firstName}\r\n        </span>\r\n      </div>\r\n      <div className=\"flex gap-2\">\r\n        <span className=\"text-slate-500 font-medium shrink-0\">EDAD:</span>\r\n        <span>{age} Años</span>\r\n      </div>\r\n      <div className=\"flex gap-2\">\r\n        <span className=\"text-slate-500 font-medium shrink-0\">DNI:</span>\r\n        <span>{order.patient.dni}</span>\r\n      </div>\r\n      <div className=\"flex gap-2\">\r\n        <span className=\"text-slate-500 font-medium shrink-0\">INDICACIÓN:</span>\r\n        <span>{order.requestedBy || \"Médico tratante\"}</span>\r\n      </div>\r\n      <div className=\"flex gap-2\">\r\n        <span className=\"text-slate-500 font-medium shrink-0\">SEXO:</span>\r\n        <span>{sexLabel}</span>\r\n      </div>\r\n      <div className=\"flex gap-2\">\r\n        <span className=\"text-slate-500 font-medium shrink-0\">FECHA:</span>\r\n        <span>{formatDate(order.createdAt)}</span>\r\n      </div>\r\n      <div className=\"flex gap-2\">\r\n        <span className=\"text-slate-500 font-medium shrink-0\">N° REGISTRO:</span>\r\n        <span className=\"font-mono\">{order.orderCode}</span>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction ReferredHeaderBlock({ referredLab }: { referredLab: { name: string; logoUrl: string | null } }) {\r\n  return (\r\n    <div className=\"flex items-center justify-center gap-2 flex-1 -mt-[50px]\t ml-[65px]\">\r\n      {referredLab.logoUrl ? (\r\n        /* eslint-disable-next-line @next/next/no-img-element */\r\n        <img\r\n          src={referredLab.logoUrl}\r\n          alt={referredLab.name}\r\n          className=\"h-16 w-auto object-contain max-w-[220px]\"\r\n        />\r\n      ) : (\r\n        <span className=\"text-sm font-semibold text-slate-700\">{referredLab.name}</span>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction FooterBlock({\r\n  items,\r\n  order,\r\n  showStamp,\r\n  stampImageUrl,\r\n  referredLabStampUrl,\r\n}: {\r\n  items: OrderForPrint[\"items\"];\r\n  order: OrderForPrint;\r\n  showStamp: boolean;\r\n  stampImageUrl: string | null;\r\n  referredLabStampUrl?: string | null;\r\n}) {\r\n  return (\r\n    <div className=\"mt-10 pt-6 border-t-2 border-slate-300 flex flex-wrap items-end justify-between gap-6\">\r\n      <div className=\"text-xs text-slate-500\">\r\n        \r\n      </div>\r\n      <div className=\"flex flex-row items-end justify-end gap-8\">\r\n        {referredLabStampUrl && (\r\n          <div className=\"text-center flex flex-col items-center gap-2\">\r\n            <div className=\"w-40 min-h-[3rem] flex flex-col items-center justify-end border-b-2 border-slate-400 pb-0.5\">\r\n              {/* eslint-disable-next-line @next/next/no-img-element */}\r\n              <img\r\n                src={referredLabStampUrl}\r\n                alt=\"Sello laboratorio referido\"\r\n                className=\"max-h-14 max-w-full w-auto object-contain opacity-90\"\r\n              />\r\n            </div>\r\n            <p className=\"text-xs font-semibold text-slate-700\">Firma</p>\r\n            <p className=\"text-xs text-slate-500\">Responsable laboratorio referido</p>\r\n          </div>\r\n        )}\r\n        <div className=\"text-center flex flex-col items-center gap-2\">\r\n          <div className=\"w-56 min-h-[3rem] flex flex-col items-center justify-end border-b-2 border-slate-400 pb-0.5\">\r\n            {showStamp && stampImageUrl && (\r\n              /* eslint-disable-next-line @next/next/no-img-element */\r\n              <img\r\n                src={stampImageUrl}\r\n                alt=\"\"\r\n                className=\"print-stamp max-h-14 max-w-full w-auto object-contain opacity-90\"\r\n              />\r\n            )}\r\n          </div>\r\n          <p className=\"text-xs font-semibold text-slate-700\">\r\n            T.M / Responsable técnico\r\n          </p>\r\n          <p className=\"text-xs text-slate-500\">CTMP</p>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default async function OrderPrintPage({ params, searchParams }: Props) {\r\n  const { id } = await params;\r\n  const { items: itemsParam, referredLabId } = await searchParams;\r\n  const selectedItemIds = itemsParam\r\n    ? new Set(itemsParam.split(\",\").map((s) => s.trim()).filter(Boolean))\r\n    : null;\r\n\r\n  const order = await prisma.labOrder.findFirst({\r\n    where: { id },\r\n    include: {\r\n      patient: true,\r\n      items: {\r\n        include: {\r\n          labTest: {\r\n            include: {\r\n              section: true,\r\n              referredLab: true,\r\n              template: { \r\n                include: { \r\n                  items: {\r\n                    include: {\r\n                      refRanges: {\r\n                        orderBy: { order: \"asc\" }\r\n                      }\r\n                    }\r\n                  }\r\n                } \r\n              } \r\n            } \r\n          },\r\n          result: { include: { items: { orderBy: { order: \"asc\" } } } },\r\n        },\r\n        orderBy: { createdAt: \"asc\" },\r\n      },\r\n    },\r\n  });\r\n\r\n  if (!order) {\r\n    notFound();\r\n  }\r\n\r\n  // Filtrar items si se especificaron IDs seleccionados\r\n  const itemsToPrint =\r\n    selectedItemIds && selectedItemIds.size > 0\r\n      ? order.items.filter((item) => selectedItemIds.has(item.id))\r\n      : order.items;\r\n\r\n  // Laboratorios referidos presentes en los análisis seleccionados\r\n  const referredLabsMap = new Map<\r\n    string,\r\n    { id: string; name: string; logoUrl: string | null; stampImageUrl: string | null }\r\n  >();\r\n  for (const item of itemsToPrint) {\r\n    if (item.labTest.isReferred && item.labTest.referredLab) {\r\n      const lab = item.labTest.referredLab;\r\n      referredLabsMap.set(lab.id, {\r\n        id: lab.id,\r\n        name: lab.name,\r\n        logoUrl: lab.logoUrl ?? null,\r\n        stampImageUrl: lab.stampImageUrl ?? null,\r\n      });\r\n    }\r\n  }\r\n  const referredLabs = Array.from(referredLabsMap.values());\r\n  const requestedReferredLabId = referredLabId?.trim() || \"\";\r\n  const selectedReferredLab =\r\n    (requestedReferredLabId\r\n      ? referredLabs.find((lab) => lab.id === requestedReferredLabId)\r\n      : referredLabs[0]) ?? null;\r\n\r\n  // Agrupar items por sección\r\n  const itemsBySection = itemsToPrint.reduce(\r\n    (acc, item) => {\r\n      const sectionKey = item.labTest.section?.name ?? item.labTest.section?.code ?? \"OTROS\";\r\n      if (!acc[sectionKey]) {\r\n        acc[sectionKey] = [];\r\n      }\r\n      acc[sectionKey].push(item);\r\n      return acc;\r\n    },\r\n    {} as Record<string, typeof itemsToPrint>,\r\n  );\r\n\r\n  const age = calculateAge(order.patient.birthDate);\r\n  const sexLabel = order.patient.sex === \"M\" ? \"Masculino\" : order.patient.sex === \"F\" ? \"Femenino\" : \"Otro\";\r\n  const sectionsEntries = Object.entries(itemsBySection);\r\n  const printConfig = await getPrintConfig();\r\n  const showStamp = printConfig.stampEnabled && printConfig.stampImageUrl;\r\n\r\n  // Si no hay secciones (sin items o items vacíos), mostramos una hoja con mensaje\r\n  const hasSections = sectionsEntries.length > 0;\r\n\r\n  const patientName = `${order.patient.firstName} ${order.patient.lastName}`.trim();\r\n  const analysesNames = itemsToPrint.map((i) => i.labTest.name).join(\", \");\r\n  const analysisCodes = itemsToPrint.map((i) => i.labTest.code).join(\"-\");\r\n  const dateStr = formatDate(order.createdAt);\r\n\r\n  return (\r\n    <>\r\n      <PrintActions\r\n        patientName={patientName}\r\n        patientPhone={order.patient.phone}\r\n        analysesNames={analysesNames}\r\n        analysisCodes={analysisCodes || order.orderCode}\r\n        date={dateStr}\r\n      />\r\n      {referredLabs.length > 1 && (\r\n        <div className=\"mx-auto mb-3 flex w-[210mm] justify-end px-4 text-xs text-slate-600 print:hidden\">\r\n          <form method=\"GET\" className=\"flex items-center gap-2\">\r\n            {itemsParam && <input type=\"hidden\" name=\"items\" value={itemsParam} />}\r\n            <label htmlFor=\"referredLabId\" className=\"text-xs\">\r\n              Lab. referido:\r\n            </label>\r\n            <select\r\n              id=\"referredLabId\"\r\n              name=\"referredLabId\"\r\n              defaultValue={selectedReferredLab?.id ?? \"\"}\r\n              className=\"h-7 rounded-md border border-slate-300 bg-white px-2 text-xs dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100\"\r\n            >\r\n              {referredLabs.map((lab) => (\r\n                <option key={lab.id} value={lab.id}>\r\n                  {lab.name}\r\n                </option>\r\n              ))}\r\n            </select>\r\n            <button\r\n              type=\"submit\"\r\n              className=\"inline-flex h-7 items-center rounded-md bg-slate-900 px-2 text-[11px] font-medium text-white hover:bg-slate-800 dark:bg-teal-600 dark:hover:bg-teal-700\"\r\n            >\r\n              Aplicar\r\n            </button>\r\n          </form>\r\n        </div>\r\n      )}\r\n      <PrintFitToPage />\r\n      {hasSections ? sectionsEntries.map(([section, items], index) => (\r\n        <div\r\n          key={section}\r\n          className={`print-a4 relative mx-auto bg-white text-slate-900 print:mx-0 print:shadow-none overflow-hidden ${index < sectionsEntries.length - 1 ? \"print-page\" : \"\"} ${index > 0 ? \"mt-8 print:mt-0\" : \"\"}`}\r\n          style={{ width: \"210mm\", height: \"297mm\" }}\r\n        >\r\n          {/* Fondo de agua: toda la hoja en pantalla e impresión */}\r\n          <div\r\n            className=\"print-watermark absolute inset-0 pointer-events-none z-0\"\r\n            style={{\r\n              backgroundImage: \"url(/watermark-clinica.png)\",\r\n              backgroundSize: \"cover\",\r\n              backgroundPosition: \"center\",\r\n              backgroundRepeat: \"no-repeat\",\r\n            }}\r\n            aria-hidden\r\n          />\r\n          {/* Wrapper escalable: permite reducir el contenido para que quepa en una hoja */}\r\n          <div className=\"print-a4-scaler absolute top-0 left-0 w-full z-10\" style={{ width: \"210mm\" }}>\r\n            <div\r\n              className=\"print-a4-content relative px-12\"\r\n              style={{ paddingTop: \"29.7mm\", paddingBottom: \"29.7mm\" }}\r\n            >\r\n              {/* Encabezado: logo del laboratorio referido (si aplica) centrado */}\r\n              <header className=\"flex items-center justify-between gap-4 mb-6 pb-4 border-b border-slate-300 min-h-[3.5rem]\">\r\n                <div className=\"min-w-0 flex-1\" aria-hidden />\r\n                {selectedReferredLab ? (\r\n                  <ReferredHeaderBlock referredLab={selectedReferredLab} />\r\n                ) : (\r\n                  <div className=\"min-w-0 flex-1\" aria-hidden />\r\n                )}\r\n                <div className=\"min-w-0 flex-1\" aria-hidden />\r\n              </header>\r\n\r\n              <PatientDataBlock\r\n                order={order}\r\n                age={age}\r\n                sexLabel={sexLabel}\r\n              />\r\n\r\n              {/* Barra de sección: fondo semi-transparente, texto en negrita más grande */}\r\n              <div\r\n                className=\"text-white py-2.5 px-4 mb-3 print-section-bar\"\r\n                style={{ backgroundColor: \"rgba(15, 23, 42, 0.7)\" }}\r\n              >\r\n                <h2 className=\"text-center text-base font-bold uppercase tracking-wide\">\r\n                  SECCIÓN {section}\r\n                </h2>\r\n              </div>\r\n\r\n              <p className=\"text-xs text-slate-600 mb-2 font-medium\">ANÁLISIS:</p>\r\n\r\n              {items.map((item) => {\r\n                const hasResults = item.result && (item.result.items?.length ?? 0) > 0;\r\n                return (\r\n                  <div key={item.id} className=\"mb-6 break-inside-avoid\">\r\n                    <p className=\"text-sm font-semibold text-slate-900 mb-2\">\r\n                      {item.labTest.name}\r\n                    </p>\r\n\r\n                    {hasResults ? (\r\n                      <>\r\n                        <table className=\"w-full text-xs border border-slate-300\">\r\n                          <thead>\r\n                            <tr className=\"bg-slate-100 border-b border-slate-300\">\r\n                              <th className=\"text-left py-2 px-3 font-semibold text-slate-900\">\r\n                                ANÁLISIS\r\n                              </th>\r\n                              <th className=\"text-left py-2 px-3 font-semibold text-slate-900\">\r\n                                RESULTADOS\r\n                              </th>\r\n                              <th className=\"text-left py-2 px-3 font-semibold text-slate-900\">\r\n                                UNIDAD\r\n                              </th>\r\n                              <th className=\"text-left py-2 px-3 font-semibold text-slate-900 w-[180px]\">\r\n                                VALOR REFERENCIAL\r\n                              </th>\r\n                            </tr>\r\n                          </thead>\r\n                          <tbody>\r\n                            {item.result!.items.map((res) => {\r\n                              // Buscar el templateItem original para obtener refRanges y valueType\r\n                              const templateItem = res.templateItemId \r\n                                ? item.labTest.template?.items.find((t) => t.id === res.templateItemId)\r\n                                : null;\r\n                              let refRanges: RefRangeItem[] = (templateItem && \"refRanges\" in templateItem ? (templateItem.refRanges as RefRangeItem[]) : []) ?? [];\r\n                              // Fallback: si no hay refRanges en la plantilla actual, usar templateSnapshot (p. ej. órdenes antiguas o plantilla modificada)\r\n                              if (refRanges.length === 0 && item.templateSnapshot && typeof item.templateSnapshot === \"object\" && \"items\" in item.templateSnapshot) {\r\n                                const snapshot = item.templateSnapshot as { items: Array<{ id: string; refRanges?: RefRangeItem[] }> };\r\n                                const snapshotItem = snapshot.items.find((t) => t.id === res.templateItemId);\r\n                                refRanges = (snapshotItem?.refRanges ?? []) as RefRangeItem[];\r\n                              }\r\n                              const valueType = (templateItem as { valueType?: string } | null)?.valueType;\r\n                              const isNumeric = [\"NUMBER\", \"DECIMAL\", \"PERCENTAGE\"].includes(valueType ?? \"\");\r\n                              const displayValue = isNumeric && res.value\r\n                                ? formatWithThousands(res.value) + (valueType === \"PERCENTAGE\" ? \" %\" : \"\")\r\n                                : res.value;\r\n                              \r\n                              return (\r\n                                <tr key={res.id} className=\"border-b border-slate-200 last:border-b-0\">\r\n                                  <td className=\"py-2 px-3 font-medium text-slate-900 align-top\">\r\n                                    {res.paramNameSnapshot}\r\n                                  </td>\r\n                                  <td\r\n                                    className={`py-2 px-3 font-semibold text-slate-900 align-top ${\r\n                                      res.isOutOfRange ? \"font-bold underline\" : \"\"\r\n                                    }`}\r\n                                  >\r\n                                    {displayValue}\r\n                                  </td>\r\n                                  <td className=\"py-2 px-3 text-slate-700 align-top\">\r\n                                    {res.unitSnapshot || \"-\"}\r\n                                  </td>\r\n                                  <td className=\"py-2 px-3 text-slate-700 w-[180px] align-top\">\r\n                                    <div className=\"space-y-1\">\r\n                                      {res.refTextSnapshot && (\r\n                                        <div className=\"font-medium\">\r\n                                          {res.refTextSnapshot}\r\n                                        </div>\r\n                                      )}\r\n                                      {refRanges.length > 0 && (\r\n                                        <div className=\"space-y-0.5 text-[10px]\">\r\n                                          {refRanges.map((range: RefRangeItem, rangeIdx: number) => {\r\n                                            const ageGroupLabels: Record<string, string> = {\r\n                                              NIÑOS: \"Niños\",\r\n                                              JOVENES: \"Jóvenes\",\r\n                                              ADULTOS: \"Adultos\",\r\n                                            };\r\n                                            const sexLabels: Record<string, string> = {\r\n                                              M: \"Hombres\",\r\n                                              F: \"Mujeres\",\r\n                                              O: \"Otros\",\r\n                                            };\r\n                                            const criteria = [\r\n                                              range.ageGroup ? ageGroupLabels[range.ageGroup] || range.ageGroup : null,\r\n                                              range.sex ? sexLabels[range.sex] || range.sex : null,\r\n                                            ].filter(Boolean);\r\n                                            \r\n                                            const rangeDisplay = range.refRangeText \r\n                                              || (range.refMin !== null && range.refMax !== null \r\n                                                ? `${range.refMin} - ${range.refMax}` \r\n                                                : \"\");\r\n                                            \r\n                                            return (\r\n                                              <div key={rangeIdx} className=\"leading-tight\">\r\n                                                {criteria.length > 0 ? (\r\n                                                  <span>\r\n                                                    <span className=\"font-semibold text-slate-800\">\r\n                                                      {criteria.join(\" + \")}:\r\n                                                    </span>\r\n                                                    <span className=\"text-slate-600 ml-1\">{rangeDisplay}</span>\r\n                                                  </span>\r\n                                                ) : (\r\n                                                  <span className=\"text-slate-600\">{rangeDisplay}</span>\r\n                                                )}\r\n                                              </div>\r\n                                            );\r\n                                          })}\r\n                                        </div>\r\n                                      )}\r\n                                      {!res.refTextSnapshot && refRanges.length === 0 ? (\r\n                                        <span className=\"font-medium\">-</span>\r\n                                      ) : null}\r\n                                    </div>\r\n                                  </td>\r\n                                </tr>\r\n                              );\r\n                            })}\r\n                          </tbody>\r\n                        </table>\r\n                        {item.result?.comment && (\r\n                          <p className=\"mt-2 text-xs text-slate-600 italic\">\r\n                            {item.result.comment}\r\n                          </p>\r\n                        )}\r\n                      </>\r\n                    ) : (\r\n                      <div className=\"border border-slate-300 py-4 text-center text-sm text-slate-500\">\r\n                        Sin resultados registrados.\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                );\r\n              })}\r\n\r\n              {order.preAnalyticNote && (\r\n                <div className=\"mt-3 rounded border border-slate-300 bg-slate-50 px-3 py-2 text-xs text-slate-700\">\r\n                  <p className=\"font-semibold uppercase tracking-wide text-slate-800\">\r\n                    Observaciones preanalíticas\r\n                  </p>\r\n                  <p className=\"mt-1 whitespace-pre-wrap\">{order.preAnalyticNote}</p>\r\n                </div>\r\n              )}\r\n\r\n              <FooterBlock\r\n                items={items}\r\n                order={order}\r\n                showStamp={!!(showStamp && printConfig.stampImageUrl)}\r\n                stampImageUrl={printConfig.stampImageUrl}\r\n                referredLabStampUrl={selectedReferredLab?.stampImageUrl ?? null}\r\n              />\r\n\r\n              <div className=\"mt-6 pt-3 text-center text-xs min-h-[1.5rem]\" aria-hidden />\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )) : (\r\n        <div\r\n          className=\"print-a4 relative mx-auto bg-white text-slate-900 print:mx-0 print:shadow-none overflow-hidden\"\r\n          style={{ width: \"210mm\", height: \"297mm\" }}\r\n        >\r\n          <div\r\n            className=\"print-watermark absolute inset-0 pointer-events-none z-0\"\r\n            style={{\r\n              backgroundImage: \"url(/watermark-clinica.png)\",\r\n              backgroundSize: \"cover\",\r\n              backgroundPosition: \"center\",\r\n              backgroundRepeat: \"no-repeat\",\r\n            }}\r\n            aria-hidden\r\n          />\r\n          <div className=\"print-a4-scaler absolute top-0 left-0 w-full z-10\" style={{ width: \"210mm\" }}>\r\n            <div\r\n              className=\"print-a4-content relative px-12\"\r\n              style={{ paddingTop: \"29.7mm\", paddingBottom: \"29.7mm\" }}\r\n            >\r\n              <header className=\"flex items-start justify-between gap-4 mb-6 pb-4 border-b border-slate-300 min-h-[3.5rem]\" />\r\n              <PatientDataBlock\r\n                order={order}\r\n                age={age}\r\n                sexLabel={sexLabel}\r\n              />\r\n              <p className=\"text-center text-slate-500 py-12\">No hay análisis seleccionados para imprimir.</p>\r\n              <FooterBlock items={[]} order={order} showStamp={!!(showStamp && printConfig.stampImageUrl)} stampImageUrl={printConfig.stampImageUrl} />\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\(app)\\orders\\new\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\(app)\\orders\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Badge' is defined but never used.","line":11,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":15,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Badge"},"fix":{"range":[588,634],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import Link from \"next/link\";\r\nimport { getServerSession } from \"next-auth\";\r\n\r\nimport { redirect } from \"next/navigation\";\r\nimport { authOptions, hasPermission, PERMISSION_ELIMINAR_REGISTROS, PERMISSION_REGISTRAR_PAGOS, PERMISSION_VER_ORDENES } from \"@/lib/auth\";\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport { getPaidTotalsByOrderIds } from \"@/lib/payments\";\r\nimport { formatCurrency, formatDate } from \"@/lib/format\";\r\nimport { Card, CardContent } from \"@/components/ui/card\";\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { DeleteButton } from \"@/components/common/DeleteButton\";\r\nimport { RegistrarpagoButton } from \"@/components/pagos/RegistrarpagoButton\";\r\nimport { Search, CalendarDays, Filter, X, Plus, Printer, Activity, CreditCard, FileText, ArrowUpDown, ArrowUp, ArrowDown } from \"lucide-react\";\r\n\r\n/** Parsea \"YYYY-MM-DD\" en hora local y devuelve inicio (00:00:00) o fin (23:59:59.999) del día */\r\nfunction parseLocalDate(dateStr: string, endOfDay: boolean): Date {\r\n  const [y, m, d] = dateStr.split(\"-\").map(Number);\r\n  if (y == null || m == null || d == null || Number.isNaN(y) || Number.isNaN(m) || Number.isNaN(d)) {\r\n    return new Date(dateStr);\r\n  }\r\n  const date = new Date(y, m - 1, d);\r\n  if (endOfDay) {\r\n    date.setHours(23, 59, 59, 999);\r\n  } else {\r\n    date.setHours(0, 0, 0, 0);\r\n  }\r\n  return date;\r\n}\r\n\r\nexport default async function OrdersPage({\r\n  searchParams,\r\n}: {\r\n  searchParams: Promise<{\r\n    search?: string;\r\n    status?: string;\r\n    paymentStatus?: string;\r\n    from?: string;\r\n    to?: string;\r\n    sortBy?: string;\r\n    sortDir?: string;\r\n    focusSearch?: string;\r\n  }>;\r\n}) {\r\n  const params = await searchParams;\r\n  const search = params.search?.trim();\r\n  const status = params.status?.trim();\r\n  const paymentStatus = params.paymentStatus?.trim();\r\n  const from = params.from?.trim();\r\n  const to = params.to?.trim();\r\n  const sortBy = params.sortBy?.trim() || \"createdAt\";\r\n  const sortDir = params.sortDir === \"asc\" ? \"asc\" : \"desc\";\r\n  const focusSearch = params.focusSearch === \"1\";\r\n  const session = await getServerSession(authOptions);\r\n  if (!session?.user || !hasPermission(session, PERMISSION_VER_ORDENES)) {\r\n    redirect(\"/dashboard\");\r\n  }\r\n  const canDeleteOrders = hasPermission(session, PERMISSION_ELIMINAR_REGISTROS);\r\n  const canRegisterPayment = hasPermission(session, PERMISSION_REGISTRAR_PAGOS);\r\n\r\n  const dateFrom = from ? parseLocalDate(from, false) : null;\r\n  const dateTo = to ? parseLocalDate(to, true) : null;\r\n\r\n  const orderByField =\r\n    sortBy === \"orderCode\"\r\n      ? { orderCode: sortDir }\r\n      : sortBy === \"patient\"\r\n        ? { patient: { lastName: sortDir } }\r\n        : { createdAt: sortDir };\r\n\r\n  const orders = await prisma.labOrder.findMany({\r\n    where: {\r\n      ...(status ? { status: status as never } : {}),\r\n      ...(dateFrom ?? dateTo\r\n        ? {\r\n            createdAt: {\r\n              ...(dateFrom ? { gte: dateFrom } : {}),\r\n              ...(dateTo ? { lte: dateTo } : {}),\r\n            },\r\n          }\r\n        : {}),\r\n      ...(search\r\n        ? {\r\n            OR: [\r\n              { orderCode: { contains: search, mode: \"insensitive\" as const } },\r\n              {\r\n                patient: {\r\n                  OR: [\r\n                    { firstName: { contains: search, mode: \"insensitive\" as const } },\r\n                    { lastName: { contains: search, mode: \"insensitive\" as const } },\r\n                    { dni: { contains: search, mode: \"insensitive\" as const } },\r\n                  ],\r\n                },\r\n              },\r\n            ],\r\n          }\r\n        : {}),\r\n    },\r\n    include: {\r\n      patient: true,\r\n      items: { include: { labTest: { select: { code: true, name: true } } } },\r\n    },\r\n    orderBy: orderByField,\r\n  });\r\n\r\n  const orderIds = orders.map((o) => o.id);\r\n  const paidByOrder = await getPaidTotalsByOrderIds(prisma, orderIds);\r\n\r\n  const ordersWithPayment = orders.map((order) => {\r\n    const paid = paidByOrder.get(order.id) ?? 0;\r\n    const total = Number(order.totalPrice);\r\n    const status =\r\n      paid <= 0 ? \"PENDIENTE\" : paid + 0.0001 < total ? \"PARCIAL\" : \"PAGADO\";\r\n    return {\r\n      ...order,\r\n      paidTotal: paid,\r\n      balance: Math.max(0, total - paid),\r\n      paymentStatus: status as \"PENDIENTE\" | \"PARCIAL\" | \"PAGADO\",\r\n    };\r\n  });\r\n\r\n  const visibleOrders = paymentStatus\r\n    ? ordersWithPayment.filter((o) => o.paymentStatus === paymentStatus)\r\n    : ordersWithPayment;\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      {/* Header */}\r\n      <div className=\"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between\">\r\n        <div>\r\n          <h1 className=\"text-2xl font-bold text-slate-900 dark:text-slate-100\">Órdenes de laboratorio</h1>\r\n          <p className=\"text-sm text-slate-500 dark:text-slate-400\">Gestión de órdenes y análisis</p>\r\n        </div>\r\n        <div className=\"flex items-center gap-2\">\r\n          {canRegisterPayment && <RegistrarpagoButton />}\r\n          <Link\r\n            className=\"inline-flex h-9 items-center gap-1.5 rounded-lg bg-slate-900 px-4 text-sm font-medium text-white transition-colors hover:bg-slate-800 dark:bg-teal-600 dark:hover:bg-teal-700\"\r\n            href=\"/orders/new\"\r\n          >\r\n            <Plus className=\"h-4 w-4\" />\r\n            Nueva orden\r\n          </Link>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Filtros (mismo estilo que Pagos) */}\r\n      <Card className=\"border-slate-200 dark:border-slate-700\">\r\n        <CardContent className=\"pt-4\">\r\n          <form className=\"space-y-4\" method=\"GET\">\r\n            <div className=\"grid gap-3 sm:grid-cols-2 lg:grid-cols-4\">\r\n              {/* Búsqueda */}\r\n              <div className=\"space-y-1.5\">\r\n                <label htmlFor=\"search-orders\" className=\"flex items-center gap-1.5 text-xs font-medium text-slate-600 dark:text-slate-400\">\r\n                  <Search className=\"h-3.5 w-3.5\" />\r\n                  Buscar\r\n                </label>\r\n                <input\r\n                  id=\"search-orders\"\r\n                  name=\"search\"\r\n                  defaultValue={search}\r\n                  autoFocus={focusSearch}\r\n                  placeholder=\"Paciente, DNI u orden...\"\r\n                  className=\"h-9 w-full rounded-lg border border-slate-200 bg-white px-3 text-sm transition-colors focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-400/20 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100 dark:placeholder:text-slate-400 dark:focus:border-slate-500\"\r\n                />\r\n              </div>\r\n\r\n              {/* Fecha desde */}\r\n              <div className=\"space-y-1.5\">\r\n                <label htmlFor=\"from-orders\" className=\"flex items-center gap-1.5 text-xs font-medium text-slate-600 dark:text-slate-400\">\r\n                  <CalendarDays className=\"h-3.5 w-3.5\" />\r\n                  Desde\r\n                </label>\r\n                <input\r\n                  id=\"from-orders\"\r\n                  type=\"date\"\r\n                  name=\"from\"\r\n                  defaultValue={from}\r\n                  className=\"h-9 w-full rounded-lg border border-slate-200 bg-white px-3 text-sm transition-colors focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-400/20 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100 dark:focus:border-slate-500\"\r\n                />\r\n              </div>\r\n\r\n              {/* Fecha hasta */}\r\n              <div className=\"space-y-1.5\">\r\n                <label htmlFor=\"to-orders\" className=\"flex items-center gap-1.5 text-xs font-medium text-slate-600 dark:text-slate-400\">\r\n                  <CalendarDays className=\"h-3.5 w-3.5\" />\r\n                  Hasta\r\n                </label>\r\n                <input\r\n                  id=\"to-orders\"\r\n                  type=\"date\"\r\n                  name=\"to\"\r\n                  defaultValue={to}\r\n                  className=\"h-9 w-full rounded-lg border border-slate-200 bg-white px-3 text-sm transition-colors focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-400/20 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100 dark:focus:border-slate-500\"\r\n                />\r\n              </div>\r\n\r\n              {/* Botones */}\r\n              <div className=\"flex items-end gap-2\">\r\n                <button\r\n                  type=\"submit\"\r\n                  className=\"flex h-9 items-center gap-1.5 rounded-lg bg-slate-900 px-4 text-sm font-medium text-white transition-colors hover:bg-slate-800 dark:bg-teal-600 dark:hover:bg-teal-700\"\r\n                >\r\n                  <Filter className=\"h-4 w-4\" />\r\n                  Filtrar\r\n                </button>\r\n                {(search || status || paymentStatus || from || to || sortBy !== \"createdAt\" || sortDir !== \"desc\") && (\r\n                  <Link\r\n                    href=\"/orders\"\r\n                    className=\"flex h-9 items-center gap-1.5 rounded-lg border border-slate-200 px-3 text-sm font-medium text-slate-700 transition-colors hover:bg-slate-100 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-700\"\r\n                  >\r\n                    <X className=\"h-4 w-4\" />\r\n                    Limpiar\r\n                  </Link>\r\n                )}\r\n              </div>\r\n            </div>\r\n            {/* Fila extra: Estado, Cobro, Ordenar */}\r\n            <div className=\"grid gap-3 sm:grid-cols-2 lg:grid-cols-5\">\r\n              <div className=\"space-y-1.5\">\r\n                <label htmlFor=\"status-orders\" className=\"flex items-center gap-1.5 text-xs font-medium text-slate-600 dark:text-slate-400\">\r\n                  <Activity className=\"h-3.5 w-3.5\" />\r\n                  Estado\r\n                </label>\r\n                <select\r\n                  id=\"status-orders\"\r\n                  name=\"status\"\r\n                  defaultValue={status || \"\"}\r\n                  className=\"h-9 w-full rounded-lg border border-slate-200 bg-white px-3 text-sm transition-colors focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-400/20 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100 dark:focus:border-slate-500\"\r\n                >\r\n                  <option value=\"\">Todos los estados</option>\r\n                  <option value=\"PENDIENTE\">Pendiente</option>\r\n                  <option value=\"EN_PROCESO\">En proceso</option>\r\n                  <option value=\"COMPLETADO\">Completado</option>\r\n                  <option value=\"ENTREGADO\">Entregado</option>\r\n                  <option value=\"ANULADO\">Anulado</option>\r\n                </select>\r\n              </div>\r\n              <div className=\"space-y-1.5\">\r\n                <label htmlFor=\"payment-orders\" className=\"flex items-center gap-1.5 text-xs font-medium text-slate-600 dark:text-slate-400\">\r\n                  <CreditCard className=\"h-3.5 w-3.5\" />\r\n                  Cobro\r\n                </label>\r\n                <select\r\n                  id=\"payment-orders\"\r\n                  name=\"paymentStatus\"\r\n                  defaultValue={paymentStatus || \"\"}\r\n                  className=\"h-9 w-full rounded-lg border border-slate-200 bg-white px-3 text-sm transition-colors focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-400/20 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100 dark:focus:border-slate-500\"\r\n                >\r\n                  <option value=\"\">Todos</option>\r\n                  <option value=\"PENDIENTE\">Por cobrar</option>\r\n                  <option value=\"PARCIAL\">Parcial</option>\r\n                  <option value=\"PAGADO\">Cobrado</option>\r\n                </select>\r\n              </div>\r\n              <div className=\"space-y-1.5\">\r\n                <label htmlFor=\"sortBy-orders\" className=\"flex items-center gap-1.5 text-xs font-medium text-slate-600 dark:text-slate-400\">\r\n                  <ArrowUpDown className=\"h-3.5 w-3.5\" />\r\n                  Ordenar por\r\n                </label>\r\n                <select\r\n                  id=\"sortBy-orders\"\r\n                  name=\"sortBy\"\r\n                  defaultValue={sortBy}\r\n                  className=\"h-9 w-full rounded-lg border border-slate-200 bg-white px-3 text-sm transition-colors focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-400/20 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100 dark:focus:border-slate-500\"\r\n                >\r\n                  <option value=\"createdAt\">Fecha</option>\r\n                  <option value=\"orderCode\">Código orden</option>\r\n                  <option value=\"patient\">Paciente</option>\r\n                </select>\r\n              </div>\r\n              <div className=\"space-y-1.5\">\r\n                <label htmlFor=\"sortDir-orders\" className=\"flex items-center gap-1.5 text-xs font-medium text-slate-600 dark:text-slate-400\">\r\n                  {sortDir === \"asc\" ? <ArrowUp className=\"h-3.5 w-3.5\" /> : <ArrowDown className=\"h-3.5 w-3.5\" />}\r\n                  Orden\r\n                </label>\r\n                <select\r\n                  id=\"sortDir-orders\"\r\n                  name=\"sortDir\"\r\n                  defaultValue={sortDir}\r\n                  className=\"h-9 w-full rounded-lg border border-slate-200 bg-white px-3 text-sm transition-colors focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-400/20 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100 dark:focus:border-slate-500\"\r\n                >\r\n                  <option value=\"asc\">Ascendente</option>\r\n                  <option value=\"desc\">Descendente</option>\r\n                </select>\r\n              </div>\r\n            </div>\r\n          </form>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Tabla (mismo estilo que Pagos) */}\r\n      <Card>\r\n        <CardContent className=\"pt-4\">\r\n          <div className=\"mt-4 overflow-x-auto rounded-lg border border-slate-200 dark:border-slate-700\">\r\n            <Table>\r\n              <TableHeader>\r\n                <TableRow className=\"bg-slate-50 dark:bg-slate-800/50\">\r\n                  <TableHead className=\"w-12 font-semibold text-center\">#</TableHead>\r\n                  <TableHead className=\"font-semibold\">Orden</TableHead>\r\n                  <TableHead className=\"font-semibold\">Paciente</TableHead>\r\n                  <TableHead className=\"font-semibold\">Fecha</TableHead>\r\n                  <TableHead className=\"font-semibold\">Estado</TableHead>\r\n                  <TableHead className=\"font-semibold\">Cobro</TableHead>\r\n                  <TableHead className=\"font-semibold\">Análisis</TableHead>\r\n                  <TableHead className=\"font-semibold text-right\">Total</TableHead>\r\n                  <TableHead className=\"font-semibold text-right\">Cobrado</TableHead>\r\n                  <TableHead className=\"font-semibold text-right\">Saldo</TableHead>\r\n                  <TableHead className=\"text-right font-semibold\">Acciones</TableHead>\r\n                </TableRow>\r\n              </TableHeader>\r\n              <TableBody>\r\n                {visibleOrders.length === 0 ? (\r\n                  <TableRow>\r\n                    <TableCell colSpan={11} className=\"py-12 text-center\">\r\n                      <FileText className=\"h-12 w-12 text-slate-300 dark:text-slate-600 mx-auto mb-3\" />\r\n                      <p className=\"text-slate-500 dark:text-slate-400\">No se encontraron órdenes</p>\r\n                    </TableCell>\r\n                  </TableRow>\r\n                ) : (\r\n                  visibleOrders.map((order, idx) => {\r\n                    const statusColors: Record<string, string> = {\r\n                      PENDIENTE: \"bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400\",\r\n                      EN_PROCESO: \"bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400\",\r\n                      COMPLETADO: \"bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400\",\r\n                      ENTREGADO: \"bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400\",\r\n                      ANULADO: \"bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400\",\r\n                    };\r\n                    const paymentColors: Record<string, string> = {\r\n                      PENDIENTE: \"bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-300\",\r\n                      PARCIAL: \"bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400\",\r\n                      PAGADO: \"bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400\",\r\n                    };\r\n                    const paymentRowColors: Record<string, string> = {\r\n                      PENDIENTE: \"hover:bg-amber-50/50 dark:hover:bg-amber-950/20\",\r\n                      PARCIAL: \"hover:bg-blue-50/50 dark:hover:bg-blue-950/20\",\r\n                      PAGADO: \"hover:bg-emerald-50/50 dark:hover:bg-emerald-950/20\",\r\n                    };\r\n                    const sinDatosCapturados = order.status === \"PENDIENTE\" || order.status === \"EN_PROCESO\";\r\n                    return (\r\n                      <TableRow\r\n                        key={order.id}\r\n                        className={`${paymentRowColors[order.paymentStatus]} transition-colors ${sinDatosCapturados ? \"bg-amber-50/80 dark:bg-amber-950/40 border-l-4 border-l-amber-400 dark:border-l-amber-500\" : \"\"}`}\r\n                        title={sinDatosCapturados ? \"Orden sin datos capturados aún\" : undefined}\r\n                      >\r\n                        <TableCell className=\"text-center text-slate-500 dark:text-slate-400 font-medium\">\r\n                          {idx + 1}\r\n                        </TableCell>\r\n                        <TableCell>\r\n                          <Link\r\n                            className=\"font-medium text-blue-600 hover:text-blue-800 hover:underline dark:text-blue-400 dark:hover:text-blue-300\"\r\n                            href={`/orders/${order.id}`}\r\n                          >\r\n                            {order.orderCode}\r\n                          </Link>\r\n                        </TableCell>\r\n                        <TableCell className=\"font-medium text-slate-900 dark:text-slate-100\">\r\n                          {order.patient.firstName} {order.patient.lastName}\r\n                        </TableCell>\r\n                        <TableCell className=\"text-slate-600 dark:text-slate-400\">\r\n                          {formatDate(order.createdAt)}\r\n                        </TableCell>\r\n                        <TableCell>\r\n                          <span className={`inline-flex rounded-md px-2 py-0.5 text-xs font-medium ${statusColors[order.status] ?? \"bg-slate-100 text-slate-700\"}`}>\r\n                            {order.status}\r\n                          </span>\r\n                        </TableCell>\r\n                        <TableCell>\r\n                          <span className={`inline-flex rounded-md px-2 py-0.5 text-xs font-medium ${paymentColors[order.paymentStatus]}`}>\r\n                            {order.paymentStatus}\r\n                          </span>\r\n                        </TableCell>\r\n                        <TableCell>\r\n                          <span className=\"block truncate text-sm text-slate-600 dark:text-slate-400 max-w-[180px]\" title={order.items.map((i) => i.labTest?.name ?? i.labTest?.code ?? \"-\").join(\", \")}>\r\n                            {order.items.length === 0\r\n                              ? \"—\"\r\n                              : order.items.map((i) => i.labTest?.name ?? i.labTest?.code ?? \"-\").join(\", \")}\r\n                          </span>\r\n                        </TableCell>\r\n                        <TableCell className=\"text-right font-semibold text-slate-900 dark:text-slate-200\">\r\n                          {formatCurrency(Number(order.totalPrice))}\r\n                        </TableCell>\r\n                        <TableCell className=\"text-right text-emerald-600 dark:text-emerald-400\">\r\n                          {formatCurrency(order.paidTotal)}\r\n                        </TableCell>\r\n                        <TableCell className=\"text-right font-bold text-slate-900 dark:text-slate-200\">\r\n                          {order.balance > 0 ? (\r\n                            <span className=\"text-amber-600 dark:text-amber-400\">{formatCurrency(order.balance)}</span>\r\n                          ) : (\r\n                            <span className=\"text-emerald-600 dark:text-emerald-400\">{formatCurrency(0)}</span>\r\n                          )}\r\n                        </TableCell>\r\n                        <TableCell className=\"text-right\">\r\n                          <div className=\"flex items-center justify-end gap-1\">\r\n                            <Link\r\n                              className=\"inline-flex h-8 w-8 items-center justify-center rounded-md text-slate-600 transition-colors hover:bg-slate-100 hover:text-slate-900 dark:text-slate-400 dark:hover:bg-slate-700 dark:hover:text-slate-100\"\r\n                              href={`/orders/${order.id}/print`}\r\n                              title=\"Imprimir\"\r\n                            >\r\n                              <Printer className=\"h-4 w-4\" />\r\n                            </Link>\r\n                            {canDeleteOrders && (\r\n                              <DeleteButton url={`/api/orders/${order.id}`} label=\"Eliminar\" />\r\n                            )}\r\n                          </div>\r\n                        </TableCell>\r\n                      </TableRow>\r\n                    );\r\n                  })\r\n                )}\r\n              </TableBody>\r\n            </Table>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\(app)\\pagos\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Badge' is defined but never used.","line":12,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":15,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Badge"},"fix":{"range":[671,717],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import Link from \"next/link\";\r\nimport { Suspense } from \"react\";\r\nimport { getServerSession } from \"next-auth\";\r\n\r\nimport { redirect } from \"next/navigation\";\r\nimport { authOptions, hasPermission, PERMISSION_IMPRIMIR_TICKET_PAGO, PERMISSION_REGISTRAR_PAGOS, PERMISSION_VER_PAGOS, PERMISSION_VER_ADMISION } from \"@/lib/auth\";\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport { getPaidTotalsByOrderIds } from \"@/lib/payments\";\r\nimport { formatCurrency, formatDate } from \"@/lib/format\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { RegistrarpagoButton } from \"@/components/pagos/RegistrarpagoButton\";\r\nimport { PagosTabs } from \"@/components/pagos/PagosTabs\";\r\nimport { Search, CalendarDays, Filter, X, Eye, Printer, Receipt, Building2, DollarSign, FileText, CreditCard, UserPlus, FlaskConical, Wallet } from \"lucide-react\";\r\n\r\n/** Parsea \"YYYY-MM-DD\" en hora local y devuelve inicio (00:00:00) o fin (23:59:59.999) del día */\r\nfunction parseLocalDate(dateStr: string, endOfDay: boolean): Date {\r\n  const [y, m, d] = dateStr.split(\"-\").map(Number);\r\n  if (y == null || m == null || d == null || Number.isNaN(y) || Number.isNaN(m) || Number.isNaN(d)) {\r\n    return new Date(dateStr);\r\n  }\r\n  const date = new Date(y, m - 1, d);\r\n  if (endOfDay) {\r\n    date.setHours(23, 59, 59, 999);\r\n  } else {\r\n    date.setHours(0, 0, 0, 0);\r\n  }\r\n  return date;\r\n}\r\n\r\ntype TabValue = \"pendientes\" | \"parcial\" | \"cobrados\";\r\n\r\nexport default async function PagosPage({\r\n  searchParams,\r\n}: {\r\n  searchParams: Promise<{\r\n    tab?: string;\r\n    search?: string;\r\n    from?: string;\r\n    to?: string;\r\n    cajaDate?: string;\r\n  }>;\r\n}) {\r\n  const params = await searchParams;\r\n  const validTabs: TabValue[] = [\"pendientes\", \"parcial\", \"cobrados\"];\r\n  const tabParam = params.tab?.toLowerCase();\r\n  const tab = validTabs.includes(tabParam as TabValue) ? (tabParam as TabValue) : \"pendientes\";\r\n  const search = params.search?.trim();\r\n  const from = params.from?.trim();\r\n  const to = params.to?.trim();\r\n   const cajaDateParam = params.cajaDate?.trim();\r\n  const session = await getServerSession(authOptions);\r\n  const canAccessPagos = hasPermission(session, PERMISSION_VER_PAGOS) || hasPermission(session, PERMISSION_REGISTRAR_PAGOS);\r\n  if (!canAccessPagos) redirect(\"/dashboard\");\r\n  const canRegisterPayment = hasPermission(session, PERMISSION_REGISTRAR_PAGOS);\r\n  const canPrintTicket = hasPermission(session, PERMISSION_IMPRIMIR_TICKET_PAGO) || canAccessPagos;\r\n  const canViewAdmision = hasPermission(session, PERMISSION_VER_ADMISION);\r\n\r\n  const dateFrom = from ? parseLocalDate(from, false) : null;\r\n  const dateTo = to ? parseLocalDate(to, true) : null;\r\n\r\n  // Rango para caja (por día). Si no se selecciona fecha, usa hoy.\r\n  let cajaStart: Date;\r\n  let cajaEnd: Date;\r\n  if (cajaDateParam) {\r\n    cajaStart = parseLocalDate(cajaDateParam, false);\r\n    cajaEnd = parseLocalDate(cajaDateParam, true);\r\n  } else {\r\n    cajaStart = new Date();\r\n    cajaStart.setHours(0, 0, 0, 0);\r\n    cajaEnd = new Date();\r\n    cajaEnd.setHours(23, 59, 59, 999);\r\n  }\r\n\r\n  const [cajaIngresos, cajaEgresos, cajaIngresosByMethod] = await Promise.all([\r\n    prisma.payment.aggregate({\r\n      where: { paidAt: { gte: cajaStart, lte: cajaEnd } },\r\n      _sum: { amount: true },\r\n      _count: { id: true },\r\n    }),\r\n    prisma.referredLabPayment.aggregate({\r\n      where: { paidAt: { gte: cajaStart, lte: cajaEnd } },\r\n      _sum: { amount: true },\r\n      _count: { id: true },\r\n    }),\r\n    prisma.payment.groupBy({\r\n      by: [\"method\"],\r\n      where: { paidAt: { gte: cajaStart, lte: cajaEnd } },\r\n      _sum: { amount: true },\r\n    }),\r\n  ]);\r\n\r\n  const cajaIngresosHoy = Number(cajaIngresos._sum.amount ?? 0);\r\n  const cajaEgresosHoy = Number(cajaEgresos._sum.amount ?? 0);\r\n  const cajaTotalHoy = cajaIngresosHoy - cajaEgresosHoy;\r\n  const methodLabels: Record<string, string> = {\r\n    EFECTIVO: \"Efectivo\",\r\n    TARJETA: \"Tarjeta\",\r\n    TRANSFERENCIA: \"Transferencia\",\r\n    CREDITO: \"Crédito\",\r\n  };\r\n\r\n  const orders = await prisma.labOrder.findMany({\r\n    where: {\r\n      status: { not: \"ANULADO\" },\r\n      ...(dateFrom ?? dateTo\r\n        ? {\r\n            createdAt: {\r\n              ...(dateFrom ? { gte: dateFrom } : {}),\r\n              ...(dateTo ? { lte: dateTo } : {}),\r\n            },\r\n          }\r\n        : {}),\r\n      ...(search\r\n        ? {\r\n            OR: [\r\n              { orderCode: { contains: search, mode: \"insensitive\" as const } },\r\n              {\r\n                patient: {\r\n                  OR: [\r\n                    { firstName: { contains: search, mode: \"insensitive\" as const } },\r\n                    { lastName: { contains: search, mode: \"insensitive\" as const } },\r\n                    { dni: { contains: search, mode: \"insensitive\" as const } },\r\n                  ],\r\n                },\r\n              },\r\n            ],\r\n          }\r\n        : {}),\r\n    },\r\n    include: {\r\n      patient: true,\r\n      branch: true,\r\n      items: {\r\n        include: {\r\n          labTest: {\r\n            select: {\r\n              code: true,\r\n              name: true,\r\n              isReferred: true,\r\n              externalLabCost: true,\r\n            },\r\n          },\r\n        },\r\n      },\r\n    },\r\n    orderBy: { createdAt: \"desc\" },\r\n  });\r\n\r\n  const orderIds = orders.map((o) => o.id);\r\n  const [paidByOrder, admissionPendingOrders, referredLabPayments] = await Promise.all([\r\n    getPaidTotalsByOrderIds(prisma, orderIds),\r\n    canViewAdmision\r\n      ? prisma.labOrder.findMany({\r\n          where: {\r\n            admissionRequestId: { not: null },\r\n            admissionSettledAt: null,\r\n            status: { not: \"ANULADO\" },\r\n            ...(dateFrom ?? dateTo\r\n              ? {\r\n                  createdAt: {\r\n                    ...(dateFrom ? { gte: dateFrom } : {}),\r\n                    ...(dateTo ? { lte: dateTo } : {}),\r\n                  },\r\n                }\r\n              : {}),\r\n          },\r\n          select: {\r\n            id: true,\r\n            items: {\r\n              select: {\r\n                priceConventionSnapshot: true,\r\n                priceSnapshot: true,\r\n              },\r\n            },\r\n          },\r\n        })\r\n      : [],\r\n    prisma.referredLabPayment.findMany({\r\n      where: { orderId: { in: orderIds } },\r\n      select: { orderId: true, amount: true },\r\n    }),\r\n  ]);\r\n\r\n  const admissionPendingTotal = admissionPendingOrders.reduce((s, order) => {\r\n    const orderTotal = order.items.reduce(\r\n      (sum, i) => sum + Number(\"priceConventionSnapshot\" in i && i.priceConventionSnapshot != null ? i.priceConventionSnapshot : i.priceSnapshot),\r\n      0,\r\n    );\r\n    return s + orderTotal;\r\n  }, 0);\r\n  const admissionPendingCount = admissionPendingOrders.length;\r\n\r\n  let totalExternalCost = 0;\r\n  const paidToLabs = referredLabPayments.reduce((s, p) => s + Number(p.amount), 0);\r\n  orders.forEach((o) => {\r\n    o.items.forEach((i) => {\r\n      if (i.labTest.isReferred && i.labTest.externalLabCost) totalExternalCost += Number(i.labTest.externalLabCost);\r\n    });\r\n  });\r\n  const referredBalance = Math.max(0, totalExternalCost - paidToLabs);\r\n\r\n  const conventionTotalForOrder = (order: (typeof orders)[0]) => {\r\n    if (!order.admissionRequestId) return null;\r\n    return order.items.reduce(\r\n      (sum, i) =>\r\n        sum +\r\n        Number(\r\n          \"priceConventionSnapshot\" in i && i.priceConventionSnapshot != null\r\n            ? i.priceConventionSnapshot\r\n            : i.priceSnapshot,\r\n        ),\r\n      0,\r\n    );\r\n  };\r\n\r\n  const ordersWithPayment = orders.map((order) => {\r\n    const paid = paidByOrder.get(order.id) ?? 0;\r\n    const conventionTotal = conventionTotalForOrder(order);\r\n    const total = conventionTotal != null ? conventionTotal : Number(order.totalPrice);\r\n    const paymentStatus =\r\n      paid <= 0 ? \"PENDIENTE\" : paid + 0.0001 < total ? \"PARCIAL\" : \"PAGADO\";\r\n    return {\r\n      ...order,\r\n      paidTotal: paid,\r\n      balance: Math.max(0, total - paid),\r\n      paymentStatus: paymentStatus as \"PENDIENTE\" | \"PARCIAL\" | \"PAGADO\",\r\n    };\r\n  });\r\n\r\n  const paymentStatusFilter: Record<TabValue, \"PENDIENTE\" | \"PARCIAL\" | \"PAGADO\"> = {\r\n    pendientes: \"PENDIENTE\",\r\n    parcial: \"PARCIAL\",\r\n    cobrados: \"PAGADO\",\r\n  };\r\n  const visibleOrders = ordersWithPayment.filter(\r\n    (o) => o.paymentStatus === paymentStatusFilter[tab],\r\n  );\r\n\r\n  const counts = {\r\n    pendientes: ordersWithPayment.filter((o) => o.paymentStatus === \"PENDIENTE\").length,\r\n    parcial: ordersWithPayment.filter((o) => o.paymentStatus === \"PARCIAL\").length,\r\n    cobrados: ordersWithPayment.filter((o) => o.paymentStatus === \"PAGADO\").length,\r\n  };\r\n\r\n  const totalPendiente = ordersWithPayment\r\n    .filter((o) => o.paymentStatus === \"PENDIENTE\")\r\n    .reduce((sum, o) => sum + o.balance, 0);\r\n  const totalParcial = ordersWithPayment\r\n    .filter((o) => o.paymentStatus === \"PARCIAL\")\r\n    .reduce((sum, o) => sum + o.balance, 0);\r\n  const totalCobrado = ordersWithPayment\r\n    .filter((o) => o.paymentStatus === \"PAGADO\")\r\n    .reduce((sum, o) => sum + o.paidTotal, 0);\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      {/* Header con título y botón de registrar pago */}\r\n      <div className=\"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between\">\r\n        <div>\r\n          <h1 className=\"text-2xl font-bold text-slate-900 dark:text-slate-100\">Pagos / Cobros</h1>\r\n          <p className=\"text-sm text-slate-500 dark:text-slate-400\">Gestión de cobros y pagos de órdenes</p>\r\n        </div>\r\n        {canRegisterPayment && <RegistrarpagoButton />}\r\n      </div>\r\n\r\n      {/* Caja del día */}\r\n      <Card className=\"border-2 border-slate-300 dark:border-slate-600 bg-gradient-to-br from-slate-50 to-white dark:from-slate-900/50 dark:to-slate-800/50\">\r\n        <CardHeader className=\"pb-2\">\r\n          <div className=\"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between\">\r\n            <div className=\"flex items-center gap-2\">\r\n            <div className=\"flex h-10 w-10 items-center justify-center rounded-xl bg-slate-200 dark:bg-slate-700\">\r\n              <Wallet className=\"h-5 w-5 text-slate-600 dark:text-slate-300\" />\r\n            </div>\r\n            <div>\r\n              <CardTitle className=\"text-lg\">Caja del día</CardTitle>\r\n              <p className=\"text-sm font-normal text-slate-500 dark:text-slate-400\">\r\n                {formatDate(cajaStart)} — Ingresos y egresos del día seleccionado\r\n              </p>\r\n            </div>\r\n            </div>\r\n            <form method=\"GET\" className=\"flex items-center gap-2 text-xs\">\r\n              <label htmlFor=\"cajaDate\" className=\"text-slate-600 dark:text-slate-300\">\r\n                Día de caja:\r\n              </label>\r\n              <input\r\n                id=\"cajaDate\"\r\n                type=\"date\"\r\n                name=\"cajaDate\"\r\n                defaultValue={cajaStart.toISOString().slice(0, 10)}\r\n                className=\"h-8 rounded-md border border-slate-300 bg-white px-2 text-xs dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100\"\r\n              />\r\n              <button\r\n                type=\"submit\"\r\n                className=\"inline-flex h-8 items-center rounded-md bg-slate-900 px-2 text-[11px] font-medium text-white hover:bg-slate-800 dark:bg-teal-600 dark:hover:bg-teal-700\"\r\n              >\r\n                Ver\r\n              </button>\r\n            </form>\r\n          </div>\r\n        </CardHeader>\r\n        <CardContent className=\"space-y-4\">\r\n          <div className=\"grid gap-4 sm:grid-cols-3\">\r\n            <div className=\"rounded-lg border border-emerald-200 bg-emerald-50/80 p-4 dark:border-emerald-800 dark:bg-emerald-900/20\">\r\n              <p className=\"text-xs font-medium text-emerald-700 dark:text-emerald-400\">Ingresos (cobros a pacientes)</p>\r\n              <p className=\"mt-1 text-2xl font-bold text-emerald-700 dark:text-emerald-300\">{formatCurrency(cajaIngresosHoy)}</p>\r\n              <p className=\"mt-0.5 text-xs text-slate-500\">{cajaIngresos._count.id} movimiento(s)</p>\r\n            </div>\r\n            <div className=\"rounded-lg border border-amber-200 bg-amber-50/80 p-4 dark:border-amber-800 dark:bg-amber-900/20\">\r\n              <p className=\"text-xs font-medium text-amber-700 dark:text-amber-400\">Egresos (pagos a lab. referidos)</p>\r\n              <p className=\"mt-1 text-2xl font-bold text-amber-700 dark:text-amber-300\">{formatCurrency(cajaEgresosHoy)}</p>\r\n              <p className=\"mt-0.5 text-xs text-slate-500\">{cajaEgresos._count.id} pago(s)</p>\r\n            </div>\r\n            <div className=\"rounded-lg border-2 border-slate-400 bg-slate-100 p-4 dark:border-slate-500 dark:bg-slate-800/50\">\r\n              <p className=\"text-xs font-medium text-slate-700 dark:text-slate-300\">Total caja hoy</p>\r\n              <p className={`mt-1 text-2xl font-bold ${cajaTotalHoy >= 0 ? \"text-slate-900 dark:text-slate-100\" : \"text-red-600 dark:text-red-400\"}`}>\r\n                {formatCurrency(cajaTotalHoy)}\r\n              </p>\r\n              <p className=\"mt-0.5 text-xs text-slate-500\">Ingresos − Egresos</p>\r\n            </div>\r\n          </div>\r\n          {cajaIngresosByMethod.length > 0 && (\r\n            <div className=\"rounded-lg border border-slate-200 bg-slate-50/50 p-3 dark:border-slate-700 dark:bg-slate-800/30\">\r\n              <p className=\"text-xs font-medium text-slate-600 dark:text-slate-400 mb-2\">Ingresos por método de pago</p>\r\n              <div className=\"flex flex-wrap gap-3\">\r\n                {cajaIngresosByMethod.map((row) => (\r\n                  <span key={row.method} className=\"inline-flex items-center gap-1.5 rounded-md bg-white px-2.5 py-1.5 text-sm font-medium shadow-sm dark:bg-slate-700\">\r\n                    <CreditCard className=\"h-3.5 w-3.5 text-slate-500\" />\r\n                    {methodLabels[row.method] ?? row.method}: {formatCurrency(Number(row._sum.amount ?? 0))}\r\n                  </span>\r\n                ))}\r\n              </div>\r\n            </div>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Cards de resumen */}\r\n      <div className=\"grid gap-3 sm:grid-cols-3 lg:grid-cols-5\">\r\n        <div className=\"rounded-xl border border-amber-200 bg-gradient-to-br from-amber-50 to-amber-100/50 p-4 dark:border-amber-800/50 dark:from-amber-900/20 dark:to-amber-800/10\">\r\n          <div className=\"flex items-center gap-3\">\r\n            <div className=\"flex h-10 w-10 items-center justify-center rounded-lg bg-amber-100 dark:bg-amber-900/50\">\r\n              <CreditCard className=\"h-5 w-5 text-amber-600 dark:text-amber-400\" />\r\n            </div>\r\n            <div>\r\n              <p className=\"text-xs font-medium text-amber-600/70 dark:text-amber-400/70\">Pendientes ({counts.pendientes})</p>\r\n              <p className=\"text-lg font-bold text-amber-700 dark:text-amber-300\">{formatCurrency(totalPendiente)}</p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n        <div className=\"rounded-xl border border-blue-200 bg-gradient-to-br from-blue-50 to-blue-100/50 p-4 dark:border-blue-800/50 dark:from-blue-900/20 dark:to-blue-800/10\">\r\n          <div className=\"flex items-center gap-3\">\r\n            <div className=\"flex h-10 w-10 items-center justify-center rounded-lg bg-blue-100 dark:bg-blue-900/50\">\r\n              <DollarSign className=\"h-5 w-5 text-blue-600 dark:text-blue-400\" />\r\n            </div>\r\n            <div>\r\n              <p className=\"text-xs font-medium text-blue-600/70 dark:text-blue-400/70\">Parcial ({counts.parcial})</p>\r\n              <p className=\"text-lg font-bold text-blue-700 dark:text-blue-300\">{formatCurrency(totalParcial)}</p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n        <div className=\"rounded-xl border border-emerald-200 bg-gradient-to-br from-emerald-50 to-emerald-100/50 p-4 dark:border-emerald-800/50 dark:from-emerald-900/20 dark:to-emerald-800/10\">\r\n          <div className=\"flex items-center gap-3\">\r\n            <div className=\"flex h-10 w-10 items-center justify-center rounded-lg bg-emerald-100 dark:bg-emerald-900/50\">\r\n              <FileText className=\"h-5 w-5 text-emerald-600 dark:text-emerald-400\" />\r\n            </div>\r\n            <div>\r\n              <p className=\"text-xs font-medium text-emerald-600/70 dark:text-emerald-400/70\">Cobrados ({counts.cobrados})</p>\r\n              <p className=\"text-lg font-bold text-emerald-700 dark:text-emerald-300\">{formatCurrency(totalCobrado)}</p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n        {canViewAdmision && admissionPendingCount > 0 && (\r\n          <Link\r\n            href=\"/cobro-admision\"\r\n            className=\"rounded-xl border border-violet-200 bg-gradient-to-br from-violet-50 to-violet-100/50 p-4 transition-colors hover:shadow-md dark:border-violet-800/50 dark:from-violet-900/20 dark:to-violet-800/10\"\r\n          >\r\n            <div className=\"flex items-center gap-3\">\r\n              <div className=\"flex h-10 w-10 items-center justify-center rounded-lg bg-violet-100 dark:bg-violet-900/50\">\r\n                <UserPlus className=\"h-5 w-5 text-violet-600 dark:text-violet-400\" />\r\n              </div>\r\n              <div>\r\n                <p className=\"text-xs font-medium text-violet-600/70 dark:text-violet-400/70\">Cobro admisión ({admissionPendingCount})</p>\r\n                <p className=\"text-lg font-bold text-violet-700 dark:text-violet-300\">{formatCurrency(admissionPendingTotal)}</p>\r\n                <p className=\"text-[10px] text-violet-600/80 dark:text-violet-400/80\">Ver pendientes →</p>\r\n              </div>\r\n            </div>\r\n          </Link>\r\n        )}\r\n        {totalExternalCost > 0 && (\r\n          <div className=\"rounded-xl border border-amber-200/80 bg-gradient-to-br from-amber-50/80 to-amber-100/30 p-4 dark:border-amber-800/50 dark:from-amber-900/10 dark:to-amber-800/5\">\r\n            <div className=\"flex items-center gap-3\">\r\n              <div className=\"flex h-10 w-10 items-center justify-center rounded-lg bg-amber-100 dark:bg-amber-900/50\">\r\n                <FlaskConical className=\"h-5 w-5 text-amber-600 dark:text-amber-400\" />\r\n              </div>\r\n              <div>\r\n                <p className=\"text-xs font-medium text-amber-600/70 dark:text-amber-400/70\">Lab. referidos</p>\r\n                <p className=\"text-sm font-bold text-amber-700 dark:text-amber-300\">{formatCurrency(totalExternalCost)}</p>\r\n                <p className=\"text-[10px] text-slate-500 dark:text-slate-400\">\r\n                  Pagado: {formatCurrency(paidToLabs)} • Pend.: {formatCurrency(referredBalance)}\r\n                </p>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* Filtros mejorados */}\r\n      <Card className=\"border-slate-200 dark:border-slate-700\">\r\n        <CardContent className=\"pt-4\">\r\n          <form className=\"space-y-4\" method=\"GET\">\r\n            <input type=\"hidden\" name=\"tab\" value={tab} />\r\n            <div className=\"grid gap-3 sm:grid-cols-2 lg:grid-cols-4\">\r\n              {/* Búsqueda */}\r\n              <div className=\"space-y-1.5\">\r\n                <label htmlFor=\"search-pagos\" className=\"flex items-center gap-1.5 text-xs font-medium text-slate-600 dark:text-slate-400\">\r\n                  <Search className=\"h-3.5 w-3.5\" />\r\n                  Buscar\r\n                </label>\r\n                <input\r\n                  id=\"search-pagos\"\r\n                  name=\"search\"\r\n                  defaultValue={search}\r\n                  placeholder=\"Paciente, DNI u orden...\"\r\n                  className=\"h-9 w-full rounded-lg border border-slate-200 bg-white px-3 text-sm transition-colors focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-400/20 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100 dark:placeholder:text-slate-400 dark:focus:border-slate-500\"\r\n                />\r\n              </div>\r\n              \r\n              {/* Fecha desde */}\r\n              <div className=\"space-y-1.5\">\r\n                <label htmlFor=\"from-date\" className=\"flex items-center gap-1.5 text-xs font-medium text-slate-600 dark:text-slate-400\">\r\n                  <CalendarDays className=\"h-3.5 w-3.5\" />\r\n                  Desde\r\n                </label>\r\n                <input\r\n                  id=\"from-date\"\r\n                  type=\"date\"\r\n                  name=\"from\"\r\n                  defaultValue={from}\r\n                  className=\"h-9 w-full rounded-lg border border-slate-200 bg-white px-3 text-sm transition-colors focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-400/20 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100 dark:focus:border-slate-500\"\r\n                />\r\n              </div>\r\n              \r\n              {/* Fecha hasta */}\r\n              <div className=\"space-y-1.5\">\r\n                <label htmlFor=\"to-date\" className=\"flex items-center gap-1.5 text-xs font-medium text-slate-600 dark:text-slate-400\">\r\n                  <CalendarDays className=\"h-3.5 w-3.5\" />\r\n                  Hasta\r\n                </label>\r\n                <input\r\n                  id=\"to-date\"\r\n                  type=\"date\"\r\n                  name=\"to\"\r\n                  defaultValue={to}\r\n                  className=\"h-9 w-full rounded-lg border border-slate-200 bg-white px-3 text-sm transition-colors focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-400/20 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100 dark:focus:border-slate-500\"\r\n                />\r\n              </div>\r\n              \r\n              {/* Botones */}\r\n              <div className=\"flex items-end gap-2\">\r\n                <button\r\n                  type=\"submit\"\r\n                  className=\"flex h-9 items-center gap-1.5 rounded-lg bg-slate-900 px-4 text-sm font-medium text-white transition-colors hover:bg-slate-800 dark:bg-teal-600 dark:hover:bg-teal-700\"\r\n                >\r\n                  <Filter className=\"h-4 w-4\" />\r\n                  Filtrar\r\n                </button>\r\n                {(search || from || to) && (\r\n                  <Link\r\n                    href={`/pagos?tab=${tab}`}\r\n                    className=\"flex h-9 items-center gap-1.5 rounded-lg border border-slate-200 px-3 text-sm font-medium text-slate-700 transition-colors hover:bg-slate-100 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-700\"\r\n                  >\r\n                    <X className=\"h-4 w-4\" />\r\n                    Limpiar\r\n                  </Link>\r\n                )}\r\n              </div>\r\n            </div>\r\n          </form>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Tabs y tabla */}\r\n      <Card>\r\n        <CardContent className=\"pt-4\">\r\n          <Suspense fallback={<div className=\"h-10 border-b border-slate-200 dark:border-slate-700\" />}>\r\n            <PagosTabs tab={tab} counts={counts} />\r\n          </Suspense>\r\n          <div className=\"mt-4 overflow-x-auto rounded-lg border border-slate-200 dark:border-slate-700\">\r\n            <Table>\r\n              <TableHeader>\r\n                <TableRow className=\"bg-slate-50 dark:bg-slate-800/50\">\r\n                  <TableHead className=\"font-semibold\">Orden</TableHead>\r\n                  <TableHead className=\"font-semibold\">Paciente</TableHead>\r\n                  <TableHead className=\"font-semibold\">Sede</TableHead>\r\n                  <TableHead className=\"font-semibold\">Fecha</TableHead>\r\n                  <TableHead className=\"font-semibold\">Estado</TableHead>\r\n                  <TableHead className=\"font-semibold text-right\">Total</TableHead>\r\n                  <TableHead className=\"font-semibold text-right\">Cobrado</TableHead>\r\n                  <TableHead className=\"font-semibold text-right\">Saldo</TableHead>\r\n                  <TableHead className=\"text-center font-semibold w-20\">Origen</TableHead>\r\n                  <TableHead className=\"text-right font-semibold\">Acciones</TableHead>\r\n                </TableRow>\r\n              </TableHeader>\r\n              <TableBody>\r\n                {visibleOrders.length === 0 ? (\r\n                  <TableRow>\r\n                    <TableCell colSpan={10} className=\"py-12 text-center\">\r\n                      <CreditCard className=\"h-12 w-12 text-slate-300 dark:text-slate-600 mx-auto mb-3\" />\r\n                      <p className=\"text-slate-500 dark:text-slate-400\">No hay órdenes en esta categoría</p>\r\n                    </TableCell>\r\n                  </TableRow>\r\n                ) : (\r\n                  visibleOrders.map((order) => {\r\n                    const statusColors: Record<string, string> = {\r\n                      PENDIENTE: \"bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400\",\r\n                      EN_PROCESO: \"bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400\",\r\n                      COMPLETADO: \"bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400\",\r\n                      ENTREGADO: \"bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400\",\r\n                      ANULADO: \"bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400\",\r\n                    };\r\n                    const paymentRowColors: Record<string, string> = {\r\n                      PENDIENTE: \"hover:bg-amber-50/50 dark:hover:bg-amber-950/20\",\r\n                      PARCIAL: \"hover:bg-blue-50/50 dark:hover:bg-blue-950/20\",\r\n                      PAGADO: \"hover:bg-emerald-50/50 dark:hover:bg-emerald-950/20\",\r\n                    };\r\n                    const sinDatosCapturados = order.status === \"PENDIENTE\" || order.status === \"EN_PROCESO\";\r\n                    const branchName = order.branch?.name ?? order.patientType ?? \"Sin sede\";\r\n                    const fromAdmission = !!order.admissionRequestId;\r\n                    const hasReferred = order.items.some((i) => i.labTest.isReferred && i.labTest.externalLabCost);\r\n                    return (\r\n                      <TableRow\r\n                        key={order.id}\r\n                        className={`${paymentRowColors[order.paymentStatus]} transition-colors ${sinDatosCapturados ? \"bg-amber-50/80 dark:bg-amber-950/40 border-l-4 border-l-amber-400 dark:border-l-amber-500\" : \"\"}`}\r\n                        title={sinDatosCapturados ? \"Orden sin datos capturados aún\" : undefined}\r\n                      >\r\n                        <TableCell>\r\n                          <Link\r\n                            className=\"font-medium text-blue-600 hover:text-blue-800 hover:underline dark:text-blue-400 dark:hover:text-blue-300\"\r\n                            href={`/orders/${order.id}`}\r\n                          >\r\n                            {order.orderCode}\r\n                          </Link>\r\n                        </TableCell>\r\n                        <TableCell className=\"font-medium text-slate-900 dark:text-slate-100\">\r\n                          {order.patient.firstName} {order.patient.lastName}\r\n                        </TableCell>\r\n                        <TableCell>\r\n                          <span className=\"inline-flex items-center gap-1 rounded-md bg-slate-100 px-2 py-0.5 text-xs font-medium text-slate-700 dark:bg-slate-700 dark:text-slate-300\">\r\n                            <Building2 className=\"h-3 w-3\" />\r\n                            {branchName}\r\n                          </span>\r\n                        </TableCell>\r\n                        <TableCell className=\"text-slate-600 dark:text-slate-400\">\r\n                          {formatDate(order.createdAt)}\r\n                        </TableCell>\r\n                        <TableCell>\r\n                          <span className={`inline-flex rounded-md px-2 py-0.5 text-xs font-medium ${statusColors[order.status] ?? \"bg-slate-100 text-slate-700\"}`}>\r\n                            {order.status}\r\n                          </span>\r\n                        </TableCell>\r\n                        <TableCell className=\"text-right font-semibold text-slate-900 dark:text-slate-200\">\r\n                          {formatCurrency(Number(order.totalPrice))}\r\n                        </TableCell>\r\n                        <TableCell className=\"text-right text-emerald-600 dark:text-emerald-400\">\r\n                          {formatCurrency(order.paidTotal)}\r\n                        </TableCell>\r\n                        <TableCell className=\"text-right font-bold text-slate-900 dark:text-slate-200\">\r\n                          {order.balance > 0 ? (\r\n                            <span className=\"text-amber-600 dark:text-amber-400\">{formatCurrency(order.balance)}</span>\r\n                          ) : (\r\n                            <span className=\"text-emerald-600 dark:text-emerald-400\">{formatCurrency(0)}</span>\r\n                          )}\r\n                        </TableCell>\r\n                        <TableCell className=\"text-center\">\r\n                          <div className=\"flex items-center justify-center gap-1\">\r\n                            {fromAdmission && (\r\n                              <span className=\"inline-flex items-center rounded bg-violet-100 px-1.5 py-0.5 text-[10px] font-medium text-violet-700 dark:bg-violet-900/40 dark:text-violet-300\" title=\"Orden de admisión\">\r\n                                <UserPlus className=\"h-3 w-3\" />\r\n                              </span>\r\n                            )}\r\n                            {hasReferred && (\r\n                              <span className=\"inline-flex items-center rounded bg-amber-100 px-1.5 py-0.5 text-[10px] font-medium text-amber-700 dark:bg-amber-900/40 dark:text-amber-300\" title=\"Incluye análisis referido\">\r\n                                <FlaskConical className=\"h-3 w-3\" />\r\n                              </span>\r\n                            )}\r\n                            {!fromAdmission && !hasReferred && <span className=\"text-slate-400\">—</span>}\r\n                          </div>\r\n                        </TableCell>\r\n                        <TableCell className=\"text-right\">\r\n                          <div className=\"flex items-center justify-end gap-1\">\r\n                            <Link\r\n                              className=\"inline-flex h-8 w-8 items-center justify-center rounded-md text-slate-600 transition-colors hover:bg-slate-100 hover:text-slate-900 dark:text-slate-400 dark:hover:bg-slate-700 dark:hover:text-slate-100\"\r\n                              href={`/orders/${order.id}`}\r\n                              title=\"Ver orden\"\r\n                            >\r\n                              <Eye className=\"h-4 w-4\" />\r\n                            </Link>\r\n                            {canPrintTicket && (\r\n                              <Link\r\n                                className=\"inline-flex h-8 w-8 items-center justify-center rounded-md text-slate-600 transition-colors hover:bg-slate-100 hover:text-slate-900 dark:text-slate-400 dark:hover:bg-slate-700 dark:hover:text-slate-100\"\r\n                                href={`/orders/${order.id}/payment-ticket`}\r\n                                target=\"_blank\"\r\n                                rel=\"noopener noreferrer\"\r\n                                title=\"Ticket de pago\"\r\n                              >\r\n                                <Receipt className=\"h-4 w-4\" />\r\n                              </Link>\r\n                            )}\r\n                            <Link\r\n                              className=\"inline-flex h-8 w-8 items-center justify-center rounded-md text-slate-600 transition-colors hover:bg-slate-100 hover:text-slate-900 dark:text-slate-400 dark:hover:bg-slate-700 dark:hover:text-slate-100\"\r\n                              href={`/orders/${order.id}/print`}\r\n                              title=\"Imprimir\"\r\n                            >\r\n                              <Printer className=\"h-4 w-4\" />\r\n                            </Link>\r\n                          </div>\r\n                        </TableCell>\r\n                      </TableRow>\r\n                    );\r\n                  })\r\n                )}\r\n              </TableBody>\r\n            </Table>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\(app)\\patients\\[id]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\(app)\\patients\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardHeader' is defined but never used.","line":8,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":39,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CardHeader"},"fix":{"range":[369,381],"text":""},"desc":"Remove unused variable \"CardHeader\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardTitle' is defined but never used.","line":8,"column":41,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":50,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CardTitle"},"fix":{"range":[381,392],"text":""},"desc":"Remove unused variable \"CardTitle\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import Link from \"next/link\";\r\nimport { redirect } from \"next/navigation\";\r\nimport { getServerSession } from \"next-auth\";\r\n\r\nimport { authOptions, hasPermission, PERMISSION_ELIMINAR_REGISTROS, PERMISSION_VER_PACIENTES } from \"@/lib/auth\";\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport { PatientForm } from \"@/components/forms/PatientForm\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\r\nimport { DeleteButton } from \"@/components/common/DeleteButton\";\r\nimport { formatDate } from \"@/lib/format\";\r\n\r\ntype Props = {\r\n  searchParams: Promise<{ search?: string }>;\r\n};\r\n\r\nexport default async function PatientsPage({ searchParams }: Props) {\r\n  const params = await searchParams;\r\n  const search = params.search?.trim();\r\n  const session = await getServerSession(authOptions);\r\n  if (!session?.user || !hasPermission(session, PERMISSION_VER_PACIENTES)) {\r\n    redirect(\"/dashboard\");\r\n  }\r\n  const canDeletePatients = hasPermission(session, PERMISSION_ELIMINAR_REGISTROS);\r\n\r\n  const patients = await prisma.patient.findMany({\r\n    where: {\r\n      deletedAt: null,\r\n      ...(search\r\n        ? {\r\n            OR: [\r\n              { firstName: { contains: search } },\r\n              { lastName: { contains: search } },\r\n              { dni: { contains: search } },\r\n              { code: { contains: search } },\r\n            ],\r\n          }\r\n        : {}),\r\n    },\r\n    orderBy: { createdAt: \"desc\" },\r\n  });\r\n\r\n  return (\r\n    <div className=\"space-y-8 min-w-0\">\r\n      <div>\r\n        <h1 className=\"text-2xl font-semibold text-slate-900 dark:text-slate-100 tracking-tight\">\r\n          Pacientes\r\n        </h1>\r\n        <p className=\"mt-1 text-sm text-slate-500 dark:text-slate-400\">\r\n          Registre pacientes y consulte el listado.\r\n        </p>\r\n      </div>\r\n\r\n      {/* 1. Registro de paciente (primero) */}\r\n      <section className=\"min-w-0\">\r\n        <h2 className=\"text-lg font-semibold text-slate-900 dark:text-slate-100 mb-3\">\r\n          Nuevo paciente\r\n        </h2>\r\n        <div className=\"rounded-2xl border border-slate-200/80 bg-white/80 shadow-sm backdrop-blur-sm dark:border-slate-700/80 dark:bg-slate-900/60\">\r\n          <PatientForm />\r\n        </div>\r\n      </section>\r\n\r\n      {/* 2. Buscar paciente */}\r\n      <section className=\"min-w-0\">\r\n        <h2 className=\"text-lg font-semibold text-slate-900 dark:text-slate-100 mb-3\">\r\n          Listado de pacientes\r\n        </h2>\r\n        <form method=\"GET\" className=\"mb-4\">\r\n          <label htmlFor=\"patient-search\" className=\"sr-only\">\r\n            Buscar paciente\r\n          </label>\r\n          <input\r\n            id=\"patient-search\"\r\n            name=\"search\"\r\n            type=\"text\"\r\n            defaultValue={search}\r\n            placeholder=\"Buscar paciente\"\r\n            className=\"w-full min-w-0 rounded-lg border border-slate-200 px-4 py-3 text-sm placeholder:text-slate-400 focus:border-slate-400 focus:outline-none focus:ring-1 focus:ring-slate-400 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100 dark:placeholder:text-slate-500 dark:focus:border-slate-500 dark:focus:ring-slate-500\"\r\n          />\r\n          <button\r\n            type=\"submit\"\r\n            className=\"mt-2 w-full sm:w-auto rounded-lg bg-slate-900 px-4 py-2.5 text-sm font-semibold text-white hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-slate-400 dark:bg-slate-100 dark:text-slate-900 dark:hover:bg-slate-200 dark:focus:ring-slate-500\"\r\n          >\r\n            Buscar\r\n          </button>\r\n        </form>\r\n\r\n        {/* 3. Catálogo / listado */}\r\n        <Card className=\"overflow-hidden\">\r\n          <CardContent className=\"p-0\">\r\n            {patients.length === 0 ? (\r\n              <div className=\"py-12 text-center text-slate-500 dark:text-slate-400\">\r\n                <p className=\"text-sm\">\r\n                  {search\r\n                    ? \"Ningún paciente coincide con la búsqueda.\"\r\n                    : \"No hay pacientes registrados.\"}\r\n                </p>\r\n                {!search && (\r\n                  <p className=\"text-xs text-slate-400 dark:text-slate-500 mt-1\">\r\n                    Use el formulario de arriba para registrar uno.\r\n                  </p>\r\n                )}\r\n              </div>\r\n            ) : (\r\n              <div className=\"overflow-x-auto max-h-[400px] overflow-y-auto\">\r\n                <Table className=\"min-w-[520px]\">\r\n                  <TableHeader>\r\n                    <TableRow>\r\n                      <TableHead>Código</TableHead>\r\n                      <TableHead>Nombre</TableHead>\r\n                      <TableHead>DNI</TableHead>\r\n                      <TableHead>Fecha Nac.</TableHead>\r\n                      <TableHead className=\"text-right\">Acciones</TableHead>\r\n                    </TableRow>\r\n                  </TableHeader>\r\n                  <TableBody>\r\n                    {patients.map((patient) => (\r\n                      <TableRow key={patient.id}>\r\n                        <TableCell className=\"font-mono text-sm text-slate-900 dark:text-slate-100\">{patient.code}</TableCell>\r\n                        <TableCell>\r\n                          <Link\r\n                            className=\"font-medium text-slate-900 dark:text-slate-100 hover:underline\"\r\n                            href={`/patients/${patient.id}`}\r\n                          >\r\n                            {patient.firstName} {patient.lastName}\r\n                          </Link>\r\n                        </TableCell>\r\n                        <TableCell className=\"text-slate-700 dark:text-slate-300\">{patient.dni}</TableCell>\r\n                        <TableCell className=\"text-slate-700 dark:text-slate-300\">{formatDate(patient.birthDate)}</TableCell>\r\n                        <TableCell className=\"text-right\">\r\n                          <Link\r\n                            href={`/patients/${patient.id}`}\r\n                            className=\"text-sm text-slate-600 dark:text-slate-300 hover:text-slate-900 dark:hover:text-slate-100 hover:underline mr-2\"\r\n                          >\r\n                            {canDeletePatients ? \"Editar\" : \"Ver\"}\r\n                          </Link>\r\n                          {canDeletePatients && (\r\n                            <DeleteButton url={`/api/patients/${patient.id}`} label=\"Eliminar\" />\r\n                          )}\r\n                        </TableCell>\r\n                      </TableRow>\r\n                    ))}\r\n                  </TableBody>\r\n                </Table>\r\n              </div>\r\n            )}\r\n          </CardContent>\r\n        </Card>\r\n      </section>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\(app)\\pending\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\(app)\\promociones\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\(app)\\promociones\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\(app)\\reportes\\ReportesFilterForm.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\(app)\\reportes\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'byPatientType' is assigned a value but never used.","line":132,"column":52,"nodeType":"Identifier","messageId":"unusedVar","endLine":132,"endColumn":65},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getSedeLabel' is defined but never used.","line":285,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":285,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import Link from \"next/link\";\r\nimport { Suspense } from \"react\";\r\nimport { redirect } from \"next/navigation\";\r\nimport { getServerSession } from \"next-auth\";\r\n\r\nimport type { OrderStatus, Prisma } from \"@prisma/client\";\r\nimport { authOptions, hasPermission, PERMISSION_REPORTES } from \"@/lib/auth\";\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport { getPaidTotalsByOrderIds } from \"@/lib/payments\";\r\nimport { formatCurrency, formatDate } from \"@/lib/format\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { PageHeader, pageLayoutClasses } from \"@/components/layout/PageHeader\";\r\nimport { ReportesFilterForm } from \"./ReportesFilterForm\";\r\nimport { Building2, TrendingUp, FileText, DollarSign, CalendarDays, Activity, BarChart3, UserPlus, FlaskConical } from \"lucide-react\";\r\n\r\ntype SearchParams = {\r\n  dateFrom?: string;\r\n  dateTo?: string;\r\n  status?: string;\r\n  paymentStatus?: \"PENDIENTE\" | \"PARCIAL\" | \"PAGADO\" | string;\r\n  branchId?: string;\r\n};\r\n\r\nfunction toYYYYMMDD(d: Date): string {\r\n  const y = d.getFullYear();\r\n  const m = String(d.getMonth() + 1).padStart(2, \"0\");\r\n  const day = String(d.getDate()).padStart(2, \"0\");\r\n  return `${y}-${m}-${day}`;\r\n}\r\n\r\n/** Parsea \"YYYY-MM-DD\" en hora local para evitar desfase por zona horaria */\r\nfunction parseLocalDate(dateStr: string): Date {\r\n  const [y, m, d] = dateStr.split(\"-\").map(Number);\r\n  if (y == null || m == null || d == null || Number.isNaN(y) || Number.isNaN(m) || Number.isNaN(d)) {\r\n    return new Date(dateStr);\r\n  }\r\n  const date = new Date(y, m - 1, d);\r\n  return date;\r\n}\r\n\r\nfunction parseDateRange(params: SearchParams) {\r\n  const today = new Date();\r\n  today.setHours(23, 59, 59, 999);\r\n  let dateFrom: Date;\r\n  let dateTo: Date;\r\n\r\n  const fromParam = params.dateFrom?.trim();\r\n  const toParam = params.dateTo?.trim();\r\n\r\n  if (fromParam && toParam) {\r\n    dateFrom = parseLocalDate(fromParam);\r\n    dateFrom.setHours(0, 0, 0, 0);\r\n    dateTo = parseLocalDate(toParam);\r\n    dateTo.setHours(23, 59, 59, 999);\r\n    if (dateFrom.getTime() > dateTo.getTime()) [dateFrom, dateTo] = [dateTo, dateFrom];\r\n  } else if (fromParam) {\r\n    dateFrom = parseLocalDate(fromParam);\r\n    dateFrom.setHours(0, 0, 0, 0);\r\n    dateTo = new Date(today);\r\n  } else if (toParam) {\r\n    dateTo = parseLocalDate(toParam);\r\n    dateTo.setHours(23, 59, 59, 999);\r\n    dateFrom = new Date(dateTo);\r\n    dateFrom.setDate(dateFrom.getDate() - 30);\r\n    dateFrom.setHours(0, 0, 0, 0);\r\n  } else {\r\n    dateTo = new Date(today);\r\n    dateFrom = new Date(today);\r\n    dateFrom.setDate(dateFrom.getDate() - 30);\r\n    dateFrom.setHours(0, 0, 0, 0);\r\n  }\r\n\r\n  return { dateFrom, dateTo };\r\n}\r\n\r\nexport const dynamic = \"force-dynamic\";\r\n\r\nexport default async function ReportesPage({\r\n  searchParams,\r\n}: {\r\n  searchParams: Promise<SearchParams>;\r\n}) {\r\n  const session = await getServerSession(authOptions);\r\n  if (!hasPermission(session, PERMISSION_REPORTES)) redirect(\"/dashboard\");\r\n\r\n  const params = await searchParams;\r\n  const { dateFrom, dateTo } = parseDateRange(params);\r\n  const statusFilter = params.status?.trim() || undefined;\r\n  const paymentStatusFilter = params.paymentStatus?.trim() || undefined;\r\n  const branchIdFilter = params.branchId?.trim() || undefined;\r\n\r\n  // Para \"Entregados\" usamos fecha de entrega (deliveredAt); para el resto, fecha de creación (createdAt)\r\n  const useDeliveredDate = statusFilter === \"ENTREGADO\";\r\n  const orderWhereWithDate: Prisma.LabOrderWhereInput = useDeliveredDate\r\n    ? {\r\n        status: \"ENTREGADO\",\r\n        deliveredAt: { not: null, gte: dateFrom, lte: dateTo },\r\n        ...(branchIdFilter ? { branchId: branchIdFilter } : {}),\r\n      }\r\n    : {\r\n        ...(statusFilter ? { status: statusFilter as OrderStatus } : { status: { not: \"ANULADO\" } }),\r\n        createdAt: { gte: dateFrom, lte: dateTo },\r\n        ...(branchIdFilter ? { branchId: branchIdFilter } : {}),\r\n      };\r\n\r\n  let orderWhereFinal: Prisma.LabOrderWhereInput = orderWhereWithDate;\r\n  if (paymentStatusFilter) {\r\n    const baseOrders = await prisma.labOrder.findMany({\r\n      where: orderWhereWithDate,\r\n      select: { id: true, totalPrice: true },\r\n    });\r\n    const baseIds = baseOrders.map((o) => o.id);\r\n    const paidByOrder = await getPaidTotalsByOrderIds(prisma, baseIds);\r\n\r\n    const filteredIds = baseOrders\r\n      .filter((o) => {\r\n        const paid = paidByOrder.get(o.id) ?? 0;\r\n        const total = Number(o.totalPrice);\r\n        const state = paid <= 0 ? \"PENDIENTE\" : paid + 0.0001 < total ? \"PARCIAL\" : \"PAGADO\";\r\n        return state === paymentStatusFilter;\r\n      })\r\n      .map((o) => o.id);\r\n\r\n    orderWhereFinal = {\r\n      ...orderWhereWithDate,\r\n      id: { in: filteredIds.length > 0 ? filteredIds : [\"__none__\"] },\r\n    };\r\n  }\r\n\r\n  const [orderItems, ordersSummary, revenueResult, byPatientType, byBranch, ordersList, branches, admissionSummary, referredLabPayments, admissionPendingSettlement] = await Promise.all([\r\n    prisma.labOrderItem.findMany({\r\n      where: { order: orderWhereFinal },\r\n      include: {\r\n        labTest: {\r\n          include: {\r\n            section: true,\r\n            referredLab: { select: { id: true, name: true } },\r\n          },\r\n        },\r\n        order: { select: { id: true } },\r\n      },\r\n    }),\r\n    prisma.labOrder.groupBy({\r\n      by: [\"status\"],\r\n      where: orderWhereFinal,\r\n      _count: { id: true },\r\n    }),\r\n    prisma.labOrder.aggregate({\r\n      _sum: { totalPrice: true },\r\n      _count: { id: true },\r\n      where: orderWhereFinal,\r\n    }),\r\n    prisma.labOrder.groupBy({\r\n      by: [\"patientType\"],\r\n      where: orderWhereFinal,\r\n      _count: { id: true },\r\n      _sum: { totalPrice: true },\r\n    }),\r\n    prisma.labOrder.groupBy({\r\n      by: [\"branchId\"],\r\n      where: orderWhereFinal,\r\n      _count: { id: true },\r\n      _sum: { totalPrice: true },\r\n    }),\r\n    prisma.labOrder.findMany({\r\n      where: orderWhereFinal,\r\n      include: { patient: true, branch: true },\r\n      orderBy: useDeliveredDate\r\n        ? [{ deliveredAt: \"desc\" }, { updatedAt: \"desc\" }]\r\n        : { createdAt: \"desc\" },\r\n      take: 500,\r\n    }),\r\n    prisma.branch.findMany({\r\n      orderBy: [{ order: \"asc\" }, { name: \"asc\" }],\r\n    }),\r\n    prisma.admissionRequest.groupBy({\r\n      by: [\"status\"],\r\n      where: {\r\n        createdAt: { gte: dateFrom, lte: dateTo },\r\n      },\r\n      _count: { id: true },\r\n      _sum: { totalPrice: true },\r\n    }),\r\n    prisma.referredLabPayment.findMany({\r\n      where: {\r\n        order: orderWhereFinal,\r\n      },\r\n      include: { referredLab: { select: { id: true, name: true } } },\r\n    }),\r\n    prisma.labOrder.aggregate({\r\n      where: {\r\n        admissionRequestId: { not: null },\r\n        admissionSettledAt: null,\r\n        status: { not: \"ANULADO\" },\r\n        createdAt: { gte: dateFrom, lte: dateTo },\r\n      },\r\n      _count: { id: true },\r\n      _sum: { totalPrice: true },\r\n    }),\r\n  ]);\r\n\r\n  // Mapa de branches para lookup rápido\r\n  const branchMap = new Map(branches.map((b) => [b.id, b]));\r\n\r\n  // Agrupar por análisis (labTest)\r\n  const byTest = new Map<\r\n    string,\r\n    { code: string; name: string; section: string; count: number; isReferred: boolean }\r\n  >();\r\n  for (const item of orderItems) {\r\n    const test = item.labTest;\r\n    const key = test.id;\r\n    const existing = byTest.get(key);\r\n    if (existing) {\r\n      existing.count += 1;\r\n    } else {\r\n      byTest.set(key, {\r\n        code: test.code,\r\n        name: test.name,\r\n        section: test.section?.name ?? test.section?.code ?? \"\",\r\n        count: 1,\r\n        isReferred: test.isReferred ?? false,\r\n      });\r\n    }\r\n  }\r\n\r\n  // Datos de laboratorios referidos\r\n  const referredOrderIds = new Set(orderItems.filter((i) => i.labTest.isReferred && i.labTest.externalLabCost).map((i) => i.order.id));\r\n  let totalExternalLabCost = 0;\r\n  const costByReferredLab = new Map<string, { labId: string; labName: string; cost: number }>();\r\n  for (const item of orderItems) {\r\n    const lt = item.labTest;\r\n    if (!lt.isReferred || !lt.referredLabId || !lt.externalLabCost) continue;\r\n    const cost = Number(lt.externalLabCost);\r\n    totalExternalLabCost += cost;\r\n    const lab = lt.referredLab;\r\n    if (lab) {\r\n      const existing = costByReferredLab.get(lab.id);\r\n      if (existing) existing.cost += cost;\r\n      else costByReferredLab.set(lab.id, { labId: lab.id, labName: lab.name, cost });\r\n    }\r\n  }\r\n  const paidToLabsInPeriod = referredLabPayments\r\n    .filter((p) => referredOrderIds.has(p.orderId))\r\n    .reduce((acc, p) => acc + Number(p.amount), 0);\r\n  const paidByLab = new Map<string, number>();\r\n  for (const p of referredLabPayments) {\r\n    if (!referredOrderIds.has(p.orderId)) continue;\r\n    const cur = paidByLab.get(p.referredLabId) ?? 0;\r\n    paidByLab.set(p.referredLabId, cur + Number(p.amount));\r\n  }\r\n  const referredLabSummaries = [...costByReferredLab.entries()].map(([labId, { labName, cost }]) => ({\r\n    labId,\r\n    labName,\r\n    cost,\r\n    paid: paidByLab.get(labId) ?? 0,\r\n    balance: Math.max(0, cost - (paidByLab.get(labId) ?? 0)),\r\n  }));\r\n  const totalBalanceOwedToLabs = Math.max(0, totalExternalLabCost - paidToLabsInPeriod);\r\n\r\n  const sortedAnalisis = [...byTest.values()].sort((a, b) => b.count - a.count);\r\n  const totalSolicitudes = orderItems.length;\r\n  const totalOrdenes = revenueResult._count.id ?? 0;\r\n  const ingresos = Number(revenueResult._sum.totalPrice ?? 0);\r\n  const gananciaNetaReferidos = ingresos - totalExternalLabCost;\r\n  const orderIds = ordersList.map((o) => o.id);\r\n  const paidMap = await getPaidTotalsByOrderIds(prisma, orderIds);\r\n  const cobrado = [...paidMap.values()].reduce((acc, v) => acc + v, 0);\r\n\r\n  const statusLabels: Record<string, string> = {\r\n    PENDIENTE: \"Pendientes\",\r\n    EN_PROCESO: \"En proceso\",\r\n    COMPLETADO: \"Completados\",\r\n    ENTREGADO: \"Entregados\",\r\n    ANULADO: \"Anulados\",\r\n  };\r\n\r\n  const sedeLabels: Record<string, string> = {\r\n    CLINICA: \"Paciente Clínica\",\r\n    EXTERNO: \"Paciente Externo\",\r\n    IZAGA: \"Paciente Izaga\",\r\n  };\r\n  function getSedeLabel(type: string | null): string {\r\n    return type ? (sedeLabels[type] ?? type) : \"Sin especificar\";\r\n  }\r\n\r\n  return (\r\n    <div className={pageLayoutClasses.wrapper}>\r\n      <PageHeader\r\n        title=\"Reportes\"\r\n        description=\"Análisis más solicitados y resumen por período\"\r\n      />\r\n\r\n      {/* Filtros */}\r\n      <Card>\r\n        <CardHeader className=\"pb-4\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <CardTitle className=\"text-lg\">Filtros de búsqueda</CardTitle>\r\n            <Link\r\n              href={`/api/reportes/export?dateFrom=${encodeURIComponent(params.dateFrom ?? toYYYYMMDD(dateFrom))}&dateTo=${encodeURIComponent(params.dateTo ?? toYYYYMMDD(dateTo))}&status=${encodeURIComponent(params.status ?? \"\")}&paymentStatus=${encodeURIComponent(params.paymentStatus ?? \"\")}&branchId=${encodeURIComponent(params.branchId ?? \"\")}`}\r\n              className=\"inline-flex h-9 items-center gap-2 rounded-lg border border-slate-200 bg-white px-4 text-sm font-medium text-slate-700 shadow-sm transition-colors hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-300 dark:hover:bg-slate-700\"\r\n            >\r\n              <FileText className=\"h-4 w-4\" />\r\n              Exportar CSV\r\n            </Link>\r\n          </div>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <Suspense fallback={<div className=\"h-32 animate-pulse rounded-lg bg-slate-100 dark:bg-slate-700\" />}>\r\n            <ReportesFilterForm\r\n              key={`${params.dateFrom ?? \"\"}-${params.dateTo ?? \"\"}-${params.status ?? \"\"}-${params.paymentStatus ?? \"\"}-${params.branchId ?? \"\"}`}\r\n              defaultDateFrom={params.dateFrom ?? toYYYYMMDD(dateFrom)}\r\n              defaultDateTo={params.dateTo ?? toYYYYMMDD(dateTo)}\r\n              defaultStatus={statusFilter ?? \"\"}\r\n              defaultPaymentStatus={paymentStatusFilter ?? \"\"}\r\n              defaultBranchId={branchIdFilter ?? \"\"}\r\n            />\r\n          </Suspense>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Resumen del período */}\r\n      <div className=\"grid gap-6 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5\">\r\n        <Card className=\"overflow-hidden\">\r\n          <div className=\"h-1 bg-slate-400\" />\r\n          <CardContent className=\"p-6\">\r\n            <div className=\"flex items-start gap-4\">\r\n              <div className=\"flex h-12 w-12 shrink-0 items-center justify-center rounded-xl bg-slate-100 dark:bg-slate-800\">\r\n                <CalendarDays className=\"h-6 w-6 text-slate-600 dark:text-slate-400\" />\r\n              </div>\r\n              <div className=\"space-y-1\">\r\n                <p className=\"text-sm font-medium text-slate-500 dark:text-slate-400\">Período</p>\r\n                <p className=\"text-base font-semibold text-slate-900 dark:text-slate-100\">\r\n                  {formatDate(dateFrom)}\r\n                </p>\r\n                <p className=\"text-base font-semibold text-slate-900 dark:text-slate-100\">\r\n                  {formatDate(dateTo)}\r\n                </p>\r\n                {statusFilter === \"ENTREGADO\" && (\r\n                  <p className=\"text-xs text-slate-500\">(por fecha de entrega)</p>\r\n                )}\r\n              </div>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n        \r\n        <Card className=\"overflow-hidden\">\r\n          <div className=\"h-1 bg-blue-500\" />\r\n          <CardContent className=\"p-6\">\r\n            <div className=\"flex items-start gap-4\">\r\n              <div className=\"flex h-12 w-12 shrink-0 items-center justify-center rounded-xl bg-blue-100 dark:bg-blue-900/30\">\r\n                <FileText className=\"h-6 w-6 text-blue-600 dark:text-blue-400\" />\r\n              </div>\r\n              <div className=\"space-y-1\">\r\n                <p className=\"text-sm font-medium text-slate-500 dark:text-slate-400\">Total Órdenes</p>\r\n                <p className=\"text-3xl font-bold text-blue-600 dark:text-blue-400\">{totalOrdenes}</p>\r\n                <p className=\"text-xs text-slate-500\">órdenes en el período</p>\r\n              </div>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n        \r\n        <Card className=\"overflow-hidden\">\r\n          <div className=\"h-1 bg-emerald-500\" />\r\n          <CardContent className=\"p-6\">\r\n            <div className=\"flex items-start gap-4\">\r\n              <div className=\"flex h-12 w-12 shrink-0 items-center justify-center rounded-xl bg-emerald-100 dark:bg-emerald-900/30\">\r\n                <DollarSign className=\"h-6 w-6 text-emerald-600 dark:text-emerald-400\" />\r\n              </div>\r\n              <div className=\"space-y-1\">\r\n                <p className=\"text-sm font-medium text-slate-500 dark:text-slate-400\">Facturado</p>\r\n                <p className=\"text-2xl font-bold text-emerald-600 dark:text-emerald-400\">{formatCurrency(ingresos)}</p>\r\n                <p className=\"text-sm text-slate-600 dark:text-slate-400\">\r\n                  Cobrado: <span className=\"font-semibold text-emerald-600 dark:text-emerald-400\">{formatCurrency(cobrado)}</span>\r\n                </p>\r\n              </div>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n        \r\n        <Card className=\"overflow-hidden\">\r\n          <div className=\"h-1 bg-purple-500\" />\r\n          <CardContent className=\"p-6\">\r\n            <div className=\"flex items-start gap-4\">\r\n              <div className=\"flex h-12 w-12 shrink-0 items-center justify-center rounded-xl bg-purple-100 dark:bg-purple-900/30\">\r\n                <TrendingUp className=\"h-6 w-6 text-purple-600 dark:text-purple-400\" />\r\n              </div>\r\n              <div className=\"space-y-1\">\r\n                <p className=\"text-sm font-medium text-slate-500 dark:text-slate-400\">Análisis Solicitados</p>\r\n                <p className=\"text-3xl font-bold text-purple-600 dark:text-purple-400\">{totalSolicitudes}</p>\r\n                <p className=\"text-xs text-slate-500\">pruebas en el período</p>\r\n              </div>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n        {totalExternalLabCost > 0 && (\r\n          <Card className=\"overflow-hidden\">\r\n            <div className=\"h-1 bg-amber-500\" />\r\n            <CardContent className=\"p-6\">\r\n              <div className=\"flex items-start gap-4\">\r\n                <div className=\"flex h-12 w-12 shrink-0 items-center justify-center rounded-xl bg-amber-100 dark:bg-amber-900/30\">\r\n                  <FlaskConical className=\"h-6 w-6 text-amber-600 dark:text-amber-400\" />\r\n                </div>\r\n                <div className=\"space-y-1\">\r\n                  <p className=\"text-sm font-medium text-slate-500 dark:text-slate-400\">Lab. referidos</p>\r\n                  <p className=\"text-xl font-bold text-amber-600 dark:text-amber-400\">{formatCurrency(totalExternalLabCost)}</p>\r\n                  <p className=\"text-xs text-slate-500\">\r\n                    Pagado: {formatCurrency(paidToLabsInPeriod)} • Pendiente: {formatCurrency(totalBalanceOwedToLabs)}\r\n                  </p>\r\n                  <p className=\"text-xs font-medium text-emerald-600 dark:text-emerald-400\">\r\n                    Ganancia neta: {formatCurrency(gananciaNetaReferidos)}\r\n                  </p>\r\n                </div>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        )}\r\n      </div>\r\n\r\n      {/* Pendiente de cobro a admisión */}\r\n      {(admissionPendingSettlement._count.id ?? 0) > 0 && (\r\n        <Card>\r\n          <CardHeader className=\"pb-3\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <div className=\"flex items-center gap-2\">\r\n                <UserPlus className=\"h-4 w-4 text-slate-500\" />\r\n                <CardTitle className=\"text-base\">Pendiente de cobro a admisión</CardTitle>\r\n              </div>\r\n              <Link\r\n                href=\"/cobro-admision\"\r\n                className=\"text-sm font-medium text-blue-600 hover:underline dark:text-blue-400\"\r\n              >\r\n                Ver cobro admisión →\r\n              </Link>\r\n            </div>\r\n            <p className=\"text-sm text-slate-500 mt-1\">\r\n              {admissionPendingSettlement._count.id} órdenes de admisión por saldar. Total:{\" \"}\r\n              <span className=\"font-semibold text-amber-600 dark:text-amber-400\">\r\n                {formatCurrency(Number(admissionPendingSettlement._sum.totalPrice ?? 0))}\r\n              </span>\r\n            </p>\r\n          </CardHeader>\r\n        </Card>\r\n      )}\r\n\r\n      {/* Pre-órdenes de Admisión */}\r\n      <Card>\r\n        <CardHeader className=\"pb-3\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <UserPlus className=\"h-4 w-4 text-slate-500\" />\r\n            <CardTitle className=\"text-base\">Pre-órdenes de Admisión</CardTitle>\r\n          </div>\r\n          <p className=\"text-sm text-slate-500 mt-1\">\r\n            Resumen de pre-órdenes creadas en el período.\r\n          </p>\r\n        </CardHeader>\r\n        <CardContent>\r\n          {admissionSummary.length === 0 ? (\r\n            <p className=\"text-sm text-slate-500\">Sin pre-órdenes en el período</p>\r\n          ) : (\r\n            <div className=\"grid gap-4 sm:grid-cols-3\">\r\n              {admissionSummary.map((row) => {\r\n                const admLabels: Record<string, string> = {\r\n                  PENDIENTE: \"Pendientes\",\r\n                  CONVERTIDA: \"Convertidas\",\r\n                  CANCELADA: \"Canceladas\",\r\n                };\r\n                const admConfig: Record<string, { bg: string; text: string }> = {\r\n                  PENDIENTE: { bg: \"bg-amber-50 dark:bg-amber-900/20\", text: \"text-amber-700 dark:text-amber-400\" },\r\n                  CONVERTIDA: { bg: \"bg-emerald-50 dark:bg-emerald-900/20\", text: \"text-emerald-700 dark:text-emerald-400\" },\r\n                  CANCELADA: { bg: \"bg-slate-100 dark:bg-slate-800\", text: \"text-slate-600 dark:text-slate-400\" },\r\n                };\r\n                const cfg = admConfig[row.status] ?? { bg: \"bg-slate-50\", text: \"text-slate-700\" };\r\n                const total = Number(row._sum.totalPrice ?? 0);\r\n                return (\r\n                  <div key={row.status} className={`rounded-xl border border-slate-200 p-4 dark:border-slate-700 ${cfg.bg}`}>\r\n                    <p className={`text-sm font-medium ${cfg.text}`}>{admLabels[row.status] ?? row.status}</p>\r\n                    <p className={`mt-2 text-2xl font-bold ${cfg.text}`}>{row._count.id}</p>\r\n                    <p className=\"mt-1 text-xs text-slate-500 dark:text-slate-400\">{formatCurrency(total)} facturado</p>\r\n                  </div>\r\n                );\r\n              })}\r\n            </div>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Laboratorios referidos / Análisis terciarizados */}\r\n      {referredLabSummaries.length > 0 && (\r\n        <Card>\r\n          <CardHeader className=\"pb-3\">\r\n            <div className=\"flex items-center gap-2\">\r\n              <FlaskConical className=\"h-4 w-4 text-slate-500\" />\r\n              <CardTitle className=\"text-base\">Laboratorios referidos (terciarizados)</CardTitle>\r\n            </div>\r\n            <p className=\"text-sm text-slate-500 mt-1\">\r\n              Costo y pagos a laboratorios externos por análisis referidos en el período.\r\n            </p>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"overflow-x-auto rounded-lg border border-slate-200 dark:border-slate-700\">\r\n              <Table>\r\n                <TableHeader>\r\n                  <TableRow className=\"bg-slate-50 dark:bg-slate-800/50\">\r\n                    <TableHead className=\"font-semibold\">Laboratorio</TableHead>\r\n                    <TableHead className=\"text-right font-semibold\">Costo externo</TableHead>\r\n                    <TableHead className=\"text-right font-semibold\">Pagado</TableHead>\r\n                    <TableHead className=\"text-right font-semibold\">Pendiente</TableHead>\r\n                  </TableRow>\r\n                </TableHeader>\r\n                <TableBody>\r\n                  {referredLabSummaries.map((row) => (\r\n                    <TableRow key={row.labId} className=\"hover:bg-slate-50 dark:hover:bg-slate-800/30\">\r\n                      <TableCell>\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <FlaskConical className=\"h-4 w-4 text-amber-500\" />\r\n                          <span className=\"font-medium\">{row.labName}</span>\r\n                        </div>\r\n                      </TableCell>\r\n                      <TableCell className=\"text-right font-semibold\">{formatCurrency(row.cost)}</TableCell>\r\n                      <TableCell className=\"text-right text-emerald-600 dark:text-emerald-400\">{formatCurrency(row.paid)}</TableCell>\r\n                      <TableCell className=\"text-right\">\r\n                        <span className={row.balance > 0 ? \"font-semibold text-amber-600 dark:text-amber-400\" : \"text-slate-500\"}>\r\n                          {formatCurrency(row.balance)}\r\n                        </span>\r\n                      </TableCell>\r\n                    </TableRow>\r\n                  ))}\r\n                </TableBody>\r\n              </Table>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n\r\n      {/* Órdenes por estado */}\r\n      <Card>\r\n        <CardHeader>\r\n          <div className=\"flex items-center gap-3\">\r\n            <div className=\"flex h-10 w-10 items-center justify-center rounded-lg bg-slate-100 dark:bg-slate-800\">\r\n              <Activity className=\"h-5 w-5 text-slate-600 dark:text-slate-400\" />\r\n            </div>\r\n            <div>\r\n              <CardTitle className=\"text-lg\">Órdenes por estado</CardTitle>\r\n              <p className=\"text-sm text-slate-500 dark:text-slate-400\">Distribución de órdenes según su estado actual</p>\r\n            </div>\r\n          </div>\r\n        </CardHeader>\r\n        <CardContent>\r\n          {ordersSummary.length === 0 ? (\r\n            <p className=\"py-8 text-center text-slate-500\">Sin órdenes en el período seleccionado</p>\r\n          ) : (\r\n            <div className=\"grid gap-4 sm:grid-cols-2 lg:grid-cols-5\">\r\n              {ordersSummary.map((s) => {\r\n                const statusConfig: Record<string, { bg: string; border: string; text: string; icon: string }> = {\r\n                  PENDIENTE: { bg: \"bg-amber-50 dark:bg-amber-900/20\", border: \"border-amber-200 dark:border-amber-800\", text: \"text-amber-700 dark:text-amber-400\", icon: \"bg-amber-100 dark:bg-amber-900/40\" },\r\n                  EN_PROCESO: { bg: \"bg-blue-50 dark:bg-blue-900/20\", border: \"border-blue-200 dark:border-blue-800\", text: \"text-blue-700 dark:text-blue-400\", icon: \"bg-blue-100 dark:bg-blue-900/40\" },\r\n                  COMPLETADO: { bg: \"bg-emerald-50 dark:bg-emerald-900/20\", border: \"border-emerald-200 dark:border-emerald-800\", text: \"text-emerald-700 dark:text-emerald-400\", icon: \"bg-emerald-100 dark:bg-emerald-900/40\" },\r\n                  ENTREGADO: { bg: \"bg-green-50 dark:bg-green-900/20\", border: \"border-green-200 dark:border-green-800\", text: \"text-green-700 dark:text-green-400\", icon: \"bg-green-100 dark:bg-green-900/40\" },\r\n                  ANULADO: { bg: \"bg-red-50 dark:bg-red-900/20\", border: \"border-red-200 dark:border-red-800\", text: \"text-red-700 dark:text-red-400\", icon: \"bg-red-100 dark:bg-red-900/40\" },\r\n                };\r\n                const config = statusConfig[s.status] ?? { bg: \"bg-slate-50\", border: \"border-slate-200\", text: \"text-slate-700\", icon: \"bg-slate-100\" };\r\n                return (\r\n                  <div\r\n                    key={s.status}\r\n                    className={`rounded-xl border-2 p-4 ${config.bg} ${config.border}`}\r\n                  >\r\n                    <p className={`text-sm font-medium ${config.text}`}>{statusLabels[s.status] ?? s.status}</p>\r\n                    <p className={`mt-2 text-3xl font-bold ${config.text}`}>{s._count.id}</p>\r\n                  </div>\r\n                );\r\n              })}\r\n            </div>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Reportes por Sede - Nueva sección mejorada */}\r\n      <Card>\r\n        <CardHeader className=\"pb-3\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <Building2 className=\"h-4 w-4 text-slate-500\" />\r\n            <CardTitle className=\"text-base\">Reportes por Sede</CardTitle>\r\n          </div>\r\n          <p className=\"text-sm text-slate-500 mt-1\">\r\n            Desglose de órdenes e ingresos por sede/sucursal.\r\n          </p>\r\n        </CardHeader>\r\n        <CardContent>\r\n          {byBranch.length === 0 ? (\r\n            <p className=\"text-sm text-slate-500\">Sin órdenes en el período</p>\r\n          ) : (\r\n            <div className=\"space-y-4\">\r\n              {/* Cards visuales por sede */}\r\n              <div className=\"grid gap-3 sm:grid-cols-2 lg:grid-cols-3\">\r\n                {byBranch.map((row) => {\r\n                  const branch = row.branchId ? branchMap.get(row.branchId) : null;\r\n                  const label = branch ? branch.name : \"Sin sede asignada\";\r\n                  const code = branch?.code ?? \"\";\r\n                  const sum = Number(row._sum.totalPrice ?? 0);\r\n                  const count = row._count.id;\r\n                  const branchColors: Record<string, string> = {\r\n                    CLINICA: \"from-blue-500 to-blue-600\",\r\n                    EXTERNO: \"from-amber-500 to-amber-600\",\r\n                    IZAGA: \"from-emerald-500 to-emerald-600\",\r\n                  };\r\n                  const gradientClass = branchColors[code] ?? \"from-slate-500 to-slate-600\";\r\n                  \r\n                  return (\r\n                    <div\r\n                      key={row.branchId ?? \"_sin_sede\"}\r\n                      className=\"relative overflow-hidden rounded-xl border border-slate-200 dark:border-slate-700\"\r\n                    >\r\n                      <div className={`bg-gradient-to-r ${gradientClass} px-4 py-3`}>\r\n                        <p className=\"text-sm font-semibold text-white\">{label}</p>\r\n                        {code && <p className=\"text-xs text-white/70\">{code}</p>}\r\n                      </div>\r\n                      <div className=\"grid grid-cols-2 divide-x divide-slate-200 dark:divide-slate-700 bg-white dark:bg-slate-800\">\r\n                        <div className=\"px-4 py-3 text-center\">\r\n                          <p className=\"text-xs text-slate-500 dark:text-slate-400\">Órdenes</p>\r\n                          <p className=\"text-xl font-bold text-slate-900 dark:text-slate-100\">{count}</p>\r\n                        </div>\r\n                        <div className=\"px-4 py-3 text-center\">\r\n                          <p className=\"text-xs text-slate-500 dark:text-slate-400\">Ingresos</p>\r\n                          <p className=\"text-lg font-bold text-emerald-600 dark:text-emerald-400\">{formatCurrency(sum)}</p>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  );\r\n                })}\r\n              </div>\r\n              \r\n              {/* Tabla detallada */}\r\n              <div className=\"overflow-x-auto rounded-lg border border-slate-200 dark:border-slate-700\">\r\n                <Table>\r\n                  <TableHeader>\r\n                    <TableRow className=\"bg-slate-50 dark:bg-slate-800/50\">\r\n                      <TableHead className=\"font-semibold\">Sede</TableHead>\r\n                      <TableHead className=\"text-right w-28 font-semibold\">Órdenes</TableHead>\r\n                      <TableHead className=\"text-right w-32 font-semibold\">% Total</TableHead>\r\n                      <TableHead className=\"text-right w-36 font-semibold\">Ingresos</TableHead>\r\n                    </TableRow>\r\n                  </TableHeader>\r\n                  <TableBody>\r\n                    {byBranch.map((row) => {\r\n                      const branch = row.branchId ? branchMap.get(row.branchId) : null;\r\n                      const label = branch ? branch.name : \"Sin sede asignada\";\r\n                      const sum = Number(row._sum.totalPrice ?? 0);\r\n                      const pct = totalOrdenes > 0 ? ((row._count.id / totalOrdenes) * 100).toFixed(1) : \"0\";\r\n                      return (\r\n                        <TableRow key={row.branchId ?? \"_sin_sede\"}>\r\n                          <TableCell>\r\n                            <div className=\"flex items-center gap-2\">\r\n                              <Building2 className=\"h-4 w-4 text-slate-400\" />\r\n                              <span className=\"font-medium\">{label}</span>\r\n                            </div>\r\n                          </TableCell>\r\n                          <TableCell className=\"text-right font-semibold\">{row._count.id}</TableCell>\r\n                          <TableCell className=\"text-right\">\r\n                            <Badge variant=\"secondary\" className=\"text-xs\">{pct}%</Badge>\r\n                          </TableCell>\r\n                          <TableCell className=\"text-right font-semibold text-emerald-600 dark:text-emerald-400\">\r\n                            {formatCurrency(sum)}\r\n                          </TableCell>\r\n                        </TableRow>\r\n                      );\r\n                    })}\r\n                  </TableBody>\r\n                </Table>\r\n              </div>\r\n            </div>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Órdenes del período (con sede) - Diseño mejorado */}\r\n      <Card>\r\n        <CardHeader className=\"pb-3\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <FileText className=\"h-4 w-4 text-slate-500\" />\r\n            <CardTitle className=\"text-base\">Órdenes del período</CardTitle>\r\n          </div>\r\n          <p className=\"text-sm text-slate-500 mt-1\">\r\n            {statusFilter === \"ENTREGADO\"\r\n              ? \"Órdenes entregadas en el rango de fechas (por fecha de entrega). Máximo 500.\"\r\n              : \"Listado con sede asignada. Máximo 500 órdenes.\"}\r\n          </p>\r\n        </CardHeader>\r\n        <CardContent>\r\n          {ordersList.length === 0 ? (\r\n            <div className=\"py-8 text-center\">\r\n              <FileText className=\"h-12 w-12 text-slate-300 dark:text-slate-600 mx-auto mb-3\" />\r\n              <p className=\"text-sm text-slate-500 dark:text-slate-400\">No hay órdenes en el período.</p>\r\n            </div>\r\n          ) : (\r\n            <div className=\"overflow-x-auto max-h-[420px] overflow-y-auto rounded-lg border border-slate-200 dark:border-slate-700\">\r\n              <Table>\r\n                <TableHeader>\r\n                  <TableRow className=\"bg-slate-50 dark:bg-slate-800/50\">\r\n                    <TableHead className=\"w-12 text-center font-semibold\">#</TableHead>\r\n                    <TableHead className=\"font-semibold\">Orden</TableHead>\r\n                    <TableHead className=\"font-semibold\">{statusFilter === \"ENTREGADO\" ? \"Fecha entrega\" : \"Fecha\"}</TableHead>\r\n                    <TableHead className=\"font-semibold\">Paciente</TableHead>\r\n                    <TableHead className=\"font-semibold\">Sede</TableHead>\r\n                    <TableHead className=\"font-semibold\">Estado</TableHead>\r\n                    <TableHead className=\"text-right font-semibold\">Total</TableHead>\r\n                  </TableRow>\r\n                </TableHeader>\r\n                <TableBody>\r\n                  {ordersList.map((order, idx) => {\r\n                    const branchName = order.branch?.name ?? \"Sin sede\";\r\n                    const statusColors: Record<string, string> = {\r\n                      PENDIENTE: \"bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400\",\r\n                      EN_PROCESO: \"bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400\",\r\n                      COMPLETADO: \"bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400\",\r\n                      ENTREGADO: \"bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400\",\r\n                      ANULADO: \"bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400\",\r\n                    };\r\n                    return (\r\n                      <TableRow key={order.id} className=\"hover:bg-slate-50 dark:hover:bg-slate-800/30\">\r\n                        <TableCell className=\"text-center text-slate-500\">{idx + 1}</TableCell>\r\n                        <TableCell>\r\n                          <Link\r\n                            href={`/orders/${order.id}`}\r\n                            className=\"font-medium text-blue-600 hover:text-blue-800 hover:underline dark:text-blue-400 dark:hover:text-blue-300\"\r\n                          >\r\n                            {order.orderCode}\r\n                          </Link>\r\n                        </TableCell>\r\n                        <TableCell className=\"text-slate-600 dark:text-slate-400\">\r\n                          {formatDate(\r\n                            statusFilter === \"ENTREGADO\" && order.deliveredAt\r\n                              ? order.deliveredAt\r\n                              : order.createdAt,\r\n                          )}\r\n                        </TableCell>\r\n                        <TableCell className=\"font-medium\">\r\n                          {order.patient.lastName} {order.patient.firstName}\r\n                        </TableCell>\r\n                        <TableCell>\r\n                          <span className=\"inline-flex items-center gap-1 rounded-md bg-slate-100 px-2 py-0.5 text-xs font-medium text-slate-700 dark:bg-slate-700 dark:text-slate-300\">\r\n                            <Building2 className=\"h-3 w-3\" />\r\n                            {branchName}\r\n                          </span>\r\n                        </TableCell>\r\n                        <TableCell>\r\n                          <span className={`inline-flex rounded-md px-2 py-0.5 text-xs font-medium ${statusColors[order.status] ?? \"bg-slate-100 text-slate-700\"}`}>\r\n                            {statusLabels[order.status] ?? order.status}\r\n                          </span>\r\n                        </TableCell>\r\n                        <TableCell className=\"text-right font-semibold\">\r\n                          {formatCurrency(Number(order.totalPrice))}\r\n                        </TableCell>\r\n                      </TableRow>\r\n                    );\r\n                  })}\r\n                </TableBody>\r\n              </Table>\r\n            </div>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Análisis más solicitados */}\r\n      <Card>\r\n        <CardHeader className=\"pb-3\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <BarChart3 className=\"h-4 w-4 text-slate-500\" />\r\n            <CardTitle className=\"text-base\">Análisis más solicitados</CardTitle>\r\n          </div>\r\n          <p className=\"text-sm text-slate-500 mt-1\">\r\n            {statusFilter === \"ENTREGADO\"\r\n              ? \"Análisis de órdenes entregadas en el período (por fecha de entrega).\"\r\n              : \"Ordenados por cantidad. Filtrado por fechas seleccionadas.\"}\r\n          </p>\r\n        </CardHeader>\r\n        <CardContent>\r\n          {sortedAnalisis.length === 0 ? (\r\n            <div className=\"py-8 text-center\">\r\n              <BarChart3 className=\"h-12 w-12 text-slate-300 dark:text-slate-600 mx-auto mb-3\" />\r\n              <p className=\"text-slate-500 dark:text-slate-400\">No hay solicitudes en el período.</p>\r\n              <p className=\"text-sm mt-1 text-slate-400 dark:text-slate-500\">\r\n                Ajusta el rango de fechas o{\" \"}\r\n                <Link href=\"/orders\" className=\"text-blue-600 hover:underline dark:text-blue-400\">\r\n                  revisa las órdenes\r\n                </Link>\r\n                .\r\n              </p>\r\n            </div>\r\n          ) : (\r\n            <div className=\"overflow-x-auto rounded-lg border border-slate-200 dark:border-slate-700\">\r\n              <Table>\r\n                <TableHeader>\r\n                  <TableRow className=\"bg-slate-50 dark:bg-slate-800/50\">\r\n                    <TableHead className=\"w-12 font-semibold\">#</TableHead>\r\n                    <TableHead className=\"font-semibold\">Código</TableHead>\r\n                    <TableHead className=\"font-semibold\">Análisis</TableHead>\r\n                    <TableHead className=\"font-semibold\">Sección</TableHead>\r\n                    <TableHead className=\"text-right w-24 font-semibold\">Cantidad</TableHead>\r\n                    <TableHead className=\"text-right w-32 font-semibold\">Porcentaje</TableHead>\r\n                  </TableRow>\r\n                </TableHeader>\r\n                <TableBody>\r\n                  {sortedAnalisis.map((row, idx) => {\r\n                    const pct = totalSolicitudes > 0\r\n                      ? ((row.count / totalSolicitudes) * 100).toFixed(1)\r\n                      : \"0\";\r\n                    const pctNum = parseFloat(pct);\r\n                    return (\r\n                      <TableRow key={row.code} className=\"hover:bg-slate-50 dark:hover:bg-slate-800/30\">\r\n                        <TableCell>\r\n                          <span className={`inline-flex h-6 w-6 items-center justify-center rounded-full text-xs font-medium ${\r\n                            idx < 3\r\n                              ? \"bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400\"\r\n                              : \"bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-400\"\r\n                          }`}>\r\n                            {idx + 1}\r\n                          </span>\r\n                        </TableCell>\r\n                        <TableCell>\r\n                          <code className=\"rounded bg-slate-100 px-1.5 py-0.5 text-xs font-mono text-slate-700 dark:bg-slate-700 dark:text-slate-300\">\r\n                            {row.code}\r\n                          </code>\r\n                        </TableCell>\r\n                        <TableCell className=\"font-medium\">{row.name}</TableCell>\r\n                        <TableCell>\r\n                          <div className=\"flex items-center gap-2\">\r\n                            <span className=\"inline-flex rounded-md bg-purple-100 px-2 py-0.5 text-xs font-medium text-purple-700 dark:bg-purple-900/30 dark:text-purple-400\">\r\n                              {row.section}\r\n                            </span>\r\n                            {row.isReferred && (\r\n                              <span className=\"inline-flex items-center gap-1 rounded-md bg-amber-100 px-2 py-0.5 text-xs font-medium text-amber-700 dark:bg-amber-900/30 dark:text-amber-400\">\r\n                                <FlaskConical className=\"h-3 w-3\" />\r\n                                Referido\r\n                              </span>\r\n                            )}\r\n                          </div>\r\n                        </TableCell>\r\n                        <TableCell className=\"text-right\">\r\n                          <span className=\"font-bold text-slate-900 dark:text-slate-100\">{row.count}</span>\r\n                        </TableCell>\r\n                        <TableCell className=\"text-right\">\r\n                          <div className=\"flex items-center justify-end gap-2\">\r\n                            <div className=\"h-2 w-16 overflow-hidden rounded-full bg-slate-200 dark:bg-slate-700\">\r\n                              <div\r\n                                className=\"h-full rounded-full bg-blue-500 dark:bg-blue-400\"\r\n                                style={{ width: `${Math.min(pctNum, 100)}%` }}\r\n                              />\r\n                            </div>\r\n                            <span className=\"text-sm text-slate-600 dark:text-slate-400 w-12 text-right\">{pct}%</span>\r\n                          </div>\r\n                        </TableCell>\r\n                      </TableRow>\r\n                    );\r\n                  })}\r\n                </TableBody>\r\n              </Table>\r\n            </div>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\(app)\\results\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\(app)\\templates\\[id]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\(app)\\templates\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\admisiones\\[id]\\convert\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\admisiones\\[id]\\purge\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\admisiones\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\admisiones\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":38,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":38,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1672,1675],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1672,1675],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":258,"column":85,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":258,"endColumn":88,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9954,9957],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9954,9957],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\";\r\nimport { getServerSession } from \"next-auth\";\r\nimport type { Prisma } from \"@prisma/client\";\r\n\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport { logger } from \"@/lib/logger\";\r\nimport { authOptions, hasPermission, PERMISSION_AJUSTAR_PRECIO_ADMISION, PERMISSION_GESTIONAR_ADMISION, PERMISSION_VER_ADMISION } from \"@/lib/auth\";\r\nimport { admissionCreateSchema } from \"@/features/lab/schemas\";\r\nimport { generateNextPatientCode } from \"@/lib/patient-code\";\r\nimport {\r\n  admissionCodePrefixForDate,\r\n  buildAdmissionCode,\r\n  parseOrderCodeSequence,\r\n} from \"@/features/lab/order-utils\";\r\nimport { convertAdmissionToOrder } from \"@/features/lab/convert-admission-to-order\";\r\n\r\nfunction canViewOrManageAdmission(session: Awaited<ReturnType<typeof getServerSession>>) {\r\n  return hasPermission(session ?? null, PERMISSION_VER_ADMISION) || hasPermission(session ?? null, PERMISSION_GESTIONAR_ADMISION);\r\n}\r\n\r\nexport async function GET(request: Request) {\r\n  const session = await getServerSession(authOptions);\r\n  if (!session?.user) {\r\n    return NextResponse.json({ error: \"No autorizado\" }, { status: 401 });\r\n  }\r\n  if (!canViewOrManageAdmission(session)) {\r\n    return NextResponse.json({ error: \"Sin permiso para ver admisiones\" }, { status: 403 });\r\n  }\r\n\r\n  try {\r\n    const { searchParams } = new URL(request.url);\r\n    const status = searchParams.get(\"status\")?.trim() || \"\";\r\n    const search = searchParams.get(\"search\")?.trim() || \"\";\r\n    const patientId = searchParams.get(\"patientId\")?.trim() || \"\";\r\n\r\n    const items = await prisma.admissionRequest.findMany({\r\n      where: {\r\n        ...(status ? { status: status as any } : {}),\r\n        ...(patientId ? { patientId } : {}),\r\n        ...(search\r\n          ? {\r\n              OR: [\r\n                { requestCode: { contains: search, mode: \"insensitive\" } },\r\n                { patient: { dni: { contains: search, mode: \"insensitive\" } } },\r\n                { patient: { firstName: { contains: search, mode: \"insensitive\" } } },\r\n                { patient: { lastName: { contains: search, mode: \"insensitive\" } } },\r\n              ],\r\n            }\r\n          : {}),\r\n      },\r\n      include: {\r\n        patient: true,\r\n        branch: true,\r\n        items: { include: { labTest: { include: { section: true } } }, orderBy: { order: \"asc\" } },\r\n      },\r\n      orderBy: { createdAt: \"desc\" },\r\n      take: 500,\r\n    });\r\n\r\n    return NextResponse.json({ items });\r\n  } catch (error) {\r\n    logger.error(\"Error fetching admissions:\", error);\r\n    return NextResponse.json({ error: \"Error al obtener admisiones\" }, { status: 500 });\r\n  }\r\n}\r\n\r\nexport async function POST(request: Request) {\r\n  const session = await getServerSession(authOptions);\r\n  if (!session?.user) {\r\n    return NextResponse.json({ error: \"No autorizado\" }, { status: 401 });\r\n  }\r\n  if (!hasPermission(session, PERMISSION_GESTIONAR_ADMISION)) {\r\n    return NextResponse.json({ error: \"Sin permiso para crear admisiones\" }, { status: 403 });\r\n  }\r\n\r\n  try {\r\n    const body = await request.json();\r\n    const parsed = admissionCreateSchema.parse(body);\r\n\r\n    let patientId: string;\r\n    if (parsed.patientId) {\r\n      const existing = await prisma.patient.findFirst({\r\n        where: { id: parsed.patientId, deletedAt: null },\r\n      });\r\n      if (!existing) {\r\n        return NextResponse.json({ error: \"Paciente no encontrado\" }, { status: 400 });\r\n      }\r\n      patientId = existing.id;\r\n    } else if (parsed.patientDraft) {\r\n      const draft = parsed.patientDraft;\r\n      const code = await generateNextPatientCode();\r\n      const patient = await prisma.patient.create({\r\n        data: {\r\n          code,\r\n          dni: draft.dni.trim(),\r\n          firstName: draft.firstName.trim().toUpperCase(),\r\n          lastName: draft.lastName.trim().toUpperCase(),\r\n          birthDate: new Date(draft.birthDate),\r\n          sex: draft.sex,\r\n        },\r\n      });\r\n      patientId = patient.id;\r\n    } else {\r\n      return NextResponse.json({ error: \"Se requiere patientId o patientDraft\" }, { status: 400 });\r\n    }\r\n\r\n    const fullInclude = {\r\n      template: {\r\n        include: {\r\n          items: {\r\n            include: { refRanges: { orderBy: { order: \"asc\" as const } } },\r\n            orderBy: { order: \"asc\" as const },\r\n          },\r\n        },\r\n      },\r\n    } as const;\r\n    type TestWithTemplate = Prisma.LabTestGetPayload<{ include: typeof fullInclude }>;\r\n\r\n    type AdmissionItemPayload = {\r\n      test: TestWithTemplate;\r\n      priceBase: number;\r\n    };\r\n    const itemPayload: AdmissionItemPayload[] = [];\r\n    const fromProfileTestIds = new Set<string>();\r\n\r\n    if (parsed.profileIds.length > 0) {\r\n      const profiles = await prisma.testProfile.findMany({\r\n        where: { id: { in: parsed.profileIds }, isActive: true },\r\n        include: {\r\n          items: {\r\n            orderBy: { order: \"asc\" },\r\n            include: { labTest: { include: fullInclude } },\r\n          },\r\n        },\r\n      });\r\n      for (const profile of profiles) {\r\n        const profileTests = profile.items.map((i) => i.labTest).filter(Boolean);\r\n        if (profileTests.length === 0) continue;\r\n        const priceEach =\r\n          profile.packagePrice != null ? Number(profile.packagePrice) / profileTests.length : null;\r\n        for (const test of profileTests) {\r\n          itemPayload.push({\r\n            test,\r\n            priceBase: priceEach ?? Number(test.price),\r\n          });\r\n          fromProfileTestIds.add(test.id);\r\n        }\r\n      }\r\n    }\r\n\r\n    const individualTestIds = parsed.tests.filter((id) => !fromProfileTestIds.has(id));\r\n    if (individualTestIds.length > 0) {\r\n      const individualTests = await prisma.labTest.findMany({\r\n        where: { id: { in: individualTestIds }, deletedAt: null, isActive: true },\r\n        include: fullInclude,\r\n      });\r\n      for (const test of individualTests) {\r\n        itemPayload.push({ test, priceBase: Number(test.price) });\r\n      }\r\n    }\r\n\r\n    if (itemPayload.length === 0) {\r\n      return NextResponse.json({ error: \"No hay análisis válidos\" }, { status: 400 });\r\n    }\r\n\r\n    const canAdjust = hasPermission(session, PERMISSION_AJUSTAR_PRECIO_ADMISION);\r\n    const adjustments = new Map(\r\n      parsed.itemAdjustments.map((adj) => [adj.testId, { priceApplied: adj.priceApplied, reason: adj.adjustmentReason ?? null }]),\r\n    );\r\n\r\n    const itemsPrepared = itemPayload.map((item, index) => {\r\n      const adjustment = adjustments.get(item.test.id);\r\n      const priceApplied = adjustment?.priceApplied ?? item.priceBase;\r\n      if (!canAdjust && Math.abs(priceApplied - item.priceBase) > 0.0001) {\r\n        throw new Error(\"NO_PERMISSION_ADJUSTMENT\");\r\n      }\r\n      return {\r\n        labTestId: item.test.id,\r\n        order: index,\r\n        priceBase: item.priceBase,\r\n        priceApplied,\r\n        adjustmentReason: adjustment?.reason ?? null,\r\n      };\r\n    });\r\n\r\n    const totalPrice = itemsPrepared.reduce((acc, item) => acc + item.priceApplied, 0);\r\n\r\n    const todayStart = new Date();\r\n    todayStart.setHours(0, 0, 0, 0);\r\n    const prefix = admissionCodePrefixForDate(todayStart);\r\n\r\n    let admission: Awaited<ReturnType<typeof prisma.admissionRequest.create>>;\r\n    for (let attempt = 0; attempt < 3; attempt++) {\r\n      const existing = await prisma.admissionRequest.findMany({\r\n        where: { requestCode: { startsWith: prefix } },\r\n        select: { requestCode: true },\r\n      });\r\n      const maxSeq = Math.max(0, ...existing.map((row) => parseOrderCodeSequence(row.requestCode)));\r\n      const requestCode = buildAdmissionCode(maxSeq + 1, todayStart);\r\n\r\n      try {\r\n        admission = await prisma.admissionRequest.create({\r\n          data: {\r\n            requestCode,\r\n            patientId,\r\n            requestedBy: parsed.requestedBy ?? null,\r\n            notes: parsed.notes ?? null,\r\n            patientType: parsed.patientType ?? null,\r\n            branchId: parsed.branchId ?? null,\r\n            status: \"PENDIENTE\",\r\n            totalPrice,\r\n            createdById: session.user.id ?? null,\r\n            items: { createMany: { data: itemsPrepared } },\r\n          },\r\n          include: {\r\n            patient: true,\r\n            branch: true,\r\n            items: { include: { labTest: true }, orderBy: { order: \"asc\" } },\r\n          },\r\n        });\r\n\r\n        // Conversión automática: crear orden de laboratorio y marcar pre-orden como convertida\r\n        let convertedOrder: { orderId: string; orderCode: string } | null = null;\r\n        try {\r\n          convertedOrder = await convertAdmissionToOrder(admission.id);\r\n        } catch (convertErr) {\r\n          logger.error(\"Error en conversión automática de pre-orden a orden:\", convertErr);\r\n          // La pre-orden ya quedó creada; el usuario puede convertirla manualmente desde la bandeja\r\n        }\r\n\r\n        return NextResponse.json(\r\n          {\r\n            item: admission,\r\n            convertedOrder: convertedOrder ?? undefined,\r\n          },\r\n          { status: 201 },\r\n        );\r\n      } catch (err) {\r\n        const isUnique =\r\n          err && typeof err === \"object\" && \"code\" in err && (err as { code: string }).code === \"P2002\";\r\n        if (isUnique && attempt < 2) continue;\r\n        throw err;\r\n      }\r\n    }\r\n\r\n    return NextResponse.json({ error: \"No se pudo generar el código de admisión\" }, { status: 500 });\r\n  } catch (error) {\r\n    logger.error(\"Error creating admission:\", error);\r\n    if (error instanceof Error && error.message === \"NO_PERMISSION_ADJUSTMENT\") {\r\n      return NextResponse.json(\r\n        { error: \"No tienes permiso para ajustar precios puntuales en admisión\" },\r\n        { status: 403 },\r\n      );\r\n    }\r\n    if (error instanceof Error && error.name === \"ZodError\") {\r\n      return NextResponse.json({ error: \"Datos inválidos\", details: error }, { status: 400 });\r\n    }\r\n    if (typeof error === \"object\" && error !== null && \"code\" in error && (error as any).code === \"P2002\") {\r\n      return NextResponse.json({ error: \"Ya existe un paciente con ese DNI.\" }, { status: 409 });\r\n    }\r\n    return NextResponse.json({ error: \"Error al crear la pre-orden de admisión\" }, { status: 500 });\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\auth\\[...nextauth]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\config\\branches\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\config\\branches\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\config\\preanaliticos\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\config\\preanaliticos\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\config\\print\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\config\\print\\upload\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\config\\users\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\config\\users\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\favorites\\tests\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\health\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\notifications\\[id]\\read\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\notifications\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\orders\\[id]\\items\\[itemId]\\referred-lab\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\orders\\[id]\\items\\[itemId]\\result-draft\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'saved' is assigned a value but never used.","line":31,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":31,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\";\r\n\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport { resultDraftSchema } from \"@/features/lab/schemas\";\r\nimport { getServerSession } from \"next-auth\";\r\nimport { authOptions } from \"@/lib/auth\";\r\nimport { logger } from \"@/lib/logger\";\r\n\r\ntype Params = { params: Promise<{ id: string; itemId: string }> };\r\n\r\nexport async function PUT(request: Request, { params }: Params) {\r\n  const session = await getServerSession(authOptions);\r\n  if (!session?.user) {\r\n    return NextResponse.json({ error: \"No autorizado\" }, { status: 401 });\r\n  }\r\n\r\n  try {\r\n    const { id: orderId, itemId } = await params;\r\n    const payload = await request.json();\r\n    const parsed = resultDraftSchema.parse(payload);\r\n\r\n    const orderItem = await prisma.labOrderItem.findFirst({\r\n      where: { id: itemId, orderId },\r\n      include: { result: true },\r\n    });\r\n\r\n    if (!orderItem) {\r\n      return NextResponse.json({ error: \"Item no encontrado\" }, { status: 404 });\r\n    }\r\n\r\n    const saved = await prisma.$transaction(async (tx) => {\r\n      let result = orderItem.result;\r\n      if (!result) {\r\n        result = await tx.labResult.create({\r\n          data: {\r\n            orderItemId: orderItem.id,\r\n            isDraft: true,\r\n          },\r\n        });\r\n      }\r\n\r\n      await tx.labResultItem.deleteMany({ where: { resultId: result.id } });\r\n      await tx.labResultItem.createMany({\r\n        data: parsed.items.map((item) => ({\r\n          resultId: result!.id,\r\n          templateItemId: item.templateItemId ?? null,\r\n          paramNameSnapshot: item.paramNameSnapshot,\r\n          unitSnapshot: item.unitSnapshot ?? null,\r\n          refTextSnapshot: item.refTextSnapshot ?? null,\r\n          refMinSnapshot: item.refMinSnapshot ?? null,\r\n          refMaxSnapshot: item.refMaxSnapshot ?? null,\r\n          value: item.value,\r\n          isOutOfRange: item.isOutOfRange ?? false,\r\n          order: item.order,\r\n        })),\r\n      });\r\n\r\n      return tx.labResult.update({\r\n        where: { id: result.id },\r\n        data: { isDraft: true, updatedAt: new Date() },\r\n      });\r\n    });\r\n\r\n    const savedAt = new Date();\r\n    return NextResponse.json({\r\n      savedAt: savedAt.toISOString(),\r\n      isDraft: true,\r\n    });\r\n  } catch (error) {\r\n    logger.error(\"Error saving draft:\", error);\r\n    if (error instanceof Error && error.name === \"ZodError\") {\r\n      return NextResponse.json(\r\n        { error: \"Datos inválidos\", details: error },\r\n        { status: 400 }\r\n      );\r\n    }\r\n    return NextResponse.json(\r\n      { error: \"Error al guardar borrador\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\orders\\[id]\\items\\[itemId]\\result\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\orders\\[id]\\items\\[itemId]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\orders\\[id]\\items\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\orders\\[id]\\payments\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\orders\\[id]\\referred-lab-payments\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\orders\\[id]\\repeat\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\orders\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\orders\\[id]\\validate\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\orders\\pending-payments\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\orders\\quick\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\orders\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\patients\\[id]\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_code' is assigned a value but never used.","line":48,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":48,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\";\r\n\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport { patientSchema } from \"@/features/lab/schemas\";\r\nimport {\r\n  requirePermission,\r\n  PERMISSION_EDITAR_PACIENTES,\r\n  PERMISSION_ELIMINAR_REGISTROS,\r\n  getServerSession,\r\n} from \"@/lib/auth\";\r\nimport { logger } from \"@/lib/logger\";\r\n\r\ntype Params = { params: Promise<{ id: string }> };\r\n\r\nexport async function GET(_request: Request, { params }: Params) {\r\n  const session = await getServerSession();\r\n  if (!session?.user) {\r\n    return NextResponse.json({ error: \"No autorizado\" }, { status: 401 });\r\n  }\r\n\r\n  try {\r\n    const { id } = await params;\r\n    const item = await prisma.patient.findFirst({\r\n      where: { id, deletedAt: null },\r\n    });\r\n\r\n    if (!item) {\r\n      return NextResponse.json({ error: \"Paciente no encontrado\" }, { status: 404 });\r\n    }\r\n\r\n    return NextResponse.json({ item });\r\n  } catch (error) {\r\n    logger.error(\"Error fetching patient:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Error al obtener paciente\" },\r\n      { status: 500 },\r\n    );\r\n  }\r\n}\r\n\r\nexport async function PUT(request: Request, { params }: Params) {\r\n  const auth = await requirePermission(PERMISSION_EDITAR_PACIENTES);\r\n  if (auth.response) return auth.response;\r\n  try {\r\n    const { id } = await params;\r\n    const payload = await request.json();\r\n    const parsed = patientSchema.parse(payload);\r\n    const { code: _code, ...rest } = parsed;\r\n    const firstName = rest.firstName.trim().toUpperCase();\r\n    const lastName = rest.lastName.trim().toUpperCase();\r\n\r\n    const { createdAt: createdAtStr, ...restWithoutCreatedAt } = rest;\r\n    const updateData: Record<string, unknown> = {\r\n      ...restWithoutCreatedAt,\r\n      firstName,\r\n      lastName,\r\n      birthDate: new Date(rest.birthDate),\r\n      phone: rest.phone || null,\r\n      address: rest.address || null,\r\n      email: rest.email || null,\r\n    };\r\n    if (createdAtStr && createdAtStr.trim()) {\r\n      updateData.createdAt = new Date(createdAtStr);\r\n    }\r\n    const item = await prisma.patient.update({\r\n      where: { id },\r\n      data: updateData as Parameters<typeof prisma.patient.update>[0][\"data\"],\r\n    });\r\n\r\n    return NextResponse.json({ item });\r\n  } catch (error) {\r\n    logger.error(\"Error updating patient:\", error);\r\n    if (error instanceof Error && error.name === \"ZodError\") {\r\n      return NextResponse.json(\r\n        { error: \"Datos inválidos\", details: error },\r\n        { status: 400 },\r\n      );\r\n    }\r\n    if (error instanceof Error && error.message.includes(\"Record to update not found\")) {\r\n      return NextResponse.json({ error: \"Paciente no encontrado\" }, { status: 404 });\r\n    }\r\n    return NextResponse.json(\r\n      { error: \"Error al actualizar paciente\" },\r\n      { status: 500 },\r\n    );\r\n  }\r\n}\r\n\r\nexport async function DELETE(_request: Request, { params }: Params) {\r\n  const auth = await requirePermission(PERMISSION_ELIMINAR_REGISTROS);\r\n  if (auth.response) return auth.response;\r\n  try {\r\n    const { id } = await params;\r\n    const item = await prisma.patient.update({\r\n      where: { id },\r\n      data: { deletedAt: new Date() },\r\n    });\r\n\r\n    return NextResponse.json({ item });\r\n  } catch (error) {\r\n    logger.error(\"Error deleting patient:\", error);\r\n    if (error instanceof Error && error.message.includes(\"Record to update not found\")) {\r\n      return NextResponse.json({ error: \"Paciente no encontrado\" }, { status: 404 });\r\n    }\r\n    return NextResponse.json(\r\n      { error: \"Error al eliminar paciente\" },\r\n      { status: 500 },\r\n    );\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\patients\\next-code\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\patients\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":93,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":93,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2895,2898],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2895,2898],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\";\r\n\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport { patientSchema } from \"@/features/lab/schemas\";\r\nimport { generateNextPatientCode } from \"@/lib/patient-code\";\r\nimport { getServerSession } from \"next-auth\";\r\nimport { authOptions } from \"@/lib/auth\";\r\nimport { logger } from \"@/lib/logger\";\r\n\r\nexport async function GET(request: Request) {\r\n  const session = await getServerSession(authOptions);\r\n  if (!session?.user) {\r\n    return NextResponse.json({ error: \"No autorizado\" }, { status: 401 });\r\n  }\r\n\r\n  try {\r\n    const { searchParams } = new URL(request.url);\r\n    const search = searchParams.get(\"search\")?.trim();\r\n\r\n    const items = await prisma.patient.findMany({\r\n      where: {\r\n        deletedAt: null,\r\n        ...(search\r\n          ? {\r\n              OR: [\r\n                { firstName: { contains: search } },\r\n                { lastName: { contains: search } },\r\n                { dni: { contains: search } },\r\n                { code: { contains: search } },\r\n              ],\r\n            }\r\n          : {}),\r\n      },\r\n      orderBy: { createdAt: \"desc\" },\r\n    });\r\n\r\n    return NextResponse.json({ items });\r\n  } catch (error) {\r\n    logger.error(\"Error fetching patients:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Error al obtener pacientes\" },\r\n      { status: 500 },\r\n    );\r\n  }\r\n}\r\n\r\nexport async function POST(request: Request) {\r\n  const session = await getServerSession(authOptions);\r\n  if (!session?.user) {\r\n    return NextResponse.json({ error: \"No autorizado\" }, { status: 401 });\r\n  }\r\n\r\n  try {\r\n    const payload = await request.json();\r\n    const parsed = patientSchema.parse(payload);\r\n\r\n    const code = await generateNextPatientCode();\r\n    const firstName = parsed.firstName.trim().toUpperCase();\r\n    const lastName = parsed.lastName.trim().toUpperCase();\r\n\r\n    const createData: Parameters<typeof prisma.patient.create>[0][\"data\"] = {\r\n      code,\r\n      dni: parsed.dni.trim(),\r\n      firstName,\r\n      lastName,\r\n      birthDate: new Date(parsed.birthDate),\r\n      sex: parsed.sex,\r\n      phone: parsed.phone || null,\r\n      address: parsed.address || null,\r\n      email: parsed.email || null,\r\n    };\r\n    if (parsed.createdAt && parsed.createdAt.trim()) {\r\n      createData.createdAt = new Date(parsed.createdAt);\r\n    }\r\n    const item = await prisma.patient.create({\r\n      data: createData,\r\n    });\r\n\r\n    return NextResponse.json({ item });\r\n  } catch (error) {\r\n    logger.error(\"Error creating patient:\", error);\r\n    if (error instanceof Error && error.name === \"ZodError\") {\r\n      return NextResponse.json(\r\n        { error: \"Datos inválidos\", details: error },\r\n        { status: 400 },\r\n      );\r\n    }\r\n    // Prisma: clave única (por ejemplo, DNI duplicado)\r\n    if (\r\n      typeof error === \"object\" &&\r\n      error !== null &&\r\n      \"code\" in error &&\r\n      (error as any).code === \"P2002\"\r\n    ) {\r\n      return NextResponse.json(\r\n        { error: \"Ya existe un paciente registrado con ese DNI.\" },\r\n        { status: 409 },\r\n      );\r\n    }\r\n    const message =\r\n      error instanceof Error ? error.message : \"Error al crear paciente\";\r\n    return NextResponse.json({ error: message }, { status: 500 });\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\pending\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\queue\\next\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\referred-labs\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\referred-labs\\[id]\\upload\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\referred-labs\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\reportes\\export\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\roles\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\roles\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\search\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\sections\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\sections\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\templates\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\templates\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\test-profiles\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\test-profiles\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\tests\\[id]\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'updated' is assigned a value but never used.","line":70,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":70,"endColumn":20}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\";\r\n\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport { labTestSchema } from \"@/features/lab/schemas\";\r\nimport { getServerSession } from \"next-auth\";\r\nimport {\r\n  authOptions,\r\n  hasPermission,\r\n  PERMISSION_EDITAR_PRECIO_CATALOGO,\r\n  PERMISSION_GESTIONAR_CATALOGO,\r\n} from \"@/lib/auth\";\r\nimport { logger } from \"@/lib/logger\";\r\n\r\ntype Params = { params: Promise<{ id: string }> };\r\n\r\nexport async function GET(_request: Request, { params }: Params) {\r\n  // GET puede ser público para ver detalles de análisis\r\n  try {\r\n    const { id } = await params;\r\n    const item = await prisma.labTest.findFirst({\r\n      where: { id, deletedAt: null },\r\n      include: { section: true, referredLab: true },\r\n    });\r\n\r\n    if (!item) {\r\n      return NextResponse.json({ error: \"Análisis no encontrado\" }, { status: 404 });\r\n    }\r\n\r\n    return NextResponse.json({ item });\r\n  } catch (error) {\r\n    logger.error(\"Error fetching test:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Error al obtener análisis\" },\r\n      { status: 500 },\r\n    );\r\n  }\r\n}\r\n\r\nexport async function PUT(request: Request, { params }: Params) {\r\n  const session = await getServerSession(authOptions);\r\n  if (!session?.user) {\r\n    return NextResponse.json({ error: \"No autorizado\" }, { status: 401 });\r\n  }\r\n  if (!hasPermission(session, PERMISSION_GESTIONAR_CATALOGO)) {\r\n    return NextResponse.json({ error: \"Sin permiso para actualizar análisis\" }, { status: 403 });\r\n  }\r\n\r\n  try {\r\n    const { id } = await params;\r\n    const payload = await request.json();\r\n    const parsed = labTestSchema.parse(payload);\r\n    const current = await prisma.labTest.findUnique({\r\n      where: { id },\r\n      select: { price: true },\r\n    });\r\n    if (!current) {\r\n      return NextResponse.json({ error: \"Análisis no encontrado\" }, { status: 404 });\r\n    }\r\n    const requestedPrice = Number(parsed.price);\r\n    const currentPrice = Number(current.price);\r\n    const priceChanged = Math.abs(requestedPrice - currentPrice) > 0.0001;\r\n    if (priceChanged && !hasPermission(session, PERMISSION_EDITAR_PRECIO_CATALOGO)) {\r\n      return NextResponse.json(\r\n        { error: \"No tienes permiso para editar el precio global del catálogo.\" },\r\n        { status: 403 },\r\n      );\r\n    }\r\n\r\n    const item = await prisma.$transaction(async (tx) => {\r\n      const updated = await tx.labTest.update({\r\n        where: { id },\r\n        data: {\r\n          code: parsed.code,\r\n          name: parsed.name,\r\n          sectionId: parsed.sectionId,\r\n          price: parsed.price,\r\n          estimatedTimeMinutes: parsed.estimatedTimeMinutes ?? null,\r\n          isActive: parsed.isActive ?? true,\r\n          isReferred: parsed.isReferred ?? false,\r\n          // Legacy: mantener compatibilidad\r\n          referredLabId: parsed.referredLabId ?? null,\r\n          priceToAdmission: parsed.priceToAdmission ?? null,\r\n          externalLabCost: parsed.externalLabCost ?? null,\r\n        },\r\n      });\r\n\r\n      // Reemplazar opciones de labs referidos\r\n      const options = (parsed.referredLabOptions ?? []).filter(\r\n        (opt) => opt.referredLabId,\r\n      );\r\n      await tx.labTestReferredLab.deleteMany({\r\n        where: { labTestId: id },\r\n      });\r\n      if (options.length > 0) {\r\n        const anyDefault = options.some((o) => o.isDefault);\r\n        await tx.labTestReferredLab.createMany({\r\n          data: options.map((opt, idx) => ({\r\n            labTestId: id,\r\n            referredLabId: opt.referredLabId!,\r\n            priceToAdmission:\r\n              opt.priceToAdmission ??\r\n              parsed.priceToAdmission ??\r\n              parsed.price ??\r\n              0,\r\n            externalLabCost: opt.externalLabCost ?? null,\r\n            isDefault: anyDefault ? !!opt.isDefault : idx === 0,\r\n          })),\r\n        });\r\n        const defaultOpt =\r\n          options.find((o) => o.isDefault) ?? options[0];\r\n        await tx.labTest.update({\r\n          where: { id },\r\n          data: {\r\n            referredLabId: defaultOpt.referredLabId!,\r\n            priceToAdmission:\r\n              defaultOpt.priceToAdmission ??\r\n              parsed.priceToAdmission ??\r\n              parsed.price ??\r\n              0,\r\n            externalLabCost: defaultOpt.externalLabCost ?? null,\r\n            isReferred: true,\r\n          },\r\n        });\r\n      }\r\n\r\n      return tx.labTest.findUniqueOrThrow({\r\n        where: { id },\r\n        include: { section: true, referredLab: true },\r\n      });\r\n    });\r\n\r\n    return NextResponse.json({ item });\r\n  } catch (error) {\r\n    logger.error(\"Error updating test:\", error);\r\n    if (error instanceof Error && error.name === \"ZodError\") {\r\n      return NextResponse.json(\r\n        { error: \"Datos inválidos\", details: error },\r\n        { status: 400 },\r\n      );\r\n    }\r\n    if (error instanceof Error && error.message.includes(\"Record to update not found\")) {\r\n      return NextResponse.json({ error: \"Análisis no encontrado\" }, { status: 404 });\r\n    }\r\n    return NextResponse.json(\r\n      { error: \"Error al actualizar análisis\" },\r\n      { status: 500 },\r\n    );\r\n  }\r\n}\r\n\r\nexport async function DELETE(_request: Request, { params }: Params) {\r\n  const session = await getServerSession(authOptions);\r\n  if (!session?.user) {\r\n    return NextResponse.json({ error: \"No autorizado\" }, { status: 401 });\r\n  }\r\n  if (!hasPermission(session, PERMISSION_GESTIONAR_CATALOGO)) {\r\n    return NextResponse.json({ error: \"Sin permiso para eliminar análisis\" }, { status: 403 });\r\n  }\r\n\r\n  try {\r\n    const { id } = await params;\r\n    const item = await prisma.labTest.update({\r\n      where: { id },\r\n      data: { deletedAt: new Date(), isActive: false },\r\n    });\r\n\r\n    return NextResponse.json({ item });\r\n  } catch (error) {\r\n    logger.error(\"Error deleting test:\", error);\r\n    if (error instanceof Error && error.message.includes(\"Record to update not found\")) {\r\n      return NextResponse.json({ error: \"Análisis no encontrado\" }, { status: 404 });\r\n    }\r\n    return NextResponse.json(\r\n      { error: \"Error al eliminar análisis\" },\r\n      { status: 500 },\r\n    );\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\api\\tests\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":130,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":130,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4564,4567],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4564,4567],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\";\r\n\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport { labTestSchema } from \"@/features/lab/schemas\";\r\nimport { getServerSession } from \"next-auth\";\r\nimport { authOptions, hasPermission, PERMISSION_GESTIONAR_CATALOGO } from \"@/lib/auth\";\r\nimport { logger } from \"@/lib/logger\";\r\n\r\nexport async function GET(request: Request) {\r\n  // GET puede ser público para ver catálogo de análisis\r\n  try {\r\n    const { searchParams } = new URL(request.url);\r\n    const search = searchParams.get(\"search\")?.trim();\r\n\r\n    const activeOnly = searchParams.get(\"active\") === \"true\";\r\n    const items = await prisma.labTest.findMany({\r\n      where: {\r\n        deletedAt: null,\r\n        ...(activeOnly ? { isActive: true } : {}),\r\n        ...(search\r\n          ? {\r\n              OR: [\r\n                { name: { contains: search, mode: \"insensitive\" as const } },\r\n                { code: { contains: search, mode: \"insensitive\" as const } },\r\n              ],\r\n            }\r\n          : {}),\r\n      },\r\n      include: { section: true, referredLab: true },\r\n      orderBy: [{ section: { order: \"asc\" } }, { name: \"asc\" }],\r\n    });\r\n\r\n    return NextResponse.json({ items });\r\n  } catch (error) {\r\n    logger.error(\"Error fetching tests:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Error al obtener análisis\" },\r\n      { status: 500 },\r\n    );\r\n  }\r\n}\r\n\r\nexport async function POST(request: Request) {\r\n  const session = await getServerSession(authOptions);\r\n  if (!session?.user) {\r\n    return NextResponse.json({ error: \"No autorizado\" }, { status: 401 });\r\n  }\r\n  if (!hasPermission(session, PERMISSION_GESTIONAR_CATALOGO)) {\r\n    return NextResponse.json({ error: \"Sin permiso para crear análisis\" }, { status: 403 });\r\n  }\r\n\r\n  try {\r\n    const payload = await request.json();\r\n    const parsed = labTestSchema.parse(payload);\r\n\r\n    const item = await prisma.$transaction(async (tx) => {\r\n      const test = await tx.labTest.create({\r\n        data: {\r\n          code: parsed.code,\r\n          name: parsed.name,\r\n          sectionId: parsed.sectionId,\r\n          price: parsed.price,\r\n          estimatedTimeMinutes: parsed.estimatedTimeMinutes ?? null,\r\n          isActive: parsed.isActive ?? true,\r\n          isReferred: parsed.isReferred ?? false,\r\n          // Legacy: mantener un solo lab por test si se envía\r\n          referredLabId: parsed.referredLabId ?? null,\r\n          priceToAdmission: parsed.priceToAdmission ?? null,\r\n          externalLabCost: parsed.externalLabCost ?? null,\r\n        },\r\n      });\r\n\r\n      // Crear opciones de labs referidos si se enviaron\r\n      const options = (parsed.referredLabOptions ?? []).filter(\r\n        (opt) => opt.referredLabId,\r\n      );\r\n      if (options.length > 0) {\r\n        const anyDefault = options.some((o) => o.isDefault);\r\n        await tx.labTestReferredLab.createMany({\r\n          data: options.map((opt, idx) => ({\r\n            labTestId: test.id,\r\n            referredLabId: opt.referredLabId!,\r\n            priceToAdmission:\r\n              opt.priceToAdmission ??\r\n              parsed.priceToAdmission ??\r\n              parsed.price ??\r\n              0,\r\n            externalLabCost: opt.externalLabCost ?? null,\r\n            isDefault: anyDefault ? !!opt.isDefault : idx === 0,\r\n          })),\r\n        });\r\n        // Alinear el campo legacy con la opción por defecto\r\n        const defaultOpt =\r\n          options.find((o) => o.isDefault) ?? options[0];\r\n        await tx.labTest.update({\r\n          where: { id: test.id },\r\n          data: {\r\n            referredLabId: defaultOpt.referredLabId!,\r\n            priceToAdmission:\r\n              defaultOpt.priceToAdmission ??\r\n              parsed.priceToAdmission ??\r\n              parsed.price ??\r\n              0,\r\n            externalLabCost: defaultOpt.externalLabCost ?? null,\r\n            isReferred: true,\r\n          },\r\n        });\r\n      }\r\n\r\n      return tx.labTest.findUniqueOrThrow({\r\n        where: { id: test.id },\r\n        include: { section: true, referredLab: true },\r\n      });\r\n    });\r\n\r\n    return NextResponse.json({ item });\r\n  } catch (error) {\r\n    logger.error(\"Error creating test:\", error);\r\n    if (error instanceof Error && error.name === \"ZodError\") {\r\n      return NextResponse.json(\r\n        { error: \"Datos inválidos\", details: error },\r\n        { status: 400 },\r\n      );\r\n    }\r\n    // Prisma: clave única (por ejemplo, código de análisis duplicado)\r\n    if (\r\n      typeof error === \"object\" &&\r\n      error !== null &&\r\n      \"code\" in error &&\r\n      (error as any).code === \"P2002\"\r\n    ) {\r\n      return NextResponse.json(\r\n        { error: \"Ya existe un análisis con ese código.\" },\r\n        { status: 409 },\r\n      );\r\n    }\r\n    return NextResponse.json(\r\n      { error: \"Error al crear análisis\" },\r\n      { status: 500 },\r\n    );\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\error.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\global-error.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\login\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'router' is assigned a value but never used.","line":13,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":13,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { Suspense, useState } from \"react\";\r\nimport { signIn } from \"next-auth/react\";\r\nimport { useRouter, useSearchParams } from \"next/navigation\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { toast } from \"sonner\";\r\nimport { ThemeToggle } from \"@/components/layout/ThemeToggle\";\r\n\r\nfunction LoginForm() {\r\n  const router = useRouter();\r\n  const searchParams = useSearchParams();\r\n  const callbackUrl = searchParams.get(\"callbackUrl\") ?? \"/dashboard\";\r\n  const [email, setEmail] = useState(\"\");\r\n  const [password, setPassword] = useState(\"\");\r\n  const [loading, setLoading] = useState(false);\r\n\r\n  async function onSubmit(e: React.FormEvent) {\r\n    e.preventDefault();\r\n    setLoading(true);\r\n    try {\r\n      const res = await signIn(\"credentials\", {\r\n        email: email.trim().toLowerCase(),\r\n        password,\r\n        redirect: false,\r\n      });\r\n      if (res?.error) {\r\n        toast.error(\"Email o contraseña incorrectos\");\r\n        return;\r\n      }\r\n      if (!res?.ok) {\r\n        toast.error(\"No se pudo iniciar sesión. Revisa NEXTAUTH_URL y NEXTAUTH_SECRET en Vercel.\");\r\n        return;\r\n      }\r\n      // Redirección completa para que el middleware reciba la cookie de sesión\r\n      window.location.href = callbackUrl;\r\n      return;\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"relative flex min-h-screen items-center justify-center bg-slate-100 px-4 dark:bg-slate-900\">\r\n      <div className=\"absolute right-4 top-4\">\r\n        <ThemeToggle />\r\n      </div>\r\n      <div className=\"w-full max-w-sm space-y-8 rounded-xl border border-slate-200 bg-white p-8 shadow-sm dark:border-slate-700 dark:bg-slate-800\">\r\n        <div className=\"text-center\">\r\n          <h1 className=\"text-2xl font-semibold text-slate-900 dark:text-slate-100\">\r\n            Sistema de Laboratorio Clínico\r\n          </h1>\r\n          <p className=\"mt-1 text-sm text-slate-500 dark:text-slate-400\">\r\n            Inicia sesión para continuar\r\n          </p>\r\n        </div>\r\n        <form onSubmit={onSubmit} className=\"space-y-4\">\r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor=\"email\">Email</Label>\r\n            <Input\r\n              id=\"email\"\r\n              type=\"email\"\r\n              placeholder=\"usuario@laboratorio.com\"\r\n              value={email}\r\n              onChange={(e) => setEmail(e.target.value)}\r\n              required\r\n              autoComplete=\"email\"\r\n              disabled={loading}\r\n            />\r\n          </div>\r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor=\"password\">Contraseña</Label>\r\n            <Input\r\n              id=\"password\"\r\n              type=\"password\"\r\n              placeholder=\"••••••••\"\r\n              value={password}\r\n              onChange={(e) => setPassword(e.target.value)}\r\n              required\r\n              autoComplete=\"current-password\"\r\n              disabled={loading}\r\n            />\r\n          </div>\r\n          <Button type=\"submit\" className=\"w-full\" disabled={loading}>\r\n            {loading ? \"Entrando...\" : \"Iniciar sesión\"}\r\n          </Button>\r\n        </form>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default function LoginPage() {\r\n  return (\r\n    <Suspense fallback={\r\n      <div className=\"flex min-h-screen items-center justify-center bg-slate-100 dark:bg-slate-900\">\r\n        <div className=\"text-slate-500 dark:text-slate-400\">Cargando...</div>\r\n      </div>\r\n    }>\r\n      <LoginForm />\r\n    </Suspense>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\not-found.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\app\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\admisiones\\AdmissionActions.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\admisiones\\AdmissionForm.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":470,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":470,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18010,18013],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18010,18013],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useMemo, useState } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { toast } from \"sonner\";\r\nimport { calculateAge } from \"@/lib/template-helpers\";\r\nimport { toDateTimeLocal } from \"@/lib/format\";\r\nimport {\r\n  Search,\r\n  UserPlus,\r\n  Stethoscope,\r\n  FlaskConical,\r\n  Tag,\r\n  DollarSign,\r\n  Building2,\r\n  FileText,\r\n} from \"lucide-react\";\r\n\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\n\r\ntype PatientOption = {\r\n  id: string;\r\n  label: string;\r\n  dni: string;\r\n  firstName: string;\r\n  lastName: string;\r\n};\r\n\r\ntype TestOption = {\r\n  id: string;\r\n  code: string;\r\n  name: string;\r\n  sectionLabel: string;\r\n  price: number;\r\n};\r\n\r\ntype ProfileOption = {\r\n  id: string;\r\n  name: string;\r\n  packagePrice: number | null;\r\n  tests: { id: string; code: string; name: string; price: number }[];\r\n};\r\n\r\ntype BranchOption = {\r\n  id: string;\r\n  name: string;\r\n};\r\n\r\ntype Props = {\r\n  patients: PatientOption[];\r\n  tests: TestOption[];\r\n  profiles: ProfileOption[];\r\n  branches: BranchOption[];\r\n  canAdjustPrice: boolean;\r\n};\r\n\r\ntype DraftPatient = {\r\n  firstName: string;\r\n  lastName: string;\r\n  dni: string;\r\n  birthDate: string;\r\n  sex: \"M\" | \"F\" | \"O\";\r\n};\r\n\r\nexport function AdmissionForm({\r\n  patients,\r\n  tests,\r\n  profiles,\r\n  branches,\r\n  canAdjustPrice,\r\n}: Props) {\r\n  const router = useRouter();\r\n  const [saving, setSaving] = useState(false);\r\n  const [patientMode, setPatientMode] = useState<\"existing\" | \"new\">(\"existing\");\r\n  const [patientSearch, setPatientSearch] = useState(\"\");\r\n  const [selectedPatientId, setSelectedPatientId] = useState(\"\");\r\n\r\n  const [draftPatient, setDraftPatient] = useState<DraftPatient>({\r\n    firstName: \"\",\r\n    lastName: \"\",\r\n    dni: \"\",\r\n    birthDate: \"\",\r\n    sex: \"M\",\r\n  });\r\n\r\n  const [createdAt, setCreatedAt] = useState(() => toDateTimeLocal(new Date()));\r\n\r\n  useEffect(() => {\r\n    const tick = () => setCreatedAt(toDateTimeLocal(new Date()));\r\n    tick();\r\n    const id = setInterval(tick, 1000);\r\n    return () => clearInterval(id);\r\n  }, []);\r\n\r\n  const displayedAge = useMemo(() => {\r\n    if (!draftPatient.birthDate || typeof draftPatient.birthDate !== \"string\") return null;\r\n    try {\r\n      const date = new Date(draftPatient.birthDate);\r\n      if (isNaN(date.getTime())) return null;\r\n      return calculateAge(date);\r\n    } catch {\r\n      return null;\r\n    }\r\n  }, [draftPatient.birthDate]);\r\n\r\n  const [requestedBy, setRequestedBy] = useState(\"\");\r\n  const [notes, setNotes] = useState(\"\");\r\n  const [patientType, setPatientType] = useState<\"\" | \"CLINICA\" | \"EXTERNO\" | \"IZAGA\">(\"\");\r\n  const [branchId, setBranchId] = useState(\"\");\r\n  const [testSearch, setTestSearch] = useState(\"\");\r\n\r\n  const [selectedProfileIds, setSelectedProfileIds] = useState<string[]>([]);\r\n  const [selectedTestIds, setSelectedTestIds] = useState<string[]>([]);\r\n  const [priceAdjustments, setPriceAdjustments] = useState<\r\n    Record<string, { priceApplied: string; reason: string }>\r\n  >({});\r\n\r\n  const selectedProfiles = useMemo(\r\n    () => profiles.filter((p) => selectedProfileIds.includes(p.id)),\r\n    [profiles, selectedProfileIds],\r\n  );\r\n\r\n  const testIdsFromProfiles = useMemo(() => {\r\n    return new Set(selectedProfiles.flatMap((profile) => profile.tests.map((t) => t.id)));\r\n  }, [selectedProfiles]);\r\n\r\n  const filteredPatients = useMemo(() => {\r\n    const term = patientSearch.trim().toLowerCase();\r\n    if (!term) return [];\r\n    return patients\r\n      .filter(\r\n        (p) =>\r\n          p.dni.toLowerCase().includes(term) ||\r\n          p.firstName.toLowerCase().includes(term) ||\r\n          p.lastName.toLowerCase().includes(term) ||\r\n          p.label.toLowerCase().includes(term),\r\n      )\r\n      .slice(0, 12);\r\n  }, [patients, patientSearch]);\r\n\r\n  const filteredTestsBySection = useMemo(() => {\r\n    const term = testSearch.trim().toLowerCase();\r\n    const filtered = term\r\n      ? tests.filter(\r\n          (t) =>\r\n            t.name.toLowerCase().includes(term) ||\r\n            t.code.toLowerCase().includes(term) ||\r\n            t.sectionLabel.toLowerCase().includes(term),\r\n        )\r\n      : tests;\r\n    const groups = new Map<string, TestOption[]>();\r\n    for (const test of filtered) {\r\n      if (!groups.has(test.sectionLabel)) groups.set(test.sectionLabel, []);\r\n      groups.get(test.sectionLabel)!.push(test);\r\n    }\r\n    return Array.from(groups.entries()).sort((a, b) => a[0].localeCompare(b[0]));\r\n  }, [tests, testSearch]);\r\n\r\n  const selectedItemsForPricing = useMemo(() => {\r\n    const profileItems = selectedProfiles.flatMap((profile) => {\r\n      const each =\r\n        profile.packagePrice != null && profile.tests.length > 0\r\n          ? profile.packagePrice / profile.tests.length\r\n          : null;\r\n      return profile.tests.map((test) => ({\r\n        testId: test.id,\r\n        code: test.code,\r\n        name: test.name,\r\n        priceBase: each ?? test.price,\r\n        source: `Promoción: ${profile.name}`,\r\n      }));\r\n    });\r\n    const individualItems = selectedTestIds\r\n      .filter((id) => !testIdsFromProfiles.has(id))\r\n      .map((id) => tests.find((t) => t.id === id))\r\n      .filter(Boolean)\r\n      .map((test) => ({\r\n        testId: test!.id,\r\n        code: test!.code,\r\n        name: test!.name,\r\n        priceBase: test!.price,\r\n        source: \"Individual\",\r\n      }));\r\n\r\n    const merged = [...profileItems, ...individualItems];\r\n    return merged.map((item) => {\r\n      const adjustment = priceAdjustments[item.testId];\r\n      const parsedApplied = adjustment?.priceApplied ? Number(adjustment.priceApplied) : item.priceBase;\r\n      const priceApplied = Number.isFinite(parsedApplied) ? parsedApplied : item.priceBase;\r\n      return {\r\n        ...item,\r\n        priceApplied,\r\n        reason: adjustment?.reason ?? \"\",\r\n      };\r\n    });\r\n  }, [priceAdjustments, selectedProfiles, selectedTestIds, testIdsFromProfiles, tests]);\r\n\r\n  const total = useMemo(\r\n    () => selectedItemsForPricing.reduce((acc, item) => acc + item.priceApplied, 0),\r\n    [selectedItemsForPricing],\r\n  );\r\n\r\n  function toggleTest(testId: string) {\r\n    setSelectedTestIds((prev) =>\r\n      prev.includes(testId) ? prev.filter((id) => id !== testId) : [...prev, testId],\r\n    );\r\n  }\r\n\r\n  function addProfile(profileId: string) {\r\n    if (!profileId) return;\r\n    if (selectedProfileIds.includes(profileId)) return;\r\n    setSelectedProfileIds((prev) => [...prev, profileId]);\r\n    const profile = profiles.find((p) => p.id === profileId);\r\n    if (!profile) return;\r\n    const profileTestIds = new Set(profile.tests.map((t) => t.id));\r\n    setSelectedTestIds((prev) => prev.filter((id) => !profileTestIds.has(id)));\r\n  }\r\n\r\n  function removeProfile(profileId: string) {\r\n    setSelectedProfileIds((prev) => prev.filter((id) => id !== profileId));\r\n  }\r\n\r\n  async function onSubmit(e: React.FormEvent) {\r\n    e.preventDefault();\r\n    if (patientMode === \"existing\" && !selectedPatientId) {\r\n      toast.error(\"Selecciona un paciente existente o cambia a registro rápido.\");\r\n      return;\r\n    }\r\n    if (patientMode === \"new\") {\r\n      if (!draftPatient.firstName || !draftPatient.lastName || !draftPatient.dni || !draftPatient.birthDate) {\r\n        toast.error(\"Completa los datos obligatorios del paciente nuevo.\");\r\n        return;\r\n      }\r\n    }\r\n    if (selectedItemsForPricing.length === 0) {\r\n      toast.error(\"Selecciona al menos un análisis o promoción.\");\r\n      return;\r\n    }\r\n\r\n    const itemAdjustments = selectedItemsForPricing\r\n      .filter((item) => Math.abs(item.priceApplied - item.priceBase) > 0.0001 || item.reason.trim().length > 0)\r\n      .map((item) => ({\r\n        testId: item.testId,\r\n        priceApplied: item.priceApplied,\r\n        adjustmentReason: item.reason.trim() || null,\r\n      }));\r\n\r\n    setSaving(true);\r\n    try {\r\n      const payload = {\r\n        patientId: patientMode === \"existing\" ? selectedPatientId : undefined,\r\n        patientDraft:\r\n          patientMode === \"new\"\r\n            ? {\r\n                firstName: draftPatient.firstName.trim(),\r\n                lastName: draftPatient.lastName.trim(),\r\n                dni: draftPatient.dni.trim(),\r\n                birthDate: draftPatient.birthDate,\r\n                sex: draftPatient.sex,\r\n              }\r\n            : undefined,\r\n        requestedBy: requestedBy.trim() || null,\r\n        notes: notes.trim() || null,\r\n        patientType: patientType || null,\r\n        branchId: branchId || null,\r\n        tests: selectedTestIds,\r\n        profileIds: selectedProfileIds,\r\n        itemAdjustments,\r\n      };\r\n\r\n      const res = await fetch(\"/api/admisiones\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify(payload),\r\n      });\r\n      const data = await res.json().catch(() => ({}));\r\n      if (!res.ok) {\r\n        toast.error(data.error ?? \"No se pudo crear la orden.\");\r\n        return;\r\n      }\r\n\r\n      const convertedOrder = data.convertedOrder as { orderId: string; orderCode: string } | undefined;\r\n      if (convertedOrder?.orderId) {\r\n        toast.success(`Orden creada: ${convertedOrder.orderCode}.`);\r\n        router.push(`/orders/${convertedOrder.orderId}`);\r\n      } else {\r\n        toast.success(\"Orden de admisión creada correctamente.\");\r\n        router.push(\"/admisiones\");\r\n      }\r\n      router.refresh();\r\n    } catch {\r\n      toast.error(\"Error de conexión.\");\r\n    } finally {\r\n      setSaving(false);\r\n    }\r\n  }\r\n\r\n  return (\r\n    <form onSubmit={onSubmit} className=\"divide-y divide-slate-100 dark:divide-slate-800\">\r\n      {/* Paciente y datos generales */}\r\n      <section className=\"p-6 sm:p-8\">\r\n        <div className=\"mb-5 flex items-center gap-2\">\r\n          <div className=\"flex h-9 w-9 items-center justify-center rounded-lg bg-teal-100 text-teal-600 dark:bg-teal-900/40 dark:text-teal-400\">\r\n            <UserPlus className=\"h-4 w-4\" />\r\n          </div>\r\n          <h2 className=\"text-base font-semibold text-slate-800 dark:text-slate-100\">Paciente y datos generales</h2>\r\n        </div>\r\n\r\n        <div className=\"space-y-5\">\r\n          <div>\r\n            <Label className=\"mb-2 block text-xs font-medium text-slate-500 dark:text-slate-400\">Modo paciente</Label>\r\n            <div className=\"inline-flex rounded-xl border border-slate-200 bg-slate-50/80 p-1 dark:border-slate-700 dark:bg-slate-800/50\">\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => setPatientMode(\"existing\")}\r\n                className={`rounded-lg px-4 py-2 text-sm font-medium transition-all ${\r\n                  patientMode === \"existing\"\r\n                    ? \"bg-white text-teal-600 shadow-sm dark:bg-slate-800 dark:text-teal-400\"\r\n                    : \"text-slate-600 hover:text-slate-900 dark:text-slate-400 dark:hover:text-slate-200\"\r\n                }`}\r\n              >\r\n                <Search className=\"mr-1.5 inline-block h-3.5 w-3.5\" />\r\n                Existente\r\n              </button>\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => setPatientMode(\"new\")}\r\n                className={`rounded-lg px-4 py-2 text-sm font-medium transition-all ${\r\n                  patientMode === \"new\"\r\n                    ? \"bg-white text-teal-600 shadow-sm dark:bg-slate-800 dark:text-teal-400\"\r\n                    : \"text-slate-600 hover:text-slate-900 dark:text-slate-400 dark:hover:text-slate-200\"\r\n                }`}\r\n              >\r\n                <UserPlus className=\"mr-1.5 inline-block h-3.5 w-3.5\" />\r\n                Nuevo\r\n              </button>\r\n            </div>\r\n          </div>\r\n\r\n          {patientMode === \"existing\" ? (\r\n            <div className=\"space-y-2\">\r\n              <Label className=\"text-xs font-medium text-slate-500 dark:text-slate-400\">Buscar paciente</Label>\r\n              <div className=\"relative\">\r\n                <Search className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-slate-400\" />\r\n                <Input\r\n                  value={patientSearch}\r\n                  onChange={(e) => setPatientSearch(e.target.value)}\r\n                  placeholder=\"DNI, nombres o apellidos...\"\r\n                  className=\"pl-9\"\r\n                />\r\n              </div>\r\n              {patientSearch.trim() && (\r\n                <div className=\"max-h-44 overflow-y-auto rounded-xl border border-slate-200 bg-white shadow-sm dark:border-slate-700 dark:bg-slate-900/50\">\r\n                  {filteredPatients.length === 0 ? (\r\n                    <p className=\"p-4 text-center text-sm text-slate-500\">Sin resultados</p>\r\n                  ) : (\r\n                    filteredPatients.map((patient) => (\r\n                      <button\r\n                        key={patient.id}\r\n                        type=\"button\"\r\n                        onClick={() => {\r\n                          setSelectedPatientId(patient.id);\r\n                          setPatientSearch(\"\");\r\n                        }}\r\n                        className=\"block w-full border-b border-slate-100 px-4 py-2.5 text-left text-sm transition-colors last:border-0 hover:bg-teal-50/80 dark:border-slate-800 dark:hover:bg-teal-900/20\"\r\n                      >\r\n                        {patient.label}\r\n                      </button>\r\n                    ))\r\n                  )}\r\n                </div>\r\n              )}\r\n              {selectedPatientId && (\r\n                <div className=\"flex items-center gap-2 rounded-lg bg-emerald-50 px-3 py-2 text-sm text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300\">\r\n                  <span className=\"h-2 w-2 rounded-full bg-emerald-500\" />\r\n                  {patients.find((p) => p.id === selectedPatientId)?.label}\r\n                </div>\r\n              )}\r\n            </div>\r\n          ) : (\r\n            <div className=\"grid gap-4 sm:grid-cols-2 lg:grid-cols-3\">\r\n              <div>\r\n                <Label className=\"text-xs font-medium text-slate-500 dark:text-slate-400\">Nombres</Label>\r\n                <Input\r\n                  className=\"mt-1\"\r\n                  value={draftPatient.firstName}\r\n                  onChange={(e) => setDraftPatient((prev) => ({ ...prev, firstName: e.target.value }))}\r\n                  placeholder=\"Ej: Juan Carlos\"\r\n                />\r\n              </div>\r\n              <div>\r\n                <Label className=\"text-xs font-medium text-slate-500 dark:text-slate-400\">Apellidos</Label>\r\n                <Input\r\n                  className=\"mt-1\"\r\n                  value={draftPatient.lastName}\r\n                  onChange={(e) => setDraftPatient((prev) => ({ ...prev, lastName: e.target.value }))}\r\n                  placeholder=\"Ej: García López\"\r\n                />\r\n              </div>\r\n              <div>\r\n                <Label className=\"text-xs font-medium text-slate-500 dark:text-slate-400\">DNI</Label>\r\n                <Input\r\n                  className=\"mt-1\"\r\n                  value={draftPatient.dni}\r\n                  onChange={(e) => setDraftPatient((prev) => ({ ...prev, dni: e.target.value }))}\r\n                  placeholder=\"8 dígitos\"\r\n                />\r\n              </div>\r\n              <div>\r\n                <Label className=\"text-xs font-medium text-slate-500 dark:text-slate-400\">Fecha de creación</Label>\r\n                <Input\r\n                  type=\"datetime-local\"\r\n                  className=\"mt-1 read-only:cursor-default\"\r\n                  value={createdAt}\r\n                  readOnly\r\n                />\r\n              </div>\r\n              <div>\r\n                <Label className=\"text-xs font-medium text-slate-500 dark:text-slate-400\">Fecha de nacimiento</Label>\r\n                <Input\r\n                  type=\"date\"\r\n                  className=\"mt-1\"\r\n                  value={draftPatient.birthDate}\r\n                  onChange={(e) => setDraftPatient((prev) => ({ ...prev, birthDate: e.target.value }))}\r\n                />\r\n              </div>\r\n              <div>\r\n                <Label className=\"text-xs font-medium text-slate-500 dark:text-slate-400\">Edad</Label>\r\n                <Input\r\n                  className=\"mt-1 read-only:cursor-default read-only:opacity-100\"\r\n                  value={displayedAge !== null ? `${displayedAge} años` : \"\"}\r\n                  placeholder=\"Se calcula automáticamente\"\r\n                  readOnly\r\n                />\r\n              </div>\r\n              <div>\r\n                <Label className=\"text-xs font-medium text-slate-500 dark:text-slate-400\">Sexo</Label>\r\n                <select\r\n                  value={draftPatient.sex}\r\n                  onChange={(e) => setDraftPatient((prev) => ({ ...prev, sex: e.target.value as \"M\" | \"F\" | \"O\" }))}\r\n                  className=\"mt-1 h-10 w-full rounded-xl border border-slate-200 bg-white px-3 text-sm dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100\"\r\n                >\r\n                  <option value=\"M\">Masculino</option>\r\n                  <option value=\"F\">Femenino</option>\r\n                  <option value=\"O\">Otro</option>\r\n                </select>\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          <div className=\"grid gap-4 sm:grid-cols-2 lg:grid-cols-4\">\r\n            <div>\r\n              <Label className=\"text-xs font-medium text-slate-500 dark:text-slate-400\">\r\n                <Stethoscope className=\"mr-1 inline-block h-3.5 w-3.5\" />\r\n                Médico solicitante\r\n              </Label>\r\n              <Input\r\n                className=\"mt-1\"\r\n                value={requestedBy}\r\n                onChange={(e) => setRequestedBy(e.target.value)}\r\n                placeholder=\"Opcional\"\r\n              />\r\n            </div>\r\n            <div>\r\n              <Label className=\"text-xs font-medium text-slate-500 dark:text-slate-400\">Tipo de paciente</Label>\r\n              <select\r\n                value={patientType}\r\n                onChange={(e) => setPatientType(e.target.value as any)}\r\n                className=\"mt-1 h-10 w-full rounded-xl border border-slate-200 bg-white px-3 text-sm dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100\"\r\n              >\r\n                <option value=\"\">Sin especificar</option>\r\n                <option value=\"CLINICA\">Clínica</option>\r\n                <option value=\"EXTERNO\">Externo</option>\r\n                <option value=\"IZAGA\">Izaga</option>\r\n              </select>\r\n            </div>\r\n            <div>\r\n              <Label className=\"text-xs font-medium text-slate-500 dark:text-slate-400\">\r\n                <Building2 className=\"mr-1 inline-block h-3.5 w-3.5\" />\r\n                Sede\r\n              </Label>\r\n              <select\r\n                value={branchId}\r\n                onChange={(e) => setBranchId(e.target.value)}\r\n                className=\"mt-1 h-10 w-full rounded-xl border border-slate-200 bg-white px-3 text-sm dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100\"\r\n              >\r\n                <option value=\"\">Sin sede</option>\r\n                {branches.map((branch) => (\r\n                  <option key={branch.id} value={branch.id}>\r\n                    {branch.name}\r\n                  </option>\r\n                ))}\r\n              </select>\r\n            </div>\r\n            <div className=\"sm:col-span-2 lg:col-span-1\">\r\n              <Label className=\"text-xs font-medium text-slate-500 dark:text-slate-400\">\r\n                <FileText className=\"mr-1 inline-block h-3.5 w-3.5\" />\r\n                Notas\r\n              </Label>\r\n              <Input\r\n                className=\"mt-1\"\r\n                value={notes}\r\n                onChange={(e) => setNotes(e.target.value)}\r\n                placeholder=\"Opcional\"\r\n              />\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </section>\r\n\r\n      {/* Análisis a solicitar */}\r\n      <section className=\"p-6 sm:p-8\">\r\n        <div className=\"mb-5 flex items-center gap-2\">\r\n          <div className=\"flex h-9 w-9 items-center justify-center rounded-lg bg-cyan-100 text-cyan-600 dark:bg-cyan-900/40 dark:text-cyan-400\">\r\n            <FlaskConical className=\"h-4 w-4\" />\r\n          </div>\r\n          <h2 className=\"text-base font-semibold text-slate-800 dark:text-slate-100\">Análisis a solicitar</h2>\r\n        </div>\r\n\r\n        {profiles.length > 0 && (\r\n          <div className=\"mb-5 flex flex-wrap items-center gap-2 rounded-xl border border-slate-200/80 bg-slate-50/80 p-3 dark:border-slate-700 dark:bg-slate-800/40\">\r\n            <Tag className=\"h-4 w-4 text-slate-500\" />\r\n            <select\r\n              className=\"h-9 rounded-lg border border-slate-200 bg-white px-3 text-sm dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100\"\r\n              onChange={(e) => {\r\n                if (e.target.value) {\r\n                  addProfile(e.target.value);\r\n                  e.target.value = \"\";\r\n                }\r\n              }}\r\n            >\r\n              <option value=\"\">+ Agregar promoción</option>\r\n              {profiles.map((profile) => (\r\n                <option key={profile.id} value={profile.id}>\r\n                  {profile.name}\r\n                  {profile.packagePrice != null ? ` · S/ ${profile.packagePrice.toFixed(2)}` : \"\"}\r\n                </option>\r\n              ))}\r\n            </select>\r\n            {selectedProfiles.map((profile) => (\r\n              <span\r\n                key={profile.id}\r\n                className=\"inline-flex items-center gap-1.5 rounded-full bg-teal-100 px-3 py-1 text-xs font-medium text-teal-700 dark:bg-teal-900/50 dark:text-teal-300\"\r\n              >\r\n                {profile.name}\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => removeProfile(profile.id)}\r\n                  className=\"rounded-full p-0.5 hover:bg-teal-200 dark:hover:bg-teal-800\"\r\n                  aria-label=\"Quitar\"\r\n                >\r\n                  ×\r\n                </button>\r\n              </span>\r\n            ))}\r\n          </div>\r\n        )}\r\n\r\n        <div className=\"relative mb-4\">\r\n          <Search className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-slate-400\" />\r\n          <Input\r\n            value={testSearch}\r\n            onChange={(e) => setTestSearch(e.target.value)}\r\n            placeholder=\"Buscar por código, nombre o sección...\"\r\n            className=\"pl-9\"\r\n          />\r\n        </div>\r\n\r\n        <div className=\"max-h-[320px] overflow-y-auto rounded-xl border border-slate-200 bg-white shadow-inner dark:border-slate-700 dark:bg-slate-900/30\">\r\n          {filteredTestsBySection.length === 0 ? (\r\n            <p className=\"p-6 text-center text-sm text-slate-500\">Sin análisis disponibles</p>\r\n          ) : (\r\n            filteredTestsBySection.map(([section, sectionTests]) => (\r\n              <div key={section} className=\"border-b border-slate-100 last:border-0 dark:border-slate-800\">\r\n                <div className=\"sticky top-0 z-10 bg-teal-50/90 px-4 py-2 text-xs font-semibold uppercase tracking-wider text-teal-700 dark:bg-teal-900/40 dark:text-teal-300\">\r\n                  {section}\r\n                </div>\r\n                <div className=\"divide-y divide-slate-100 dark:divide-slate-800/80\">\r\n                  {sectionTests.map((test) => {\r\n                    const inProfile = testIdsFromProfiles.has(test.id);\r\n                    const checked = selectedTestIds.includes(test.id) || inProfile;\r\n                    return (\r\n                      <label\r\n                        key={test.id}\r\n                        className={`flex cursor-pointer items-center gap-4 px-4 py-3 transition-colors ${\r\n                          inProfile\r\n                            ? \"bg-amber-50/70 dark:bg-amber-950/25\"\r\n                            : \"hover:bg-slate-50/80 dark:hover:bg-slate-800/30\"\r\n                        } ${checked ? \"bg-teal-50/50 dark:bg-teal-900/20\" : \"\"}`}\r\n                      >\r\n                        <input\r\n                          type=\"checkbox\"\r\n                          checked={checked}\r\n                          disabled={inProfile}\r\n                          className=\"h-4 w-4 rounded border-slate-300 text-teal-600 focus:ring-teal-500\"\r\n                          onChange={() => toggleTest(test.id)}\r\n                        />\r\n                        <span className=\"min-w-0 flex-1\">\r\n                          <span className=\"block truncate font-medium text-slate-900 dark:text-slate-100\">\r\n                            {test.name}\r\n                          </span>\r\n                          <span className=\"text-xs text-slate-500\">{test.code}</span>\r\n                        </span>\r\n                        <span className=\"shrink-0 font-semibold text-slate-700 dark:text-slate-200\">\r\n                          S/ {test.price.toFixed(2)}\r\n                        </span>\r\n                      </label>\r\n                    );\r\n                  })}\r\n                </div>\r\n              </div>\r\n            ))\r\n          )}\r\n        </div>\r\n      </section>\r\n\r\n      {/* Precios */}\r\n      <section className=\"p-6 sm:p-8\">\r\n        <div className=\"mb-5 flex items-center gap-2\">\r\n          <div className=\"flex h-9 w-9 items-center justify-center rounded-lg bg-emerald-100 text-emerald-600 dark:bg-emerald-900/40 dark:text-emerald-400\">\r\n            <DollarSign className=\"h-4 w-4\" />\r\n          </div>\r\n          <h2 className=\"text-base font-semibold text-slate-800 dark:text-slate-100\">Precios de la solicitud</h2>\r\n        </div>\r\n        {selectedItemsForPricing.length === 0 ? (\r\n          <p className=\"rounded-xl border border-dashed border-slate-200 py-8 text-center text-sm text-slate-500 dark:border-slate-700\">\r\n            Selecciona análisis arriba para ver el resumen\r\n          </p>\r\n        ) : (\r\n          <div className=\"space-y-3\">\r\n            {selectedItemsForPricing.map((item) => (\r\n              <div\r\n                key={`${item.source}-${item.testId}`}\r\n                className=\"grid gap-3 rounded-xl border border-slate-200/80 bg-slate-50/50 p-4 sm:grid-cols-12 dark:border-slate-700 dark:bg-slate-800/30\"\r\n              >\r\n                <div className=\"sm:col-span-4\">\r\n                  <p className=\"text-sm font-semibold text-slate-900 dark:text-slate-100\">{item.code}</p>\r\n                  <p className=\"text-xs text-slate-500\">{item.name}</p>\r\n                </div>\r\n                <div className=\"sm:col-span-2 text-sm text-slate-600 dark:text-slate-400\">\r\n                  Base: S/ {item.priceBase.toFixed(2)}\r\n                </div>\r\n                <div className=\"sm:col-span-2\">\r\n                  <Input\r\n                    type=\"number\"\r\n                    min=\"0\"\r\n                    step=\"0.01\"\r\n                    disabled={!canAdjustPrice}\r\n                    className=\"h-9\"\r\n                    value={priceAdjustments[item.testId]?.priceApplied ?? item.priceBase.toFixed(2)}\r\n                    onChange={(e) =>\r\n                      setPriceAdjustments((prev) => ({\r\n                        ...prev,\r\n                        [item.testId]: {\r\n                          priceApplied: e.target.value,\r\n                          reason: prev[item.testId]?.reason ?? \"\",\r\n                        },\r\n                      }))\r\n                    }\r\n                  />\r\n                </div>\r\n                <div className=\"sm:col-span-4\">\r\n                  <Input\r\n                    placeholder=\"Motivo de ajuste (opcional)\"\r\n                    disabled={!canAdjustPrice}\r\n                    className=\"h-9\"\r\n                    value={priceAdjustments[item.testId]?.reason ?? \"\"}\r\n                    onChange={(e) =>\r\n                      setPriceAdjustments((prev) => ({\r\n                        ...prev,\r\n                        [item.testId]: {\r\n                          priceApplied: prev[item.testId]?.priceApplied ?? item.priceBase.toFixed(2),\r\n                          reason: e.target.value,\r\n                        },\r\n                      }))\r\n                    }\r\n                  />\r\n                </div>\r\n                <p className=\"sm:col-span-12 text-xs text-slate-500\">{item.source}</p>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        )}\r\n        {!canAdjustPrice && selectedItemsForPricing.length > 0 && (\r\n          <p className=\"mt-3 text-xs text-amber-600 dark:text-amber-400\">\r\n            Sin permiso para ajustar precios. Se aplicará el precio base.\r\n          </p>\r\n        )}\r\n      </section>\r\n\r\n      {/* Footer */}\r\n      <div className=\"flex flex-col gap-4 border-t border-slate-200 bg-slate-50/50 px-6 py-5 sm:flex-row sm:items-center sm:justify-between dark:border-slate-800 dark:bg-slate-900/30 sm:px-8\">\r\n        <div className=\"flex items-baseline gap-2\">\r\n          <span className=\"text-sm text-slate-600 dark:text-slate-400\">Total estimado:</span>\r\n          <span className=\"text-xl font-bold text-teal-600 dark:text-teal-400\">S/ {total.toFixed(2)}</span>\r\n        </div>\r\n        <div className=\"flex gap-3\">\r\n          <Button\r\n            type=\"button\"\r\n            variant=\"outline\"\r\n            onClick={() => router.push(\"/admisiones\")}\r\n            className=\"min-w-[100px]\"\r\n          >\r\n            Cancelar\r\n          </Button>\r\n          <Button\r\n            type=\"submit\"\r\n            disabled={saving || selectedItemsForPricing.length === 0}\r\n            className=\"min-w-[140px] bg-gradient-to-r from-teal-600 to-cyan-600 hover:from-teal-500 hover:to-cyan-500\"\r\n          >\r\n            {saving ? \"Guardando...\" : \"Guardar orden\"}\r\n          </Button>\r\n        </div>\r\n      </div>\r\n    </form>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\admisiones\\SettleAdmissionButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\catalog\\CatalogTestsList.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\common\\DeleteButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\dashboard\\DashboardAdmissionBlock.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'recentAdmissions' is defined but never used.","line":43,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":43,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'canConvert' is defined but never used.","line":48,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":48,"endColumn":13}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import Link from \"next/link\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\r\nimport { ClipboardList, DollarSign, UserPlus, CalendarDays, Filter } from \"lucide-react\";\r\nimport { formatDate } from \"@/lib/format\";\r\n\r\ntype AdmissionListItem = {\r\n  id: string;\r\n  requestCode: string;\r\n  status: string;\r\n  patientName: string;\r\n  totalPrice: string;\r\n  createdAt: Date;\r\n  createdByName: string;\r\n  convertedOrderId?: string;\r\n  /** Si la orden tiene todos los resultados listos (no borrador), se puede ver impresión */\r\n  orderPrintReady?: boolean;\r\n};\r\n\r\ntype Props = {\r\n  pendingCount: number;\r\n  convertedToday: number;\r\n  pendingSettlementCount: number;\r\n  recentAdmissions: Array<{\r\n    id: string;\r\n    requestCode: string;\r\n    status: string;\r\n    patientName: string;\r\n    totalPrice: string;\r\n  }>;\r\n  admissionsList: AdmissionListItem[];\r\n  admissionDateFrom: string;\r\n  admissionDateTo: string;\r\n  canManage: boolean;\r\n  canConvert: boolean;\r\n};\r\n\r\nexport function DashboardAdmissionBlock({\r\n  pendingCount,\r\n  convertedToday,\r\n  pendingSettlementCount,\r\n  recentAdmissions,\r\n  admissionsList,\r\n  admissionDateFrom,\r\n  admissionDateTo,\r\n  canManage,\r\n  canConvert,\r\n}: Props) {\r\n  return (\r\n    <Card>\r\n      <CardHeader className=\"flex flex-row items-center justify-between\">\r\n        <div>\r\n          <CardTitle className=\"text-base\">Admisión</CardTitle>\r\n          <p className=\"text-sm font-normal text-slate-500 dark:text-slate-400 mt-0.5\">\r\n            Órdenes de admisión (pacientes existentes y nuevos) listadas por personal de admisión\r\n          </p>\r\n        </div>\r\n        <Link\r\n          href=\"/admisiones\"\r\n          className=\"text-sm font-medium text-teal-600 dark:text-teal-400 hover:text-teal-700 dark:hover:text-teal-300 hover:underline shrink-0 transition-colors\"\r\n        >\r\n          Ver bandeja\r\n        </Link>\r\n      </CardHeader>\r\n      <CardContent className=\"space-y-4\">\r\n        <div className=\"grid grid-cols-2 gap-3 sm:grid-cols-4\">\r\n          <div className=\"rounded-lg border border-slate-200 bg-slate-50/80 px-3 py-2 dark:border-slate-600 dark:bg-slate-800/50\">\r\n            <p className=\"text-xs font-medium text-slate-500 dark:text-slate-400\">Órdenes pendientes</p>\r\n            <p className=\"text-xl font-semibold text-slate-900 dark:text-slate-100\">{pendingCount}</p>\r\n          </div>\r\n          <div className=\"rounded-lg border border-slate-200 bg-slate-50/80 px-3 py-2 dark:border-slate-600 dark:bg-slate-800/50\">\r\n            <p className=\"text-xs font-medium text-slate-500 dark:text-slate-400\">Convertidas hoy</p>\r\n            <p className=\"text-xl font-semibold text-slate-900 dark:text-slate-100\">{convertedToday}</p>\r\n          </div>\r\n          <div className=\"rounded-lg border border-slate-200 bg-slate-50/80 px-3 py-2 dark:border-slate-600 dark:bg-slate-800/50\">\r\n            <p className=\"text-xs font-medium text-slate-500 dark:text-slate-400\">Pend. cobro admisión</p>\r\n            <p className=\"text-xl font-semibold text-slate-900 dark:text-slate-100\">{pendingSettlementCount}</p>\r\n          </div>\r\n        </div>\r\n\r\n        <div>\r\n          <p className=\"mb-2 text-xs font-medium text-slate-500 dark:text-slate-400\">Filtro por fecha</p>\r\n          <form method=\"get\" action=\"/dashboard\" className=\"flex flex-wrap items-end gap-2\">\r\n            <div className=\"min-w-[130px]\">\r\n              <label htmlFor=\"adm-from-dash\" className=\"mb-1 block text-xs font-medium text-slate-500 dark:text-slate-400\">\r\n                <CalendarDays className=\"mr-1 inline h-3.5 w-3.5\" />\r\n                Desde\r\n              </label>\r\n              <input\r\n                id=\"adm-from-dash\"\r\n                name=\"admissionFrom\"\r\n                type=\"date\"\r\n                defaultValue={admissionDateFrom}\r\n                className=\"h-9 w-full rounded-lg border border-slate-200 px-2 text-sm dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100\"\r\n              />\r\n            </div>\r\n            <div className=\"min-w-[130px]\">\r\n              <label htmlFor=\"adm-to-dash\" className=\"mb-1 block text-xs font-medium text-slate-500 dark:text-slate-400\">\r\n                Hasta\r\n              </label>\r\n              <input\r\n                id=\"adm-to-dash\"\r\n                name=\"admissionTo\"\r\n                type=\"date\"\r\n                defaultValue={admissionDateTo}\r\n                className=\"h-9 w-full rounded-lg border border-slate-200 px-2 text-sm dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100\"\r\n              />\r\n            </div>\r\n            <Button type=\"submit\" size=\"sm\" variant=\"outline\" className=\"gap-1.5\">\r\n              <Filter className=\"h-4 w-4\" />\r\n              Filtrar\r\n            </Button>\r\n          </form>\r\n        </div>\r\n\r\n        <div className=\"overflow-x-auto rounded-lg border border-slate-200 dark:border-slate-700\">\r\n          <p className=\"mb-2 text-xs font-medium text-slate-500 dark:text-slate-400\">\r\n            Órdenes de admisión (más recientes primero)\r\n          </p>\r\n          {admissionsList.length === 0 ? (\r\n            <p className=\"py-6 text-center text-sm text-slate-500 dark:text-slate-400\">\r\n              No hay órdenes de admisión en el rango de fechas seleccionado\r\n            </p>\r\n          ) : (\r\n            <Table>\r\n              <TableHeader>\r\n                <TableRow className=\"bg-slate-50 dark:bg-slate-800/50\">\r\n                  <TableHead className=\"font-semibold\">Código</TableHead>\r\n                  <TableHead className=\"font-semibold\">Paciente</TableHead>\r\n                  <TableHead className=\"font-semibold\">Fecha</TableHead>\r\n                  <TableHead className=\"font-semibold\">Personal admisión</TableHead>\r\n                  <TableHead className=\"font-semibold\">Estado</TableHead>\r\n                  <TableHead className=\"text-right font-semibold\">Total</TableHead>\r\n                  <TableHead className=\"text-right font-semibold\">Orden</TableHead>\r\n                </TableRow>\r\n              </TableHeader>\r\n              <TableBody>\r\n                {admissionsList.map((a) => (\r\n                  <TableRow key={a.id} className=\"hover:bg-slate-50 dark:hover:bg-slate-800/30\">\r\n                    <TableCell>\r\n                      <code className=\"rounded bg-slate-100 px-1.5 py-0.5 font-mono text-sm dark:bg-slate-700\">\r\n                        {a.requestCode}\r\n                      </code>\r\n                    </TableCell>\r\n                    <TableCell className=\"font-medium text-slate-900 dark:text-slate-100\">{a.patientName}</TableCell>\r\n                    <TableCell className=\"text-slate-600 dark:text-slate-400\">\r\n                      {formatDate(a.createdAt)}\r\n                    </TableCell>\r\n                    <TableCell className=\"text-slate-600 dark:text-slate-400\">{a.createdByName}</TableCell>\r\n                    <TableCell>\r\n                      <span\r\n                        className={`inline-flex rounded-md px-2 py-0.5 text-xs font-medium ${\r\n                          a.status === \"CONVERTIDA\"\r\n                            ? \"bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400\"\r\n                            : a.status === \"CANCELADA\"\r\n                              ? \"bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-300\"\r\n                              : \"bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400\"\r\n                        }`}\r\n                      >\r\n                        {a.status}\r\n                      </span>\r\n                    </TableCell>\r\n                    <TableCell className=\"text-right font-medium text-slate-900 dark:text-slate-100\">{a.totalPrice}</TableCell>\r\n                    <TableCell className=\"text-right\">\r\n                      {a.convertedOrderId ? (\r\n                        a.orderPrintReady ? (\r\n                          <Link\r\n                            href={`/orders/${a.convertedOrderId}/print`}\r\n                            className=\"text-sm font-medium text-teal-600 hover:underline dark:text-teal-400\"\r\n                          >\r\n                            Ver orden\r\n                          </Link>\r\n                        ) : (\r\n                          <span className=\"text-xs text-slate-400\" title=\"Resultados aún no listos\">\r\n                            Resultados pendientes\r\n                          </span>\r\n                        )\r\n                      ) : (\r\n                        <span className=\"text-xs text-slate-400\">—</span>\r\n                      )}\r\n                    </TableCell>\r\n                  </TableRow>\r\n                ))}\r\n              </TableBody>\r\n            </Table>\r\n          )}\r\n        </div>\r\n\r\n        <div className=\"flex flex-wrap gap-2 border-t border-slate-200 pt-3 dark:border-slate-700\">\r\n          {canManage && (\r\n            <Link href=\"/admisiones/nueva\">\r\n              <Button size=\"sm\" className=\"gap-2\">\r\n                <UserPlus className=\"h-4 w-4\" />\r\n                Nueva orden\r\n              </Button>\r\n            </Link>\r\n          )}\r\n          <Link href=\"/admisiones\">\r\n            <Button size=\"sm\" variant=\"outline\" className=\"gap-2\">\r\n              <ClipboardList className=\"h-4 w-4\" />\r\n              Bandeja de admisión\r\n            </Button>\r\n          </Link>\r\n          <Link href=\"/cobro-admision\">\r\n            <Button size=\"sm\" variant=\"outline\" className=\"gap-2\">\r\n              <DollarSign className=\"h-4 w-4\" />\r\n              Cobro admisión\r\n              {pendingSettlementCount > 0 && (\r\n                <span className=\"rounded-full bg-amber-100 px-1.5 py-0.5 text-xs font-medium text-amber-800 dark:bg-amber-900/50 dark:text-amber-200\">\r\n                  {pendingSettlementCount}\r\n                </span>\r\n              )}\r\n            </Button>\r\n          </Link>\r\n        </div>\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\dashboard\\DashboardCTAs.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\dashboard\\DashboardPendingTable.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\dashboard\\GlobalSearch.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\dashboard\\MetricCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\dashboard\\OrdersFilters.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\dashboard\\QuickActions.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\dashboard\\QuickActionsBar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\dashboard\\QuickOrderButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\dashboard\\RecentActivity.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\forms\\AutosaveIndicator.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\forms\\AutosaveIndicator.tsx:26:7\n  24 |   useEffect(() => {\n  25 |     if (status === \"saving\") {\n> 26 |       setLabel(\"Guardando…\");\n     |       ^^^^^^^^ Avoid calling setState() directly within an effect\n  27 |     } else if (status === \"saved\" && savedAt) {\n  28 |       setLabel(`Guardado ${formatTimeAgo(savedAt)}`);\n  29 |     } else if (status === \"error\") {","line":26,"column":7,"nodeType":null,"endLine":26,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport { Loader2 } from \"lucide-react\";\r\nimport type { AutosaveStatus } from \"@/hooks/useAutosaveResults\";\r\n\r\ntype Props = {\r\n  status: AutosaveStatus;\r\n  savedAt: Date | null;\r\n  onRetry?: () => void;\r\n};\r\n\r\nfunction formatTimeAgo(date: Date): string {\r\n  const sec = Math.floor((Date.now() - date.getTime()) / 1000);\r\n  if (sec < 5) return \"hace un momento\";\r\n  if (sec < 60) return `hace ${sec}s`;\r\n  const min = Math.floor(sec / 60);\r\n  return `hace ${min}m`;\r\n}\r\n\r\nexport function AutosaveIndicator({ status, savedAt, onRetry }: Props) {\r\n  const [label, setLabel] = useState(\"\");\r\n\r\n  useEffect(() => {\r\n    if (status === \"saving\") {\r\n      setLabel(\"Guardando…\");\r\n    } else if (status === \"saved\" && savedAt) {\r\n      setLabel(`Guardado ${formatTimeAgo(savedAt)}`);\r\n    } else if (status === \"error\") {\r\n      setLabel(\"Error\");\r\n    } else {\r\n      setLabel(\"\");\r\n    }\r\n  }, [status, savedAt]);\r\n\r\n  useEffect(() => {\r\n    if (status !== \"saved\" || !savedAt) return;\r\n    const t = setInterval(() => {\r\n      setLabel(`Guardado ${formatTimeAgo(savedAt)}`);\r\n    }, 2000);\r\n    return () => clearInterval(t);\r\n  }, [status, savedAt]);\r\n\r\n  if (!label) return null;\r\n\r\n  return (\r\n    <div className=\"flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400\">\r\n      {status === \"saving\" && (\r\n        <Loader2 className=\"h-4 w-4 animate-spin text-slate-500\" />\r\n      )}\r\n      {status === \"saved\" && (\r\n        <span className=\"h-2 w-2 rounded-full bg-emerald-500\" aria-hidden />\r\n      )}\r\n      {status === \"error\" && (\r\n        <span className=\"h-2 w-2 rounded-full bg-red-500\" aria-hidden />\r\n      )}\r\n      <span>{label}</span>\r\n      {status === \"error\" && onRetry && (\r\n        <button\r\n          type=\"button\"\r\n          onClick={onRetry}\r\n          className=\"text-slate-700 underline hover:text-slate-900 dark:text-slate-300 dark:hover:text-slate-100\"\r\n        >\r\n          Reintentar\r\n        </button>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\forms\\LabTestForm.tsx","messages":[{"ruleId":"react-hooks/incompatible-library","severity":1,"message":"Compilation Skipped: Use of incompatible library\n\nThis API returns functions which cannot be memoized without leading to stale UI. To prevent this, by default React Compiler will skip memoizing this component/hook. However, you may see issues if values from this API are passed to other components/hooks that are memoized.\n\nC:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\forms\\LabTestForm.tsx:45:27\n  43 |     },\n  44 |   });\n> 45 |   const isReferredValue = form.watch(\"isReferred\");\n     |                           ^^^^ React Hook Form's `useForm()` API returns a `watch()` function which cannot be memoized safely.\n  46 |   const referredOptions = form.watch(\"referredLabOptions\") ?? [];\n  47 |\n  48 |   const addReferredOption = () => {","line":45,"column":27,"nodeType":null,"endLine":45,"endColumn":31},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":56,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":56,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1820,1823],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1820,1823],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useRouter } from \"next/navigation\";\r\nimport { useForm, type Resolver } from \"react-hook-form\";\r\nimport { zodResolver } from \"@hookform/resolvers/zod\";\r\nimport { toast } from \"sonner\";\r\n\r\nimport { labTestSchema } from \"@/features/lab/schemas\";\r\nimport type { z } from \"zod\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\n\r\ntype LabTestFormValues = z.infer<typeof labTestSchema>;\r\n\r\ntype SectionOption = { id: string; code: string; name: string };\r\ntype ReferredLabOption = { id: string; name: string };\r\n\r\ntype Props = {\r\n  testId?: string;\r\n  defaultValues?: Partial<LabTestFormValues>;\r\n  sections: SectionOption[];\r\n  referredLabs: ReferredLabOption[];\r\n};\r\n\r\nexport function LabTestForm({ testId, defaultValues, sections, referredLabs }: Props) {\r\n  const router = useRouter();\r\n  const form = useForm<LabTestFormValues>({\r\n    resolver: zodResolver(labTestSchema) as Resolver<LabTestFormValues>,\r\n    defaultValues: {\r\n      code: \"\",\r\n      name: \"\",\r\n      sectionId: sections[0]?.id ?? \"\",\r\n      price: 0,\r\n      estimatedTimeMinutes: undefined,\r\n      isActive: true,\r\n      isReferred: false,\r\n      referredLabId: null,\r\n      priceToAdmission: null,\r\n      externalLabCost: null,\r\n      referredLabOptions: defaultValues?.referredLabOptions ?? [],\r\n      ...defaultValues,\r\n    },\r\n  });\r\n  const isReferredValue = form.watch(\"isReferred\");\r\n  const referredOptions = form.watch(\"referredLabOptions\") ?? [];\r\n\r\n  const addReferredOption = () => {\r\n    form.setValue(\"referredLabOptions\", [\r\n      ...referredOptions,\r\n      {\r\n        referredLabId: \"\",\r\n        priceToAdmission: null,\r\n        externalLabCost: null,\r\n        isDefault: referredOptions.length === 0,\r\n      } as any,\r\n    ]);\r\n  };\r\n\r\n  const removeReferredOption = (index: number) => {\r\n    const next = [...referredOptions];\r\n    next.splice(index, 1);\r\n    form.setValue(\"referredLabOptions\", next);\r\n  };\r\n\r\n  const onSubmit = async (values: LabTestFormValues) => {\r\n    try {\r\n      const method = testId ? \"PUT\" : \"POST\";\r\n      const url = testId ? `/api/tests/${testId}` : \"/api/tests\";\r\n\r\n      const res = await fetch(url, {\r\n        method,\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify(values),\r\n      });\r\n\r\n      if (!res.ok) {\r\n        const errorData = await res.json().catch(() => ({}));\r\n        toast.error(errorData.error || \"No se pudo guardar el análisis.\");\r\n        return;\r\n      }\r\n\r\n      toast.success(\"Análisis guardado correctamente.\");\r\n      router.refresh();\r\n    } catch (error) {\r\n      console.error(\"Error submitting test form:\", error);\r\n      toast.error(\"Error de conexión. Intenta nuevamente.\");\r\n    }\r\n  };\r\n\r\n  return (\r\n    <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\r\n      <div className=\"grid gap-4 md:grid-cols-2\">\r\n        <div className=\"space-y-2\">\r\n          <Label>Código</Label>\r\n          <Input {...form.register(\"code\")} />\r\n        </div>\r\n        <div className=\"space-y-2\">\r\n          <Label>Sección</Label>\r\n          <select\r\n            className=\"h-10 w-full rounded-md border border-slate-200 bg-white px-3 text-sm dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100\"\r\n            {...form.register(\"sectionId\")}\r\n          >\r\n            {sections.map((s) => (\r\n              <option key={s.id} value={s.id}>\r\n                {s.name}\r\n              </option>\r\n            ))}\r\n          </select>\r\n        </div>\r\n      </div>\r\n      <div className=\"space-y-2\">\r\n        <Label>Nombre</Label>\r\n        <Input {...form.register(\"name\")} />\r\n      </div>\r\n      <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\r\n        <div className=\"space-y-2\">\r\n          <Label>Precio público (S/)</Label>\r\n          <Input type=\"number\" step=\"0.01\" {...form.register(\"price\")} />\r\n          <p className=\"text-xs text-slate-500\">Lo que cobra admisión al paciente</p>\r\n        </div>\r\n        <div className=\"space-y-2\">\r\n          <Label>Precio convenio (S/)</Label>\r\n          <Input\r\n            type=\"number\"\r\n            step=\"0.01\"\r\n            placeholder=\"Opcional; si vacío = precio público\"\r\n            {...form.register(\"priceToAdmission\")}\r\n          />\r\n          <p className=\"text-xs text-slate-500\">Lo que cobra el laboratorio a admisión</p>\r\n        </div>\r\n        <div className=\"space-y-2\">\r\n          <Label>Tiempo estimado (min)</Label>\r\n          <Input type=\"number\" {...form.register(\"estimatedTimeMinutes\")} />\r\n        </div>\r\n        <div className=\"flex items-center gap-2 pt-7\">\r\n          <input type=\"checkbox\" {...form.register(\"isActive\")} />\r\n          <Label>Activo</Label>\r\n        </div>\r\n      </div>\r\n      <div className=\"flex items-center gap-2 rounded-md border border-slate-200 bg-slate-50 px-4 py-3 dark:border-slate-600 dark:bg-slate-800/50\">\r\n        <input type=\"checkbox\" id=\"isReferred\" {...form.register(\"isReferred\")} />\r\n        <Label htmlFor=\"isReferred\" className=\"cursor-pointer font-medium\">\r\n          Análisis referido (derivado a otro laboratorio)\r\n        </Label>\r\n      </div>\r\n      {isReferredValue && (\r\n        <div className=\"space-y-3 rounded-md border border-slate-200 bg-slate-50 p-4 dark:border-slate-600 dark:bg-slate-800/30\">\r\n          <div className=\"flex items-center justify-between gap-2\">\r\n            <div>\r\n              <p className=\"text-sm font-medium text-slate-700 dark:text-slate-200\">Laboratorios referidos</p>\r\n              <p className=\"text-xs text-slate-500 dark:text-slate-400\">\r\n                Configura uno o varios labs a los que puedes derivar este análisis.\r\n              </p>\r\n            </div>\r\n            <Button type=\"button\" size=\"sm\" variant=\"outline\" onClick={addReferredOption}>\r\n              + Añadir lab referido\r\n            </Button>\r\n          </div>\r\n\r\n          {referredOptions.length === 0 ? (\r\n            <p className=\"text-xs text-slate-500 dark:text-slate-400\">\r\n              No hay labs referidos configurados. Añade al menos uno para marcar este análisis como referido.\r\n            </p>\r\n          ) : (\r\n            <div className=\"space-y-3\">\r\n              {referredOptions.map((opt, index) => (\r\n                <div\r\n                  key={index}\r\n                  className=\"grid gap-3 rounded-md border border-slate-200 bg-white/60 p-3 text-xs dark:border-slate-600 dark:bg-slate-900/30 md:grid-cols-4\"\r\n                >\r\n                  <div className=\"space-y-1 md:col-span-2\">\r\n                    <Label className=\"text-xs\">Laboratorio</Label>\r\n                    <select\r\n                      className=\"h-8 w-full rounded-md border border-slate-300 bg-white px-2 text-xs dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100\"\r\n                      {...form.register(`referredLabOptions.${index}.referredLabId` as const)}\r\n                    >\r\n                      <option value=\"\">Seleccionar…</option>\r\n                      {referredLabs.map((lab) => (\r\n                        <option key={lab.id} value={lab.id}>\r\n                          {lab.name}\r\n                        </option>\r\n                      ))}\r\n                    </select>\r\n                  </div>\r\n                  <div className=\"space-y-1\">\r\n                    <Label className=\"text-xs\">Precio convenio (S/)</Label>\r\n                    <Input\r\n                      type=\"number\"\r\n                      step=\"0.01\"\r\n                      className=\"h-8 text-xs\"\r\n                      {...form.register(`referredLabOptions.${index}.priceToAdmission` as const)}\r\n                    />\r\n                  </div>\r\n                  <div className=\"space-y-1\">\r\n                    <Label className=\"text-xs\">Costo lab. externo (S/)</Label>\r\n                    <Input\r\n                      type=\"number\"\r\n                      step=\"0.01\"\r\n                      className=\"h-8 text-xs\"\r\n                      {...form.register(`referredLabOptions.${index}.externalLabCost` as const)}\r\n                    />\r\n                  </div>\r\n                  <div className=\"flex items-center justify-between md:col-span-4\">\r\n                    <label className=\"flex items-center gap-1.5\">\r\n                      <input\r\n                        type=\"checkbox\"\r\n                        className=\"h-3 w-3\"\r\n                        {...form.register(`referredLabOptions.${index}.isDefault` as const)}\r\n                      />\r\n                      <span className=\"text-[11px] text-slate-600 dark:text-slate-300\">\r\n                        Usar como lab principal por defecto\r\n                      </span>\r\n                    </label>\r\n                    <button\r\n                      type=\"button\"\r\n                      onClick={() => removeReferredOption(index)}\r\n                      className=\"text-[11px] text-red-600 hover:underline dark:text-red-400\"\r\n                    >\r\n                      Quitar\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          )}\r\n        </div>\r\n      )}\r\n      <div className=\"flex justify-end\">\r\n        <Button type=\"submit\">Guardar</Button>\r\n      </div>\r\n    </form>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\forms\\OrderForm.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has a missing dependency: 'form'. Either include it or remove the dependency array.","line":130,"column":5,"nodeType":"ArrayExpression","endLine":130,"endColumn":41,"suggestions":[{"desc":"Update the dependencies array to be: [form, profiles]","fix":{"range":[4074,4110],"text":"[form, profiles]"}}]},{"ruleId":"react-hooks/use-memo","severity":2,"message":"Error: Expected the dependency list to be an array of simple expressions (e.g. `x`, `x.y.z`, `x?.y?.z`)\n\nExpected the dependency list to be an array of simple expressions (e.g. `x`, `x.y.z`, `x?.y?.z`).\n\nC:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\forms\\OrderForm.tsx:130:16\n  128 |           .flatMap((pid) => profiles.find((p) => p.id === pid)?.tests.map((t) => t.id) ?? [])\n  129 |       ),\n> 130 |     [profiles, form.watch(\"profileIds\")]\n      |                ^^^^^^^^^^^^^^^^^^^^^^^^ Expected the dependency list to be an array of simple expressions (e.g. `x`, `x.y.z`, `x?.y?.z`)\n  131 |   );\n  132 |\n  133 |   const getProfileContainingTest = (testId: string) =>","line":130,"column":16,"nodeType":null,"endLine":130,"endColumn":40},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has a complex expression in the dependency array. Extract it to a separate variable so it can be statically checked.","line":130,"column":16,"nodeType":"CallExpression","endLine":130,"endColumn":40}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useMemo, useState } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { useForm, type Resolver } from \"react-hook-form\";\r\nimport { zodResolver } from \"@hookform/resolvers/zod\";\r\nimport { toast } from \"sonner\";\r\nimport { Search, UserRound, FlaskConical, Tag, Stethoscope, FileText } from \"lucide-react\";\r\n\r\nimport { orderCreateSchema } from \"@/features/lab/schemas\";\r\nimport type { z } from \"zod\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { FormSection } from \"@/components/ui/form-section\";\r\nimport { FormFooter } from \"@/components/ui/form-footer\";\r\n\r\ntype OrderFormValues = z.infer<typeof orderCreateSchema>;\r\n\r\ntype PatientOption = {\r\n  id: string;\r\n  label: string;\r\n  dni: string;\r\n  firstName: string;\r\n  lastName: string;\r\n};\r\n\r\ntype TestOption = {\r\n  id: string;\r\n  label: string;\r\n  code: string;\r\n  name: string;\r\n  section: string;\r\n  sectionLabel: string;\r\n  price: number;\r\n  hasTemplate?: boolean;\r\n  templateTitle?: string | null;\r\n};\r\n\r\ntype ProfileOption = {\r\n  id: string;\r\n  name: string;\r\n  packagePrice: number | null;\r\n  tests: { id: string; code: string; name: string; section: string; price: number }[];\r\n};\r\n\r\ntype Props = {\r\n  patients: PatientOption[];\r\n  recentPatients?: PatientOption[];\r\n  tests: TestOption[];\r\n  profiles?: ProfileOption[];\r\n  /** ID del paciente a preseleccionar (ej. desde perfil de paciente) */\r\n  defaultPatientId?: string;\r\n};\r\n\r\nexport function OrderForm({ patients, recentPatients = [], tests, profiles = [], defaultPatientId }: Props) {\r\n  const router = useRouter();\r\n  const [patientSearch, setPatientSearch] = useState(\"\");\r\n  const [testSearch, setTestSearch] = useState(\"\");\r\n\r\n  const form = useForm<OrderFormValues>({\r\n    resolver: zodResolver(orderCreateSchema) as Resolver<OrderFormValues>,\r\n    defaultValues: {\r\n      patientId: defaultPatientId && patients.some((p) => p.id === defaultPatientId) ? defaultPatientId : \"\",\r\n      requestedBy: \"\",\r\n      notes: \"\",\r\n      orderDate: new Date().toISOString().slice(0, 10),\r\n      patientType: null,\r\n      labTestIds: [],\r\n      profileIds: [],\r\n    },\r\n  });\r\n\r\n  const selectedPatientId = form.watch(\"patientId\");\r\n  const selectedPatient = selectedPatientId\r\n    ? patients.find((p) => p.id === selectedPatientId)\r\n    : null;\r\n\r\n  const filteredPatients = useMemo(() => {\r\n    const term = patientSearch.trim().toLowerCase();\r\n    if (!term) return [];\r\n    return patients.filter(\r\n      (p) =>\r\n        p.dni.toLowerCase().includes(term) ||\r\n        p.firstName.toLowerCase().includes(term) ||\r\n        p.lastName.toLowerCase().includes(term) ||\r\n        p.label.toLowerCase().includes(term),\r\n    );\r\n  }, [patients, patientSearch]);\r\n\r\n  const filteredTestsBySection = useMemo(() => {\r\n    const term = testSearch.trim().toLowerCase();\r\n    const filtered = term\r\n      ? tests.filter(\r\n          (t) =>\r\n            t.label.toLowerCase().includes(term) ||\r\n            t.code.toLowerCase().includes(term) ||\r\n            t.name.toLowerCase().includes(term) ||\r\n            t.sectionLabel.toLowerCase().includes(term),\r\n        )\r\n      : tests;\r\n\r\n    const bySection = new Map<string, TestOption[]>();\r\n    for (const t of filtered) {\r\n      const key = t.sectionLabel;\r\n      if (!bySection.has(key)) bySection.set(key, []);\r\n      bySection.get(key)!.push(t);\r\n    }\r\n    return Array.from(bySection.entries()).sort((a, b) =>\r\n      a[0].localeCompare(b[0]),\r\n    );\r\n  }, [tests, testSearch]);\r\n\r\n  const handleSelectPatient = (patient: PatientOption) => {\r\n    form.setValue(\"patientId\", patient.id, { shouldValidate: true });\r\n    setPatientSearch(\"\");\r\n  };\r\n\r\n  const handleClearPatient = () => {\r\n    form.setValue(\"patientId\", \"\");\r\n    setPatientSearch(\"\");\r\n  };\r\n\r\n  const testIdsInPromos = useMemo(\r\n    () =>\r\n      new Set(\r\n        (form.watch(\"profileIds\") ?? [])\r\n          .flatMap((pid) => profiles.find((p) => p.id === pid)?.tests.map((t) => t.id) ?? [])\r\n      ),\r\n    [profiles, form.watch(\"profileIds\")]\r\n  );\r\n\r\n  const getProfileContainingTest = (testId: string) =>\r\n    profiles.find((p) => selectedProfileIds.includes(p.id) && p.tests.some((t) => t.id === testId));\r\n\r\n  const toggleTest = (testId: string) => {\r\n    const current = new Set(form.getValues(\"labTestIds\"));\r\n    if (current.has(testId)) {\r\n      current.delete(testId);\r\n      form.setValue(\"labTestIds\", Array.from(current), { shouldValidate: true });\r\n    } else {\r\n      if (testIdsInPromos.has(testId)) {\r\n        const promoContaining = getProfileContainingTest(testId);\r\n        toast.info(\r\n          `Este análisis ya está incluido en la promoción \"${promoContaining?.name ?? \"\"}\". No se puede seleccionar individualmente.`\r\n        );\r\n        return;\r\n      }\r\n      current.add(testId);\r\n      form.setValue(\"labTestIds\", Array.from(current), { shouldValidate: true });\r\n    }\r\n  };\r\n\r\n  const addProfile = (profileId: string) => {\r\n    const profile = profiles.find((p) => p.id === profileId);\r\n    if (!profile) return;\r\n    const currentProfiles = new Set(form.getValues(\"profileIds\"));\r\n    if (currentProfiles.has(profileId)) {\r\n      toast.info(\"Esta promoción ya está seleccionada.\");\r\n      return;\r\n    }\r\n    currentProfiles.add(profileId);\r\n    const profileTestIds = new Set(profile.tests.map((t) => t.id));\r\n    const currentLabIds = form.getValues(\"labTestIds\");\r\n    const labIds = currentLabIds.filter((id) => !profileTestIds.has(id));\r\n    \r\n    // Si se eliminaron análisis individuales porque ahora están en la promoción, mostrar mensaje\r\n    const removedCount = currentLabIds.length - labIds.length;\r\n    if (removedCount > 0) {\r\n      toast.info(\r\n        `Se agregó la promoción \"${profile.name}\". ${removedCount} análisis individual${removedCount > 1 ? \"es\" : \"\"} que ya estaban incluidos fueron removidos para evitar duplicados.`\r\n      );\r\n    }\r\n    \r\n    form.setValue(\"profileIds\", Array.from(currentProfiles), { shouldValidate: true });\r\n    form.setValue(\"labTestIds\", labIds, { shouldValidate: true });\r\n  };\r\n\r\n  const removeProfile = (profileId: string) => {\r\n    const current = form.getValues(\"profileIds\").filter((id) => id !== profileId);\r\n    form.setValue(\"profileIds\", current, { shouldValidate: true });\r\n  };\r\n\r\n  const onSubmit = async (values: OrderFormValues) => {\r\n    try {\r\n      const profileIds = values.profileIds ?? [];\r\n      const testIdsInSelectedPromos = new Set(\r\n        profileIds.flatMap(\r\n          (pid) => profiles.find((p) => p.id === pid)?.tests.map((t) => t.id) ?? []\r\n        )\r\n      );\r\n      const labTestIdsOnlyExternal = (values.labTestIds ?? []).filter(\r\n        (id) => !testIdsInSelectedPromos.has(id)\r\n      );\r\n      const res = await fetch(\"/api/orders\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({\r\n          ...values,\r\n          labTestIds: labTestIdsOnlyExternal,\r\n        }),\r\n      });\r\n\r\n      if (!res.ok) {\r\n        const errorData = await res.json().catch(() => ({}));\r\n        toast.error(errorData.error || \"No se pudo crear la orden.\");\r\n        return;\r\n      }\r\n\r\n      toast.success(\"Orden creada correctamente.\");\r\n      router.push(\"/orders\");\r\n      router.refresh();\r\n    } catch (error) {\r\n      console.error(\"Error submitting order form:\", error);\r\n      toast.error(\"Error de conexión. Intenta nuevamente.\");\r\n    }\r\n  };\r\n\r\n  const selectedIds = new Set(form.watch(\"labTestIds\"));\r\n  const selectedProfileIds = form.watch(\"profileIds\") ?? [];\r\n  const selectedProfiles = profiles.filter((p) => selectedProfileIds.includes(p.id));\r\n  const selectedIndividualTests = tests.filter(\r\n    (t) => selectedIds.has(t.id) && !testIdsInPromos.has(t.id)\r\n  );\r\n  const totalFromProfiles = selectedProfiles.reduce((acc, p) => {\r\n    return acc + (p.packagePrice ?? p.tests.reduce((s, t) => s + t.price, 0));\r\n  }, 0);\r\n  const totalFromTests = selectedIndividualTests.reduce((acc, t) => acc + t.price, 0);\r\n  const total = totalFromProfiles + totalFromTests;\r\n\r\n  return (\r\n    <form onSubmit={form.handleSubmit(onSubmit)} className=\"divide-y divide-slate-100 dark:divide-slate-800\">\r\n      <FormSection title=\"Paciente y solicitud\" icon={UserRound} iconBg=\"teal\">\r\n        <div className=\"grid gap-5 sm:grid-cols-2\">\r\n          <div className=\"space-y-2 min-w-0\">\r\n            <Label className=\"text-xs font-medium text-slate-500 dark:text-slate-400\">Paciente</Label>\r\n            {selectedPatient ? (\r\n              <div className=\"flex items-center gap-2 sm:gap-3 rounded-xl border border-slate-200 bg-white px-4 py-3 shadow-sm min-w-0 dark:border-slate-700 dark:bg-slate-800/50\">\r\n                <span className=\"h-2 w-2 shrink-0 rounded-full bg-emerald-500\" />\r\n                <span className=\"flex-1 text-sm font-medium text-slate-900 truncate min-w-0 dark:text-slate-100\">\r\n                  {selectedPatient.label}\r\n                </span>\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={handleClearPatient}\r\n                  className=\"text-sm font-medium text-teal-600 hover:text-teal-700 dark:text-teal-400 dark:hover:text-teal-300\"\r\n                >\r\n                  Cambiar\r\n                </button>\r\n              </div>\r\n            ) : (\r\n              <div className=\"space-y-3\">\r\n                {recentPatients.length > 0 && (\r\n                  <div>\r\n                    <p className=\"text-xs font-medium text-slate-500 mb-2\">\r\n                      Últimos 3 registrados\r\n                    </p>\r\n                    <div className=\"flex flex-wrap gap-2\">\r\n                      {recentPatients.map((p) => (\r\n                        <button\r\n                          key={p.id}\r\n                          type=\"button\"\r\n                          onClick={() => handleSelectPatient(p)}\r\n                          className=\"rounded-lg border border-slate-200 bg-white px-3 py-2 text-left text-sm shadow-sm hover:bg-slate-50 hover:border-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-400 min-w-0 max-w-full sm:max-w-none\"\r\n                        >\r\n                          <span className=\"font-medium text-slate-900 block truncate\">{p.label}</span>\r\n                          <span className=\"text-slate-500 text-xs\">DNI {p.dni}</span>\r\n                        </button>\r\n                      ))}\r\n                    </div>\r\n                  </div>\r\n                )}\r\n                <div className=\"relative\">\r\n                  <Search className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-slate-400\" />\r\n                  <Input\r\n                    type=\"text\"\r\n                    placeholder=\"Buscar por DNI o nombre...\"\r\n                    value={patientSearch}\r\n                    onChange={(e) => setPatientSearch(e.target.value)}\r\n                    autoComplete=\"off\"\r\n                    className=\"pl-9 rounded-xl\"\r\n                  />\r\n                {patientSearch.trim() && (\r\n                  <ul className=\"absolute z-10 mt-1 w-full rounded-xl border border-slate-200 bg-white py-1 shadow-lg max-h-52 overflow-y-auto dark:border-slate-700 dark:bg-slate-900\">\r\n                    {filteredPatients.length === 0 ? (\r\n                      <li className=\"px-4 py-3 text-sm text-slate-500\">\r\n                        Sin coincidencias. Pruebe DNI, nombre o apellido.\r\n                      </li>\r\n                    ) : (\r\n                      filteredPatients.map((patient) => (\r\n                        <li key={patient.id}>\r\n                          <button\r\n                            type=\"button\"\r\n                            onClick={() => handleSelectPatient(patient)}\r\n                            className=\"w-full px-4 py-2.5 text-left text-sm transition-colors hover:bg-teal-50/80 dark:hover:bg-teal-900/20 focus:outline-none\"\r\n                          >\r\n                            <span className=\"font-medium text-slate-900\">\r\n                              {patient.label}\r\n                            </span>\r\n                            <span className=\"ml-2 text-slate-500\">\r\n                              DNI {patient.dni}\r\n                            </span>\r\n                          </button>\r\n                        </li>\r\n                      ))\r\n                    )}\r\n                  </ul>\r\n                )}\r\n                </div>\r\n              </div>\r\n            )}\r\n          </div>\r\n          <div className=\"space-y-2\">\r\n            <Label className=\"text-xs font-medium text-slate-500 dark:text-slate-400\">Fecha de la orden</Label>\r\n            <Input\r\n              type=\"date\"\r\n              {...form.register(\"orderDate\")}\r\n              className=\"rounded-xl\"\r\n            />\r\n          </div>\r\n          <div className=\"space-y-2\">\r\n            <Label className=\"text-xs font-medium text-slate-500 dark:text-slate-400\">Tipo de paciente</Label>\r\n            <select\r\n              {...form.register(\"patientType\")}\r\n              className=\"h-10 w-full rounded-xl border border-slate-200 bg-white px-3 text-sm dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100\"\r\n            >\r\n              <option value=\"\">Sin especificar</option>\r\n              <option value=\"CLINICA\">Paciente Clínica</option>\r\n              <option value=\"EXTERNO\">Paciente Externo</option>\r\n              <option value=\"IZAGA\">Paciente Izaga</option>\r\n            </select>\r\n            <p className=\"text-xs text-slate-500\">Solo para reportes; no se muestra en PDF.</p>\r\n          </div>\r\n          <div className=\"space-y-2\">\r\n            <Label className=\"text-xs font-medium text-slate-500 dark:text-slate-400\">\r\n              <Stethoscope className=\"mr-1 inline-block h-3.5 w-3.5\" />\r\n              Médico solicitante\r\n            </Label>\r\n            <Input\r\n              {...form.register(\"requestedBy\")}\r\n              placeholder=\"Ej: Dr. García\"\r\n              className=\"rounded-xl\"\r\n            />\r\n          </div>\r\n        </div>\r\n        <div className=\"space-y-2\">\r\n          <Label className=\"text-xs font-medium text-slate-500 dark:text-slate-400\">\r\n            <FileText className=\"mr-1 inline-block h-3.5 w-3.5\" />\r\n            Notas (opcional)\r\n          </Label>\r\n          <Input\r\n            {...form.register(\"notes\")}\r\n            placeholder=\"Indicaciones o observaciones\"\r\n            className=\"rounded-xl\"\r\n          />\r\n        </div>\r\n      </FormSection>\r\n\r\n      <FormSection title=\"Análisis a solicitar\" icon={FlaskConical} iconBg=\"cyan\">\r\n        <div className=\"space-y-4 min-w-0\">\r\n        <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between\">\r\n          {(selectedIndividualTests.length > 0 || selectedProfiles.length > 0) && (\r\n            <p className=\"text-sm text-slate-500\">\r\n              {selectedProfiles.length > 0 && (\r\n                <span className=\"font-medium text-slate-700\">\r\n                  {selectedProfiles.length} promoción(es)\r\n                </span>\r\n              )}\r\n              {selectedProfiles.length > 0 && selectedIndividualTests.length > 0 && \" · \"}\r\n              {selectedIndividualTests.length > 0 && (\r\n                <span className=\"font-medium text-slate-700\">\r\n                  {selectedIndividualTests.length} análisis sueltos\r\n                </span>\r\n              )}\r\n              {\" · Total: \"}\r\n              <span className=\"font-semibold text-slate-900\">\r\n                S/ {total.toFixed(2)}\r\n              </span>\r\n            </p>\r\n          )}\r\n        </div>\r\n\r\n        {profiles.length > 0 && (\r\n          <div className=\"flex flex-wrap items-center gap-2 rounded-xl border border-slate-200/80 bg-slate-50/80 p-3 dark:border-slate-700 dark:bg-slate-800/40\">\r\n            <Tag className=\"h-4 w-4 text-slate-500\" />\r\n            <select\r\n              className=\"h-9 rounded-lg border border-slate-200 bg-white px-3 text-sm dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100\"\r\n              onChange={(e) => {\r\n                const id = e.target.value;\r\n                if (id) {\r\n                  addProfile(id);\r\n                  e.target.value = \"\";\r\n                }\r\n              }}\r\n            >\r\n              <option value=\"\">+ Agregar promoción</option>\r\n              {profiles.map((p) => (\r\n                <option key={p.id} value={p.id}>\r\n                  {p.name}\r\n                  {p.packagePrice != null ? ` — S/ ${p.packagePrice.toFixed(2)}` : \"\"}\r\n                  {` (${p.tests.length} análisis)`}\r\n                </option>\r\n              ))}\r\n            </select>\r\n            {selectedProfiles.map((p) => (\r\n              <span\r\n                key={p.id}\r\n                className=\"inline-flex items-center gap-1.5 rounded-full bg-teal-100 px-3 py-1 text-xs font-medium text-teal-700 dark:bg-teal-900/50 dark:text-teal-300\"\r\n              >\r\n                {p.name}\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => removeProfile(p.id)}\r\n                  className=\"text-slate-400 hover:text-red-600\"\r\n                  title=\"Quitar\"\r\n                >\r\n                  ×\r\n                </button>\r\n              </span>\r\n            ))}\r\n          </div>\r\n        )}\r\n\r\n        <div className=\"relative\">\r\n          <Search className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-slate-400\" />\r\n          <Input\r\n            type=\"text\"\r\n            placeholder=\"Buscar por código, nombre o sección...\"\r\n            value={testSearch}\r\n            onChange={(e) => setTestSearch(e.target.value)}\r\n            autoComplete=\"off\"\r\n            className=\"pl-9 rounded-xl\"\r\n          />\r\n        </div>\r\n\r\n        <div className=\"rounded-xl border border-slate-200 bg-white overflow-hidden min-w-0 shadow-inner dark:border-slate-700 dark:bg-slate-900/30\">\r\n          <div className=\"max-h-[420px] overflow-y-auto overflow-x-hidden\">\r\n            {filteredTestsBySection.length === 0 ? (\r\n              <div className=\"px-5 py-8 text-center text-sm text-slate-500\">\r\n                {testSearch.trim()\r\n                  ? \"Ningún análisis coincide con la búsqueda.\"\r\n                  : \"No hay análisis disponibles.\"}\r\n              </div>\r\n            ) : (\r\n              <ul className=\"divide-y divide-slate-100\">\r\n                {filteredTestsBySection.map(([sectionLabel, sectionTests]) => (\r\n                  <li key={sectionLabel}>\r\n                    <div className=\"sticky top-0 z-[1] bg-teal-50/90 px-4 py-2 text-xs font-semibold uppercase tracking-wider text-teal-700 dark:bg-teal-900/40 dark:text-teal-300\">\r\n                      {sectionLabel}\r\n                    </div>\r\n                    <ul className=\"py-1\">\r\n                      {sectionTests.map((test) => {\r\n                        const isInPromo = testIdsInPromos.has(test.id);\r\n                        const promoContaining = getProfileContainingTest(test.id);\r\n                        const isSelected = selectedIds.has(test.id);\r\n                        const isDisabled = isInPromo;\r\n                        return (\r\n                          <li key={test.id}>\r\n                            <label\r\n                              className={`flex items-center gap-4 px-4 py-3 transition-colors ${\r\n                                isDisabled ? \"cursor-default opacity-90\" : \"cursor-pointer hover:bg-slate-50/80 dark:hover:bg-slate-800/30\"\r\n                              } ${isSelected ? \"bg-teal-50/50 dark:bg-teal-900/20\" : \"\"} ${isInPromo ? \"bg-amber-50/70 dark:bg-amber-950/25\" : \"\"}`}\r\n                            >\r\n                              <input\r\n                                type=\"checkbox\"\r\n                                checked={isSelected || isInPromo}\r\n                                disabled={isDisabled}\r\n                                onChange={() => !isDisabled && toggleTest(test.id)}\r\n                                className=\"h-4 w-4 rounded border-slate-300 text-teal-600 focus:ring-teal-500 disabled:opacity-70\"\r\n                                title={isInPromo ? `Incluido en promoción: ${promoContaining?.name ?? \"\"}` : undefined}\r\n                              />\r\n                              <span className=\"flex-1 min-w-0\">\r\n                                <span className=\"font-medium text-slate-900 block truncate\">\r\n                                  {test.name}\r\n                                </span>\r\n                                <span className=\"text-xs text-slate-500\">\r\n                                  {test.code}\r\n                                  {isInPromo && promoContaining && (\r\n                                    <span className=\"ml-2 text-amber-600\">\r\n                                      · Incluido en {promoContaining.name}\r\n                                    </span>\r\n                                  )}\r\n                                  {!isInPromo && test.hasTemplate && (\r\n                                    <span className=\"ml-2 text-blue-600\">\r\n                                      · Con plantilla\r\n                                    </span>\r\n                                  )}\r\n                                </span>\r\n                              </span>\r\n                              <span className=\"text-sm font-medium text-slate-700 shrink-0\">\r\n                                S/ {test.price.toFixed(2)}\r\n                              </span>\r\n                            </label>\r\n                          </li>\r\n                        );\r\n                      })}\r\n                    </ul>\r\n                  </li>\r\n                ))}\r\n              </ul>\r\n            )}\r\n          </div>\r\n        </div>\r\n\r\n        {(selectedIndividualTests.length > 0 || selectedProfiles.length > 0) && (\r\n          <div className=\"rounded-xl border border-slate-200/80 bg-slate-50/80 px-4 py-3 space-y-3 dark:border-slate-700 dark:bg-slate-800/30\">\r\n            <p className=\"text-xs font-medium text-slate-500\">\r\n              Resumen (promociones encapsuladas, análisis sueltos aparte)\r\n            </p>\r\n            {selectedProfiles.length > 0 && (\r\n              <div className=\"space-y-2\">\r\n                <p className=\"text-xs font-semibold text-slate-600\">Promociones</p>\r\n                {selectedProfiles.map((p) => (\r\n                  <div\r\n                    key={p.id}\r\n                    className=\"rounded border border-amber-200 bg-amber-50/50 px-3 py-2\"\r\n                  >\r\n                    <div className=\"flex items-center justify-between gap-2\">\r\n                      <span className=\"text-sm font-medium text-slate-800\">{p.name}</span>\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() => removeProfile(p.id)}\r\n                        className=\"text-slate-400 hover:text-red-600 text-xs\"\r\n                        title=\"Quitar promoción\"\r\n                      >\r\n                        × Quitar\r\n                      </button>\r\n                    </div>\r\n                    <p className=\"text-xs text-slate-600 mt-1\">\r\n                      Análisis: {p.tests.map((t) => t.code).join(\", \")}\r\n                    </p>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            )}\r\n            {selectedIndividualTests.length > 0 && (\r\n              <div>\r\n                <p className=\"text-xs font-semibold text-slate-600 mb-1\">Análisis sueltos</p>\r\n                <ul className=\"flex flex-wrap gap-2\">\r\n                  {selectedIndividualTests.map((t) => (\r\n                    <li\r\n                      key={t.id}\r\n                      className=\"inline-flex items-center gap-1.5 rounded-full bg-white px-2.5 py-1 text-xs font-medium text-slate-700 shadow-sm border border-slate-200\"\r\n                    >\r\n                      {t.code}\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() => toggleTest(t.id)}\r\n                        className=\"text-slate-400 hover:text-red-600 rounded-full p-0.5 leading-none\"\r\n                        title=\"Quitar\"\r\n                      >\r\n                        ×\r\n                      </button>\r\n                    </li>\r\n                  ))}\r\n                </ul>\r\n              </div>\r\n            )}\r\n          </div>\r\n        )}\r\n        </div>\r\n      </FormSection>\r\n\r\n      <FormFooter\r\n        total={\r\n          (selectedProfileIds.length > 0 || selectedIds.size > 0) && (\r\n            <div className=\"flex items-baseline gap-2\">\r\n              <span className=\"text-sm text-slate-600 dark:text-slate-400\">Total:</span>\r\n              <span className=\"text-xl font-bold text-teal-600 dark:text-teal-400\">S/ {total.toFixed(2)}</span>\r\n            </div>\r\n          )\r\n        }\r\n      >\r\n        <Button\r\n          type=\"submit\"\r\n          className=\"min-w-[140px] bg-gradient-to-r from-teal-600 to-cyan-600 hover:from-teal-500 hover:to-cyan-500\"\r\n          disabled={selectedProfileIds.length === 0 && selectedIds.size === 0}\r\n        >\r\n          Crear orden\r\n        </Button>\r\n      </FormFooter>\r\n    </form>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\forms\\PatientForm.tsx","messages":[{"ruleId":"react-hooks/incompatible-library","severity":1,"message":"Compilation Skipped: Use of incompatible library\n\nThis API returns functions which cannot be memoized without leading to stale UI. To prevent this, by default React Compiler will skip memoizing this component/hook. However, you may see issues if values from this API are passed to other components/hooks that are memoized.\n\nC:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\forms\\PatientForm.tsx:83:21\n  81 |   }, [patientId]);\n  82 |\n> 83 |   const birthDate = form.watch(\"birthDate\");\n     |                     ^^^^ React Hook Form's `useForm()` API returns a `watch()` function which cannot be memoized safely.\n  84 |   const displayedAge = useMemo(() => {\n  85 |     if (!birthDate || typeof birthDate !== \"string\") return null;\n  86 |     try {","line":83,"column":21,"nodeType":null,"endLine":83,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useMemo, useState } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { useForm } from \"react-hook-form\";\r\nimport { zodResolver } from \"@hookform/resolvers/zod\";\r\nimport { toast } from \"sonner\";\r\nimport { User, Hash, Mail, Phone, MapPin } from \"lucide-react\";\r\n\r\nimport { patientSchema } from \"@/features/lab/schemas\";\r\nimport { calculateAge } from \"@/lib/template-helpers\";\r\nimport { toDateTimeLocal } from \"@/lib/format\";\r\nimport type { z } from \"zod\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { FormSection } from \"@/components/ui/form-section\";\r\nimport { FormFooter } from \"@/components/ui/form-footer\";\r\n\r\ntype PatientFormValues = z.infer<typeof patientSchema>;\r\n\r\ntype Props = {\r\n  patientId?: string;\r\n  defaultValues?: Partial<PatientFormValues>;\r\n  /** Si false, el formulario es solo lectura (solo administradores pueden editar). */\r\n  canEdit?: boolean;\r\n  /** Fecha y hora de creación del registro (solo para pacientes existentes). */\r\n  createdAt?: Date | string;\r\n};\r\n\r\nexport function PatientForm({ patientId, defaultValues, canEdit = true, createdAt }: Props) {\r\n  const router = useRouter();\r\n  const [nextCode, setNextCode] = useState<string | null>(null);\r\n  const [loadingCode, setLoadingCode] = useState(false);\r\n\r\n  const form = useForm<PatientFormValues>({\r\n    resolver: zodResolver(patientSchema),\r\n    defaultValues: {\r\n      dni: \"\",\r\n      firstName: \"\",\r\n      lastName: \"\",\r\n      birthDate: \"\",\r\n      sex: \"M\",\r\n      phone: \"\",\r\n      address: \"\",\r\n      email: \"\",\r\n      createdAt: patientId && createdAt ? toDateTimeLocal(createdAt) : toDateTimeLocal(new Date()),\r\n      ...defaultValues,\r\n      ...(createdAt && { createdAt: toDateTimeLocal(createdAt) }),\r\n    },\r\n  });\r\n\r\n  // Nuevo paciente: actualizar createdAt cada segundo para mostrar el momento actual\r\n  useEffect(() => {\r\n    if (!patientId) {\r\n      const tick = () => form.setValue(\"createdAt\", toDateTimeLocal(new Date()));\r\n      tick();\r\n      const id = setInterval(tick, 1000);\r\n      return () => clearInterval(id);\r\n    }\r\n  }, [patientId, form]);\r\n\r\n  // Cargar el próximo código disponible cuando es un nuevo paciente\r\n  useEffect(() => {\r\n    if (!patientId) {\r\n      setLoadingCode(true);\r\n      fetch(\"/api/patients/next-code\")\r\n        .then((res) => res.json())\r\n        .then((data) => {\r\n          if (data.code) {\r\n            setNextCode(data.code);\r\n          }\r\n        })\r\n        .catch(() => {\r\n          // Silencioso: si falla, simplemente no mostramos el código\r\n        })\r\n        .finally(() => {\r\n          setLoadingCode(false);\r\n        });\r\n    }\r\n  }, [patientId]);\r\n\r\n  const birthDate = form.watch(\"birthDate\");\r\n  const displayedAge = useMemo(() => {\r\n    if (!birthDate || typeof birthDate !== \"string\") return null;\r\n    try {\r\n      const date = new Date(birthDate);\r\n      if (isNaN(date.getTime())) return null;\r\n      return calculateAge(date);\r\n    } catch {\r\n      return null;\r\n    }\r\n  }, [birthDate]);\r\n\r\n  const onSubmit = async (values: PatientFormValues) => {\r\n    try {\r\n      const method = patientId ? \"PUT\" : \"POST\";\r\n      const url = patientId ? `/api/patients/${patientId}` : \"/api/patients\";\r\n\r\n      // Nuevo paciente: usar el momento exacto en que se hace clic en Guardar\r\n      const payload = patientId ? values : { ...values, createdAt: toDateTimeLocal(new Date()) };\r\n\r\n      const res = await fetch(url, {\r\n        method,\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify(payload),\r\n      });\r\n\r\n      if (!res.ok) {\r\n        const errorData = await res.json().catch(() => ({}));\r\n        toast.error(errorData.error || \"No se pudo guardar el paciente.\");\r\n        return;\r\n      }\r\n\r\n      const data = await res.json().catch(() => ({}));\r\n      const code = data?.item?.code as string | undefined;\r\n      toast.success(\r\n        code\r\n          ? `Paciente guardado correctamente. Código: ${code}`\r\n          : \"Paciente guardado correctamente.\",\r\n      );\r\n      router.refresh();\r\n    } catch (error) {\r\n      console.error(\"Error submitting patient form:\", error);\r\n      toast.error(\"Error de conexión. Intenta nuevamente.\");\r\n    }\r\n  };\r\n\r\n  return (\r\n    <form onSubmit={form.handleSubmit(onSubmit)} className=\"divide-y divide-slate-100 dark:divide-slate-800\">\r\n      <FormSection title=\"Datos del paciente\" icon={User} iconBg=\"teal\">\r\n      <div className=\"grid gap-4 sm:grid-cols-2 lg:grid-cols-3\">\r\n        <div>\r\n          <Label className=\"text-xs font-medium text-slate-500 dark:text-slate-400\">\r\n            <Hash className=\"mr-1 inline-block h-3.5 w-3.5\" />\r\n            Código\r\n          </Label>\r\n          {patientId ? (\r\n            <p className=\"mt-1 h-10 flex items-center rounded-xl border border-slate-200 bg-slate-50 px-3 text-sm text-slate-700 dark:bg-slate-800 dark:text-slate-200 dark:border-slate-600\">\r\n              {defaultValues?.code ?? \"-\"}\r\n            </p>\r\n          ) : loadingCode ? (\r\n            <p className=\"mt-1 h-10 flex items-center rounded-xl border border-dashed border-slate-300 bg-slate-50 px-3 text-xs text-slate-500 dark:bg-slate-800 dark:text-slate-400 dark:border-slate-600\">\r\n              Cargando...\r\n            </p>\r\n          ) : nextCode ? (\r\n            <p className=\"mt-1 h-10 flex items-center rounded-xl border border-slate-200 bg-slate-50 px-3 text-sm font-mono font-medium text-slate-900 dark:bg-slate-800 dark:text-slate-100 dark:border-slate-600\">\r\n              {nextCode}\r\n            </p>\r\n          ) : (\r\n            <p className=\"mt-1 h-10 flex items-center rounded-xl border border-dashed border-slate-300 bg-slate-50 px-3 text-xs text-slate-500 dark:bg-slate-800 dark:text-slate-400 dark:border-slate-600\">\r\n              Se generará automáticamente\r\n            </p>\r\n          )}\r\n        </div>\r\n        <div>\r\n          <Label className=\"text-xs font-medium text-slate-500 dark:text-slate-400\">DNI</Label>\r\n          <Input className=\"mt-1 rounded-xl\" {...form.register(\"dni\")} disabled={!canEdit} readOnly={!canEdit} />\r\n        </div>\r\n        <div>\r\n          <Label className=\"text-xs font-medium text-slate-500 dark:text-slate-400\">Fecha de creación</Label>\r\n          {patientId ? (\r\n            <Input\r\n              type=\"datetime-local\"\r\n              className=\"mt-1 rounded-xl\"\r\n              {...form.register(\"createdAt\")}\r\n              disabled={!canEdit}\r\n            />\r\n          ) : (\r\n            <Input\r\n              type=\"datetime-local\"\r\n              className=\"mt-1 rounded-xl read-only:cursor-default\"\r\n              {...form.register(\"createdAt\")}\r\n              readOnly\r\n            />\r\n          )}\r\n        </div>\r\n      </div>\r\n      <div className=\"mt-4 grid gap-4 sm:grid-cols-2 lg:grid-cols-3\">\r\n        <div>\r\n          <Label className=\"text-xs font-medium text-slate-500 dark:text-slate-400\">Nombres</Label>\r\n          <Input className=\"mt-1 rounded-xl\" {...form.register(\"firstName\")} disabled={!canEdit} readOnly={!canEdit} placeholder=\"Ej: Juan Carlos\" />\r\n        </div>\r\n        <div>\r\n          <Label className=\"text-xs font-medium text-slate-500 dark:text-slate-400\">Apellidos</Label>\r\n          <Input className=\"mt-1 rounded-xl\" {...form.register(\"lastName\")} disabled={!canEdit} readOnly={!canEdit} placeholder=\"Ej: García López\" />\r\n        </div>\r\n        <div>\r\n          <Label className=\"text-xs font-medium text-slate-500 dark:text-slate-400\">Fecha de nacimiento</Label>\r\n          <Input type=\"date\" className=\"mt-1 rounded-xl\" {...form.register(\"birthDate\")} disabled={!canEdit} readOnly={!canEdit} />\r\n        </div>\r\n        <div>\r\n          <Label className=\"text-xs font-medium text-slate-500 dark:text-slate-400\">Edad</Label>\r\n          <Input\r\n            className=\"mt-1 rounded-xl read-only:cursor-default read-only:opacity-100\"\r\n            value={displayedAge !== null ? `${displayedAge} años` : \"\"}\r\n            placeholder=\"Se calcula automáticamente\"\r\n            readOnly\r\n          />\r\n        </div>\r\n        <div>\r\n          <Label className=\"text-xs font-medium text-slate-500 dark:text-slate-400\">Sexo</Label>\r\n          <select\r\n            className=\"mt-1 h-10 w-full rounded-xl border border-slate-200 bg-white px-3 text-sm dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100 disabled:opacity-70 disabled:cursor-not-allowed\"\r\n            {...form.register(\"sex\")}\r\n            disabled={!canEdit}\r\n          >\r\n            <option value=\"M\">Masculino</option>\r\n            <option value=\"F\">Femenino</option>\r\n            <option value=\"O\">Otro</option>\r\n          </select>\r\n        </div>\r\n        <div>\r\n          <Label className=\"text-xs font-medium text-slate-500 dark:text-slate-400\">\r\n            <Phone className=\"mr-1 inline-block h-3.5 w-3.5\" />\r\n            Teléfono\r\n          </Label>\r\n          <Input className=\"mt-1 rounded-xl\" {...form.register(\"phone\")} disabled={!canEdit} readOnly={!canEdit} placeholder=\"Opcional\" />\r\n        </div>\r\n      </div>\r\n      <div className=\"mt-4 grid gap-4 sm:grid-cols-2\">\r\n        <div>\r\n          <Label className=\"text-xs font-medium text-slate-500 dark:text-slate-400\">\r\n            <MapPin className=\"mr-1 inline-block h-3.5 w-3.5\" />\r\n            Dirección\r\n          </Label>\r\n          <Input className=\"mt-1 rounded-xl\" {...form.register(\"address\")} disabled={!canEdit} readOnly={!canEdit} placeholder=\"Opcional\" />\r\n        </div>\r\n        <div>\r\n          <Label className=\"text-xs font-medium text-slate-500 dark:text-slate-400\">\r\n            <Mail className=\"mr-1 inline-block h-3.5 w-3.5\" />\r\n            Email\r\n          </Label>\r\n          <Input type=\"email\" className=\"mt-1 rounded-xl\" {...form.register(\"email\")} disabled={!canEdit} readOnly={!canEdit} placeholder=\"Opcional\" />\r\n        </div>\r\n      </div>\r\n      </FormSection>\r\n      {canEdit && (\r\n        <FormFooter>\r\n          <Button type=\"submit\" className=\"min-w-[120px] bg-gradient-to-r from-teal-600 to-cyan-600 hover:from-teal-500 hover:to-cyan-500\">\r\n            Guardar\r\n          </Button>\r\n        </FormFooter>\r\n      )}\r\n      {!canEdit && patientId && (\r\n        <div className=\"p-6 sm:p-8\">\r\n          <p className=\"text-sm text-slate-500 dark:text-slate-400\">\r\n            Solo los administradores pueden modificar los datos del paciente.\r\n          </p>\r\n        </div>\r\n      )}\r\n    </form>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\forms\\RefRangesManager.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Control' is defined but never used.","line":4,"column":41,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":48,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Control"},"fix":{"range":[90,99],"text":""},"desc":"Remove unused variable \"Control\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Label' is defined but never used.","line":7,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":15,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Label"},"fix":{"range":[225,271],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport { useFieldArray, useFormContext, Control } from \"react-hook-form\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogTrigger,\r\n} from \"@/components/ui/dialog\";\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\r\nimport { Plus, Trash2 } from \"lucide-react\";\r\nimport { ageGroupValues, sexValues } from \"@/features/lab/schemas\";\r\n\r\ntype Props = {\r\n  itemIndex: number;\r\n};\r\n\r\nexport function RefRangesManager({ itemIndex }: Props) {\r\n  const form = useFormContext();\r\n  const [open, setOpen] = useState(false);\r\n\r\n  const { fields, append, remove } = useFieldArray({\r\n    control: form.control,\r\n    name: `items.${itemIndex}.refRanges`,\r\n  });\r\n\r\n  const addRange = () => {\r\n    append({\r\n      ageGroup: null,\r\n      sex: null,\r\n      refRangeText: \"\",\r\n      refMin: undefined,\r\n      refMax: undefined,\r\n      order: fields.length,\r\n    });\r\n  };\r\n\r\n  const ageGroupLabels: Record<string, string> = {\r\n    NIÑOS: \"Niños\",\r\n    JOVENES: \"Jóvenes\",\r\n    ADULTOS: \"Adultos\",\r\n  };\r\n\r\n  const sexLabels: Record<string, string> = {\r\n    M: \"Hombres\",\r\n    F: \"Mujeres\",\r\n    O: \"Otros\",\r\n  };\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={setOpen}>\r\n      <DialogTrigger asChild>\r\n        <Button type=\"button\" variant=\"outline\" size=\"sm\" className=\"text-xs\">\r\n          Rangos de referencia\r\n          {fields.length > 0 && (\r\n            <span className=\"ml-1 text-slate-500 dark:text-slate-400\">({fields.length})</span>\r\n          )}\r\n        </Button>\r\n      </DialogTrigger>\r\n      <DialogContent className=\"max-w-4xl max-h-[80vh] overflow-y-auto\">\r\n        <DialogHeader>\r\n          <DialogTitle>Valores Referenciales</DialogTitle>\r\n          <p className=\"text-sm text-slate-500 dark:text-slate-400 mt-1\">\r\n            Configure múltiples rangos según edad y sexo. Si no especifica edad/sexo, será el valor por defecto.\r\n          </p>\r\n        </DialogHeader>\r\n        <div className=\"space-y-4 mt-4\">\r\n          <div className=\"flex justify-end\">\r\n            <Button type=\"button\" onClick={addRange} size=\"sm\">\r\n              <Plus className=\"h-4 w-4 mr-2\" />\r\n              Agregar rango\r\n            </Button>\r\n          </div>\r\n\r\n          {fields.length === 0 ? (\r\n            <div className=\"text-center py-8 text-slate-500 dark:text-slate-400\">\r\n              <p>No hay rangos configurados.</p>\r\n              <p className=\"text-sm mt-1\">Agrega un rango para definir valores referenciales específicos.</p>\r\n            </div>\r\n          ) : (\r\n            <div className=\"rounded-lg border border-slate-200 dark:border-slate-600 overflow-hidden\">\r\n              <Table>\r\n                <TableHeader>\r\n                  <TableRow>\r\n                    <TableHead className=\"w-12\">#</TableHead>\r\n                    <TableHead>Grupo de edad</TableHead>\r\n                    <TableHead>Sexo</TableHead>\r\n                    <TableHead>Texto</TableHead>\r\n                    <TableHead className=\"w-24\">Mínimo</TableHead>\r\n                    <TableHead className=\"w-24\">Máximo</TableHead>\r\n                    <TableHead className=\"w-16\"></TableHead>\r\n                  </TableRow>\r\n                </TableHeader>\r\n                <TableBody>\r\n                  {fields.map((field, idx) => (\r\n                    <TableRow key={field.id}>\r\n                      <TableCell className=\"text-xs text-slate-500 dark:text-slate-400\">{idx + 1}</TableCell>\r\n                      <TableCell>\r\n                        <select\r\n                          className=\"h-9 w-full rounded-md border border-slate-200 bg-white px-2 text-sm dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100\"\r\n                          {...form.register(`items.${itemIndex}.refRanges.${idx}.ageGroup`, {\r\n                            setValueAs: (v) => (v === \"\" ? null : v),\r\n                          })}\r\n                        >\r\n                          <option value=\"\">Todos</option>\r\n                          {ageGroupValues.map((ag) => (\r\n                            <option key={ag} value={ag}>\r\n                              {ageGroupLabels[ag] ?? ag}\r\n                            </option>\r\n                          ))}\r\n                        </select>\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <select\r\n                          className=\"h-9 w-full rounded-md border border-slate-200 bg-white px-2 text-sm dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100\"\r\n                          {...form.register(`items.${itemIndex}.refRanges.${idx}.sex`, {\r\n                            setValueAs: (v) => (v === \"\" ? null : v),\r\n                          })}\r\n                        >\r\n                          <option value=\"\">Todos</option>\r\n                          {sexValues.map((s) => (\r\n                            <option key={s} value={s}>\r\n                              {sexLabels[s] ?? s}\r\n                            </option>\r\n                          ))}\r\n                        </select>\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <Input\r\n                          className=\"h-9 text-sm\"\r\n                          placeholder=\"Ej: 5,000 - 10,000\"\r\n                          {...form.register(`items.${itemIndex}.refRanges.${idx}.refRangeText`, {\r\n                            setValueAs: (v) => (v === \"\" ? null : v),\r\n                          })}\r\n                        />\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <Input\r\n                          type=\"number\"\r\n                          step=\"0.01\"\r\n                          className=\"h-9 text-sm\"\r\n                          placeholder=\"Min\"\r\n                          {...form.register(`items.${itemIndex}.refRanges.${idx}.refMin`, {\r\n                            setValueAs: (v) => (v === \"\" || v === null || v === undefined ? null : Number(v)),\r\n                          })}\r\n                        />\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <Input\r\n                          type=\"number\"\r\n                          step=\"0.01\"\r\n                          className=\"h-9 text-sm\"\r\n                          placeholder=\"Max\"\r\n                          {...form.register(`items.${itemIndex}.refRanges.${idx}.refMax`, {\r\n                            setValueAs: (v) => (v === \"\" || v === null || v === undefined ? null : Number(v)),\r\n                          })}\r\n                        />\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <Button\r\n                          type=\"button\"\r\n                          variant=\"ghost\"\r\n                          size=\"icon\"\r\n                          className=\"h-8 w-8 text-red-600\"\r\n                          onClick={() => remove(idx)}\r\n                        >\r\n                          <Trash2 className=\"h-4 w-4\" />\r\n                        </Button>\r\n                      </TableCell>\r\n                    </TableRow>\r\n                  ))}\r\n                </TableBody>\r\n              </Table>\r\n            </div>\r\n          )}\r\n\r\n          <div className=\"flex justify-end gap-2 pt-2 border-t border-slate-200 dark:border-slate-600\">\r\n            <Button type=\"button\" variant=\"outline\" onClick={() => setOpen(false)}>\r\n              Cerrar\r\n            </Button>\r\n          </div>\r\n        </div>\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\forms\\ResultForm.tsx","messages":[{"ruleId":"react-hooks/incompatible-library","severity":1,"message":"Compilation Skipped: Use of incompatible library\n\nThis API returns functions which cannot be memoized without leading to stale UI. To prevent this, by default React Compiler will skip memoizing this component/hook. However, you may see issues if values from this API are passed to other components/hooks that are memoized.\n\nC:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\forms\\ResultForm.tsx:200:22\n  198 |           id: `field-${idx}`,\n  199 |           groupName: null,\n> 200 |           paramName: form.watch(`items.${idx}.paramNameSnapshot`) || \"\",\n      |                      ^^^^ React Hook Form's `useForm()` API returns a `watch()` function which cannot be memoized safely.\n  201 |           unit: form.watch(`items.${idx}.unitSnapshot`) || null,\n  202 |           refRangeText: form.watch(`items.${idx}.refTextSnapshot`) || null,\n  203 |           refMin: form.watch(`items.${idx}.refMinSnapshot`) ?? null,","line":200,"column":22,"nodeType":null,"endLine":200,"endColumn":26}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect, useRef } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { useSession } from \"next-auth/react\";\r\nimport { useForm, useFieldArray, useWatch, type Resolver } from \"react-hook-form\";\r\nimport { zodResolver } from \"@hookform/resolvers/zod\";\r\nimport { toast } from \"sonner\";\r\n\r\nimport { resultSchema } from \"@/features/lab/schemas\";\r\nimport { useAutosaveResults } from \"@/hooks/useAutosaveResults\";\r\nimport { AutosaveIndicator } from \"./AutosaveIndicator\";\r\nimport type { z } from \"zod\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { NumericInput } from \"@/components/ui/numeric-input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\n\r\ntype ResultFormValues = z.infer<typeof resultSchema>;\r\n\r\ntype RefRange = {\r\n  id?: string;\r\n  ageGroup: string | null;\r\n  sex: \"M\" | \"F\" | \"O\" | null;\r\n  refRangeText: string | null;\r\n  refMin: number | null;\r\n  refMax: number | null;\r\n  order: number;\r\n};\r\n\r\ntype TemplateItem = {\r\n  id: string;\r\n  groupName: string | null;\r\n  paramName: string;\r\n  unit: string | null;\r\n  refRangeText: string | null;\r\n  refMin: number | null;\r\n  refMax: number | null;\r\n  valueType: \"NUMBER\" | \"DECIMAL\" | \"PERCENTAGE\" | \"TEXT\" | \"SELECT\";\r\n  selectOptions: string[];\r\n  order: number;\r\n  refRanges?: RefRange[];\r\n};\r\n\r\nconst NUMERIC_VALUE_TYPES = [\"NUMBER\", \"DECIMAL\", \"PERCENTAGE\"] as const;\r\nfunction isNumericValueType(t: string): t is (typeof NUMERIC_VALUE_TYPES)[number] {\r\n  return NUMERIC_VALUE_TYPES.includes(t as (typeof NUMERIC_VALUE_TYPES)[number]);\r\n}\r\n\r\ntype Props = {\r\n  orderId: string;\r\n  itemId: string;\r\n  templateItems: TemplateItem[];\r\n  defaultValues?: ResultFormValues;\r\n  onSaved?: () => void;\r\n};\r\n\r\nfunction checkOutOfRange(value: string, refMin: number | null, refMax: number | null): boolean {\r\n  if (!value || value.trim() === \"\") return false;\r\n  const numValue = parseFloat(value);\r\n  if (isNaN(numValue)) return false;\r\n  if (refMin !== null && numValue < refMin) return true;\r\n  if (refMax !== null && numValue > refMax) return true;\r\n  return false;\r\n}\r\n\r\nexport function ResultForm({\r\n  orderId,\r\n  itemId,\r\n  templateItems,\r\n  defaultValues,\r\n  onSaved,\r\n}: Props) {\r\n  const router = useRouter();\r\n  const { data: session } = useSession();\r\n  const [viewMode, setViewMode] = useState<\"table\" | \"print\" | \"form\">(\"table\");\r\n  const [editableRefs, setEditableRefs] = useState<Record<number, boolean>>({});\r\n\r\n  const form = useForm<ResultFormValues>({\r\n    resolver: zodResolver(resultSchema) as Resolver<ResultFormValues>,\r\n    defaultValues: defaultValues ?? {\r\n      reportedBy: \"\",\r\n      comment: \"\",\r\n      items: templateItems.length > 0\r\n        ? templateItems.map((item) => ({\r\n            templateItemId: item.id,\r\n            paramNameSnapshot: item.paramName,\r\n            unitSnapshot: item.unit,\r\n            refTextSnapshot: item.refRangeText,\r\n            refMinSnapshot: item.refMin ?? undefined,\r\n            refMaxSnapshot: item.refMax ?? undefined,\r\n            value: \"\",\r\n            isOutOfRange: false,\r\n            order: item.order,\r\n          }))\r\n        : [\r\n            // Si no hay items, crear uno vacío para que el usuario pueda agregar\r\n            {\r\n              templateItemId: undefined,\r\n              paramNameSnapshot: \"\",\r\n              unitSnapshot: \"\",\r\n              refTextSnapshot: \"\",\r\n              refMinSnapshot: undefined,\r\n              refMaxSnapshot: undefined,\r\n              value: \"\",\r\n              isOutOfRange: false,\r\n              order: 1,\r\n            },\r\n          ],\r\n    },\r\n  });\r\n\r\n  const { fields, append, remove } = useFieldArray({\r\n    control: form.control,\r\n    name: \"items\",\r\n  });\r\n\r\n  const { status, savedAt, saveOnBlur, retry } = useAutosaveResults({\r\n    orderId,\r\n    itemId,\r\n    form,\r\n    debounceMs: 1000,\r\n    enabled: fields.length > 0,\r\n  });\r\n\r\n  const prevAutosaveStatus = useRef<string>(status);\r\n  useEffect(() => {\r\n    if (prevAutosaveStatus.current !== \"saved\" && status === \"saved\") {\r\n      router.refresh();\r\n    }\r\n    prevAutosaveStatus.current = status;\r\n  }, [status, router]);\r\n\r\n  // Rellenar \"Reportado por\" con el usuario en sesión cuando no hay valor previo\r\n  useEffect(() => {\r\n    if (session?.user && !defaultValues?.reportedBy) {\r\n      const value = session.user.name ?? session.user.email ?? \"\";\r\n      if (value) form.setValue(\"reportedBy\", value);\r\n    }\r\n  }, [session?.user, session?.user?.name, session?.user?.email, defaultValues?.reportedBy, form]);\r\n\r\n  // Determinar automáticamente el modo según la cantidad de parámetros\r\n  useEffect(() => {\r\n    const itemCount = templateItems.length > 0 ? templateItems.length : fields.length;\r\n    if (itemCount <= 3) {\r\n      setViewMode(\"form\");\r\n    } else {\r\n      setViewMode(\"table\");\r\n    }\r\n  }, [templateItems.length, fields.length]);\r\n\r\n  // Sincronizar isOutOfRange en el formulario cuando cambian valor o rangos (usa refRanges vía templateItem.refMin/refMax)\r\n  const watchedItems = useWatch({ control: form.control, name: \"items\", defaultValue: [] });\r\n  useEffect(() => {\r\n    const items = Array.isArray(watchedItems) ? watchedItems : [];\r\n    items.forEach((item: Record<string, unknown>, idx: number) => {\r\n      const templateItem = templateItems[idx];\r\n      const refMin = (item.refMinSnapshot as number | null | undefined) ?? templateItem?.refMin ?? null;\r\n      const refMax = (item.refMaxSnapshot as number | null | undefined) ?? templateItem?.refMax ?? null;\r\n      const computed = checkOutOfRange(String(item.value ?? \"\"), refMin, refMax);\r\n      const stored = Boolean(item.isOutOfRange ?? false);\r\n      if (computed !== stored) {\r\n        form.setValue(`items.${idx}.isOutOfRange`, computed);\r\n      }\r\n    });\r\n  }, [watchedItems, templateItems, form]);\r\n\r\n  const addNewParameter = () => {\r\n    append({\r\n      templateItemId: undefined,\r\n      paramNameSnapshot: \"\",\r\n      unitSnapshot: \"\",\r\n      refTextSnapshot: \"\",\r\n      refMinSnapshot: undefined,\r\n      refMaxSnapshot: undefined,\r\n      value: \"\",\r\n      isOutOfRange: false,\r\n      order: fields.length + 1,\r\n    });\r\n  };\r\n\r\n  const toggleEditRefs = (index: number) => {\r\n    setEditableRefs((prev) => ({\r\n      ...prev,\r\n      [index]: !prev[index],\r\n    }));\r\n  };\r\n\r\n  // Agrupar items por grupoName\r\n  // Si no hay templateItems pero hay fields en el formulario, crear items desde los fields\r\n  const itemsToUse =\r\n    templateItems.length > 0\r\n      ? templateItems\r\n      : fields.map((field, idx) => ({\r\n          id: `field-${idx}`,\r\n          groupName: null,\r\n          paramName: form.watch(`items.${idx}.paramNameSnapshot`) || \"\",\r\n          unit: form.watch(`items.${idx}.unitSnapshot`) || null,\r\n          refRangeText: form.watch(`items.${idx}.refTextSnapshot`) || null,\r\n          refMin: form.watch(`items.${idx}.refMinSnapshot`) ?? null,\r\n          refMax: form.watch(`items.${idx}.refMaxSnapshot`) ?? null,\r\n          valueType: \"TEXT\" as const,\r\n          selectOptions: [],\r\n          order: idx + 1,\r\n        }));\r\n\r\n  const groupedItems = itemsToUse.reduce(\r\n    (acc, item, index) => {\r\n      const groupKey = item.groupName || \"Sin grupo\";\r\n      if (!acc[groupKey]) {\r\n        acc[groupKey] = [];\r\n      }\r\n      acc[groupKey].push({ ...item, index });\r\n      return acc;\r\n    },\r\n    {} as Record<string, Array<TemplateItem & { index: number }>>,\r\n  );\r\n\r\n  const isSimple = itemsToUse.length <= 3;\r\n\r\n  const onSubmit = async (values: ResultFormValues) => {\r\n    try {\r\n      // Validar rangos antes de enviar y asegurar que todos los snapshots estén completos\r\n      const validatedItems = values.items.map((item, idx) => {\r\n        const templateItem = templateItems[idx];\r\n        const refMin = item.refMinSnapshot ?? templateItem?.refMin ?? null;\r\n        const refMax = item.refMaxSnapshot ?? templateItem?.refMax ?? null;\r\n        const isOutOfRange = checkOutOfRange(item.value, refMin, refMax);\r\n        \r\n        return {\r\n          ...item,\r\n          // Asegurar que los snapshots estén completos\r\n          paramNameSnapshot: item.paramNameSnapshot || templateItem?.paramName || \"\",\r\n          unitSnapshot: item.unitSnapshot ?? templateItem?.unit ?? null,\r\n          refTextSnapshot: item.refTextSnapshot ?? templateItem?.refRangeText ?? null,\r\n          refMinSnapshot: refMin,\r\n          refMaxSnapshot: refMax,\r\n          isOutOfRange,\r\n        };\r\n      });\r\n\r\n      const res = await fetch(\r\n        `/api/orders/${orderId}/items/${itemId}/result`,\r\n        {\r\n          method: \"POST\",\r\n          headers: { \"Content-Type\": \"application/json\" },\r\n          body: JSON.stringify({ ...values, items: validatedItems }),\r\n        },\r\n      );\r\n\r\n      if (!res.ok) {\r\n        const errorData = await res.json().catch(() => ({}));\r\n        toast.error(errorData.error || \"No se pudo guardar el resultado.\");\r\n        return;\r\n      }\r\n\r\n      toast.success(\"Resultado guardado.\");\r\n      onSaved?.();\r\n      router.refresh();\r\n    } catch (error) {\r\n      console.error(\"Error submitting result form:\", error);\r\n      toast.error(\"Error de conexión. Intenta nuevamente.\");\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    const onSaveDraftShortcut = () => {\r\n      saveOnBlur();\r\n      toast.success(\"Borrador guardado\");\r\n    };\r\n\r\n    const onValidateShortcut = async () => {\r\n      const ok = window.confirm(\"¿Validar resultados de esta orden?\");\r\n      if (!ok) return;\r\n      try {\r\n        const res = await fetch(`/api/orders/${orderId}/validate`, { method: \"POST\" });\r\n        const data = await res.json().catch(() => ({}));\r\n        if (!res.ok) {\r\n          toast.error(data.error ?? \"No se pudo validar\");\r\n          return;\r\n        }\r\n        toast.success(\"Orden validada\");\r\n        router.refresh();\r\n      } catch {\r\n        toast.error(\"Error de conexión al validar\");\r\n      }\r\n    };\r\n\r\n    const onPrintShortcut = () => {\r\n      window.open(`/orders/${orderId}/print`, \"_blank\", \"noopener,noreferrer\");\r\n    };\r\n\r\n    window.addEventListener(\"shortcuts:save-draft\", onSaveDraftShortcut);\r\n    window.addEventListener(\"shortcuts:validate\", onValidateShortcut);\r\n    window.addEventListener(\"shortcuts:print\", onPrintShortcut);\r\n    return () => {\r\n      window.removeEventListener(\"shortcuts:save-draft\", onSaveDraftShortcut);\r\n      window.removeEventListener(\"shortcuts:validate\", onValidateShortcut);\r\n      window.removeEventListener(\"shortcuts:print\", onPrintShortcut);\r\n    };\r\n  }, [orderId, router, saveOnBlur]);\r\n\r\n  return (\r\n    <form\r\n      onSubmit={form.handleSubmit(onSubmit)}\r\n      onBlur={() => saveOnBlur()}\r\n      className=\"space-y-6\"\r\n    >\r\n      <div className=\"flex items-center justify-between gap-4 min-h-6\">\r\n        <AutosaveIndicator status={status} savedAt={savedAt} onRetry={retry} />\r\n      </div>\r\n      <div className=\"grid gap-4 md:grid-cols-2\">\r\n        <div className=\"space-y-2\">\r\n          <Label>Reportado por</Label>\r\n          <Input {...form.register(\"reportedBy\")} placeholder=\"Ej: Bioquímica\" />\r\n        </div>\r\n        <div className=\"space-y-2\">\r\n          <Label>Comentario general</Label>\r\n          <Textarea {...form.register(\"comment\")} placeholder=\"Observaciones adicionales...\" />\r\n        </div>\r\n      </div>\r\n\r\n      {/* Selector de vista */}\r\n      <div className=\"flex flex-wrap items-center justify-between gap-3 rounded-lg border border-slate-200 bg-slate-50 p-3 dark:border-slate-700 dark:bg-slate-800/40\">\r\n        <div className=\"text-xs text-slate-600 dark:text-slate-300\">\r\n          {isSimple\r\n            ? \"Captura en modo simple. También puedes usar vista de impresión.\"\r\n            : \"Plantilla del paciente editable. Los cambios no afectan la plantilla estándar.\"}\r\n        </div>\r\n        <div className=\"flex gap-1 rounded-md border border-slate-200 bg-white p-1 dark:border-slate-600 dark:bg-slate-800\">\r\n          <button\r\n            type=\"button\"\r\n            onClick={() => setViewMode(\"table\")}\r\n            className={`px-3 py-1 text-xs rounded ${\r\n              viewMode === \"table\"\r\n                ? \"bg-slate-900 text-white dark:bg-teal-600\"\r\n                : \"text-slate-600 hover:bg-slate-100 dark:text-slate-300 dark:hover:bg-slate-700\"\r\n            }`}\r\n          >\r\n            Vista Tabla\r\n          </button>\r\n          <button\r\n            type=\"button\"\r\n            onClick={() => setViewMode(\"print\")}\r\n            className={`px-3 py-1 text-xs rounded ${\r\n              viewMode === \"print\"\r\n                ? \"bg-slate-900 text-white dark:bg-teal-600\"\r\n                : \"text-slate-600 hover:bg-slate-100 dark:text-slate-300 dark:hover:bg-slate-700\"\r\n            }`}\r\n          >\r\n            Vista Impresión\r\n          </button>\r\n          <button\r\n            type=\"button\"\r\n            onClick={() => setViewMode(\"form\")}\r\n            className={`px-3 py-1 text-xs rounded ${\r\n              viewMode === \"form\"\r\n                ? \"bg-slate-900 text-white dark:bg-teal-600\"\r\n                : \"text-slate-600 hover:bg-slate-100 dark:text-slate-300 dark:hover:bg-slate-700\"\r\n            }`}\r\n          >\r\n            Vista Formulario\r\n          </button>\r\n        </div>\r\n      </div>\r\n\r\n      {viewMode === \"table\" ? (\r\n        <div className=\"space-y-6\">\r\n          {Object.entries(groupedItems).map(([groupName, items]) => (\r\n            <div key={groupName} className=\"rounded-lg border border-slate-200 overflow-hidden\">\r\n              {groupName !== \"Sin grupo\" && (\r\n                <div className=\"bg-slate-100 px-4 py-2 border-b border-slate-200\">\r\n                  <h3 className=\"text-sm font-semibold text-slate-900 uppercase\">\r\n                    {groupName}\r\n                  </h3>\r\n                </div>\r\n              )}\r\n              <div className=\"-mx-1 overflow-x-auto\">\r\n                <Table className=\"min-w-[560px]\">\r\n                  <TableHeader>\r\n                    <TableRow>\r\n                      <TableHead className=\"w-12\">#</TableHead>\r\n                      <TableHead>Parámetro</TableHead>\r\n                      <TableHead className=\"w-24\">Unidad</TableHead>\r\n                      <TableHead className=\"w-32\">Valor Referencial</TableHead>\r\n                      <TableHead className=\"w-40\">Resultado</TableHead>\r\n                      <TableHead className=\"w-32\">Rangos Adicionales</TableHead>\r\n                      <TableHead className=\"w-20\">Estado</TableHead>\r\n                    </TableRow>\r\n                  </TableHeader>\r\n                  <TableBody>\r\n                    {items.map((item) => {\r\n                      const formIndex = item.index;\r\n                      const currentValue = form.watch(`items.${formIndex}.value`);\r\n                      const currentRefText = form.watch(`items.${formIndex}.refTextSnapshot`);\r\n                      const currentRefMin = form.watch(`items.${formIndex}.refMinSnapshot`);\r\n                      const currentRefMax = form.watch(`items.${formIndex}.refMaxSnapshot`);\r\n                      const currentParamName = form.watch(`items.${formIndex}.paramNameSnapshot`);\r\n                      const currentUnit = form.watch(`items.${formIndex}.unitSnapshot`);\r\n                      const isEditingRefs = editableRefs[formIndex];\r\n                      const isOutOfRange = checkOutOfRange(\r\n                        currentValue,\r\n                        currentRefMin ?? null,\r\n                        currentRefMax ?? null,\r\n                      );\r\n                      const hasValue = currentValue && currentValue.trim() !== \"\";\r\n\r\n                      return (\r\n                        <TableRow key={item.id}>\r\n                          <TableCell className=\"text-xs text-slate-500\">\r\n                            {form.watch(`items.${formIndex}.order`) || item.order}\r\n                          </TableCell>\r\n                          <TableCell\r\n                            className=\"cursor-text\"\r\n                            onClick={(e) => {\r\n                              const field = (e.currentTarget as HTMLTableCellElement).querySelector(\"input\");\r\n                              (field as HTMLInputElement)?.focus();\r\n                            }}\r\n                          >\r\n                            <Input\r\n                              className=\"h-8 text-xs font-medium border-transparent hover:border-slate-300 focus:border-slate-400\"\r\n                              placeholder=\"Nombre parámetro\"\r\n                              value={currentParamName}\r\n                              onChange={(e) =>\r\n                                form.setValue(`items.${formIndex}.paramNameSnapshot`, e.target.value)\r\n                              }\r\n                            />\r\n                          </TableCell>\r\n                          <TableCell\r\n                            className=\"cursor-text\"\r\n                            onClick={(e) => {\r\n                              const field = (e.currentTarget as HTMLTableCellElement).querySelector(\"input\");\r\n                              (field as HTMLInputElement)?.focus();\r\n                            }}\r\n                          >\r\n                            <Input\r\n                              className=\"h-8 text-xs w-20 border-transparent hover:border-slate-300 focus:border-slate-400\"\r\n                              placeholder=\"g/dL\"\r\n                              value={currentUnit || \"\"}\r\n                              onChange={(e) =>\r\n                                form.setValue(`items.${formIndex}.unitSnapshot`, e.target.value)\r\n                              }\r\n                            />\r\n                          </TableCell>\r\n                          <TableCell\r\n                            className=\"cursor-text\"\r\n                            onClick={(e) => {\r\n                              if ((e.target as HTMLElement).closest(\"button\")) return;\r\n                              const field = (e.currentTarget as HTMLTableCellElement).querySelector(\"input\");\r\n                              (field as HTMLInputElement)?.focus();\r\n                            }}\r\n                          >\r\n                            <div className=\"flex gap-1 items-center\">\r\n                              {isEditingRefs ? (\r\n                                <>\r\n                                  <Input\r\n                                    type=\"number\"\r\n                                    step=\"0.01\"\r\n                                    className=\"h-8 text-xs w-16 border-slate-300\"\r\n                                    placeholder=\"Min\"\r\n                                    value={currentRefMin ?? \"\"}\r\n                                    onChange={(e) =>\r\n                                      form.setValue(\r\n                                        `items.${formIndex}.refMinSnapshot`,\r\n                                        e.target.value ? parseFloat(e.target.value) : undefined,\r\n                                      )\r\n                                    }\r\n                                  />\r\n                                  <span className=\"text-xs\">-</span>\r\n                                  <Input\r\n                                    type=\"number\"\r\n                                    step=\"0.01\"\r\n                                    className=\"h-8 text-xs w-16 border-slate-300\"\r\n                                    placeholder=\"Max\"\r\n                                    value={currentRefMax ?? \"\"}\r\n                                    onChange={(e) =>\r\n                                      form.setValue(\r\n                                        `items.${formIndex}.refMaxSnapshot`,\r\n                                        e.target.value ? parseFloat(e.target.value) : undefined,\r\n                                      )\r\n                                    }\r\n                                  />\r\n                                  <button\r\n                                    type=\"button\"\r\n                                    onClick={() => toggleEditRefs(formIndex)}\r\n                                    className=\"text-xs text-slate-600 hover:text-slate-900\"\r\n                                  >\r\n                                    ✓\r\n                                  </button>\r\n                                </>\r\n                              ) : (\r\n                                <>\r\n                                  <Input\r\n                                    className=\"h-8 text-xs w-32 border-transparent hover:border-slate-300 focus:border-slate-400\"\r\n                                    placeholder=\"12-16\"\r\n                                    value={currentRefText || \"\"}\r\n                                    onChange={(e) =>\r\n                                      form.setValue(`items.${formIndex}.refTextSnapshot`, e.target.value)\r\n                                    }\r\n                                  />\r\n                                  <button\r\n                                    type=\"button\"\r\n                                    onClick={() => toggleEditRefs(formIndex)}\r\n                                    className=\"text-xs text-slate-500 hover:text-slate-700\"\r\n                                    title=\"Editar rangos numéricos\"\r\n                                  >\r\n                                    ✏️\r\n                                  </button>\r\n                                </>\r\n                              )}\r\n                            </div>\r\n                          </TableCell>\r\n                          <TableCell\r\n                            className=\"w-40 align-top cursor-text\"\r\n                            onClick={(e) => {\r\n                              const cell = e.currentTarget as HTMLTableCellElement;\r\n                              const field = cell.querySelector(\r\n                                \"input, select\",\r\n                              ) as HTMLInputElement | HTMLSelectElement | null;\r\n                              field?.focus();\r\n                            }}\r\n                          >\r\n                            {item.valueType === \"SELECT\" ? (\r\n                              <select\r\n                                className={`h-9 w-full rounded-md border px-2 text-sm ${\r\n                                  hasValue && isOutOfRange\r\n                                    ? \"border-red-500 bg-red-50 font-bold underline dark:bg-red-900/20 dark:text-red-200\"\r\n                                    : \"border-slate-200 bg-white dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100\"\r\n                                }`}\r\n                                {...form.register(`items.${formIndex}.value`)}\r\n                              >\r\n                                <option value=\"\">-</option>\r\n                                {item.selectOptions.map((opt) => (\r\n                                  <option key={opt} value={opt}>\r\n                                    {opt}\r\n                                  </option>\r\n                                ))}\r\n                              </select>\r\n                            ) : isNumericValueType(item.valueType) ? (\r\n                              <NumericInput\r\n                                name={`items.${formIndex}.value`}\r\n                                value={form.watch(`items.${formIndex}.value`) ?? \"\"}\r\n                                onChange={(v) => form.setValue(`items.${formIndex}.value`, v)}\r\n                                suffix={item.valueType === \"PERCENTAGE\" ? \"%\" : undefined}\r\n                                className={`h-9 w-full text-sm ${\r\n                                  hasValue && isOutOfRange\r\n                                    ? \"border-red-500 bg-red-50 font-bold underline text-red-900 dark:bg-red-950/20 dark:text-red-200\"\r\n                                    : \"text-slate-900 dark:text-slate-100\"\r\n                                }`}\r\n                                placeholder=\"-\"\r\n                                onKeyDown={(e) => {\r\n                                  if (e.key === \"Enter\") {\r\n                                    e.preventDefault();\r\n                                    const nextIndex = formIndex + 1;\r\n                                    if (nextIndex < fields.length) {\r\n                                      const nextInput = document.querySelector(\r\n                                        `input[name=\"items.${nextIndex}.value\"], select[name=\"items.${nextIndex}.value\"]`,\r\n                                      ) as HTMLInputElement | HTMLSelectElement;\r\n                                      nextInput?.focus();\r\n                                    }\r\n                                  }\r\n                                }}\r\n                              />\r\n                            ) : (\r\n                              <Input\r\n                                type=\"text\"\r\n                                className={`h-9 w-full text-sm ${\r\n                                  hasValue && isOutOfRange\r\n                                    ? \"border-red-500 bg-red-50 font-bold underline text-red-900 dark:bg-red-950/20 dark:text-red-200\"\r\n                                    : \"text-slate-900 dark:text-slate-100\"\r\n                                }`}\r\n                                placeholder=\"-\"\r\n                                {...form.register(`items.${formIndex}.value`)}\r\n                                onKeyDown={(e) => {\r\n                                  if (e.key === \"Enter\") {\r\n                                    e.preventDefault();\r\n                                    const nextIndex = formIndex + 1;\r\n                                    if (nextIndex < fields.length) {\r\n                                      const nextInput = document.querySelector(\r\n                                        `input[name=\"items.${nextIndex}.value\"], select[name=\"items.${nextIndex}.value\"]`,\r\n                                      ) as HTMLInputElement | HTMLSelectElement;\r\n                                      nextInput?.focus();\r\n                                    }\r\n                                  }\r\n                                }}\r\n                              />\r\n                            )}\r\n                          </TableCell>\r\n                          <TableCell className=\"w-32 align-top\">\r\n                            {item.refRanges && item.refRanges.length > 0 ? (\r\n                              <div className=\"bg-slate-50 rounded-md p-2 border border-slate-200 space-y-1.5\">\r\n                                {item.refRanges.map((range, rangeIdx) => {\r\n                                  const ageGroupLabels: Record<string, string> = {\r\n                                    NIÑOS: \"Niños\",\r\n                                    JOVENES: \"Jóvenes\",\r\n                                    ADULTOS: \"Adultos\",\r\n                                  };\r\n                                  const sexLabels: Record<string, string> = {\r\n                                    M: \"Hombres\",\r\n                                    F: \"Mujeres\",\r\n                                    O: \"Otros\",\r\n                                  };\r\n                                  const criteria = [\r\n                                    range.ageGroup ? ageGroupLabels[range.ageGroup] || range.ageGroup : null,\r\n                                    range.sex ? sexLabels[range.sex] || range.sex : null,\r\n                                  ].filter(Boolean);\r\n                                  \r\n                                  const rangeDisplay = range.refRangeText \r\n                                    || (range.refMin !== null && range.refMax !== null \r\n                                      ? `${range.refMin} - ${range.refMax}` \r\n                                      : \"\");\r\n                                  \r\n                                  return (\r\n                                    <div key={rangeIdx} className=\"text-[10px] text-slate-700 leading-tight\">\r\n                                      {criteria.length > 0 ? (\r\n                                        <div>\r\n                                          <span className=\"font-semibold text-slate-800\">\r\n                                            {criteria.join(\" + \")}:\r\n                                          </span>\r\n                                          <span className=\"text-slate-600 ml-1\">{rangeDisplay}</span>\r\n                                        </div>\r\n                                      ) : (\r\n                                        <span className=\"text-slate-600\">{rangeDisplay}</span>\r\n                                      )}\r\n                                    </div>\r\n                                  );\r\n                                })}\r\n                              </div>\r\n                            ) : (\r\n                              <span className=\"text-[10px] text-slate-400 italic\">-</span>\r\n                            )}\r\n                          </TableCell>\r\n                          <TableCell>\r\n                            {hasValue && (\r\n                              <Badge\r\n                                variant={isOutOfRange ? \"danger\" : \"success\"}\r\n                                className=\"text-xs\"\r\n                              >\r\n                                {isOutOfRange ? \"Fuera\" : \"OK\"}\r\n                              </Badge>\r\n                            )}\r\n                          </TableCell>\r\n                        </TableRow>\r\n                      );\r\n                    })}\r\n                  </TableBody>\r\n                </Table>\r\n              </div>\r\n            </div>\r\n          ))}\r\n          \r\n          {/* Botón para agregar parámetros adicionales */}\r\n          <div className=\"flex justify-end\">\r\n            <Button\r\n              type=\"button\"\r\n              variant=\"outline\"\r\n              size=\"sm\"\r\n              onClick={addNewParameter}\r\n            >\r\n              + Agregar parámetro adicional\r\n            </Button>\r\n          </div>\r\n\r\n          {/* Mostrar parámetros adicionales agregados */}\r\n          {fields.length > templateItems.length && (\r\n            <div className=\"rounded-lg border-2 border-amber-200 bg-amber-50 p-4\">\r\n              <h4 className=\"text-sm font-semibold text-amber-900 mb-3\">\r\n                Parámetros adicionales ({fields.length - templateItems.length})\r\n              </h4>\r\n              <div className=\"-mx-1 overflow-x-auto\">\r\n                <Table className=\"min-w-[560px]\">\r\n                  <TableHeader>\r\n                    <TableRow>\r\n                      <TableHead className=\"w-12\">#</TableHead>\r\n                      <TableHead>Parámetro</TableHead>\r\n                      <TableHead className=\"w-24\">Unidad</TableHead>\r\n                      <TableHead className=\"w-32\">Valor Referencial</TableHead>\r\n                      <TableHead className=\"w-40\">Resultado</TableHead>\r\n                      <TableHead className=\"w-32\">Rangos Adicionales</TableHead>\r\n                      <TableHead className=\"w-20\"></TableHead>\r\n                    </TableRow>\r\n                  </TableHeader>\r\n                  <TableBody>\r\n                    {fields.slice(templateItems.length).map((field, idx) => {\r\n                      const formIndex = templateItems.length + idx;\r\n                      const currentRefText = form.watch(`items.${formIndex}.refTextSnapshot`);\r\n                      const currentRefMin = form.watch(`items.${formIndex}.refMinSnapshot`);\r\n                      const currentRefMax = form.watch(`items.${formIndex}.refMaxSnapshot`);\r\n                      const isEditingRefs = editableRefs[formIndex];\r\n\r\n                      return (\r\n                        <TableRow key={field.id}>\r\n                          <TableCell className=\"text-xs text-slate-500\">\r\n                            {form.watch(`items.${formIndex}.order`) || formIndex + 1}\r\n                          </TableCell>\r\n                          <TableCell\r\n                            className=\"cursor-text\"\r\n                            onClick={(e) => {\r\n                              const fieldEl = (e.currentTarget as HTMLTableCellElement).querySelector(\"input\");\r\n                              (fieldEl as HTMLInputElement)?.focus();\r\n                            }}\r\n                          >\r\n                            <Input\r\n                              className=\"h-8 text-xs font-medium\"\r\n                              placeholder=\"Nombre parámetro\"\r\n                              value={form.watch(`items.${formIndex}.paramNameSnapshot`) || \"\"}\r\n                              onChange={(e) =>\r\n                                form.setValue(`items.${formIndex}.paramNameSnapshot`, e.target.value)\r\n                              }\r\n                            />\r\n                          </TableCell>\r\n                          <TableCell\r\n                            className=\"cursor-text\"\r\n                            onClick={(e) => {\r\n                              const fieldEl = (e.currentTarget as HTMLTableCellElement).querySelector(\"input\");\r\n                              (fieldEl as HTMLInputElement)?.focus();\r\n                            }}\r\n                          >\r\n                            <Input\r\n                              className=\"h-8 text-xs w-20\"\r\n                              placeholder=\"g/dL\"\r\n                              value={form.watch(`items.${formIndex}.unitSnapshot`) || \"\"}\r\n                              onChange={(e) =>\r\n                                form.setValue(`items.${formIndex}.unitSnapshot`, e.target.value)\r\n                              }\r\n                            />\r\n                          </TableCell>\r\n                          <TableCell\r\n                            className=\"cursor-text\"\r\n                            onClick={(e) => {\r\n                              if ((e.target as HTMLElement).closest(\"button\")) return;\r\n                              const fieldEl = (e.currentTarget as HTMLTableCellElement).querySelector(\"input\");\r\n                              (fieldEl as HTMLInputElement)?.focus();\r\n                            }}\r\n                          >\r\n                            <div className=\"flex gap-1 items-center\">\r\n                              {isEditingRefs ? (\r\n                                <>\r\n                                  <Input\r\n                                    type=\"number\"\r\n                                    step=\"0.01\"\r\n                                    className=\"h-8 text-xs w-16\"\r\n                                    placeholder=\"Min\"\r\n                                    value={currentRefMin ?? \"\"}\r\n                                    onChange={(e) =>\r\n                                      form.setValue(\r\n                                        `items.${formIndex}.refMinSnapshot`,\r\n                                        e.target.value ? parseFloat(e.target.value) : undefined,\r\n                                      )\r\n                                    }\r\n                                  />\r\n                                  <span className=\"text-xs\">-</span>\r\n                                  <Input\r\n                                    type=\"number\"\r\n                                    step=\"0.01\"\r\n                                    className=\"h-8 text-xs w-16\"\r\n                                    placeholder=\"Max\"\r\n                                    value={currentRefMax ?? \"\"}\r\n                                    onChange={(e) =>\r\n                                      form.setValue(\r\n                                        `items.${formIndex}.refMaxSnapshot`,\r\n                                        e.target.value ? parseFloat(e.target.value) : undefined,\r\n                                      )\r\n                                    }\r\n                                  />\r\n                                  <button\r\n                                    type=\"button\"\r\n                                    onClick={() => toggleEditRefs(formIndex)}\r\n                                    className=\"text-xs\"\r\n                                  >\r\n                                    ✓\r\n                                  </button>\r\n                                </>\r\n                              ) : (\r\n                                <>\r\n                                  <Input\r\n                                    className=\"h-8 text-xs w-32\"\r\n                                    placeholder=\"12-16\"\r\n                                    value={currentRefText || \"\"}\r\n                                    onChange={(e) =>\r\n                                      form.setValue(`items.${formIndex}.refTextSnapshot`, e.target.value)\r\n                                    }\r\n                                  />\r\n                                  <button\r\n                                    type=\"button\"\r\n                                    onClick={() => toggleEditRefs(formIndex)}\r\n                                    className=\"text-xs\"\r\n                                  >\r\n                                    ✏️\r\n                                  </button>\r\n                                </>\r\n                              )}\r\n                            </div>\r\n                          </TableCell>\r\n                          <TableCell\r\n                            className=\"w-40 align-top cursor-text\"\r\n                            onClick={(e) => {\r\n                              const field = (e.currentTarget as HTMLTableCellElement).querySelector(\r\n                                \"input\",\r\n                              ) as HTMLInputElement | null;\r\n                              field?.focus();\r\n                            }}\r\n                          >\r\n                            <Input\r\n                              type=\"text\"\r\n                              className=\"h-9 w-full text-sm\"\r\n                              placeholder=\"Resultado\"\r\n                              {...form.register(`items.${formIndex}.value`)}\r\n                            />\r\n                          </TableCell>\r\n                          <TableCell className=\"w-32 align-top\">\r\n                            {(() => {\r\n                              // Buscar el templateItem original si existe\r\n                              const originalItem = templateItems.find((t) => t.id === form.watch(`items.${formIndex}.templateItemId`));\r\n                              const refRanges = originalItem?.refRanges || [];\r\n                              \r\n                              return refRanges.length > 0 ? (\r\n                                <div className=\"bg-slate-50 rounded-md p-2 border border-slate-200 space-y-1.5\">\r\n                                  {refRanges.map((range, rangeIdx) => {\r\n                                    const ageGroupLabels: Record<string, string> = {\r\n                                      NIÑOS: \"Niños\",\r\n                                      JOVENES: \"Jóvenes\",\r\n                                      ADULTOS: \"Adultos\",\r\n                                    };\r\n                                    const sexLabels: Record<string, string> = {\r\n                                      M: \"Hombres\",\r\n                                      F: \"Mujeres\",\r\n                                      O: \"Otros\",\r\n                                    };\r\n                                    const criteria = [\r\n                                      range.ageGroup ? ageGroupLabels[range.ageGroup] || range.ageGroup : null,\r\n                                      range.sex ? sexLabels[range.sex] || range.sex : null,\r\n                                    ].filter(Boolean);\r\n                                    \r\n                                    const rangeDisplay = range.refRangeText \r\n                                      || (range.refMin !== null && range.refMax !== null \r\n                                        ? `${range.refMin} - ${range.refMax}` \r\n                                        : \"\");\r\n                                    \r\n                                    return (\r\n                                      <div key={rangeIdx} className=\"text-[10px] text-slate-700 leading-tight\">\r\n                                        {criteria.length > 0 ? (\r\n                                          <div>\r\n                                            <span className=\"font-semibold text-slate-800\">\r\n                                              {criteria.join(\" + \")}:\r\n                                            </span>\r\n                                            <span className=\"text-slate-600 ml-1\">{rangeDisplay}</span>\r\n                                          </div>\r\n                                        ) : (\r\n                                          <span className=\"text-slate-600\">{rangeDisplay}</span>\r\n                                        )}\r\n                                      </div>\r\n                                    );\r\n                                  })}\r\n                                </div>\r\n                              ) : (\r\n                                <span className=\"text-[10px] text-slate-400 italic\">-</span>\r\n                              );\r\n                            })()}\r\n                          </TableCell>\r\n                          <TableCell>\r\n                            <Button\r\n                              type=\"button\"\r\n                              variant=\"ghost\"\r\n                              size=\"sm\"\r\n                              className=\"h-7 w-7 p-0 text-red-600\"\r\n                              onClick={() => remove(formIndex)}\r\n                            >\r\n                              ×\r\n                            </Button>\r\n                          </TableCell>\r\n                        </TableRow>\r\n                      );\r\n                    })}\r\n                  </TableBody>\r\n                </Table>\r\n              </div>\r\n            </div>\r\n          )}\r\n        </div>\r\n      ) : viewMode === \"print\" ? (\r\n        <div className=\"space-y-4\">\r\n          <div className=\"relative overflow-hidden rounded-xl border border-slate-300 bg-white shadow-sm dark:border-slate-700 dark:bg-slate-900\">\r\n            <div\r\n              className=\"pointer-events-none absolute inset-0 opacity-[0.14]\"\r\n              style={{\r\n                backgroundImage: \"url(/watermark-clinica.png)\",\r\n                backgroundSize: \"cover\",\r\n                backgroundPosition: \"center\",\r\n                backgroundRepeat: \"no-repeat\",\r\n              }}\r\n              aria-hidden\r\n            />\r\n            <div className=\"relative z-10 border-b border-slate-200 bg-white/80 px-4 py-3 dark:border-slate-700 dark:bg-slate-900/80\">\r\n              <p className=\"text-xs font-semibold uppercase tracking-wide text-slate-600 dark:text-slate-300\">\r\n                Vista final (tipo impresión)\r\n              </p>\r\n              <p className=\"text-xs text-slate-500 dark:text-slate-400\">\r\n                Representación estilo hoja de reporte. Puedes capturar resultados en línea.\r\n              </p>\r\n            </div>\r\n\r\n            <div className=\"relative z-10 p-4\">\r\n              {Object.entries(groupedItems).map(([groupName, items]) => (\r\n                <div key={groupName} className=\"mb-5 last:mb-0\">\r\n                  <div className=\"bg-slate-800/80 px-3 py-1.5 text-center text-xs font-bold uppercase tracking-wide text-white dark:bg-slate-700/90\">\r\n                    {groupName === \"Sin grupo\" ? \"SECCIÓN GENERAL\" : `SECCIÓN ${groupName}`}\r\n                  </div>\r\n                  <Table className=\"border border-slate-300 bg-white/95 dark:border-slate-600 dark:bg-slate-900/95\">\r\n                    <TableHeader>\r\n                      <TableRow className=\"border-b border-slate-300 bg-slate-100/90 dark:border-slate-600 dark:bg-slate-800/90\">\r\n                        <TableHead className=\"w-1/3 text-[11px] font-semibold uppercase\">Análisis</TableHead>\r\n                        <TableHead className=\"w-1/4 text-[11px] font-semibold uppercase\">Resultados</TableHead>\r\n                        <TableHead className=\"w-1/6 text-[11px] font-semibold uppercase\">Unidad</TableHead>\r\n                        <TableHead className=\"w-1/4 text-[11px] font-semibold uppercase\">Valor referencial</TableHead>\r\n                      </TableRow>\r\n                    </TableHeader>\r\n                    <TableBody>\r\n                      {items.map((item) => {\r\n                        const formIndex = item.index;\r\n                        const currentValue = form.watch(`items.${formIndex}.value`);\r\n                        const currentRefText = form.watch(`items.${formIndex}.refTextSnapshot`);\r\n                        const currentUnit = form.watch(`items.${formIndex}.unitSnapshot`);\r\n                        const currentRefMin = form.watch(`items.${formIndex}.refMinSnapshot`);\r\n                        const currentRefMax = form.watch(`items.${formIndex}.refMaxSnapshot`);\r\n                        const isOutOfRange = checkOutOfRange(\r\n                          currentValue,\r\n                          currentRefMin ?? null,\r\n                          currentRefMax ?? null,\r\n                        );\r\n                        const hasValue = currentValue && currentValue.trim() !== \"\";\r\n\r\n                        return (\r\n                          <TableRow key={item.id} className=\"border-b border-slate-200 dark:border-slate-700\">\r\n                            <TableCell className=\"align-top text-sm font-medium text-slate-900 dark:text-slate-100\">\r\n                              {form.watch(`items.${formIndex}.paramNameSnapshot`) || item.paramName}\r\n                            </TableCell>\r\n                            <TableCell className=\"align-top\">\r\n                              {item.valueType === \"SELECT\" ? (\r\n                                <select\r\n                                  className={`h-9 w-full rounded-md border px-2 text-sm ${\r\n                                    hasValue && isOutOfRange\r\n                                      ? \"border-red-500 bg-red-50 font-semibold text-red-900 dark:bg-red-950/20 dark:text-red-200\"\r\n                                      : \"border-slate-300 bg-white text-slate-900 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100\"\r\n                                  }`}\r\n                                  {...form.register(`items.${formIndex}.value`)}\r\n                                >\r\n                                  <option value=\"\">-</option>\r\n                                  {item.selectOptions.map((opt) => (\r\n                                    <option key={opt} value={opt}>\r\n                                      {opt}\r\n                                    </option>\r\n                                  ))}\r\n                                </select>\r\n                              ) : item.valueType === \"NUMBER\" ? (\r\n                                <NumericInput\r\n                                  name={`items.${formIndex}.value`}\r\n                                  value={form.watch(`items.${formIndex}.value`) ?? \"\"}\r\n                                  onChange={(v) => form.setValue(`items.${formIndex}.value`, v)}\r\n                                  className={`h-9 ${\r\n                                    hasValue && isOutOfRange\r\n                                      ? \"border-red-500 bg-red-50 font-semibold text-red-900 dark:bg-red-950/20 dark:text-red-200\"\r\n                                      : \"border-slate-300 text-slate-900 dark:border-slate-600 dark:text-slate-100\"\r\n                                  }`}\r\n                                  placeholder=\"-\"\r\n                                />\r\n                              ) : (\r\n                                <Input\r\n                                  type=\"text\"\r\n                                  className={`h-9 ${\r\n                                    hasValue && isOutOfRange\r\n                                      ? \"border-red-500 bg-red-50 font-semibold text-red-900 dark:bg-red-950/20 dark:text-red-200\"\r\n                                      : \"border-slate-300 text-slate-900 dark:border-slate-600 dark:text-slate-100\"\r\n                                  }`}\r\n                                  placeholder=\"-\"\r\n                                  {...form.register(`items.${formIndex}.value`)}\r\n                                />\r\n                              )}\r\n                            </TableCell>\r\n                            <TableCell className=\"align-top text-sm text-slate-700 dark:text-slate-300\">\r\n                              {currentUnit || item.unit || \"-\"}\r\n                            </TableCell>\r\n                            <TableCell className=\"align-top text-xs text-slate-700 dark:text-slate-300\">\r\n                              <div className=\"space-y-1\">\r\n                                {(currentRefText || item.refRangeText) && (\r\n                                  <div className=\"font-medium\">\r\n                                    {currentRefText || item.refRangeText}\r\n                                  </div>\r\n                                )}\r\n                                {item.refRanges && item.refRanges.length > 0 && (\r\n                                  <div className=\"space-y-0.5 text-[10px]\">\r\n                                    {item.refRanges.map((range, rangeIdx) => {\r\n                                      const ageGroupLabels: Record<string, string> = {\r\n                                        NIÑOS: \"Niños\",\r\n                                        JOVENES: \"Jóvenes\",\r\n                                        ADULTOS: \"Adultos\",\r\n                                      };\r\n                                      const sexLabels: Record<string, string> = {\r\n                                        M: \"Hombres\",\r\n                                        F: \"Mujeres\",\r\n                                        O: \"Otros\",\r\n                                      };\r\n                                      const criteria = [\r\n                                        range.ageGroup ? ageGroupLabels[range.ageGroup] || range.ageGroup : null,\r\n                                        range.sex ? sexLabels[range.sex] || range.sex : null,\r\n                                      ].filter(Boolean);\r\n\r\n                                      const rangeDisplay =\r\n                                        range.refRangeText ||\r\n                                        (range.refMin !== null && range.refMax !== null\r\n                                          ? `${range.refMin} - ${range.refMax}`\r\n                                          : \"\");\r\n\r\n                                      if (!rangeDisplay) return null;\r\n\r\n                                      return (\r\n                                        <div key={rangeIdx} className=\"leading-tight\">\r\n                                          {criteria.length > 0 ? (\r\n                                            <span>\r\n                                              <span className=\"font-semibold text-slate-800 dark:text-slate-200\">\r\n                                                {criteria.join(\" + \")}:\r\n                                              </span>\r\n                                              <span className=\"ml-1 text-slate-600 dark:text-slate-300\">\r\n                                                {rangeDisplay}\r\n                                              </span>\r\n                                            </span>\r\n                                          ) : (\r\n                                            <span className=\"text-slate-600 dark:text-slate-300\">\r\n                                              {rangeDisplay}\r\n                                            </span>\r\n                                          )}\r\n                                        </div>\r\n                                      );\r\n                                    })}\r\n                                  </div>\r\n                                )}\r\n                                {!currentRefText && !item.refRangeText && (!item.refRanges || item.refRanges.length === 0) && (\r\n                                  <span className=\"text-slate-400\">-</span>\r\n                                )}\r\n                              </div>\r\n                            </TableCell>\r\n                          </TableRow>\r\n                        );\r\n                      })}\r\n                    </TableBody>\r\n                  </Table>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"flex justify-end\">\r\n            <Button type=\"button\" variant=\"outline\" onClick={addNewParameter}>\r\n              + Agregar parámetro adicional\r\n            </Button>\r\n          </div>\r\n        </div>\r\n      ) : (\r\n        <div className=\"space-y-6\">\r\n          {Object.entries(groupedItems).map(([groupName, items]) => (\r\n            <div key={groupName} className=\"rounded-lg border-2 border-slate-300 bg-slate-50\">\r\n              {groupName !== \"Sin grupo\" && (\r\n                <div className=\"border-b border-slate-300 bg-white px-4 py-3\">\r\n                  <h3 className=\"text-base font-semibold text-slate-900 uppercase\">\r\n                    {groupName}\r\n                  </h3>\r\n                </div>\r\n              )}\r\n              <div className=\"p-4 space-y-4\">\r\n                {items.map((item) => {\r\n                  const formIndex = item.index;\r\n                  const currentValue = form.watch(`items.${formIndex}.value`);\r\n                  const currentRefText = form.watch(`items.${formIndex}.refTextSnapshot`);\r\n                  const currentRefMin = form.watch(`items.${formIndex}.refMinSnapshot`);\r\n                  const currentRefMax = form.watch(`items.${formIndex}.refMaxSnapshot`);\r\n                  const isOutOfRange = checkOutOfRange(\r\n                    currentValue,\r\n                    currentRefMin ?? null,\r\n                    currentRefMax ?? null,\r\n                  );\r\n                  const hasValue = currentValue && currentValue.trim() !== \"\";\r\n                  const isEditingRefs = editableRefs[formIndex];\r\n\r\n                  return (\r\n                    <div\r\n                      key={item.id}\r\n                      className={`bg-white rounded-md border p-4 ${\r\n                        hasValue && isOutOfRange ? \"border-red-300 bg-red-50\" : \"border-slate-200\"\r\n                      }`}\r\n                    >\r\n                      <div className=\"grid grid-cols-12 gap-4 items-start\">\r\n                        <div className=\"col-span-4\">\r\n                          <Input\r\n                            className=\"text-sm font-semibold text-slate-900 mb-2\"\r\n                            placeholder=\"Nombre parámetro\"\r\n                            value={form.watch(`items.${formIndex}.paramNameSnapshot`) || \"\"}\r\n                            onChange={(e) =>\r\n                              form.setValue(`items.${formIndex}.paramNameSnapshot`, e.target.value)\r\n                            }\r\n                          />\r\n                          <div className=\"flex gap-2 items-center\">\r\n                            <Input\r\n                              className=\"text-xs w-20\"\r\n                              placeholder=\"Unidad\"\r\n                              value={form.watch(`items.${formIndex}.unitSnapshot`) || \"\"}\r\n                              onChange={(e) =>\r\n                                form.setValue(`items.${formIndex}.unitSnapshot`, e.target.value)\r\n                              }\r\n                            />\r\n                            {isEditingRefs ? (\r\n                              <div className=\"flex gap-1 items-center\">\r\n                                <Input\r\n                                  type=\"number\"\r\n                                  step=\"0.01\"\r\n                                  className=\"text-xs w-16\"\r\n                                  placeholder=\"Min\"\r\n                                  value={currentRefMin ?? \"\"}\r\n                                  onChange={(e) =>\r\n                                    form.setValue(\r\n                                      `items.${formIndex}.refMinSnapshot`,\r\n                                      e.target.value ? parseFloat(e.target.value) : undefined,\r\n                                    )\r\n                                  }\r\n                                />\r\n                                <span className=\"text-xs\">-</span>\r\n                                <Input\r\n                                  type=\"number\"\r\n                                  step=\"0.01\"\r\n                                  className=\"text-xs w-16\"\r\n                                  placeholder=\"Max\"\r\n                                  value={currentRefMax ?? \"\"}\r\n                                  onChange={(e) =>\r\n                                    form.setValue(\r\n                                      `items.${formIndex}.refMaxSnapshot`,\r\n                                      e.target.value ? parseFloat(e.target.value) : undefined,\r\n                                    )\r\n                                  }\r\n                                />\r\n                                <button\r\n                                  type=\"button\"\r\n                                  onClick={() => toggleEditRefs(formIndex)}\r\n                                  className=\"text-xs\"\r\n                                >\r\n                                  ✓\r\n                                </button>\r\n                              </div>\r\n                            ) : (\r\n                              <>\r\n                                <div className=\"flex gap-1 items-center\">\r\n                                  <Input\r\n                                    className=\"text-xs w-32\"\r\n                                    placeholder=\"Ref: 12-16\"\r\n                                    value={currentRefText || \"\"}\r\n                                    onChange={(e) =>\r\n                                      form.setValue(`items.${formIndex}.refTextSnapshot`, e.target.value)\r\n                                    }\r\n                                  />\r\n                                  <button\r\n                                    type=\"button\"\r\n                                    onClick={() => toggleEditRefs(formIndex)}\r\n                                    className=\"text-xs text-slate-500\"\r\n                                    title=\"Editar rangos\"\r\n                                  >\r\n                                    ✏️\r\n                                  </button>\r\n                                </div>\r\n                              </>\r\n                            )}\r\n                          </div>\r\n                          {hasValue && isOutOfRange && (\r\n                            <Badge variant=\"danger\" className=\"mt-2 text-xs\">\r\n                              Fuera de rango\r\n                            </Badge>\r\n                          )}\r\n                        </div>\r\n                        <div className=\"col-span-8\">\r\n                          <div className=\"space-y-2\">\r\n                            {/* Campo de resultado */}\r\n                            <div>\r\n                              {item.valueType === \"SELECT\" ? (\r\n                                <select\r\n                                  className={`h-10 w-full rounded-md border bg-white px-3 text-sm text-slate-900 dark:bg-slate-800 dark:text-slate-100 ${\r\n                                    hasValue && isOutOfRange\r\n                                      ? \"border-red-500 font-bold underline text-red-900 dark:bg-red-950/20 dark:text-red-200\"\r\n                                      : \"border-slate-200 dark:border-slate-600\"\r\n                                  }`}\r\n                                  {...form.register(`items.${formIndex}.value`)}\r\n                                >\r\n                                  <option value=\"\">Seleccionar</option>\r\n                                  {item.selectOptions.map((opt) => (\r\n                                    <option key={opt} value={opt}>\r\n                                      {opt}\r\n                                    </option>\r\n                                  ))}\r\n                                </select>\r\n                              ) : isNumericValueType(item.valueType) ? (\r\n                                <NumericInput\r\n                                  name={`items.${formIndex}.value`}\r\n                                  value={form.watch(`items.${formIndex}.value`) ?? \"\"}\r\n                                  onChange={(v) => form.setValue(`items.${formIndex}.value`, v)}\r\n                                  suffix={item.valueType === \"PERCENTAGE\" ? \"%\" : undefined}\r\n                                  placeholder=\"Ingrese el resultado\"\r\n                                  className={\r\n                                    hasValue && isOutOfRange\r\n                                      ? \"border-red-500 bg-red-50 font-bold underline text-red-900 dark:bg-red-950/20 dark:text-red-200\"\r\n                                      : \"text-slate-900 dark:text-slate-100\"\r\n                                  }\r\n                                />\r\n                              ) : (\r\n                                <Input\r\n                                  type=\"text\"\r\n                                  placeholder=\"Ingrese el resultado\"\r\n                                  className={\r\n                                    hasValue && isOutOfRange\r\n                                      ? \"border-red-500 bg-red-50 font-bold underline text-red-900 dark:bg-red-950/20 dark:text-red-200\"\r\n                                      : \"text-slate-900 dark:text-slate-100\"\r\n                                  }\r\n                                  {...form.register(`items.${formIndex}.value`)}\r\n                                />\r\n                              )}\r\n                            </div>\r\n                            {/* Rangos referenciales adicionales debajo del resultado */}\r\n                            {item.refRanges && item.refRanges.length > 0 && (\r\n                              <div className=\"bg-slate-50 rounded-md p-3 border border-slate-200 space-y-2 min-h-[80px] w-full\">\r\n                                <div className=\"text-[10px] font-semibold text-slate-700 uppercase tracking-wide mb-1\">\r\n                                  Rangos referenciales:\r\n                                </div>\r\n                                {item.refRanges.map((range, rangeIdx) => {\r\n                                  const ageGroupLabels: Record<string, string> = {\r\n                                    NIÑOS: \"Niños\",\r\n                                    JOVENES: \"Jóvenes\",\r\n                                    ADULTOS: \"Adultos\",\r\n                                  };\r\n                                  const sexLabels: Record<string, string> = {\r\n                                    M: \"Hombres\",\r\n                                    F: \"Mujeres\",\r\n                                    O: \"Otros\",\r\n                                  };\r\n                                  const criteria = [\r\n                                    range.ageGroup ? ageGroupLabels[range.ageGroup] || range.ageGroup : null,\r\n                                    range.sex ? sexLabels[range.sex] || range.sex : null,\r\n                                  ].filter(Boolean);\r\n                                  \r\n                                  const rangeDisplay = range.refRangeText \r\n                                    || (range.refMin !== null && range.refMax !== null \r\n                                      ? `${range.refMin} - ${range.refMax}` \r\n                                      : \"\");\r\n                                  \r\n                                  return (\r\n                                    <div key={rangeIdx} className=\"text-xs text-slate-700 leading-relaxed\">\r\n                                      {criteria.length > 0 ? (\r\n                                        <div className=\"flex flex-col gap-0.5\">\r\n                                          <span className=\"font-semibold text-slate-800 text-[11px]\">\r\n                                            {criteria.join(\" + \")}:\r\n                                          </span>\r\n                                          <span className=\"text-slate-600 text-[11px] pl-1\">{rangeDisplay}</span>\r\n                                        </div>\r\n                                      ) : (\r\n                                        <span className=\"text-slate-600 text-[11px]\">{rangeDisplay}</span>\r\n                                      )}\r\n                                    </div>\r\n                                  );\r\n                                })}\r\n                              </div>\r\n                            )}\r\n                          </div>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  );\r\n                })}\r\n              </div>\r\n            </div>\r\n          ))}\r\n          \r\n          {/* Botón para agregar parámetros adicionales */}\r\n          <div className=\"flex justify-end\">\r\n            <Button\r\n              type=\"button\"\r\n              variant=\"outline\"\r\n              onClick={addNewParameter}\r\n            >\r\n              + Agregar parámetro adicional\r\n            </Button>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      <div className=\"flex justify-end gap-3 pt-4 border-t\">\r\n        <Button type=\"submit\" className=\"min-w-[150px]\">\r\n          Guardar resultados\r\n        </Button>\r\n      </div>\r\n    </form>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\forms\\TemplateForm.tsx","messages":[{"ruleId":"react-hooks/incompatible-library","severity":1,"message":"Compilation Skipped: Use of incompatible library\n\nThis API returns functions which cannot be memoized without leading to stale UI. To prevent this, by default React Compiler will skip memoizing this component/hook. However, you may see issues if values from this API are passed to other components/hooks that are memoized.\n\nC:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\forms\\TemplateForm.tsx:813:20\n  811 |                     </div>\n  812 |                   </div>\n> 813 |                   {form.watch(`items.${index}.valueType`) === \"SELECT\" && (\n      |                    ^^^^ React Hook Form's `useForm()` API returns a `watch()` function which cannot be memoized safely.\n  814 |                     <div className=\"space-y-1.5\">\n  815 |                       <Label className=\"text-xs text-slate-600 dark:text-slate-300\">Opciones (separadas por coma)</Label>\n  816 |                       <Input","line":813,"column":20,"nodeType":null,"endLine":813,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useMemo } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { useFieldArray, useForm, type Resolver, FormProvider } from \"react-hook-form\";\r\nimport { zodResolver } from \"@hookform/resolvers/zod\";\r\nimport { toast } from \"sonner\";\r\nimport { Search, Check, FileText } from \"lucide-react\";\r\n\r\nimport { templateSchema, valueTypeValues, valueTypeLabels } from \"@/features/lab/schemas\";\r\nimport type { z } from \"zod\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\r\nimport { templatePresets } from \"@/lib/template-presets\";\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\r\nimport { RefRangesManager } from \"./RefRangesManager\";\r\n\r\ntype TemplateFormValues = z.infer<typeof templateSchema>;\r\n\r\ntype LabTestOption = {\r\n  id: string;\r\n  name: string;\r\n  code: string;\r\n  /** Si es false o no viene, el análisis aún no tiene plantilla (prioritario para crear una nueva) */\r\n  hasTemplate?: boolean;\r\n};\r\n\r\ntype Props = {\r\n  templateId?: string;\r\n  labTests: LabTestOption[];\r\n  defaultValues?: Partial<TemplateFormValues>;\r\n};\r\n\r\nexport function TemplateForm({ templateId, labTests, defaultValues }: Props) {\r\n  const router = useRouter();\r\n  const [viewMode, setViewMode] = useState<\"table\" | \"form\">(\"form\");\r\n  const [searchTerm, setSearchTerm] = useState(\"\");\r\n  const [isAnalysisModalOpen, setIsAnalysisModalOpen] = useState(false);\r\n  const defaultLabTestId =\r\n    labTests.find((t) => !t.hasTemplate)?.id ?? labTests[0]?.id ?? \"\";\r\n\r\n  const form = useForm<TemplateFormValues>({\r\n    resolver: zodResolver(templateSchema) as Resolver<TemplateFormValues>,\r\n    defaultValues: {\r\n      labTestId: defaultLabTestId,\r\n      title: \"\",\r\n      notes: \"\",\r\n      items: [\r\n        {\r\n          groupName: \"\",\r\n          paramName: \"\",\r\n          unit: \"\",\r\n                  refRangeText: \"\",\r\n                  refMin: undefined,\r\n                  refMax: undefined,\r\n                  valueType: \"NUMBER\",\r\n                  selectOptions: [],\r\n                  order: 1,\r\n                  refRanges: [],\r\n        },\r\n      ],\r\n      ...defaultValues,\r\n    },\r\n  });\r\n\r\n  const { fields, append, remove, move } = useFieldArray({\r\n    control: form.control,\r\n    name: \"items\",\r\n  });\r\n\r\n  const watchedLabTestId = form.watch(\"labTestId\");\r\n  \r\n  const filteredLabTests = useMemo(() => {\r\n    if (!searchTerm.trim()) return labTests;\r\n    const term = searchTerm.toLowerCase();\r\n    return labTests.filter(\r\n      (t) =>\r\n        t.name.toLowerCase().includes(term) ||\r\n        t.code.toLowerCase().includes(term)\r\n    );\r\n  }, [labTests, searchTerm]);\r\n\r\n  const selectedTest = labTests.find((t) => t.id === watchedLabTestId);\r\n\r\n  const moveUp = (index: number) => {\r\n    if (index <= 0) return;\r\n    move(index, index - 1);\r\n    const items = form.getValues(\"items\");\r\n    items.forEach((_, i) => {\r\n      form.setValue(`items.${i}.order`, i + 1);\r\n    });\r\n  };\r\n\r\n  const moveDown = (index: number) => {\r\n    if (index >= fields.length - 1) return;\r\n    move(index, index + 1);\r\n    const items = form.getValues(\"items\");\r\n    items.forEach((_, i) => {\r\n      form.setValue(`items.${i}.order`, i + 1);\r\n    });\r\n  };\r\n\r\n  const addMultipleRows = () => {\r\n    const count = parseInt(prompt(\"¿Cuántas filas desea agregar?\", \"5\") || \"5\");\r\n    if (count > 0) {\r\n      for (let i = 0; i < count; i++) {\r\n        append({\r\n          groupName: \"\",\r\n          paramName: \"\",\r\n          unit: \"\",\r\n                  refRangeText: \"\",\r\n                  refMin: undefined,\r\n                  refMax: undefined,\r\n                  valueType: \"NUMBER\",\r\n                  selectOptions: [],\r\n                  order: fields.length + i + 1,\r\n                  refRanges: [],\r\n        });\r\n      }\r\n    }\r\n  };\r\n\r\n  const duplicateRow = (index: number) => {\r\n    const currentItem = form.getValues(`items.${index}`);\r\n    append({\r\n      ...currentItem,\r\n      paramName: `${currentItem.paramName} (copia)`,\r\n      order: fields.length + 1,\r\n      refRanges: currentItem.refRanges ? [...currentItem.refRanges] : [],\r\n    });\r\n  };\r\n\r\n  const loadPreset = (preset: typeof templatePresets[0]) => {\r\n    if (!confirm(`¿Cargar plantilla predefinida \"${preset.name}\"? Esto reemplazará los parámetros actuales.`)) {\r\n      return;\r\n    }\r\n    \r\n    form.setValue(\"title\", preset.title);\r\n    form.setValue(\"notes\", preset.notes || \"\");\r\n    \r\n    // Limpiar items actuales y agregar los del preset\r\n    const currentItems = form.getValues(\"items\");\r\n    currentItems.forEach(() => remove(0));\r\n    \r\n    preset.items.forEach((item) => {\r\n      append({\r\n        groupName: item.groupName || \"\",\r\n        paramName: item.paramName,\r\n        unit: item.unit || \"\",\r\n        refRangeText: item.refRangeText || \"\",\r\n        refMin: item.refMin,\r\n        refMax: item.refMax,\r\n        valueType: item.valueType,\r\n        selectOptions: item.selectOptions || [],\r\n        order: item.order,\r\n        refRanges: item.refRanges || [],\r\n      });\r\n    });\r\n    \r\n    toast.success(`Plantilla \"${preset.name}\" cargada correctamente.`);\r\n  };\r\n\r\n  const onSubmit = async (values: TemplateFormValues) => {\r\n    try {\r\n      const method = templateId ? \"PUT\" : \"POST\";\r\n      const url = templateId ? `/api/templates/${templateId}` : \"/api/templates\";\r\n\r\n      const res = await fetch(url, {\r\n        method,\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify(values),\r\n      });\r\n\r\n      if (!res.ok) {\r\n        const errorData = await res.json().catch(() => ({}));\r\n        toast.error(errorData.error || \"No se pudo guardar la plantilla.\");\r\n        return;\r\n      }\r\n\r\n      toast.success(\"Plantilla guardada correctamente.\");\r\n      router.refresh();\r\n    } catch (error) {\r\n      console.error(\"Error submitting template form:\", error);\r\n      toast.error(\"Error de conexión. Intenta nuevamente.\");\r\n    }\r\n  };\r\n\r\n  const onError = () => {\r\n    // Usar form.formState.errors directamente ya que el parámetro puede estar vacío\r\n    const errors = form.formState.errors;\r\n    \r\n    // Debug: mostrar errores en consola solo en desarrollo\r\n    if (process.env.NODE_ENV === 'development') {\r\n      console.log(\"Form validation errors:\", errors);\r\n    }\r\n    \r\n    // Buscar errores en los items\r\n    if (errors.items && Array.isArray(errors.items)) {\r\n      const itemErrors = errors.items;\r\n      const firstErrorIndex = itemErrors.findIndex((err) => err !== undefined);\r\n      \r\n      if (firstErrorIndex !== -1) {\r\n        const firstError = itemErrors[firstErrorIndex];\r\n        \r\n        if (firstError?.paramName) {\r\n          const message = firstError.paramName.message || \"requiere un nombre de al menos 2 caracteres\";\r\n          toast.error(`Parámetro ${firstErrorIndex + 1}: ${message}`);\r\n          return;\r\n        } else if (firstError?.valueType) {\r\n          toast.error(`El parámetro ${firstErrorIndex + 1} requiere un tipo válido.`);\r\n          return;\r\n        } else if (firstError?.order) {\r\n          toast.error(`El parámetro ${firstErrorIndex + 1} requiere un orden válido.`);\r\n          return;\r\n        } else {\r\n          // Mostrar el primer error encontrado\r\n          const errorKeys = Object.keys(firstError);\r\n          if (errorKeys.length > 0) {\r\n            toast.error(`Error en el parámetro ${firstErrorIndex + 1}, campo: ${errorKeys[0]}`);\r\n          } else {\r\n            toast.error(`Error en el parámetro ${firstErrorIndex + 1}. Verifica los datos.`);\r\n          }\r\n          return;\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Verificar otros campos\r\n    if (errors.title) {\r\n      const message = errors.title.message || \"debe tener al menos 2 caracteres\";\r\n      toast.error(`Título: ${message}`);\r\n      return;\r\n    }\r\n    \r\n    if (errors.labTestId) {\r\n      toast.error(\"Debes seleccionar un análisis.\");\r\n      return;\r\n    }\r\n    \r\n    // Si hay errores pero no los identificamos específicamente\r\n    if (Object.keys(errors).length > 0) {\r\n      toast.error(\"Por favor, completa todos los campos requeridos correctamente.\");\r\n    } else {\r\n      toast.error(\"Por favor, completa todos los campos requeridos.\");\r\n    }\r\n  };\r\n\r\n  return (\r\n    <FormProvider {...form}>\r\n      <form onSubmit={form.handleSubmit(onSubmit, onError)} className=\"space-y-6\">\r\n      <section className=\"space-y-4 rounded-lg border border-slate-200/80 dark:border-slate-600 bg-slate-50/50 dark:bg-slate-800/50 p-4\">\r\n        <h3 className=\"text-sm font-medium text-slate-700 dark:text-slate-200\">Datos de la plantilla</h3>\r\n        <div className=\"grid gap-4 sm:grid-cols-2\">\r\n          <div className=\"space-y-2\">\r\n            <Label className=\"text-slate-700 dark:text-slate-300\">Análisis</Label>\r\n            \r\n            {/* Botón para abrir modal de búsqueda */}\r\n            <button\r\n              type=\"button\"\r\n              onClick={() => {\r\n                setSearchTerm(\"\");\r\n                setIsAnalysisModalOpen(true);\r\n              }}\r\n              className=\"w-full h-10 px-3 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-800 text-left flex items-center gap-2 hover:border-slate-300 dark:hover:border-slate-500 transition-colors\"\r\n            >\r\n              <Search className=\"h-4 w-4 text-slate-400 flex-shrink-0\" />\r\n              {selectedTest ? (\r\n                <div className=\"flex items-center gap-2 min-w-0 flex-1\">\r\n                  <span className=\"text-xs font-mono px-1.5 py-0.5 rounded bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300\">\r\n                    {selectedTest.code}\r\n                  </span>\r\n                  <span className=\"text-sm text-slate-900 dark:text-slate-100 truncate\">\r\n                    {selectedTest.name}\r\n                  </span>\r\n                  {selectedTest.hasTemplate && (\r\n                    <span className=\"text-xs px-1.5 py-0.5 rounded bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 flex-shrink-0\">\r\n                      Con plantilla\r\n                    </span>\r\n                  )}\r\n                </div>\r\n              ) : (\r\n                <span className=\"text-sm text-slate-500 dark:text-slate-400\">Buscar análisis...</span>\r\n              )}\r\n            </button>\r\n            \r\n            {/* Input hidden para el formulario */}\r\n            <input type=\"hidden\" {...form.register(\"labTestId\")} />\r\n            \r\n            {labTests.some((t) => !t.hasTemplate) && (\r\n              <p className=\"text-xs text-slate-500 dark:text-slate-400\">\r\n                Haz clic para buscar y seleccionar un análisis.\r\n              </p>\r\n            )}\r\n            \r\n            {/* Modal de búsqueda de análisis */}\r\n            <Dialog open={isAnalysisModalOpen} onOpenChange={setIsAnalysisModalOpen}>\r\n              <DialogContent className=\"max-w-lg max-h-[85vh] flex flex-col\">\r\n                <DialogHeader>\r\n                  <DialogTitle>Seleccionar análisis</DialogTitle>\r\n                </DialogHeader>\r\n                \r\n                <div className=\"relative\">\r\n                  <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400\" />\r\n                  <Input\r\n                    type=\"text\"\r\n                    placeholder=\"Buscar por nombre o código...\"\r\n                    value={searchTerm}\r\n                    onChange={(e) => setSearchTerm(e.target.value)}\r\n                    className=\"pl-9 h-10 rounded-lg\"\r\n                    autoFocus\r\n                  />\r\n                </div>\r\n                \r\n                {/* Lista de análisis */}\r\n                <div className=\"flex-1 overflow-y-auto rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-800 min-h-[300px] max-h-[400px]\">\r\n                  {(() => {\r\n                    const withoutTemplate = filteredLabTests.filter((t) => !t.hasTemplate);\r\n                    const withTemplate = filteredLabTests.filter((t) => t.hasTemplate);\r\n                    \r\n                    if (filteredLabTests.length === 0 && searchTerm) {\r\n                      return (\r\n                        <div className=\"p-8 text-center text-sm text-slate-500 dark:text-slate-400\">\r\n                          <Search className=\"h-8 w-8 mx-auto mb-2 text-slate-300 dark:text-slate-600\" />\r\n                          No se encontraron análisis para &quot;{searchTerm}&quot;\r\n                        </div>\r\n                      );\r\n                    }\r\n                    \r\n                    if (labTests.length === 0) {\r\n                      return (\r\n                        <div className=\"p-8 text-center text-sm text-slate-500 dark:text-slate-400\">\r\n                          No hay análisis en el catálogo\r\n                        </div>\r\n                      );\r\n                    }\r\n                    \r\n                    return (\r\n                      <div className=\"divide-y divide-slate-100 dark:divide-slate-700\">\r\n                        {withoutTemplate.length > 0 && (\r\n                          <div>\r\n                            <div className=\"px-3 py-2 bg-amber-50 dark:bg-amber-900/20 border-b border-amber-100 dark:border-amber-800/30 sticky top-0 z-10\">\r\n                              <span className=\"text-xs font-medium text-amber-700 dark:text-amber-400 flex items-center gap-1.5\">\r\n                                <FileText className=\"h-3.5 w-3.5\" />\r\n                                Sin plantilla — elegir para crear ({withoutTemplate.length})\r\n                              </span>\r\n                            </div>\r\n                            <div className=\"divide-y divide-slate-100 dark:divide-slate-700\">\r\n                              {withoutTemplate.map((test) => (\r\n                                <button\r\n                                  key={test.id}\r\n                                  type=\"button\"\r\n                                  onClick={() => {\r\n                                    form.setValue(\"labTestId\", test.id);\r\n                                    setIsAnalysisModalOpen(false);\r\n                                  }}\r\n                                  className={`w-full px-3 py-3 text-left transition-colors flex items-center gap-3 ${\r\n                                    watchedLabTestId === test.id\r\n                                      ? \"bg-blue-50 dark:bg-blue-900/30 border-l-4 border-blue-500\"\r\n                                      : \"hover:bg-slate-50 dark:hover:bg-slate-700/50 border-l-4 border-transparent\"\r\n                                  }`}\r\n                                >\r\n                                  <div className={`flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center ${\r\n                                    watchedLabTestId === test.id\r\n                                      ? \"bg-blue-500 text-white\"\r\n                                      : \"bg-slate-200 dark:bg-slate-600\"\r\n                                  }`}>\r\n                                    {watchedLabTestId === test.id && <Check className=\"h-3.5 w-3.5\" />}\r\n                                  </div>\r\n                                  <div className=\"min-w-0 flex-1\">\r\n                                    <div className=\"flex items-center gap-2 flex-wrap\">\r\n                                      <span className=\"text-xs font-mono px-1.5 py-0.5 rounded bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300\">\r\n                                        {test.code}\r\n                                      </span>\r\n                                      <span className=\"text-sm font-medium text-slate-900 dark:text-slate-100\">\r\n                                        {test.name}\r\n                                      </span>\r\n                                    </div>\r\n                                  </div>\r\n                                </button>\r\n                              ))}\r\n                            </div>\r\n                          </div>\r\n                        )}\r\n                        {withTemplate.length > 0 && (\r\n                          <div>\r\n                            <div className=\"px-3 py-2 bg-green-50 dark:bg-green-900/20 border-b border-green-100 dark:border-green-800/30 sticky top-0 z-10\">\r\n                              <span className=\"text-xs font-medium text-green-700 dark:text-green-400 flex items-center gap-1.5\">\r\n                                <Check className=\"h-3.5 w-3.5\" />\r\n                                Ya tienen plantilla ({withTemplate.length})\r\n                              </span>\r\n                            </div>\r\n                            <div className=\"divide-y divide-slate-100 dark:divide-slate-700\">\r\n                              {withTemplate.map((test) => (\r\n                                <button\r\n                                  key={test.id}\r\n                                  type=\"button\"\r\n                                  onClick={() => {\r\n                                    form.setValue(\"labTestId\", test.id);\r\n                                    setIsAnalysisModalOpen(false);\r\n                                  }}\r\n                                  className={`w-full px-3 py-3 text-left transition-colors flex items-center gap-3 ${\r\n                                    watchedLabTestId === test.id\r\n                                      ? \"bg-blue-50 dark:bg-blue-900/30 border-l-4 border-blue-500\"\r\n                                      : \"hover:bg-slate-50 dark:hover:bg-slate-700/50 border-l-4 border-transparent\"\r\n                                  }`}\r\n                                >\r\n                                  <div className={`flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center ${\r\n                                    watchedLabTestId === test.id\r\n                                      ? \"bg-blue-500 text-white\"\r\n                                      : \"bg-green-100 dark:bg-green-800/50 text-green-600 dark:text-green-400\"\r\n                                  }`}>\r\n                                    <Check className=\"h-3.5 w-3.5\" />\r\n                                  </div>\r\n                                  <div className=\"min-w-0 flex-1\">\r\n                                    <div className=\"flex items-center gap-2 flex-wrap\">\r\n                                      <span className=\"text-xs font-mono px-1.5 py-0.5 rounded bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300\">\r\n                                        {test.code}\r\n                                      </span>\r\n                                      <span className=\"text-sm font-medium text-slate-700 dark:text-slate-300\">\r\n                                        {test.name}\r\n                                      </span>\r\n                                    </div>\r\n                                  </div>\r\n                                </button>\r\n                              ))}\r\n                            </div>\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                    );\r\n                  })()}\r\n                </div>\r\n              </DialogContent>\r\n            </Dialog>\r\n          </div>\r\n          \r\n          <div className=\"space-y-2\">\r\n            <Label className=\"text-slate-700 dark:text-slate-300\">Título</Label>\r\n            <Input\r\n              {...form.register(\"title\")}\r\n              placeholder=\"Ej: Hemograma completo\"\r\n              className=\"rounded-lg\"\r\n            />\r\n            {form.formState.errors.title && (\r\n              <p className=\"text-xs text-red-500 mt-0.5\">\r\n                El título debe tener al menos 2 caracteres\r\n              </p>\r\n            )}\r\n          </div>\r\n        </div>\r\n        <div className=\"space-y-2\">\r\n          <Label className=\"text-slate-700 dark:text-slate-300\">Notas (opcional)</Label>\r\n          <Textarea\r\n            {...form.register(\"notes\")}\r\n            placeholder=\"Notas adicionales...\"\r\n            className=\"min-h-[80px] rounded-lg resize-y\"\r\n          />\r\n        </div>\r\n      </section>\r\n\r\n      <section className=\"space-y-4\">\r\n        <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between\">\r\n          <h3 className=\"text-sm font-medium text-slate-700 dark:text-slate-200\">\r\n            Parámetros <span className=\"text-slate-500 dark:text-slate-400 font-normal\">({fields.length})</span>\r\n          </h3>\r\n          <div className=\"flex flex-wrap gap-2\">\r\n            <Button\r\n              type=\"button\"\r\n              variant=\"secondary\"\r\n              size=\"sm\"\r\n              onClick={() =>\r\n                append({\r\n                  groupName: \"\",\r\n                  paramName: \"\",\r\n                  unit: \"\",\r\n                  refRangeText: \"\",\r\n                  refMin: undefined,\r\n                  refMax: undefined,\r\n                  valueType: \"NUMBER\",\r\n                  selectOptions: [],\r\n                  order: fields.length + 1,\r\n                  refRanges: [],\r\n                })\r\n              }\r\n            >\r\n              + Añadir uno\r\n            </Button>\r\n            <Button type=\"button\" variant=\"outline\" size=\"sm\" onClick={addMultipleRows}>\r\n              + Varios\r\n            </Button>\r\n            <Button\r\n              type=\"button\"\r\n              variant=\"outline\"\r\n              size=\"sm\"\r\n              onClick={() => setViewMode(viewMode === \"table\" ? \"form\" : \"table\")}\r\n            >\r\n              {viewMode === \"table\" ? \"Vista tarjetas\" : \"Vista tabla\"}\r\n            </Button>\r\n            <Dialog>\r\n              <DialogTrigger asChild>\r\n                <Button type=\"button\" variant=\"outline\" size=\"sm\">\r\n                  Plantillas predefinidas\r\n                </Button>\r\n              </DialogTrigger>\r\n              <DialogContent className=\"max-w-2xl max-h-[80vh] overflow-y-auto\">\r\n                <DialogHeader>\r\n                  <DialogTitle>Plantillas Predefinidas</DialogTitle>\r\n                </DialogHeader>\r\n                <div className=\"grid gap-2 mt-4\">\r\n                  {templatePresets.map((preset) => (\r\n                    <button\r\n                      key={preset.code}\r\n                      type=\"button\"\r\n                      onClick={() => loadPreset(preset)}\r\n                      className=\"text-left p-3 rounded-md border border-slate-200 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-700/50 hover:border-slate-300 dark:hover:border-slate-500 transition-colors\"\r\n                    >\r\n                      <div className=\"font-semibold text-slate-900 dark:text-slate-100\">{preset.name}</div>\r\n                      <div className=\"text-xs text-slate-500 dark:text-slate-400 mt-1\">\r\n                        {preset.items.length} parámetros\r\n                        {preset.notes && ` · ${preset.notes}`}\r\n                      </div>\r\n                    </button>\r\n                  ))}\r\n                </div>\r\n              </DialogContent>\r\n            </Dialog>\r\n          </div>\r\n        </div>\r\n\r\n        {viewMode === \"table\" ? (\r\n          <div className=\"rounded-lg border border-slate-200 dark:border-slate-600 overflow-hidden\">\r\n            <div className=\"overflow-x-auto max-h-[70vh] overflow-y-auto\">\r\n              <Table className=\"min-w-[800px]\">\r\n                <TableHeader className=\"sticky top-0 bg-slate-100/95 dark:bg-slate-800/95 z-10\">\r\n                  <TableRow className=\"border-slate-200 dark:border-slate-600\">\r\n                    <TableHead className=\"w-10 text-slate-600 dark:text-slate-300\">#</TableHead>\r\n                    <TableHead className=\"text-slate-600 dark:text-slate-300\">Grupo</TableHead>\r\n                    <TableHead className=\"text-slate-600 dark:text-slate-300\">Parámetro</TableHead>\r\n                    <TableHead className=\"text-slate-600 dark:text-slate-300 w-24\">Unidad</TableHead>\r\n                    <TableHead className=\"text-slate-600 dark:text-slate-300 min-w-[100px]\">Ref. texto</TableHead>\r\n                    <TableHead className=\"text-slate-600 dark:text-slate-300 w-24\">Tipo</TableHead>\r\n                    <TableHead className=\"text-slate-600 dark:text-slate-300 w-20\">Min</TableHead>\r\n                    <TableHead className=\"text-slate-600 dark:text-slate-300 w-20\">Max</TableHead>\r\n                    <TableHead className=\"text-slate-600 dark:text-slate-300 w-14\">Ord.</TableHead>\r\n                    <TableHead className=\"text-slate-600 dark:text-slate-300 w-32\">Rangos</TableHead>\r\n                    <TableHead className=\"w-32\">Ordenar</TableHead>\r\n                  </TableRow>\r\n                </TableHeader>\r\n                <TableBody>\r\n                  {fields.map((field, index) => (\r\n                    <TableRow key={field.id}>\r\n                      <TableCell className=\"text-xs text-slate-500 dark:text-slate-400\">{index + 1}</TableCell>\r\n                      <TableCell>\r\n                        <Input\r\n                          className=\"h-8 text-xs\"\r\n                          placeholder=\"Grupo\"\r\n                          {...form.register(`items.${index}.groupName`)}\r\n                        />\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <Input\r\n                          className=\"h-8 text-xs font-medium\"\r\n                          placeholder=\"Nombre parámetro\"\r\n                          {...form.register(`items.${index}.paramName`)}\r\n                        />\r\n                        {form.formState.errors.items?.[index]?.paramName && (\r\n                          <p className=\"text-[10px] text-red-500 mt-0.5\">\r\n                            Mínimo 2 caracteres\r\n                          </p>\r\n                        )}\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <Input\r\n                          className=\"h-8 text-xs w-20\"\r\n                          placeholder=\"g/dL\"\r\n                          {...form.register(`items.${index}.unit`)}\r\n                        />\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <Input\r\n                          className=\"h-8 text-xs w-32\"\r\n                          placeholder=\"12-16\"\r\n                          {...form.register(`items.${index}.refRangeText`)}\r\n                        />\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <select\r\n                          className=\"h-8 w-full rounded-md border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-800 px-2 text-xs text-slate-900 dark:text-slate-100\"\r\n                          {...form.register(`items.${index}.valueType`)}\r\n                          title=\"Tipo de dato para la captura de resultados\"\r\n                        >\r\n                          {valueTypeValues.map((value) => (\r\n                            <option key={value} value={value}>\r\n                              {valueTypeLabels[value]}\r\n                            </option>\r\n                          ))}\r\n                        </select>\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <Input\r\n                          type=\"number\"\r\n                          step=\"0.01\"\r\n                          className=\"h-8 text-xs w-20\"\r\n                          placeholder=\"Min\"\r\n                          {...form.register(`items.${index}.refMin`, {\r\n                            setValueAs: (v) => v === \"\" || v === null || v === undefined ? undefined : Number(v),\r\n                          })}\r\n                        />\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <Input\r\n                          type=\"number\"\r\n                          step=\"0.01\"\r\n                          className=\"h-8 text-xs w-20\"\r\n                          placeholder=\"Max\"\r\n                          {...form.register(`items.${index}.refMax`, {\r\n                            setValueAs: (v) => v === \"\" || v === null || v === undefined ? undefined : Number(v),\r\n                          })}\r\n                        />\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <Input\r\n                          type=\"number\"\r\n                          className=\"h-8 text-xs w-16\"\r\n                          {...form.register(`items.${index}.order`)}\r\n                        />\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <RefRangesManager itemIndex={index} />\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <div className=\"flex items-center gap-1 flex-wrap\">\r\n                          <Button\r\n                            type=\"button\"\r\n                            variant=\"ghost\"\r\n                            size=\"sm\"\r\n                            className=\"h-7 w-7 p-0\"\r\n                            onClick={() => moveUp(index)}\r\n                            title=\"Subir\"\r\n                            disabled={index === 0}\r\n                          >\r\n                            ↑\r\n                          </Button>\r\n                          <Button\r\n                            type=\"button\"\r\n                            variant=\"ghost\"\r\n                            size=\"sm\"\r\n                            className=\"h-7 w-7 p-0\"\r\n                            onClick={() => moveDown(index)}\r\n                            title=\"Bajar\"\r\n                            disabled={index === fields.length - 1}\r\n                          >\r\n                            ↓\r\n                          </Button>\r\n                          <Button\r\n                            type=\"button\"\r\n                            variant=\"ghost\"\r\n                            size=\"sm\"\r\n                            className=\"h-7 w-7 p-0\"\r\n                            onClick={() => duplicateRow(index)}\r\n                            title=\"Duplicar\"\r\n                          >\r\n                            📋\r\n                          </Button>\r\n                          <Button\r\n                            type=\"button\"\r\n                            variant=\"ghost\"\r\n                            size=\"sm\"\r\n                            className=\"h-7 w-7 p-0 text-red-600\"\r\n                            onClick={() => remove(index)}\r\n                            title=\"Eliminar\"\r\n                          >\r\n                            ×\r\n                          </Button>\r\n                        </div>\r\n                      </TableCell>\r\n                    </TableRow>\r\n                  ))}\r\n                </TableBody>\r\n              </Table>\r\n            </div>\r\n          </div>\r\n        ) : (\r\n          <ul className=\"space-y-3\">\r\n            {fields.map((field, index) => (\r\n              <li key={field.id}>\r\n                <div className=\"rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-800/80 p-4 shadow-sm space-y-4\">\r\n                  <div className=\"flex items-center justify-between gap-2 flex-wrap\">\r\n                    <span className=\"text-xs font-medium text-slate-400 dark:text-slate-500\">Parámetro {index + 1}</span>\r\n                    <div className=\"flex gap-2 flex-wrap\">\r\n                      <Button\r\n                        type=\"button\"\r\n                        variant=\"outline\"\r\n                        size=\"sm\"\r\n                        className=\"h-8 text-xs\"\r\n                        onClick={() => moveUp(index)}\r\n                        disabled={index === 0}\r\n                        title=\"Subir\"\r\n                      >\r\n                        ↑ Subir\r\n                      </Button>\r\n                      <Button\r\n                        type=\"button\"\r\n                        variant=\"outline\"\r\n                        size=\"sm\"\r\n                        className=\"h-8 text-xs\"\r\n                        onClick={() => moveDown(index)}\r\n                        disabled={index === fields.length - 1}\r\n                        title=\"Bajar\"\r\n                      >\r\n                        ↓ Bajar\r\n                      </Button>\r\n                      <Button\r\n                        type=\"button\"\r\n                        variant=\"ghost\"\r\n                        size=\"sm\"\r\n                        className=\"h-8 text-xs\"\r\n                        onClick={() => duplicateRow(index)}\r\n                      >\r\n                        Duplicar\r\n                      </Button>\r\n                      <Button\r\n                        type=\"button\"\r\n                        variant=\"ghost\"\r\n                        size=\"sm\"\r\n                        className=\"h-8 text-xs text-red-600 hover:text-red-700\"\r\n                        onClick={() => remove(index)}\r\n                      >\r\n                        Quitar\r\n                      </Button>\r\n                    </div>\r\n                  </div>\r\n                  <div className=\"grid gap-4 sm:grid-cols-2\">\r\n                    <div className=\"space-y-1.5\">\r\n                      <Label className=\"text-xs text-slate-600 dark:text-slate-300\">Parámetro</Label>\r\n                      <Input\r\n                        className=\"rounded-lg h-9\"\r\n                        placeholder=\"Nombre\"\r\n                        {...form.register(`items.${index}.paramName`)}\r\n                      />\r\n                      {form.formState.errors.items?.[index]?.paramName && (\r\n                        <p className=\"text-[10px] text-red-500 mt-0.5\">\r\n                          Mínimo 2 caracteres\r\n                        </p>\r\n                      )}\r\n                    </div>\r\n                    <div className=\"space-y-1.5\">\r\n                      <Label className=\"text-xs text-slate-600 dark:text-slate-300\">Grupo (opcional)</Label>\r\n                      <Input\r\n                        className=\"rounded-lg h-9\"\r\n                        placeholder=\"Grupo\"\r\n                        {...form.register(`items.${index}.groupName`)}\r\n                      />\r\n                    </div>\r\n                  </div>\r\n                  <div className=\"grid gap-4 sm:grid-cols-2 lg:grid-cols-4\">\r\n                    <div className=\"space-y-1.5\">\r\n                      <Label className=\"text-xs text-slate-600 dark:text-slate-300\">Unidad</Label>\r\n                      <Input\r\n                        className=\"rounded-lg h-9\"\r\n                        placeholder=\"mg/dL\"\r\n                        {...form.register(`items.${index}.unit`)}\r\n                      />\r\n                    </div>\r\n                    <div className=\"space-y-1.5\">\r\n                      <Label className=\"text-xs text-slate-600 dark:text-slate-300\">Ref. texto</Label>\r\n                      <Input\r\n                        className=\"rounded-lg h-9\"\r\n                        placeholder=\"12-16\"\r\n                        {...form.register(`items.${index}.refRangeText`)}\r\n                      />\r\n                    </div>\r\n                    <div className=\"space-y-1.5\">\r\n                      <Label className=\"text-xs text-slate-600 dark:text-slate-300\">Tipo de dato</Label>\r\n                      <select\r\n                        className=\"h-9 w-full rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-800 px-3 text-sm text-slate-900 dark:text-slate-100\"\r\n                        {...form.register(`items.${index}.valueType`)}\r\n                        title=\"Define el tipo de valor que se capturará (modificable en cualquier momento)\"\r\n                      >\r\n                        {valueTypeValues.map((v) => (\r\n                          <option key={v} value={v}>{valueTypeLabels[v]}</option>\r\n                        ))}\r\n                      </select>\r\n                    </div>\r\n                    <div className=\"space-y-1.5 sm:col-span-2 lg:col-span-1 grid grid-cols-2 gap-2\">\r\n                      <div>\r\n                        <Label className=\"text-xs text-slate-600 dark:text-slate-300\">Min</Label>\r\n                        <Input\r\n                          type=\"number\"\r\n                          step=\"0.01\"\r\n                          className=\"rounded-lg h-9\"\r\n                          {...form.register(`items.${index}.refMin`, {\r\n                            setValueAs: (v) => v === \"\" || v === null || v === undefined ? undefined : Number(v),\r\n                          })}\r\n                        />\r\n                      </div>\r\n                      <div>\r\n                        <Label className=\"text-xs text-slate-600 dark:text-slate-300\">Max</Label>\r\n                        <Input\r\n                          type=\"number\"\r\n                          step=\"0.01\"\r\n                          className=\"rounded-lg h-9\"\r\n                          {...form.register(`items.${index}.refMax`, {\r\n                            setValueAs: (v) => v === \"\" || v === null || v === undefined ? undefined : Number(v),\r\n                          })}\r\n                        />\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                  {form.watch(`items.${index}.valueType`) === \"SELECT\" && (\r\n                    <div className=\"space-y-1.5\">\r\n                      <Label className=\"text-xs text-slate-600 dark:text-slate-300\">Opciones (separadas por coma)</Label>\r\n                      <Input\r\n                        className=\"rounded-lg h-9\"\r\n                        value={form.watch(`items.${index}.selectOptions`)?.join(\", \") || \"\"}\r\n                        onChange={(e) =>\r\n                          form.setValue(\r\n                            `items.${index}.selectOptions`,\r\n                            e.target.value.split(\",\").map((o) => o.trim()),\r\n                          )\r\n                        }\r\n                      />\r\n                    </div>\r\n                  )}\r\n                  <div className=\"space-y-2 border-t pt-3\">\r\n                    <Label className=\"text-xs text-slate-600 dark:text-slate-300 font-medium\">Valores Referenciales</Label>\r\n                    <RefRangesManager itemIndex={index} />\r\n                  </div>\r\n                  <div className=\"flex items-center justify-end gap-2\">\r\n                    <Label className=\"text-xs text-slate-600 dark:text-slate-300\">Orden</Label>\r\n                    <Input\r\n                      type=\"number\"\r\n                      className=\"rounded-lg h-9 w-16 text-center\"\r\n                      {...form.register(`items.${index}.order`)}\r\n                    />\r\n                  </div>\r\n                </div>\r\n              </li>\r\n            ))}\r\n          </ul>\r\n        )}\r\n      </section>\r\n\r\n      <div className=\"flex flex-col-reverse gap-3 sm:flex-row sm:justify-end pt-4 border-t border-slate-200 dark:border-slate-600\">\r\n        <Button type=\"submit\" className=\"w-full sm:w-auto sm:min-w-[180px]\">\r\n          Guardar plantilla\r\n        </Button>\r\n      </div>\r\n      </form>\r\n    </FormProvider>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\layout\\AppShell.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\layout\\AppShell.tsx:15:19\n  13 |\n  14 |   useEffect(() => {\n> 15 |     if (isMobile) setSidebarOpen(false);\n     |                   ^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  16 |     else setSidebarOpen(true);\n  17 |   }, [isMobile]);\n  18 |","line":15,"column":19,"nodeType":null,"endLine":15,"endColumn":33}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { FlaskConical, ShieldCheck } from \"lucide-react\";\r\nimport { Sidebar } from \"@/components/layout/Sidebar\";\r\nimport { Topbar } from \"@/components/layout/Topbar\";\r\nimport { useMediaQuery } from \"@/hooks/useMediaQuery\";\r\nimport { ShortcutsProvider } from \"@/components/shortcuts/ShortcutsProvider\";\r\n\r\nexport function AppShell({ children }: { children: React.ReactNode }) {\r\n  const isMobile = useMediaQuery(\"(max-width: 767px)\");\r\n  const [sidebarOpen, setSidebarOpen] = useState(true);\r\n\r\n  useEffect(() => {\r\n    if (isMobile) setSidebarOpen(false);\r\n    else setSidebarOpen(true);\r\n  }, [isMobile]);\r\n\r\n  return (\r\n    <ShortcutsProvider>\r\n      <div className=\"flex min-h-screen bg-gradient-to-br from-slate-100 via-slate-50 to-slate-100/70 transition-colors duration-200 dark:from-slate-950 dark:via-slate-900 dark:to-slate-950\">\r\n        <Sidebar open={sidebarOpen} onToggle={() => setSidebarOpen((v) => !v)} />\r\n        <div className=\"flex min-w-0 flex-1 flex-col\">\r\n          <Topbar\r\n            sidebarOpen={sidebarOpen}\r\n            onToggleSidebar={() => setSidebarOpen((v) => !v)}\r\n          />\r\n          <main className=\"min-w-0 flex-1 overflow-x-hidden p-5 sm:p-6 lg:p-8\">\r\n            {children}\r\n          </main>\r\n          <footer className=\"border-t border-slate-200/80 bg-white/70 px-5 py-3 backdrop-blur-md transition-colors dark:border-slate-700/80 dark:bg-slate-900/60 sm:px-6 lg:px-8\">\r\n            <div className=\"flex flex-wrap items-center justify-between gap-2 text-xs text-slate-500 dark:text-slate-400\">\r\n              <p className=\"inline-flex items-center gap-1.5\">\r\n                <FlaskConical className=\"h-3.5 w-3.5 text-teal-600 dark:text-teal-400\" />\r\n                Sistema de Laboratorio Clínico - Enfoque Salud\r\n              </p>\r\n              <p className=\"inline-flex items-center gap-1.5\">\r\n                <ShieldCheck className=\"h-3.5 w-3.5 text-emerald-600 dark:text-emerald-400\" />\r\n                Desarrollado por <a href=\"https://novtiq.com\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"hover:underline\">Novtiq.com</a>\r\n              </p>\r\n            </div>\r\n          </footer>\r\n        </div>\r\n      </div>\r\n    </ShortcutsProvider>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\layout\\NotificationBell.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\layout\\PageHeader.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\layout\\Sidebar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\layout\\ThemeToggle.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\layout\\Topbar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\orders\\AddAnalysisToOrderDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\orders\\EditOrderButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\orders\\EditOrderDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\orders\\OrderAlertsCell.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\orders\\OrderAlertsCell.tsx:37:19\n  35 | export function OrderAlertsCell({ order }: Props) {\n  36 |   const [clientNow, setClientNow] = useState<Date | null>(null);\n> 37 |   useEffect(() => setClientNow(new Date()), []);\n     |                   ^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  38 |\n  39 |   const alerts = getOrderAlerts(order, clientNow);\n  40 |   const maxVisible = 3;","line":37,"column":19,"nodeType":null,"endLine":37,"endColumn":31}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { getOrderAlerts, type OrderAlert, type OrderForAlerts } from \"@/features/lab/order-alerts\";\r\n\r\nfunction severityToBadgeVariant(\r\n  severity: OrderAlert[\"severity\"]\r\n): \"success\" | \"warning\" | \"danger\" | \"secondary\" {\r\n  if (severity === \"green\") return \"success\";\r\n  if (severity === \"yellow\") return \"warning\";\r\n  return \"danger\";\r\n}\r\n\r\nfunction AlertBadge({ alert }: { alert: OrderAlert }) {\r\n  const variant = severityToBadgeVariant(alert.severity);\r\n  const dotColor =\r\n    alert.severity === \"green\"\r\n      ? \"bg-emerald-500\"\r\n      : alert.severity === \"yellow\"\r\n        ? \"bg-amber-500\"\r\n        : \"bg-red-500\";\r\n  return (\r\n    <span title={alert.tooltip}>\r\n      <Badge variant={variant} className=\"inline-flex items-center gap-1 py-0 font-normal\">\r\n        <span className={`h-1.5 w-1.5 rounded-full ${dotColor}`} />\r\n        {alert.label}\r\n      </Badge>\r\n    </span>\r\n  );\r\n}\r\n\r\ntype Props = { order: OrderForAlerts };\r\n\r\nexport function OrderAlertsCell({ order }: Props) {\r\n  const [clientNow, setClientNow] = useState<Date | null>(null);\r\n  useEffect(() => setClientNow(new Date()), []);\r\n\r\n  const alerts = getOrderAlerts(order, clientNow);\r\n  const maxVisible = 3;\r\n  const visible = alerts.slice(0, maxVisible);\r\n  const extra = alerts.length - maxVisible;\r\n  const tooltipText =\r\n    alerts.length > maxVisible\r\n      ? alerts.map((a) => `${a.label}: ${a.tooltip}`).join(\" | \")\r\n      : undefined;\r\n\r\n  return (\r\n    <div\r\n      className=\"flex flex-wrap items-center gap-1.5\"\r\n      title={tooltipText}\r\n    >\r\n      {visible.map((a, i) => (\r\n        <AlertBadge key={`${a.type}-${i}`} alert={a} />\r\n      ))}\r\n      {extra > 0 && (\r\n        <Badge variant=\"secondary\" className=\"py-0 font-normal\" title={tooltipText}>\r\n          +{extra}\r\n        </Badge>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\orders\\OrderItemResultDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\orders\\OrderItemsTableWithPrint.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'formatDate' is defined but never used.","line":7,"column":26,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":36,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"formatDate"},"fix":{"range":[184,196],"text":""},"desc":"Remove unused variable \"formatDate\"."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\orders\\OrderItemsTableWithPrint.tsx:126:28\n  124 |\n  125 |   useEffect(() => {\n> 126 |     if (defaultOpenItemId) setOpenItemId(defaultOpenItemId);\n      |                            ^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  127 |     // eslint-disable-next-line react-hooks/set-state-in-effect -- intencional: sincronizar con prop al montar/cambiar\n  128 |   }, [defaultOpenItemId]);\n  129 |","line":126,"column":28,"nodeType":null,"endLine":126,"endColumn":41},{"ruleId":null,"message":"Unused eslint-disable directive (no problems were reported from 'react-hooks/set-state-in-effect').","line":127,"column":5,"severity":1,"nodeType":null,"fix":{"range":[4102,4216],"text":" "}},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\orders\\OrderItemsTableWithPrint.tsx:140:5\n  138 |       next[item.id] = item.referredLabId ?? fallback;\n  139 |     }\n> 140 |     setSelectedReferredByItemId(next);\n      |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  141 |   }, [order.items]);\n  142 |\n  143 |   const printableItemIds = useMemo(","line":140,"column":5,"nodeType":null,"endLine":140,"endColumn":32}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":1,"source":"\"use client\";\r\n\r\nimport { useState, useMemo, useEffect, Fragment } from \"react\";\r\nimport Link from \"next/link\";\r\nimport { useRouter } from \"next/navigation\";\r\n\r\nimport { formatCurrency, formatDate } from \"@/lib/format\";\r\nimport { parseSelectOptions } from \"@/lib/json-helpers\";\r\nimport { getTemplateItemsForPatient } from \"@/lib/template-helpers\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from \"@/components/ui/table\";\r\nimport { OrderItemResultDialog } from \"@/components/orders/OrderItemResultDialog\";\r\nimport { AddAnalysisToOrderDialog } from \"@/components/orders/AddAnalysisToOrderDialog\";\r\nimport { DeleteButton } from \"@/components/common/DeleteButton\";\r\nimport { Plus } from \"lucide-react\";\r\nimport { toast } from \"sonner\";\r\n\r\ntype OrderItem = {\r\n  id: string;\r\n  status: string;\r\n  priceSnapshot: number | { toString(): string };\r\n  referredLabId?: string | null;\r\n  templateSnapshot: unknown;\r\n  promotionId?: string | null;\r\n  promotionName?: string | null;\r\n  labTest: {\r\n    id: string;\r\n    code: string;\r\n    name: string;\r\n    section: string | { code: string; name?: string } | null;\r\n    referredLabOptions?: Array<{\r\n      referredLabId: string;\r\n      isDefault: boolean;\r\n      referredLab: { id: string; name: string };\r\n      priceToAdmission: number | null;\r\n      externalLabCost: number | null;\r\n    }>;\r\n    template: {\r\n      items: Array<{\r\n        id: string;\r\n        groupName: string | null;\r\n        paramName: string;\r\n        unit: string | null;\r\n        refRangeText: string | null;\r\n        refMin: number | null;\r\n        refMax: number | null;\r\n        valueType: string;\r\n        selectOptions: string;\r\n        order: number;\r\n      }>;\r\n    } | null;\r\n  };\r\n  result: {\r\n    reportedBy: string | null;\r\n    comment: string | null;\r\n    items: Array<{\r\n      id: string;\r\n      templateItemId: string | null;\r\n      paramNameSnapshot: string;\r\n      unitSnapshot: string | null;\r\n      refTextSnapshot: string | null;\r\n      refMinSnapshot: number | null;\r\n      refMaxSnapshot: number | null;\r\n      value: string;\r\n      isOutOfRange: boolean;\r\n      order: number;\r\n    }>;\r\n  } | null;\r\n};\r\n\r\ntype Order = {\r\n  id: string;\r\n  status?: string;\r\n  items: OrderItem[];\r\n  patient?: {\r\n    birthDate: Date | string;\r\n    sex: \"M\" | \"F\" | \"O\";\r\n  };\r\n};\r\n\r\ntype Props = {\r\n  order: Order;\r\n  /** Abre automáticamente el diálogo de captura de este item (ej. desde lista de pendientes) */\r\n  defaultOpenItemId?: string;\r\n  /** Si false, no se muestra el botón de quitar análisis (solo administradores pueden eliminar). */\r\n  canDeleteItems?: boolean;\r\n};\r\n\r\nexport function OrderItemsTableWithPrint({ order, defaultOpenItemId, canDeleteItems = true }: Props) {\r\n  const router = useRouter();\r\n  const [openItemId, setOpenItemId] = useState<string | null>(null);\r\n  const [addAnalysisOpen, setAddAnalysisOpen] = useState(false);\r\n  const [selectedReferredByItemId, setSelectedReferredByItemId] = useState<Record<string, string>>({});\r\n\r\n  const existingLabTestIds = useMemo(\r\n    () => order.items.map((i) => i.labTest.id),\r\n    [order.items],\r\n  );\r\n  const canAddAnalysis = order.status !== \"ANULADO\";\r\n\r\n  const itemsByPromotion = useMemo(() => {\r\n    const groups: { promotionKey: string | null; promotionName: string; items: OrderItem[] }[] = [];\r\n    const byKey = new Map<string | null, OrderItem[]>();\r\n    for (const item of order.items) {\r\n      const key = item.promotionId ?? null;\r\n      if (!byKey.has(key)) byKey.set(key, []);\r\n      byKey.get(key)!.push(item);\r\n    }\r\n    byKey.forEach((items, key) => {\r\n      const promotionName = key == null ? \"Análisis sueltos\" : (items[0].promotionName ?? \"Promoción\");\r\n      groups.push({ promotionKey: key, promotionName, items });\r\n    });\r\n    return groups;\r\n  }, [order.items]);\r\n\r\n  useEffect(() => {\r\n    if (defaultOpenItemId) setOpenItemId(defaultOpenItemId);\r\n    // eslint-disable-next-line react-hooks/set-state-in-effect -- intencional: sincronizar con prop al montar/cambiar\r\n  }, [defaultOpenItemId]);\r\n\r\n  useEffect(() => {\r\n    const next: Record<string, string> = {};\r\n    for (const item of order.items) {\r\n      const options = item.labTest.referredLabOptions ?? [];\r\n      const fallback =\r\n        options.find((o) => o.isDefault)?.referredLabId ??\r\n        options[0]?.referredLabId ??\r\n        \"\";\r\n      next[item.id] = item.referredLabId ?? fallback;\r\n    }\r\n    setSelectedReferredByItemId(next);\r\n  }, [order.items]);\r\n\r\n  const printableItemIds = useMemo(\r\n    () =>\r\n      order.items\r\n        .filter((item) => item.result && item.result.items.length > 0)\r\n        .map((item) => item.id),\r\n    [order.items],\r\n  );\r\n\r\n  const [selectedIds, setSelectedIds] = useState<Set<string>>(\r\n    () => new Set(printableItemIds),\r\n  );\r\n\r\n  const toggleItem = (itemId: string) => {\r\n    if (!printableItemIds.includes(itemId)) return;\r\n    setSelectedIds((prev) => {\r\n      const next = new Set(prev);\r\n      if (next.has(itemId)) {\r\n        next.delete(itemId);\r\n      } else {\r\n        next.add(itemId);\r\n      }\r\n      return next;\r\n    });\r\n  };\r\n\r\n  const selectAll = () => setSelectedIds(new Set(printableItemIds));\r\n  const deselectAll = () => setSelectedIds(new Set());\r\n\r\n  const allSelected =\r\n    printableItemIds.length > 0 &&\r\n    printableItemIds.every((id) => selectedIds.has(id));\r\n  const someSelected = selectedIds.size > 0;\r\n\r\n  const printUrl =\r\n    selectedIds.size > 0\r\n      ? `/orders/${order.id}/print?items=${Array.from(selectedIds).join(\",\")}`\r\n      : `/orders/${order.id}/print`;\r\n\r\n  if (order.items.length === 0) {\r\n    const canAddAnalysis = order.status !== \"ANULADO\";\r\n    return (\r\n      <Card>\r\n        <CardHeader className=\"flex flex-row items-center justify-between gap-2\">\r\n          <CardTitle>Análisis solicitados</CardTitle>\r\n          {canAddAnalysis && (\r\n            <Button\r\n              type=\"button\"\r\n              variant=\"outline\"\r\n              size=\"sm\"\r\n              className=\"gap-1.5\"\r\n              onClick={() => setAddAnalysisOpen(true)}\r\n            >\r\n              <Plus className=\"h-4 w-4\" />\r\n              Añadir análisis\r\n            </Button>\r\n          )}\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"py-8 text-center text-slate-500\">\r\n            <p>No hay análisis solicitados en esta orden.</p>\r\n            {canAddAnalysis && (\r\n              <p className=\"mt-1 text-sm\">\r\n                Usa el botón &quot;Añadir análisis&quot; para agregar análisis del catálogo.\r\n              </p>\r\n            )}\r\n          </div>\r\n        </CardContent>\r\n        {canAddAnalysis && (\r\n          <AddAnalysisToOrderDialog\r\n            orderId={order.id}\r\n            existingLabTestIds={[]}\r\n            open={addAnalysisOpen}\r\n            onOpenChange={setAddAnalysisOpen}\r\n          />\r\n        )}\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <Card>\r\n      <CardHeader className=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between\">\r\n        <div className=\"flex flex-wrap items-center gap-2\">\r\n          <CardTitle className=\"mb-0\">Análisis solicitados</CardTitle>\r\n          {canAddAnalysis && (\r\n            <>\r\n              <Button\r\n                type=\"button\"\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                className=\"gap-1.5\"\r\n                onClick={() => setAddAnalysisOpen(true)}\r\n              >\r\n                <Plus className=\"h-4 w-4\" />\r\n                Añadir análisis\r\n              </Button>\r\n              <AddAnalysisToOrderDialog\r\n                orderId={order.id}\r\n                existingLabTestIds={existingLabTestIds}\r\n                open={addAnalysisOpen}\r\n                onOpenChange={setAddAnalysisOpen}\r\n              />\r\n            </>\r\n          )}\r\n        </div>\r\n        {printableItemIds.length > 0 && (\r\n          <div className=\"flex flex-wrap items-center gap-2\">\r\n            <button\r\n              type=\"button\"\r\n              onClick={allSelected ? deselectAll : selectAll}\r\n              className=\"text-sm text-slate-600 hover:text-slate-900 hover:underline\"\r\n            >\r\n              {allSelected ? \"Deseleccionar todos\" : \"Seleccionar todos\"}\r\n            </button>\r\n            <span className=\"text-slate-300\">|</span>\r\n            <Link href={printUrl} target=\"_blank\" rel=\"noopener noreferrer\">\r\n              <Button size=\"sm\" className=\"gap-2\">\r\n                <svg\r\n                  xmlns=\"http://www.w3.org/2000/svg\"\r\n                  width=\"16\"\r\n                  height=\"16\"\r\n                  viewBox=\"0 0 24 24\"\r\n                  fill=\"none\"\r\n                  stroke=\"currentColor\"\r\n                  strokeWidth=\"2\"\r\n                  strokeLinecap=\"round\"\r\n                  strokeLinejoin=\"round\"\r\n                >\r\n                  <path d=\"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4\" />\r\n                  <polyline points=\"7 10 12 15 17 10\" />\r\n                  <line x1=\"12\" y1=\"15\" x2=\"12\" y2=\"3\" />\r\n                </svg>\r\n                Imprimir seleccionados en PDF\r\n                {someSelected && (\r\n                  <span className=\"ml-1 text-xs opacity-90\">\r\n                    ({selectedIds.size})\r\n                  </span>\r\n                )}\r\n              </Button>\r\n            </Link>\r\n          </div>\r\n        )}\r\n      </CardHeader>\r\n      <CardContent>\r\n        <div className=\"-mx-1 overflow-x-auto\">\r\n        <Table className=\"min-w-[640px]\">\r\n          <TableHeader>\r\n            <TableRow>\r\n              {printableItemIds.length > 0 && (\r\n                <TableHead className=\"w-10\">Sel.</TableHead>\r\n              )}\r\n              <TableHead>Análisis</TableHead>\r\n              <TableHead>Sección</TableHead>\r\n              <TableHead>Lab. referido</TableHead>\r\n              <TableHead>Estado</TableHead>\r\n              <TableHead>Resultados</TableHead>\r\n              <TableHead>Precio</TableHead>\r\n              <TableHead className=\"text-right\">Acciones</TableHead>\r\n            </TableRow>\r\n          </TableHeader>\r\n          <TableBody>\r\n            {itemsByPromotion.map((group) => (\r\n              <Fragment key={group.promotionKey ?? \"sueltos\"}>\r\n                <TableRow className=\"bg-slate-100 hover:bg-slate-100\">\r\n                    <TableCell\r\n                      colSpan={printableItemIds.length > 0 ? 7 : 6}\r\n                      className=\"font-semibold text-slate-700 py-2\"\r\n                    >\r\n                      {group.promotionKey != null ? (\r\n                        <span className=\"text-amber-700\">Promoción: {group.promotionName}</span>\r\n                      ) : (\r\n                        <span className=\"text-slate-600\">{group.promotionName}</span>\r\n                      )}\r\n                    </TableCell>\r\n                  </TableRow>\r\n                {group.items.map((item) => {\r\n              const hasResults =\r\n                item.result && (item.result.items?.length ?? 0) > 0;\r\n              const canSelect = printableItemIds.includes(item.id);\r\n              const isSelected = selectedIds.has(item.id);\r\n\r\n              const templateItems = item.result\r\n                ? (() => {\r\n                    const patientBirthDate = order.patient?.birthDate \r\n                      ? (typeof order.patient.birthDate === \"string\" \r\n                          ? new Date(order.patient.birthDate) \r\n                          : order.patient.birthDate)\r\n                      : undefined;\r\n                    const patientSex = order.patient?.sex;\r\n\r\n                    const templateItemsFromSnapshot = getTemplateItemsForPatient(\r\n                      item.templateSnapshot,\r\n                      item.labTest.template\r\n                        ? {\r\n                            items: item.labTest.template.items.map((t) => ({\r\n                              id: t.id,\r\n                              groupName: t.groupName,\r\n                              paramName: t.paramName,\r\n                              unit: t.unit,\r\n                              refRangeText: t.refRangeText,\r\n                              refMin: t.refMin ? Number(t.refMin) : null,\r\n                              refMax: t.refMax ? Number(t.refMax) : null,\r\n                              valueType: t.valueType as \"NUMBER\" | \"DECIMAL\" | \"PERCENTAGE\" | \"TEXT\" | \"SELECT\",\r\n                              selectOptions: parseSelectOptions(t.selectOptions),\r\n                              order: t.order,\r\n                              refRanges: ((t as { refRanges?: import(\"@/lib/template-helpers\").RefRange[] }).refRanges ?? []) as import(\"@/lib/template-helpers\").RefRange[],\r\n                            })),\r\n                          }\r\n                        : null,\r\n                      patientBirthDate,\r\n                      patientSex,\r\n                    );\r\n\r\n                    return item.result!.items.map((r, idx) => {\r\n                      const originalItem = templateItemsFromSnapshot.find(\r\n                        (t) => t.id === r.templateItemId,\r\n                      );\r\n                      // Buscar el item original en la plantilla para obtener refRanges\r\n                      const originalTemplateItem = item.labTest.template?.items.find(\r\n                        (t) => t.id === r.templateItemId,\r\n                      );\r\n                      return {\r\n                        id: r.templateItemId || `snapshot-${idx}`,\r\n                        groupName: originalItem?.groupName || null,\r\n                        paramName: r.paramNameSnapshot,\r\n                        unit: r.unitSnapshot,\r\n                        refRangeText: r.refTextSnapshot,\r\n                        refMin: r.refMinSnapshot ? Number(r.refMinSnapshot) : null,\r\n                        refMax: r.refMaxSnapshot ? Number(r.refMaxSnapshot) : null,\r\n                        valueType: (originalItem?.valueType || \"NUMBER\") as\r\n                          | \"NUMBER\"\r\n                          | \"DECIMAL\"\r\n                          | \"PERCENTAGE\"\r\n                          | \"TEXT\"\r\n                          | \"SELECT\",\r\n                        selectOptions: originalItem?.selectOptions || [],\r\n                        order: r.order,\r\n                        refRanges: ((originalTemplateItem as { refRanges?: import(\"@/lib/template-helpers\").RefRange[] } | undefined)?.refRanges ?? []) as import(\"@/lib/template-helpers\").RefRange[],\r\n                      };\r\n                    });\r\n                  })()\r\n                : (() => {\r\n                    const patientBirthDate = order.patient?.birthDate \r\n                      ? (typeof order.patient.birthDate === \"string\" \r\n                          ? new Date(order.patient.birthDate) \r\n                          : order.patient.birthDate)\r\n                      : undefined;\r\n                    const patientSex = order.patient?.sex;\r\n\r\n                    const itemsWithRefRanges = item.labTest.template\r\n                      ? {\r\n                          items: item.labTest.template.items.map((t) => ({\r\n                            id: t.id,\r\n                            groupName: t.groupName,\r\n                            paramName: t.paramName,\r\n                            unit: t.unit,\r\n                            refRangeText: t.refRangeText,\r\n                            refMin: t.refMin ? Number(t.refMin) : null,\r\n                            refMax: t.refMax ? Number(t.refMax) : null,\r\n                            valueType: t.valueType as \"NUMBER\" | \"DECIMAL\" | \"PERCENTAGE\" | \"TEXT\" | \"SELECT\",\r\n                            selectOptions: parseSelectOptions(t.selectOptions),\r\n                            order: t.order,\r\n                            refRanges: ((t as { refRanges?: import(\"@/lib/template-helpers\").RefRange[] }).refRanges ?? []) as import(\"@/lib/template-helpers\").RefRange[],\r\n                          })),\r\n                        }\r\n                      : null;\r\n                    \r\n                    const processedItems = getTemplateItemsForPatient(\r\n                      item.templateSnapshot,\r\n                      itemsWithRefRanges,\r\n                      patientBirthDate,\r\n                      patientSex,\r\n                    );\r\n                    \r\n                    // Restaurar los refRanges originales para mostrar todos\r\n                    return processedItems.map((processedItem) => {\r\n                      const originalItem = itemsWithRefRanges?.items.find((t) => t.id === processedItem.id);\r\n                      return {\r\n                        ...processedItem,\r\n                        refRanges: originalItem?.refRanges || [],\r\n                      };\r\n                    });\r\n                  })();\r\n\r\n              const patientBirthDate = order.patient?.birthDate \r\n                ? (typeof order.patient.birthDate === \"string\" \r\n                    ? new Date(order.patient.birthDate) \r\n                    : order.patient.birthDate)\r\n                : undefined;\r\n              const patientSex = order.patient?.sex;\r\n\r\n              const originalTemplateItems = item.labTest.template\r\n                ? (() => {\r\n                    const itemsWithRefRanges = item.labTest.template.items.map((t) => ({\r\n                      id: t.id,\r\n                      groupName: t.groupName,\r\n                      paramName: t.paramName,\r\n                      unit: t.unit,\r\n                      refRangeText: t.refRangeText,\r\n                      refMin: t.refMin ? Number(t.refMin) : null,\r\n                      refMax: t.refMax ? Number(t.refMax) : null,\r\n                      valueType: t.valueType as \"NUMBER\" | \"DECIMAL\" | \"PERCENTAGE\" | \"TEXT\" | \"SELECT\",\r\n                      selectOptions: parseSelectOptions(t.selectOptions),\r\n                      order: t.order,\r\n                      refRanges: ((t as { refRanges?: import(\"@/lib/template-helpers\").RefRange[] }).refRanges ?? []) as import(\"@/lib/template-helpers\").RefRange[],\r\n                    }));\r\n                    \r\n                    const processedItems = getTemplateItemsForPatient(\r\n                      null,\r\n                      { items: itemsWithRefRanges },\r\n                      patientBirthDate,\r\n                      patientSex,\r\n                    );\r\n                    \r\n                    // Restaurar los refRanges originales (no filtrados) para mostrar todos\r\n                    return processedItems.map((processedItem) => {\r\n                      const originalItem = itemsWithRefRanges.find((t) => t.id === processedItem.id);\r\n                      return {\r\n                        ...processedItem,\r\n                        refRanges: originalItem?.refRanges || [],\r\n                      };\r\n                    });\r\n                  })()\r\n                : [];\r\n\r\n              const finalTemplateItems =\r\n                templateItems.length > 0 ? templateItems : originalTemplateItems;\r\n\r\n              const referredOptions = item.labTest.referredLabOptions ?? [];\r\n\r\n              const handleReferredLabChange = async (newLabId: string) => {\r\n                setSelectedReferredByItemId((prev) => ({ ...prev, [item.id]: newLabId }));\r\n                try {\r\n                  const res = await fetch(\r\n                    `/api/orders/${order.id}/items/${item.id}/referred-lab`,\r\n                    {\r\n                      method: \"PUT\",\r\n                      headers: { \"Content-Type\": \"application/json\" },\r\n                      body: JSON.stringify({ referredLabId: newLabId || null }),\r\n                    },\r\n                  );\r\n                  const data = await res.json().catch(() => ({}));\r\n                  if (!res.ok) {\r\n                    toast.error(\r\n                      data.error || \"No se pudo actualizar el laboratorio referido.\",\r\n                    );\r\n                    // restaurar valor previo al fallar\r\n                    const prevFallback =\r\n                      item.referredLabId ??\r\n                      referredOptions.find((o) => o.isDefault)?.referredLabId ??\r\n                      referredOptions[0]?.referredLabId ??\r\n                      \"\";\r\n                    setSelectedReferredByItemId((prev) => ({ ...prev, [item.id]: prevFallback }));\r\n                    return;\r\n                  }\r\n                  router.refresh();\r\n                } catch {\r\n                  toast.error(\"Error de conexión al actualizar el laboratorio referido.\");\r\n                  const prevFallback =\r\n                    item.referredLabId ??\r\n                    referredOptions.find((o) => o.isDefault)?.referredLabId ??\r\n                    referredOptions[0]?.referredLabId ??\r\n                    \"\";\r\n                  setSelectedReferredByItemId((prev) => ({ ...prev, [item.id]: prevFallback }));\r\n                }\r\n              };\r\n\r\n              return (\r\n                <TableRow key={item.id} className={group.promotionKey != null ? \"bg-amber-50/30\" : undefined}>\r\n                  {printableItemIds.length > 0 && (\r\n                    <TableCell className=\"w-10\">\r\n                      {canSelect ? (\r\n                        <input\r\n                          type=\"checkbox\"\r\n                          checked={isSelected}\r\n                          onChange={() => toggleItem(item.id)}\r\n                          className=\"h-4 w-4 rounded border-slate-300 text-slate-900 focus:ring-slate-400\"\r\n                        />\r\n                      ) : (\r\n                        <span className=\"text-slate-300\">-</span>\r\n                      )}\r\n                    </TableCell>\r\n                  )}\r\n                  <TableCell className=\"font-medium\">\r\n                    {item.labTest.code} - {item.labTest.name}\r\n                  </TableCell>\r\n                  <TableCell>\r\n                    <span className=\"text-xs text-slate-600\">\r\n                      {typeof item.labTest.section === \"object\" && item.labTest.section\r\n                        ? (item.labTest.section.name ?? item.labTest.section.code)\r\n                        : (item.labTest.section ?? \"\")}\r\n                    </span>\r\n                  </TableCell>\r\n                  <TableCell>\r\n                    {referredOptions.length === 0 ? (\r\n                      <span className=\"text-xs text-slate-400\">—</span>\r\n                    ) : referredOptions.length === 1 ? (\r\n                      <span className=\"text-xs text-slate-600\">\r\n                        {referredOptions[0].referredLab.name}\r\n                      </span>\r\n                    ) : (\r\n                      <select\r\n                        className=\"h-8 w-full rounded-md border border-slate-200 bg-white px-2 text-xs dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100\"\r\n                        value={\r\n                          selectedReferredByItemId[item.id] ??\r\n                          item.referredLabId ??\r\n                          referredOptions.find((o) => o.isDefault)?.referredLabId ??\r\n                          referredOptions[0].referredLabId\r\n                        }\r\n                        onChange={(e) => void handleReferredLabChange(e.target.value)}\r\n                      >\r\n                        {referredOptions.map((opt) => (\r\n                          <option key={opt.referredLabId} value={opt.referredLabId}>\r\n                            {opt.referredLab.name}\r\n                          </option>\r\n                        ))}\r\n                      </select>\r\n                    )}\r\n                  </TableCell>\r\n                  <TableCell>\r\n                    <Badge variant=\"secondary\">{item.status}</Badge>\r\n                  </TableCell>\r\n                  <TableCell>\r\n                    {hasResults ? (\r\n                      <Badge\r\n                        variant=\"success\"\r\n                        className=\"bg-emerald-100 text-emerald-700\"\r\n                      >\r\n                        {item.result!.items.length} parámetros\r\n                      </Badge>\r\n                    ) : (\r\n                      <Badge\r\n                        variant=\"warning\"\r\n                        className=\"bg-amber-100 text-amber-700\"\r\n                      >\r\n                        Pendiente\r\n                      </Badge>\r\n                    )}\r\n                  </TableCell>\r\n                  <TableCell>\r\n                    {formatCurrency(Number(item.priceSnapshot))}\r\n                  </TableCell>\r\n                  <TableCell className=\"text-right\">\r\n                    <div className=\"flex items-center justify-end gap-2 flex-wrap\">\r\n                      {finalTemplateItems.length > 0 || item.labTest.template ? (\r\n                        <OrderItemResultDialog\r\n                          orderId={order.id}\r\n                          itemId={item.id}\r\n                          testName={item.labTest.name}\r\n                          testCode={item.labTest.code}\r\n                          templateItems={finalTemplateItems}\r\n                          open={openItemId === item.id}\r\n                          onOpenChange={(open) => setOpenItemId(open ? item.id : null)}\r\n                          existing={\r\n                            item.result\r\n                              ? {\r\n                                  reportedBy: item.result.reportedBy,\r\n                                  comment: item.result.comment,\r\n                                  items: item.result.items.map((r) => ({\r\n                                    templateItemId: r.templateItemId,\r\n                                    paramNameSnapshot: r.paramNameSnapshot,\r\n                                    unitSnapshot: r.unitSnapshot,\r\n                                    refTextSnapshot: r.refTextSnapshot,\r\n                                    refMinSnapshot: r.refMinSnapshot\r\n                                      ? Number(r.refMinSnapshot)\r\n                                      : null,\r\n                                    refMaxSnapshot: r.refMaxSnapshot\r\n                                      ? Number(r.refMaxSnapshot)\r\n                                      : null,\r\n                                    value: r.value,\r\n                                    isOutOfRange: r.isOutOfRange,\r\n                                    order: r.order,\r\n                                  })),\r\n                                }\r\n                              : undefined\r\n                          }\r\n                        />\r\n                      ) : (\r\n                        <span className=\"text-xs text-slate-400\">\r\n                          Sin plantilla\r\n                        </span>\r\n                      )}\r\n                      {canDeleteItems && (\r\n                        <DeleteButton\r\n                          url={`/api/orders/${order.id}/items/${item.id}`}\r\n                          label=\"Quitar\"\r\n                        />\r\n                      )}\r\n                    </div>\r\n                  </TableCell>\r\n                </TableRow>\r\n              );\r\n            })}\r\n              </Fragment>\r\n            ))}\r\n          </TableBody>\r\n        </Table>\r\n        </div>\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\orders\\OrderPaymentPanel.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\orders\\OrderPaymentPanel.tsx:84:10\n  82 |\n  83 |   useEffect(() => {\n> 84 |     void reloadPayments();\n     |          ^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  85 |   }, [orderId]);\n  86 |\n  87 |   useEffect(() => {","line":84,"column":10,"nodeType":null,"endLine":84,"endColumn":24},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'reloadPayments'. Either include it or remove the dependency array.","line":85,"column":6,"nodeType":"ArrayExpression","endLine":85,"endColumn":15,"suggestions":[{"desc":"Update the dependencies array to be: [orderId, reloadPayments]","fix":{"range":[2721,2730],"text":"[orderId, reloadPayments]"}}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\orders\\OrderPaymentPanel.tsx:88:10\n  86 |\n  87 |   useEffect(() => {\n> 88 |     void reloadReferredLabSummary();\n     |          ^^^^^^^^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  89 |   }, [orderId]);\n  90 |   const paidTotal = useMemo(\n  91 |     () => payments.reduce((acc, p) => acc + Number(p.amount), 0),","line":88,"column":10,"nodeType":null,"endLine":88,"endColumn":34},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'reloadReferredLabSummary'. Either include it or remove the dependency array.","line":89,"column":6,"nodeType":"ArrayExpression","endLine":89,"endColumn":15,"suggestions":[{"desc":"Update the dependencies array to be: [orderId, reloadReferredLabSummary]","fix":{"range":[2800,2809],"text":"[orderId, reloadReferredLabSummary]"}}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useMemo, useState } from \"react\";\r\nimport Link from \"next/link\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { toast } from \"sonner\";\r\nimport { Receipt, Building2 } from \"lucide-react\";\r\n\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { formatCurrency, formatDate } from \"@/lib/format\";\r\nimport { PaymentDialog } from \"@/components/orders/PaymentDialog\";\r\nimport { ReferredLabPaymentDialog } from \"@/components/orders/ReferredLabPaymentDialog\";\r\n\r\ntype PaymentItem = {\r\n  id: string;\r\n  amount: number;\r\n  method: \"EFECTIVO\" | \"TARJETA\" | \"TRANSFERENCIA\" | \"CREDITO\";\r\n  notes: string | null;\r\n  paidAt: Date | string;\r\n  createdAt: Date | string;\r\n  user?: { id: string; name: string | null; email: string } | null;\r\n};\r\n\r\ntype Props = {\r\n  orderId: string;\r\n  orderCode: string;\r\n  orderTotal: number;\r\n  /** Si la orden es de admisión, total a cobrar (precio convenio). Se usa para pre-rellenar el monto al registrar pago. */\r\n  conventionTotal?: number | null;\r\n  canRegisterPayment: boolean;\r\n  canPrintTicket?: boolean;\r\n};\r\n\r\nconst methodLabel: Record<PaymentItem[\"method\"], string> = {\r\n  EFECTIVO: \"Efectivo\",\r\n  TARJETA: \"Tarjeta\",\r\n  TRANSFERENCIA: \"Transferencia\",\r\n  CREDITO: \"Crédito\",\r\n};\r\n\r\nexport function OrderPaymentPanel({\r\n  orderId,\r\n  orderCode,\r\n  orderTotal,\r\n  conventionTotal,\r\n  canRegisterPayment,\r\n  canPrintTicket = true,\r\n}: Props) {\r\n  const router = useRouter();\r\n  const [payments, setPayments] = useState<PaymentItem[]>([]);\r\n  const [referredLabSummary, setReferredLabSummary] = useState<{\r\n    totalExternalCost: number;\r\n    totalPaidToLabs: number;\r\n    totalBalanceOwed: number;\r\n  } | null>(null);\r\n\r\n  const reloadReferredLabSummary = async () => {\r\n    const res = await fetch(`/api/orders/${orderId}/referred-lab-payments`);\r\n    const data = await res.json().catch(() => ({}));\r\n    if (res.ok && data.totalExternalCost != null) {\r\n      setReferredLabSummary({\r\n        totalExternalCost: data.totalExternalCost,\r\n        totalPaidToLabs: data.totalPaidToLabs ?? 0,\r\n        totalBalanceOwed: data.totalBalanceOwed ?? 0,\r\n      });\r\n    } else {\r\n      setReferredLabSummary(null);\r\n    }\r\n  };\r\n\r\n  const reloadPayments = async () => {\r\n    const res = await fetch(`/api/orders/${orderId}/payments`);\r\n    const data = await res.json().catch(() => ({}));\r\n    if (res.ok && data.item?.payments) {\r\n      setPayments(data.item.payments);\r\n      return;\r\n    }\r\n    toast.error(data.error ?? \"No se pudo cargar los pagos\");\r\n  };\r\n\r\n  useEffect(() => {\r\n    void reloadPayments();\r\n  }, [orderId]);\r\n\r\n  useEffect(() => {\r\n    void reloadReferredLabSummary();\r\n  }, [orderId]);\r\n  const paidTotal = useMemo(\r\n    () => payments.reduce((acc, p) => acc + Number(p.amount), 0),\r\n    [payments],\r\n  );\r\n  const isFromAdmission = conventionTotal != null;\r\n  const effectiveTotal = isFromAdmission ? conventionTotal : orderTotal;\r\n  const balance = Math.max(0, effectiveTotal - paidTotal);\r\n\r\n  return (\r\n    <Card>\r\n      <CardHeader className=\"flex flex-row items-center justify-between gap-3\">\r\n        <CardTitle className=\"text-base\">Cobros de la orden</CardTitle>\r\n        <div className=\"flex items-center gap-2\">\r\n          {canPrintTicket && (\r\n            <Button variant=\"outline\" size=\"sm\" className=\"gap-1.5\" asChild>\r\n              <Link\r\n                href={`/orders/${orderId}/payment-ticket`}\r\n                target=\"_blank\"\r\n                rel=\"noopener noreferrer\"\r\n              >\r\n                <Receipt className=\"h-4 w-4\" />\r\n                Ticket de pago\r\n              </Link>\r\n            </Button>\r\n          )}\r\n          {canRegisterPayment && (\r\n            <>\r\n              <PaymentDialog\r\n                orderId={orderId}\r\n                orderCode={orderCode}\r\n                orderTotal={orderTotal}\r\n                paidTotal={paidTotal}\r\n                defaultAmount={conventionTotal}\r\n                disabled={balance <= 0}\r\n                onPaymentSaved={async () => {\r\n                  await reloadPayments();\r\n                  router.refresh();\r\n                }}\r\n              />\r\n              {referredLabSummary && referredLabSummary.totalExternalCost > 0 && (\r\n                <ReferredLabPaymentDialog\r\n                  orderId={orderId}\r\n                  orderCode={orderCode}\r\n                  canRegisterPayment={canRegisterPayment}\r\n                  onPaymentSaved={() => {\r\n                    void reloadReferredLabSummary();\r\n                    router.refresh();\r\n                  }}\r\n                />\r\n              )}\r\n            </>\r\n          )}\r\n        </div>\r\n      </CardHeader>\r\n      <CardContent className=\"space-y-4\">\r\n        <div className=\"grid gap-3 sm:grid-cols-3 lg:grid-cols-5\">\r\n          {isFromAdmission ? (\r\n            <div>\r\n              <p className=\"text-xs text-slate-500 dark:text-slate-400\">A cobrar a admisión (convenio)</p>\r\n              <p className=\"text-base font-semibold\">{formatCurrency(conventionTotal!)}</p>\r\n              <p className=\"text-[10px] text-slate-400 dark:text-slate-500\">Lo que cobra el lab a admisión</p>\r\n            </div>\r\n          ) : (\r\n            <div>\r\n              <p className=\"text-xs text-slate-500 dark:text-slate-400\">Total orden</p>\r\n              <p className=\"text-base font-semibold\">{formatCurrency(orderTotal)}</p>\r\n            </div>\r\n          )}\r\n          <div>\r\n            <p className=\"text-xs text-slate-500 dark:text-slate-400\">\r\n              {isFromAdmission ? \"Cobrado (de admisión)\" : \"Total cobrado\"}\r\n            </p>\r\n            <p className=\"text-base font-semibold text-emerald-600 dark:text-emerald-400\">\r\n              {formatCurrency(paidTotal)}\r\n            </p>\r\n          </div>\r\n          <div>\r\n            <p className=\"text-xs text-slate-500 dark:text-slate-400\">\r\n              {isFromAdmission ? \"Saldo pendiente (a cobrar a admisión)\" : \"Saldo pendiente\"}\r\n            </p>\r\n            <p className=\"text-base font-semibold text-amber-600 dark:text-amber-400\">\r\n              {formatCurrency(balance)}\r\n            </p>\r\n          </div>\r\n          {referredLabSummary && referredLabSummary.totalExternalCost > 0 && (\r\n            <>\r\n              <div>\r\n                <p className=\"flex items-center gap-1 text-xs text-slate-500 dark:text-slate-400\">\r\n                  <Building2 className=\"h-3.5 w-3.5\" />\r\n                  Costo lab. referido\r\n                </p>\r\n                <p className=\"text-base font-semibold\">{formatCurrency(referredLabSummary.totalExternalCost)}</p>\r\n              </div>\r\n              <div>\r\n                <p className=\"text-xs text-slate-500 dark:text-slate-400\">Pendiente por pagar al lab.</p>\r\n                <p className=\"text-base font-semibold text-amber-600 dark:text-amber-400\">\r\n                  {formatCurrency(referredLabSummary.totalBalanceOwed)}\r\n                </p>\r\n              </div>\r\n            </>\r\n          )}\r\n        </div>\r\n\r\n        {payments.length === 0 ? (\r\n          <p className=\"text-sm text-slate-500 dark:text-slate-400\">\r\n            Aún no hay pagos registrados para esta orden.\r\n          </p>\r\n        ) : (\r\n          <div className=\"space-y-2\">\r\n            {payments.map((payment) => (\r\n              <div\r\n                key={payment.id}\r\n                className=\"rounded-lg border border-slate-200 p-3 text-sm dark:border-slate-700\"\r\n              >\r\n                <div className=\"flex flex-wrap items-center justify-between gap-2\">\r\n                  <p className=\"font-semibold\">{formatCurrency(Number(payment.amount))}</p>\r\n                  <Badge variant=\"secondary\">{methodLabel[payment.method]}</Badge>\r\n                </div>\r\n                <p className=\"mt-1 text-xs text-slate-500 dark:text-slate-400\">\r\n                  {formatDate(new Date(payment.paidAt))}\r\n                  {payment.user?.name || payment.user?.email\r\n                    ? ` - Registrado por ${payment.user?.name ?? payment.user?.email}`\r\n                    : \"\"}\r\n                </p>\r\n                {payment.notes ? (\r\n                  <p className=\"mt-1 text-xs text-slate-600 dark:text-slate-300\">{payment.notes}</p>\r\n                ) : null}\r\n              </div>\r\n            ))}\r\n          </div>\r\n        )}\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\orders\\OrderStatusActions.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\orders\\PaymentDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\orders\\PreAnalyticNotePicker.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\orders\\PrintActions.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\orders\\PrintFitToPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\orders\\QuickOrderModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setPatientType' is assigned a value but never used.","line":49,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":49,"endColumn":37},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'loading' is assigned a value but never used.","line":50,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":50,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setLoading' is assigned a value but never used.","line":50,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":50,"endColumn":29}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect, useCallback, useMemo } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from \"@/components/ui/dialog\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { toast } from \"sonner\";\r\nimport { Search, Star, X } from \"lucide-react\";\r\n\r\ntype PatientResult = { id: string; label: string; sublabel: string };\r\ntype TestItem = { id: string; code: string; name: string; section: string; price: number };\r\ntype Profile = { id: string; name: string; packagePrice: number | null; tests: TestItem[] };\r\n\r\ntype Props = {\r\n  open: boolean;\r\n  onOpenChange: (open: boolean) => void;\r\n};\r\n\r\nexport function QuickOrderModal({ open, onOpenChange }: Props) {\r\n  const router = useRouter();\r\n  const [patientQuery, setPatientQuery] = useState(\"\");\r\n  const [testSearch, setTestSearch] = useState(\"\");\r\n  const [patientResults, setPatientResults] = useState<PatientResult[]>([]);\r\n  const [selectedPatient, setSelectedPatient] = useState<{ id: string; label: string } | null>(null);\r\n  const [showNewPatient, setShowNewPatient] = useState(false);\r\n  const [patientDraft, setPatientDraft] = useState({\r\n    firstName: \"\",\r\n    lastName: \"\",\r\n    dni: \"\",\r\n    sex: \"M\" as \"M\" | \"F\" | \"O\",\r\n    birthDate: \"\",\r\n  });\r\n  const [tests, setTests] = useState<TestItem[]>([]);\r\n  const [profiles, setProfiles] = useState<Profile[]>([]);\r\n  const [favoriteIds, setFavoriteIds] = useState<Set<string>>(new Set());\r\n  const [selectedTestIds, setSelectedTestIds] = useState<Set<string>>(new Set());\r\n  const [selectedProfileIds, setSelectedProfileIds] = useState<Set<string>>(new Set());\r\n  const [doctorName, setDoctorName] = useState(\"\");\r\n  const [indication, setIndication] = useState(\"\");\r\n  const [priority, setPriority] = useState<\"NORMAL\" | \"URGENTE\">(\"NORMAL\");\r\n  const [patientType, setPatientType] = useState<string>(\"\");\r\n  const [loading, setLoading] = useState(false);\r\n  const [searchLoading, setSearchLoading] = useState(false);\r\n  const [submitting, setSubmitting] = useState(false);\r\n\r\n  const fetchTests = useCallback(async () => {\r\n    const res = await fetch(\"/api/tests?active=true\");\r\n    const data = await res.json();\r\n    const items = (data.items ?? []).map((t: { section?: { code: string } | string | null }) => ({\r\n      ...t,\r\n      section: typeof t.section === \"object\" && t.section ? (t.section as { code: string }).code : (t.section ?? \"\"),\r\n    }));\r\n    setTests(items);\r\n  }, []);\r\n\r\n  const fetchProfiles = useCallback(async () => {\r\n    const res = await fetch(\"/api/test-profiles\");\r\n    const data = await res.json();\r\n    setProfiles(data.profiles ?? []);\r\n  }, []);\r\n\r\n  const fetchFavorites = useCallback(async () => {\r\n    try {\r\n      const res = await fetch(\"/api/favorites/tests\");\r\n      const data = await res.json();\r\n      setFavoriteIds(new Set(data.testIds ?? []));\r\n    } catch {\r\n      setFavoriteIds(new Set());\r\n    }\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (open) {\r\n      fetchTests();\r\n      fetchProfiles();\r\n      fetchFavorites();\r\n    }\r\n  }, [open, fetchTests, fetchProfiles, fetchFavorites]);\r\n\r\n  useEffect(() => {\r\n    if (!patientQuery || patientQuery.length < 2) {\r\n      setPatientResults([]);\r\n      return;\r\n    }\r\n    setSearchLoading(true);\r\n    const t = setTimeout(async () => {\r\n      try {\r\n        const res = await fetch(`/api/search?q=${encodeURIComponent(patientQuery)}`);\r\n        const data = await res.json();\r\n        const patients = (data.patients ?? []).map((p: { id: string; label: string; sublabel: string }) => ({\r\n          id: p.id,\r\n          label: p.label,\r\n          sublabel: p.sublabel,\r\n        }));\r\n        setPatientResults(patients);\r\n      } catch {\r\n        setPatientResults([]);\r\n      } finally {\r\n        setSearchLoading(false);\r\n      }\r\n    }, 200);\r\n    return () => clearTimeout(t);\r\n  }, [patientQuery]);\r\n\r\n  const toggleTest = (id: string) => {\r\n    if (testIdsInPromos.has(id)) {\r\n      const promoContaining = profiles.find(\r\n        (p) => selectedProfileIds.has(p.id) && p.tests.some((x) => x.id === id)\r\n      );\r\n      toast.info(\r\n        `Este análisis ya está incluido en la promoción \"${promoContaining?.name ?? \"\"}\". No se puede seleccionar individualmente.`\r\n      );\r\n      return;\r\n    }\r\n    setSelectedTestIds((prev) => {\r\n      const next = new Set(prev);\r\n      if (next.has(id)) next.delete(id);\r\n      else next.add(id);\r\n      return next;\r\n    });\r\n  };\r\n\r\n  const addProfile = (profile: Profile) => {\r\n    if (selectedProfileIds.has(profile.id)) {\r\n      toast.info(\"Esta promoción ya está seleccionada.\");\r\n      return;\r\n    }\r\n    setSelectedProfileIds((prev) => new Set(prev).add(profile.id));\r\n    const profileTestIds = new Set(profile.tests.map((t) => t.id));\r\n    setSelectedTestIds((prev) => {\r\n      const next = new Set(prev);\r\n      const removedIds: string[] = [];\r\n      profileTestIds.forEach((id) => {\r\n        if (next.has(id)) {\r\n          removedIds.push(id);\r\n          next.delete(id);\r\n        }\r\n      });\r\n      \r\n      // Si se eliminaron análisis individuales porque ahora están en la promoción, mostrar mensaje\r\n      if (removedIds.length > 0) {\r\n        setTimeout(() => {\r\n          toast.info(\r\n            `Se agregó la promoción \"${profile.name}\". ${removedIds.length} análisis individual${removedIds.length > 1 ? \"es\" : \"\"} que ya estaban incluidos fueron removidos para evitar duplicados.`\r\n          );\r\n        }, 100);\r\n      }\r\n      \r\n      return next;\r\n    });\r\n  };\r\n\r\n  const removeProfile = (profileId: string) => {\r\n    setSelectedProfileIds((prev) => {\r\n      const next = new Set(prev);\r\n      next.delete(profileId);\r\n      return next;\r\n    });\r\n  };\r\n\r\n  const testIdsInPromos = new Set(\r\n    Array.from(selectedProfileIds).flatMap((pid) => {\r\n      const p = profiles.find((x) => x.id === pid);\r\n      return p ? p.tests.map((t) => t.id) : [];\r\n    })\r\n  );\r\n\r\n  const toggleFavorite = async (testId: string) => {\r\n    const add = !favoriteIds.has(testId);\r\n    try {\r\n      const res = await fetch(\"/api/favorites/tests\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ testId, add }),\r\n      });\r\n      if (res.ok) fetchFavorites();\r\n    } catch {\r\n      toast.error(\"No se pudo actualizar favorito\");\r\n    }\r\n  };\r\n\r\n  const handleSubmit = async () => {\r\n    const testsFromProfiles = new Set(\r\n      Array.from(selectedProfileIds).flatMap((pid) => {\r\n        const p = profiles.find((x) => x.id === pid);\r\n        return p ? p.tests.map((t) => t.id) : [];\r\n      })\r\n    );\r\n    const individualTestIds = Array.from(selectedTestIds).filter((id) => !testsFromProfiles.has(id));\r\n    const hasTests = selectedProfileIds.size > 0 || individualTestIds.length > 0;\r\n    if (!hasTests) {\r\n      toast.error(\"Selecciona al menos un análisis o una promoción\");\r\n      return;\r\n    }\r\n\r\n    let patientId: string | undefined;\r\n    let patientDraftPayload: typeof patientDraft | undefined;\r\n\r\n    if (selectedPatient) {\r\n      patientId = selectedPatient.id;\r\n    } else if (showNewPatient && patientDraft.firstName && patientDraft.lastName && patientDraft.dni && patientDraft.birthDate) {\r\n      patientDraftPayload = {\r\n        ...patientDraft,\r\n        birthDate: patientDraft.birthDate,\r\n      };\r\n    } else {\r\n      toast.error(\"Selecciona o crea un paciente\");\r\n      return;\r\n    }\r\n\r\n    setSubmitting(true);\r\n    try {\r\n      const res = await fetch(\"/api/orders/quick\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({\r\n          patientId,\r\n          patientDraft: patientDraftPayload,\r\n          doctorName: doctorName || null,\r\n          indication: indication || null,\r\n          priority,\r\n          patientType: patientType || null,\r\n          profileIds: Array.from(selectedProfileIds),\r\n          tests: individualTestIds,\r\n        }),\r\n      });\r\n\r\n      const data = await res.json().catch(() => ({}));\r\n      if (!res.ok) {\r\n        toast.error(data.error || \"Error al crear la orden\");\r\n        return;\r\n      }\r\n\r\n      toast.success(\"Orden creada correctamente\", {\r\n        action: {\r\n          label: \"Ir a captura\",\r\n          onClick: () => {\r\n            router.push(`/orders/${data.orderId}`);\r\n            onOpenChange(false);\r\n          },\r\n        },\r\n      });\r\n      onOpenChange(false);\r\n      router.refresh();\r\n    } catch {\r\n      toast.error(\"Error de conexión\");\r\n    } finally {\r\n      setSubmitting(false);\r\n    }\r\n  };\r\n\r\n  const filteredTests = useMemo(() => {\r\n    const term = testSearch.trim().toLowerCase();\r\n    if (!term) return tests;\r\n    return tests.filter(\r\n      (t) =>\r\n        t.code.toLowerCase().includes(term) ||\r\n        t.name.toLowerCase().includes(term) ||\r\n        t.section.toLowerCase().includes(term),\r\n    );\r\n  }, [tests, testSearch]);\r\n\r\n  const favoriteTests = tests.filter((t) => favoriteIds.has(t.id));\r\n  const selectedProfiles = profiles.filter((p) => selectedProfileIds.has(p.id));\r\n  const testsFromProfilesSet = new Set(\r\n    selectedProfiles.flatMap((p) => p.tests.map((t) => t.id))\r\n  );\r\n  const selectedIndividualTests = tests.filter(\r\n    (t) => selectedTestIds.has(t.id) && !testsFromProfilesSet.has(t.id)\r\n  );\r\n  const totalFromProfiles = selectedProfiles.reduce(\r\n    (acc, p) => acc + (p.packagePrice ?? p.tests.reduce((s, t) => s + t.price, 0)),\r\n    0\r\n  );\r\n  const totalFromTests = selectedIndividualTests.reduce((acc, t) => acc + t.price, 0);\r\n  const total = totalFromProfiles + totalFromTests;\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={onOpenChange}>\r\n      <DialogContent className=\"max-h-[90vh] max-w-2xl overflow-y-auto\">\r\n        <DialogHeader>\r\n          <DialogTitle>Orden rápida</DialogTitle>\r\n        </DialogHeader>\r\n\r\n        <div className=\"space-y-6\">\r\n          {/* Paciente */}\r\n          <div className=\"space-y-2\">\r\n            <Label>Paciente</Label>\r\n            {selectedPatient && !showNewPatient ? (\r\n              <div className=\"flex items-center justify-between rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 dark:border-slate-600 dark:bg-slate-800\">\r\n                <span className=\"text-sm font-medium\">{selectedPatient.label}</span>\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => setSelectedPatient(null)}\r\n                  className=\"text-slate-500 hover:text-slate-700\"\r\n                >\r\n                  <X className=\"h-4 w-4\" />\r\n                </button>\r\n              </div>\r\n            ) : showNewPatient ? (\r\n              <div className=\"space-y-3 rounded-lg border border-slate-200 p-3 dark:border-slate-600\">\r\n                <div className=\"grid grid-cols-2 gap-2\">\r\n                  <Input\r\n                    placeholder=\"Nombre\"\r\n                    value={patientDraft.firstName}\r\n                    onChange={(e) => setPatientDraft((p) => ({ ...p, firstName: e.target.value }))}\r\n                  />\r\n                  <Input\r\n                    placeholder=\"Apellido\"\r\n                    value={patientDraft.lastName}\r\n                    onChange={(e) => setPatientDraft((p) => ({ ...p, lastName: e.target.value }))}\r\n                  />\r\n                  <Input\r\n                    placeholder=\"DNI\"\r\n                    value={patientDraft.dni}\r\n                    onChange={(e) => setPatientDraft((p) => ({ ...p, dni: e.target.value }))}\r\n                  />\r\n                  <Input\r\n                    type=\"date\"\r\n                    placeholder=\"Fecha nac.\"\r\n                    value={patientDraft.birthDate}\r\n                    onChange={(e) => setPatientDraft((p) => ({ ...p, birthDate: e.target.value }))}\r\n                  />\r\n                  <select\r\n                    value={patientDraft.sex}\r\n                    onChange={(e) =>\r\n                      setPatientDraft((p) => ({ ...p, sex: e.target.value as \"M\" | \"F\" | \"O\" }))\r\n                    }\r\n                    className=\"h-9 rounded-md border border-slate-200 bg-white px-3 text-sm dark:border-slate-600 dark:bg-slate-800\"\r\n                  >\r\n                    <option value=\"M\">Masculino</option>\r\n                    <option value=\"F\">Femenino</option>\r\n                    <option value=\"O\">Otro</option>\r\n                  </select>\r\n                </div>\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => setShowNewPatient(false)}\r\n                  className=\"text-sm text-slate-600 hover:underline dark:text-slate-400\"\r\n                >\r\n                  Cancelar · Buscar paciente existente\r\n                </button>\r\n              </div>\r\n            ) : (\r\n              <div className=\"space-y-2\">\r\n                <div className=\"relative\">\r\n                  <Search className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-slate-400\" />\r\n                  <Input\r\n                    placeholder=\"Buscar por DNI o nombre...\"\r\n                    value={patientQuery}\r\n                    onChange={(e) => setPatientQuery(e.target.value)}\r\n                    className=\"pl-9\"\r\n                  />\r\n                </div>\r\n                {patientQuery.length >= 2 && (\r\n                  <ul className=\"max-h-40 overflow-auto rounded border border-slate-200 bg-white dark:border-slate-600 dark:bg-slate-800\">\r\n                    {searchLoading ? (\r\n                      <li className=\"px-4 py-3 text-sm text-slate-500\">Buscando...</li>\r\n                    ) : patientResults.length === 0 ? (\r\n                      <li className=\"px-4 py-3 text-sm text-slate-500\">Sin resultados</li>\r\n                    ) : (\r\n                      patientResults.map((p) => (\r\n                        <li key={p.id}>\r\n                          <button\r\n                            type=\"button\"\r\n                            onClick={() => {\r\n                              setSelectedPatient({ id: p.id, label: p.label });\r\n                              setPatientQuery(\"\");\r\n                              setPatientResults([]);\r\n                            }}\r\n                            className=\"w-full px-4 py-2 text-left text-sm hover:bg-slate-50 dark:hover:bg-slate-700\"\r\n                          >\r\n                            {p.label} · {p.sublabel}\r\n                          </button>\r\n                        </li>\r\n                      ))\r\n                    )}\r\n                  </ul>\r\n                )}\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => setShowNewPatient(true)}\r\n                  className=\"text-sm text-slate-600 hover:underline dark:text-slate-400\"\r\n                >\r\n                  Crear paciente rápido\r\n                </button>\r\n              </div>\r\n            )}\r\n          </div>\r\n\r\n          {/* Médico, indicación y prioridad */}\r\n          <div className=\"grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3\">\r\n            <div className=\"space-y-2\">\r\n              <Label>Médico (opcional)</Label>\r\n              <Input\r\n                placeholder=\"Dr. García\"\r\n                value={doctorName}\r\n                onChange={(e) => setDoctorName(e.target.value)}\r\n              />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label>Indicación (opcional)</Label>\r\n              <Input\r\n                placeholder=\"Control\"\r\n                value={indication}\r\n                onChange={(e) => setIndication(e.target.value)}\r\n              />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label>Prioridad</Label>\r\n              <select\r\n                value={priority}\r\n                onChange={(e) => setPriority(e.target.value as \"NORMAL\" | \"URGENTE\")}\r\n                className=\"h-9 w-full rounded-md border border-slate-200 bg-white px-3 text-sm dark:border-slate-600 dark:bg-slate-800\"\r\n              >\r\n                <option value=\"NORMAL\">Normal</option>\r\n                <option value=\"URGENTE\">Urgente</option>\r\n              </select>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Análisis */}\r\n          <div className=\"space-y-2\">\r\n            <Label>Análisis</Label>\r\n            {profiles.length > 0 && (\r\n              <div className=\"flex flex-wrap items-center gap-2\">\r\n                <span className=\"text-xs text-slate-500\">Agregar promoción:</span>\r\n                <select\r\n                  onChange={(e) => {\r\n                    const id = e.target.value;\r\n                    if (id) {\r\n                      const p = profiles.find((x) => x.id === id);\r\n                      if (p) addProfile(p);\r\n                      e.target.value = \"\";\r\n                    }\r\n                  }}\r\n                  className=\"h-8 rounded border border-slate-200 bg-white px-2 text-sm dark:border-slate-600 dark:bg-slate-800\"\r\n                >\r\n                  <option value=\"\">Seleccionar paquete</option>\r\n                  {profiles.map((p) => (\r\n                    <option key={p.id} value={p.id}>\r\n                      {p.name}\r\n                      {p.packagePrice != null ? ` — S/ ${p.packagePrice.toFixed(2)}` : \"\"}\r\n                      {\" \"}({p.tests.length} análisis)\r\n                    </option>\r\n                  ))}\r\n                </select>\r\n                {selectedProfiles.map((p) => (\r\n                  <span\r\n                    key={p.id}\r\n                    className=\"inline-flex items-center gap-1 rounded-full bg-amber-100 px-2.5 py-1 text-xs font-medium text-amber-800 border border-amber-200\"\r\n                  >\r\n                    {p.name}\r\n                    <button\r\n                      type=\"button\"\r\n                      onClick={() => removeProfile(p.id)}\r\n                      className=\"text-amber-600 hover:text-amber-800\"\r\n                      title=\"Quitar\"\r\n                    >\r\n                      ×\r\n                    </button>\r\n                  </span>\r\n                ))}\r\n              </div>\r\n            )}\r\n            {favoriteTests.length > 0 && (\r\n              <div>\r\n                <p className=\"mb-1 flex items-center gap-1 text-xs font-medium text-slate-600 dark:text-slate-400\">\r\n                  <Star className=\"h-3.5 w-3.5 fill-amber-400 text-amber-500\" /> Favoritos\r\n                </p>\r\n                <div className=\"flex flex-wrap gap-1\">\r\n                  {favoriteTests.map((t) => (\r\n                    <Badge\r\n                      key={t.id}\r\n                      variant={selectedTestIds.has(t.id) ? \"default\" : \"secondary\"}\r\n                      className=\"cursor-pointer\"\r\n                      onClick={() => toggleTest(t.id)}\r\n                    >\r\n                      {t.code} - {t.name}\r\n                    </Badge>\r\n                  ))}\r\n                </div>\r\n              </div>\r\n            )}\r\n            <div>\r\n              <div className=\"mb-2 flex items-center gap-2\">\r\n                <p className=\"text-xs font-medium text-slate-600 dark:text-slate-400\">\r\n                  Lista general\r\n                </p>\r\n                <div className=\"relative flex-1 min-w-0\">\r\n                  <Search className=\"absolute left-2.5 top-1/2 h-3.5 w-3.5 -translate-y-1/2 text-slate-400\" />\r\n                  <Input\r\n                    placeholder=\"Buscar análisis...\"\r\n                    value={testSearch}\r\n                    onChange={(e) => setTestSearch(e.target.value)}\r\n                    className=\"h-8 pl-8 text-sm\"\r\n                  />\r\n                </div>\r\n              </div>\r\n              <div className=\"max-h-44 overflow-auto rounded border border-slate-200 p-2 dark:border-slate-600\">\r\n                {filteredTests.length === 0 ? (\r\n                  <p className=\"px-2 py-4 text-center text-sm text-slate-500\">\r\n                    {testSearch.trim() ? \"Sin resultados\" : \"No hay análisis\"}\r\n                  </p>\r\n                ) : (\r\n                filteredTests.map((t) => {\r\n                  const isInPromo = testIdsInPromos.has(t.id);\r\n                  const promoContaining = profiles.find(\r\n                    (p) => selectedProfileIds.has(p.id) && p.tests.some((x) => x.id === t.id)\r\n                  );\r\n                  const isChecked = selectedTestIds.has(t.id) || isInPromo;\r\n                  return (\r\n                    <label\r\n                      key={t.id}\r\n                      className={`flex items-center justify-between gap-2 rounded px-2 py-1.5 text-sm ${\r\n                        isInPromo ? \"bg-amber-50/50 dark:bg-amber-900/10\" : \"cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800\"\r\n                      } ${selectedTestIds.has(t.id) ? \"bg-blue-50 dark:bg-blue-900/20\" : \"\"}`}\r\n                    >\r\n                      <span className=\"flex items-center gap-2 min-w-0\">\r\n                        <input\r\n                          type=\"checkbox\"\r\n                          checked={isChecked}\r\n                          disabled={isInPromo}\r\n                          onChange={() => toggleTest(t.id)}\r\n                          title={isInPromo ? `Incluido en: ${promoContaining?.name ?? \"\"}` : undefined}\r\n                        />\r\n                        <span className=\"truncate\">\r\n                          {t.code} - {t.name}\r\n                          {isInPromo && promoContaining && (\r\n                            <span className=\"ml-1 text-xs text-amber-600 dark:text-amber-400\">\r\n                              (en {promoContaining.name})\r\n                            </span>\r\n                          )}\r\n                        </span>\r\n                      </span>\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={(e) => {\r\n                          e.preventDefault();\r\n                          toggleFavorite(t.id);\r\n                        }}\r\n                        className=\"text-slate-400 hover:text-amber-500 shrink-0\"\r\n                      >\r\n                        <Star\r\n                          className={`h-4 w-4 ${favoriteIds.has(t.id) ? \"fill-amber-400 text-amber-500\" : \"\"}`}\r\n                        />\r\n                      </button>\r\n                    </label>\r\n                  );\r\n                })\r\n                )}\r\n              </div>\r\n            </div>\r\n            {(selectedProfiles.length > 0 || selectedIndividualTests.length > 0) && (\r\n              <div className=\"rounded border border-slate-200 bg-slate-50/80 p-3 dark:border-slate-600 dark:bg-slate-800/50 space-y-2\">\r\n                <p className=\"text-xs font-medium text-slate-500 dark:text-slate-400\">\r\n                  Resumen (promociones encapsuladas, análisis sueltos aparte)\r\n                </p>\r\n                {selectedProfiles.length > 0 && (\r\n                  <div className=\"space-y-1\">\r\n                    <p className=\"text-xs font-semibold text-slate-600 dark:text-slate-300\">Promociones</p>\r\n                    {selectedProfiles.map((p) => (\r\n                      <div\r\n                        key={p.id}\r\n                        className=\"text-xs rounded bg-amber-50 dark:bg-amber-900/20 px-2 py-1.5 border border-amber-200 dark:border-amber-800\"\r\n                      >\r\n                        <span className=\"font-medium\">{p.name}</span>\r\n                        <span className=\"text-slate-600 dark:text-slate-400\"> — {p.tests.map((x) => x.code).join(\", \")}</span>\r\n                      </div>\r\n                    ))}\r\n                  </div>\r\n                )}\r\n                {selectedIndividualTests.length > 0 && (\r\n                  <p className=\"text-xs text-slate-600 dark:text-slate-400\">\r\n                    Análisis sueltos: {selectedIndividualTests.map((t) => t.code).join(\", \")}\r\n                  </p>\r\n                )}\r\n                <p className=\"text-sm font-medium text-slate-700 dark:text-slate-300 pt-1 border-t border-slate-200 dark:border-slate-600\">\r\n                  Total: S/ {total.toFixed(2)}\r\n                </p>\r\n              </div>\r\n            )}\r\n          </div>\r\n\r\n          <div className=\"flex justify-end gap-2\">\r\n            <Button variant=\"outline\" onClick={() => onOpenChange(false)}>\r\n              Cancelar\r\n            </Button>\r\n            <Button onClick={handleSubmit} disabled={submitting}>\r\n              {submitting ? \"Creando...\" : \"Crear orden\"}\r\n            </Button>\r\n          </div>\r\n        </div>\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\orders\\ReferredLabPaymentDialog.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadData'. Either include it or remove the dependency array.","line":80,"column":6,"nodeType":"ArrayExpression","endLine":80,"endColumn":21,"suggestions":[{"desc":"Update the dependencies array to be: [loadData, open, orderId]","fix":{"range":[2132,2147],"text":"[loadData, open, orderId]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { toast } from \"sonner\";\r\nimport { Building2 } from \"lucide-react\";\r\n\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogTrigger,\r\n} from \"@/components/ui/dialog\";\r\nimport { formatCurrency } from \"@/lib/format\";\r\n\r\ntype LabSummary = {\r\n  referredLabId: string;\r\n  referredLabName: string;\r\n  totalCost: number;\r\n  paid: number;\r\n  balance: number;\r\n};\r\n\r\ntype Props = {\r\n  orderId: string;\r\n  orderCode: string;\r\n  canRegisterPayment: boolean;\r\n  onPaymentSaved?: () => void;\r\n};\r\n\r\nexport function ReferredLabPaymentDialog({\r\n  orderId,\r\n  orderCode,\r\n  canRegisterPayment,\r\n  onPaymentSaved,\r\n}: Props) {\r\n  const [open, setOpen] = useState(false);\r\n  const [saving, setSaving] = useState(false);\r\n  const [data, setData] = useState<{\r\n    totalExternalCost: number;\r\n    totalPaidToLabs: number;\r\n    totalBalanceOwed: number;\r\n    labs: LabSummary[];\r\n    payments: Array<{\r\n      id: string;\r\n      referredLabName: string;\r\n      amount: number;\r\n      paidAt: string;\r\n      notes: string | null;\r\n    }>;\r\n  } | null>(null);\r\n  const [loading, setLoading] = useState(false);\r\n  const [selectedLabId, setSelectedLabId] = useState(\"\");\r\n  const [amount, setAmount] = useState(\"\");\r\n  const [notes, setNotes] = useState(\"\");\r\n\r\n  const loadData = async () => {\r\n    setLoading(true);\r\n    try {\r\n      const res = await fetch(`/api/orders/${orderId}/referred-lab-payments`);\r\n      const json = await res.json().catch(() => ({}));\r\n      if (res.ok && json.labs) {\r\n        setData(json);\r\n        if (json.labs.length > 0 && !selectedLabId) {\r\n          const firstWithBalance = json.labs.find((l: LabSummary) => l.balance > 0);\r\n          setSelectedLabId(firstWithBalance?.referredLabId ?? json.labs[0].referredLabId);\r\n        }\r\n      }\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    if (open) void loadData();\r\n  }, [open, orderId]);\r\n\r\n  const selectedLab = data?.labs.find((l) => l.referredLabId === selectedLabId);\r\n  const maxAmount = selectedLab?.balance ?? 0;\r\n\r\n  const submit = async () => {\r\n    if (!selectedLabId) {\r\n      toast.error(\"Selecciona un laboratorio\");\r\n      return;\r\n    }\r\n    const parsedAmount = Number(amount);\r\n    if (!Number.isFinite(parsedAmount) || parsedAmount <= 0) {\r\n      toast.error(\"Ingresa un monto válido\");\r\n      return;\r\n    }\r\n    if (parsedAmount > maxAmount + 0.0001) {\r\n      toast.error(`El monto excede lo pendiente (${formatCurrency(maxAmount)})`);\r\n      return;\r\n    }\r\n\r\n    setSaving(true);\r\n    try {\r\n      const res = await fetch(`/api/orders/${orderId}/referred-lab-payments`, {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({\r\n          referredLabId: selectedLabId,\r\n          amount: parsedAmount,\r\n          notes: notes.trim() || null,\r\n        }),\r\n      });\r\n      const json = await res.json().catch(() => ({}));\r\n      if (!res.ok) {\r\n        toast.error(json.error ?? \"No se pudo registrar el pago\");\r\n        return;\r\n      }\r\n      toast.success(\"Pago al laboratorio referido registrado\");\r\n      setAmount(\"\");\r\n      setNotes(\"\");\r\n      await loadData();\r\n      onPaymentSaved?.();\r\n      if (selectedLab && parsedAmount >= selectedLab.balance - 0.0001) {\r\n        setOpen(false);\r\n      }\r\n    } catch {\r\n      toast.error(\"Error de conexión\");\r\n    } finally {\r\n      setSaving(false);\r\n    }\r\n  };\r\n\r\n  if (!canRegisterPayment) return null;\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={setOpen}>\r\n      <DialogTrigger asChild>\r\n        <Button size=\"sm\" variant=\"outline\" className=\"gap-2\">\r\n          <Building2 className=\"h-4 w-4\" />\r\n          Pagar lab. referido\r\n        </Button>\r\n      </DialogTrigger>\r\n      <DialogContent className=\"max-w-md\">\r\n        <DialogHeader>\r\n          <DialogTitle>Pagar laboratorio referido</DialogTitle>\r\n          <DialogDescription>\r\n            Orden {orderCode}. Registra los montos que pagas a los laboratorios terciarizados.\r\n          </DialogDescription>\r\n        </DialogHeader>\r\n\r\n        {loading ? (\r\n          <p className=\"py-6 text-center text-sm text-slate-500\">Cargando…</p>\r\n        ) : !data || data.labs.length === 0 ? (\r\n          <p className=\"py-6 text-center text-sm text-slate-500\">\r\n            Esta orden no tiene análisis referidos.\r\n          </p>\r\n        ) : (\r\n          <div className=\"space-y-4\">\r\n            <div className=\"rounded-lg border border-slate-200 bg-slate-50 p-3 dark:border-slate-700 dark:bg-slate-800/50\">\r\n              <p className=\"text-xs font-medium text-slate-600 dark:text-slate-400\">\r\n                Costo total a labs referidos\r\n              </p>\r\n              <p className=\"text-lg font-semibold\">{formatCurrency(data.totalExternalCost)}</p>\r\n              <p className=\"mt-1 text-xs text-slate-500\">\r\n                Pagado: {formatCurrency(data.totalPaidToLabs)} • Pendiente:{\" \"}\r\n                <span className=\"font-medium text-amber-600 dark:text-amber-400\">\r\n                  {formatCurrency(data.totalBalanceOwed)}\r\n                </span>\r\n              </p>\r\n            </div>\r\n\r\n            <div className=\"space-y-1.5\">\r\n              <Label htmlFor=\"referred-lab-select\">Laboratorio</Label>\r\n              <select\r\n                id=\"referred-lab-select\"\r\n                value={selectedLabId}\r\n                onChange={(e) => {\r\n                  setSelectedLabId(e.target.value);\r\n                  setAmount(\"\");\r\n                }}\r\n                className=\"h-9 w-full rounded-md border border-slate-200 bg-white px-3 text-sm dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100\"\r\n              >\r\n                {data.labs.map((l) => (\r\n                  <option key={l.referredLabId} value={l.referredLabId}>\r\n                    {l.referredLabName} — Pendiente: {formatCurrency(l.balance)}\r\n                  </option>\r\n                ))}\r\n              </select>\r\n            </div>\r\n\r\n            {selectedLab && selectedLab.balance > 0 && (\r\n              <>\r\n                <div className=\"space-y-1.5\">\r\n                  <Label htmlFor=\"referred-amount\">Monto a registrar</Label>\r\n                  <Input\r\n                    id=\"referred-amount\"\r\n                    inputMode=\"decimal\"\r\n                    placeholder={`Máx. ${formatCurrency(selectedLab.balance)}`}\r\n                    value={amount}\r\n                    onChange={(e) => setAmount(e.target.value)}\r\n                  />\r\n                  <p className=\"text-xs text-slate-500\">\r\n                    Pendiente por pagar a este lab: {formatCurrency(selectedLab.balance)}\r\n                  </p>\r\n                </div>\r\n\r\n                <div className=\"space-y-1.5\">\r\n                  <Label htmlFor=\"referred-notes\">Nota (opcional)</Label>\r\n                  <Input\r\n                    id=\"referred-notes\"\r\n                    placeholder=\"Ej: Transferencia #123\"\r\n                    value={notes}\r\n                    onChange={(e) => setNotes(e.target.value)}\r\n                  />\r\n                </div>\r\n\r\n                <div className=\"flex justify-end gap-2\">\r\n                  <Button variant=\"outline\" onClick={() => setOpen(false)} disabled={saving}>\r\n                    Cerrar\r\n                  </Button>\r\n                  <Button\r\n                    onClick={() => void submit()}\r\n                    disabled={saving || !amount || Number(amount) <= 0}\r\n                  >\r\n                    {saving ? \"Guardando…\" : \"Registrar pago\"}\r\n                  </Button>\r\n                </div>\r\n              </>\r\n            )}\r\n\r\n            {data.payments.length > 0 && (\r\n              <div className=\"mt-4 space-y-2 border-t border-slate-200 pt-4 dark:border-slate-700\">\r\n                <p className=\"text-xs font-medium text-slate-600 dark:text-slate-400\">\r\n                  Pagos registrados\r\n                </p>\r\n                {data.payments.map((p) => (\r\n                  <div\r\n                    key={p.id}\r\n                    className=\"flex items-center justify-between rounded border border-slate-200 py-2 px-3 text-sm dark:border-slate-700\"\r\n                  >\r\n                    <div>\r\n                      <p className=\"font-medium\">{p.referredLabName}</p>\r\n                      <p className=\"text-xs text-slate-500\">{formatCurrency(p.amount)}</p>\r\n                    </div>\r\n                    <p className=\"text-xs text-slate-500\">{new Date(p.paidAt).toLocaleDateString()}</p>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            )}\r\n          </div>\r\n        )}\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\orders\\RepeatOrderButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\orders\\ResultActions.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\pagos\\CashierDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\pagos\\PagosTabs.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\pagos\\PaymentTicketClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\pagos\\RegistrarpagoButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\providers\\SessionProvider.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\providers\\ThemeProvider.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\providers\\ThemeProvider.tsx:30:5\n  28 |     const prefersDark = window.matchMedia(\"(prefers-color-scheme: dark)\").matches;\n  29 |     const initial: Theme = stored ?? (prefersDark ? \"dark\" : \"light\");\n> 30 |     setThemeState(initial);\n     |     ^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  31 |     document.documentElement.classList.toggle(\"dark\", initial === \"dark\");\n  32 |     // eslint-disable-next-line react-hooks/set-state-in-effect -- sincronizar tema desde localStorage al montar\n  33 |   }, []);","line":30,"column":5,"nodeType":null,"endLine":30,"endColumn":18},{"ruleId":null,"message":"Unused eslint-disable directive (no problems were reported from 'react-hooks/set-state-in-effect').","line":32,"column":5,"severity":1,"nodeType":null,"fix":{"range":[972,1080],"text":" "}}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":1,"source":"\"use client\";\r\n\r\nimport { createContext, useContext, useEffect, useState } from \"react\";\r\n\r\ntype Theme = \"light\" | \"dark\";\r\n\r\ntype ThemeContextType = {\r\n  theme: Theme;\r\n  setTheme: (theme: Theme) => void;\r\n  toggleTheme: () => void;\r\n};\r\n\r\nconst defaultContext: ThemeContextType = {\r\n  theme: \"light\",\r\n  setTheme: () => {},\r\n  toggleTheme: () => {},\r\n};\r\n\r\nconst ThemeContext = createContext<ThemeContextType>(defaultContext);\r\n\r\nconst STORAGE_KEY = \"theme-preference\";\r\n\r\nexport function ThemeProvider({ children }: { children: React.ReactNode }) {\r\n  const [theme, setThemeState] = useState<Theme>(\"light\");\r\n\r\n  useEffect(() => {\r\n    const stored = localStorage.getItem(STORAGE_KEY) as Theme | null;\r\n    const prefersDark = window.matchMedia(\"(prefers-color-scheme: dark)\").matches;\r\n    const initial: Theme = stored ?? (prefersDark ? \"dark\" : \"light\");\r\n    setThemeState(initial);\r\n    document.documentElement.classList.toggle(\"dark\", initial === \"dark\");\r\n    // eslint-disable-next-line react-hooks/set-state-in-effect -- sincronizar tema desde localStorage al montar\r\n  }, []);\r\n\r\n  const setTheme = (value: Theme) => {\r\n    setThemeState(value);\r\n    document.documentElement.classList.toggle(\"dark\", value === \"dark\");\r\n    localStorage.setItem(STORAGE_KEY, value);\r\n  };\r\n\r\n  const toggleTheme = () => {\r\n    const next = theme === \"light\" ? \"dark\" : \"light\";\r\n    setTheme(next);\r\n  };\r\n\r\n  return (\r\n    <ThemeContext.Provider value={{ theme, setTheme, toggleTheme }}>\r\n      {children}\r\n    </ThemeContext.Provider>\r\n  );\r\n}\r\n\r\nexport function useTheme() {\r\n  return useContext(ThemeContext);\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\shortcuts\\ShortcutsProvider.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\templates\\TemplatesList.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\ui\\badge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\ui\\button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\ui\\card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\ui\\dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\ui\\form-footer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\ui\\form-section.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\ui\\input.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\ui\\label.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\ui\\numeric-input.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\ui\\sonner.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\ui\\table.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\components\\ui\\textarea.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\features\\lab\\convert-admission-to-order.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\features\\lab\\order-alerts.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\features\\lab\\order-utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\features\\lab\\pending.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\features\\lab\\schemas.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\hooks\\useAutosaveResults.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\hooks\\useMediaQuery.ts","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\hooks\\useMediaQuery.ts:10:5\n   8 |   useEffect(() => {\n   9 |     const mql = window.matchMedia(query);\n> 10 |     setMatches(mql.matches);\n     |     ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  11 |     const handler = (e: MediaQueryListEvent) => setMatches(e.matches);\n  12 |     mql.addEventListener(\"change\", handler);\n  13 |     return () => mql.removeEventListener(\"change\", handler);","line":10,"column":5,"nodeType":null,"endLine":10,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\n\r\nexport function useMediaQuery(query: string): boolean {\r\n  const [matches, setMatches] = useState(false);\r\n\r\n  useEffect(() => {\r\n    const mql = window.matchMedia(query);\r\n    setMatches(mql.matches);\r\n    const handler = (e: MediaQueryListEvent) => setMatches(e.matches);\r\n    mql.addEventListener(\"change\", handler);\r\n    return () => mql.removeEventListener(\"change\", handler);\r\n  }, [query]);\r\n\r\n  return matches;\r\n}\r\n\r\nexport function useIsMobile(): boolean {\r\n  return useMediaQuery(\"(max-width: 767px)\");\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\lib\\api-errors.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\lib\\auth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\lib\\format.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\lib\\formatNumber.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\lib\\json-helpers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\lib\\logger.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\lib\\order-utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\lib\\patient-code.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\lib\\payments.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\lib\\print-config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\lib\\prisma.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\lib\\rate-limit.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\lib\\template-helpers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\lib\\template-presets.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\lib\\time-utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\lib\\utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\proxy.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\6\\Desktop\\proyecto laboratorio Completo\\SistemaLaboratorioEnfoque\\src\\types\\next-auth.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]